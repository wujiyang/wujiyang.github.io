<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>GolangåŸå­æ“ä½œ-Atomic</title>
    <link href="/2024/11/23/Goalng%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-Atomic/"/>
    <url>/2024/11/23/Goalng%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-Atomic/</url>
    
    <content type="html"><![CDATA[<p>ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œåœ¨ CPU æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸è¢«ä¸­æ–­çš„ç‰¹æ€§ï¼Œç§°ä¸ºåŸå­æ€§ï¼ˆatomicityï¼‰ ã€‚è¿™äº›æ“ä½œå¯¹å¤–è¡¨ç°æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œä»–ä»¬è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå¤–ç•Œä¸ä¼šçœ‹åˆ°ä»–ä»¬åªæ‰§è¡Œåˆ°ä¸€åŠçš„çŠ¶æ€ã€‚</p><span id="more"></span>  <h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œåœ¨ CPU æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¸è¢«ä¸­æ–­çš„ç‰¹æ€§ï¼Œç§°ä¸ºåŸå­æ€§ï¼ˆatomicityï¼‰ ã€‚è¿™äº›æ“ä½œå¯¹å¤–è¡¨ç°æˆä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ï¼Œä»–ä»¬è¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œå¤–ç•Œä¸ä¼šçœ‹åˆ°ä»–ä»¬åªæ‰§è¡Œåˆ°ä¸€åŠçš„çŠ¶æ€ã€‚  </p><blockquote><p>ğŸ“Œ CPUæ‰§è¡Œä¸€ç³»åˆ—æ“ä½œæ—¶ä¸å¯èƒ½ä¸å‘ç”Ÿä¸­æ–­ï¼Œä½†å¦‚æœæˆ‘ä»¬åœ¨æ‰§è¡Œå¤šä¸ªæ“ä½œæ—¶ï¼Œèƒ½è®©ä»–ä»¬çš„ä¸­é—´çŠ¶æ€å¯¹å¤–ä¸å¯è§ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å®£ç§°ä»–ä»¬æ‹¥æœ‰äº†â€ä¸å¯åˆ†å‰²â€çš„åŸå­æ€§ã€‚ </p></blockquote><h2 id="2-åŸºæœ¬ä»‹ç»"><a href="#2-åŸºæœ¬ä»‹ç»" class="headerlink" title="2. åŸºæœ¬ä»‹ç»"></a>2. åŸºæœ¬ä»‹ç»</h2><h3 id="2-1-äº’æ–¥é”ä¸åŸå­æ“ä½œ"><a href="#2-1-äº’æ–¥é”ä¸åŸå­æ“ä½œ" class="headerlink" title="2.1 äº’æ–¥é”ä¸åŸå­æ“ä½œ"></a>2.1 äº’æ–¥é”ä¸åŸå­æ“ä½œ</h3><p>åŸå­æ“ä½œå’Œäº’æ–¥é”å‡å¯ç”¨äºåœ¨å¹¶å‘ç¯å¢ƒä¸­ä¿æŠ¤å…±äº«èµ„æºï¼Œä¸è¿‡å®ƒä»¬åœ¨åº”ç”¨åœºæ™¯ã€å®ç°æœºåˆ¶ã€æ€§èƒ½ç­‰æ–¹é¢å­˜åœ¨ä¸€å®šçš„å·®å¼‚ï¼š<br><img src="/img/Golang%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-Atomic/1.png"><br>å¯¹ä¸€ä¸ªå˜é‡æ›´æ–°çš„ä¿æŠ¤ï¼ŒåŸå­æ“ä½œé€šå¸¸æ›´æœ‰æ•ˆç‡ï¼Œå¹¶ä¸”èƒ½åˆ©ç”¨è®¡ç®—æœºå¤šæ ¸çš„ä¼˜åŠ¿</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mutexAdd</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a <span class="hljs-type">int32</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <span class="hljs-keyword">var</span> mu sync.Mutex<br>    start := time.Now()<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000000</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            mu.Lock()<br>            a += <span class="hljs-number">1</span><br>            mu.Unlock()<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>    timeSpends := time.Since(start).Nanoseconds()<br>    fmt.Printf(<span class="hljs-string">&quot;use mutex a is %d, spend time: %v\n&quot;</span>, a, timeSpends)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AtomicAdd</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> a <span class="hljs-type">int32</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <br>    start := time.Now()<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000000</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            atomic.AddInt32(&amp;a, <span class="hljs-number">1</span>)<br>        &#125;()<br>    &#125;<br>    <br>    <br>    wg.Wait()<br>    timeSpends := time.Since(start).Nanoseconds()<br>    fmt.Printf(<span class="hljs-string">&quot;use atomic a is %d, spend time: %v\n&quot;</span>, atomic.LoadInt32(&amp;a), timeSpends)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-åŸå­èƒ½åŠ›ä»‹ç»"><a href="#2-2-åŸå­èƒ½åŠ›ä»‹ç»" class="headerlink" title="2.2 åŸå­èƒ½åŠ›ä»‹ç»"></a>2.2 åŸå­èƒ½åŠ›ä»‹ç»</h3><p>Goè¯­è¨€é€šè¿‡å†…ç½®åŒ…sync&#x2F;atomicæä¾›äº†å¯¹åŸå­æ“ä½œçš„æ”¯æŒï¼Œå…¶æä¾›çš„åŸå­æ“ä½œæœ‰ä»¥ä¸‹5ç±»ï¼Œå…¶ä¸­æ¯ç§ç±»åˆ«æ”¯æŒçš„æ•°æ®ç±»å‹æœ‰6ç§ï¼šInt32ã€Int64ã€Uint32ã€Uint64ã€Uintptrã€Pointer  ä»–ä»¬å¯ä»¥éšæ„ç»„åˆï¼š</p><ul><li>å¢åŠ  (Add)ï¼šatomic.AddInt32(addr *int32, delta int32)</li><li>åŠ è½½ï¼ˆLoadï¼‰ï¼šatomic.LoadInt32(addr *int32)</li><li>å­˜å‚¨ï¼ˆStoreï¼‰ï¼šatomic.LoadInt32(addr *int32)</li><li>äº¤æ¢ï¼ˆSwapï¼‰ï¼šatomic.SwapInt32(addr *int32, new int32)</li><li>æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCompareAndSwapï¼‰: atomic.CompareAndSwapInt32(addr *int32, old int32, new int32)</li></ul><blockquote><p>ğŸ“Œ æ³¨æ„ï¼š</p><ul><li>æ‰€æœ‰åŸå­æ“ä½œæ–¹æ³•çš„è¢«æ“ä½œæ•°å½¢å‚å¿…é¡»æ˜¯æŒ‡é’ˆç±»å‹ï¼Œé€šè¿‡æŒ‡é’ˆå˜é‡å¯ä»¥è·å–è¢«æ“ä½œæ•°åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œä»è€Œæ–½åŠ ç‰¹æ®Šçš„CPUæŒ‡ä»¤ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªgoroutineèƒ½å¤Ÿè¿›è¡Œæ“ä½œ</li></ul></blockquote><p>è¯¦ç»†æ”¯æŒçš„åŸå­æ“ä½œæœ‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// TSL Test-and-Set-Lockï¼Œå¯¹æŸä¸ªå­˜å‚¨å™¨ä½ç½®å†™å€¼å¹¶è¿”å›æ—§å€¼</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// old = *addr</span><br><span class="hljs-comment">// *addr = new</span><br><span class="hljs-comment">// return old</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapInt32</span><span class="hljs-params">(addr *<span class="hljs-type">int32</span>, <span class="hljs-built_in">new</span> <span class="hljs-type">int32</span>)</span></span> (old <span class="hljs-type">int32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapInt64</span><span class="hljs-params">(addr *<span class="hljs-type">int64</span>, <span class="hljs-built_in">new</span> <span class="hljs-type">int64</span>)</span></span> (old <span class="hljs-type">int64</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUint32</span><span class="hljs-params">(addr *<span class="hljs-type">uint32</span>, <span class="hljs-built_in">new</span> <span class="hljs-type">uint32</span>)</span></span> (old <span class="hljs-type">uint32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUint64</span><span class="hljs-params">(addr *<span class="hljs-type">uint64</span>, <span class="hljs-built_in">new</span> <span class="hljs-type">uint64</span>)</span></span> (old <span class="hljs-type">uint64</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapUintptr</span><span class="hljs-params">(addr *<span class="hljs-type">uintptr</span>, <span class="hljs-built_in">new</span> <span class="hljs-type">uintptr</span>)</span></span> (old <span class="hljs-type">uintptr</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SwapPointer</span><span class="hljs-params">(addr *unsafe.Pointer, <span class="hljs-built_in">new</span> unsafe.Pointer)</span></span> (old unsafe.Pointer)<br><br><span class="hljs-comment">// FAA Fetch-and- Addï¼Œå¯¹æŸä¸ªå­˜å‚¨å™¨ä½ç½®åŠ å€¼å¹¶è¿”å›æ–°å€¼</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// *addr += delta</span><br><span class="hljs-comment">// return *addr</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddInt32</span><span class="hljs-params">(addr *<span class="hljs-type">int32</span>, delta <span class="hljs-type">int32</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">int32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUint32</span><span class="hljs-params">(addr *<span class="hljs-type">uint32</span>, delta <span class="hljs-type">uint32</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">uint32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddInt64</span><span class="hljs-params">(addr *<span class="hljs-type">int64</span>, delta <span class="hljs-type">int64</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">int64</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUint64</span><span class="hljs-params">(addr *<span class="hljs-type">uint64</span>, delta <span class="hljs-type">uint64</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">uint64</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUintptr</span><span class="hljs-params">(addr *<span class="hljs-type">uintptr</span>, delta <span class="hljs-type">uintptr</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">uintptr</span>)<br><br><span class="hljs-comment">// CAS Compare-and-Swapï¼Œåˆ¤æ–­æŸä¸ªå­˜å‚¨å™¨ä½ç½®çš„å€¼æ˜¯å¦ä¸æŒ‡å®šå€¼ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™æ›¿æ¢ä¸ºæ–°çš„å€¼</span><br><span class="hljs-comment">// CASæ“ä½œä¿®æ”¹å…±äº«å˜é‡æ—¶å€™ä¸éœ€è¦å¯¹å…±äº«å˜é‡åŠ é”ï¼Œè€Œæ˜¯é€šè¿‡ç±»ä¼¼ä¹è§‚é”çš„æ–¹å¼è¿›è¡Œæ£€æŸ¥ï¼Œ</span><br><span class="hljs-comment">// æœ¬è´¨è¿˜æ˜¯ä¸æ–­çš„å ç”¨CPU èµ„æºæ¢å–åŠ é”å¸¦æ¥çš„å¼€é”€ï¼ˆæ¯”å¦‚ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼‰ã€‚</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  if *addr == old &#123;</span><br><span class="hljs-comment">//      *addr = new</span><br><span class="hljs-comment">//      return true</span><br><span class="hljs-comment">//  &#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// return false</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapInt32</span><span class="hljs-params">(addr *<span class="hljs-type">int32</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-type">int32</span>)</span></span> (swapped <span class="hljs-type">bool</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapInt64</span><span class="hljs-params">(addr *<span class="hljs-type">int64</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-type">int64</span>)</span></span> (swapped <span class="hljs-type">bool</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUint32</span><span class="hljs-params">(addr *<span class="hljs-type">uint32</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-type">uint32</span>)</span></span> (swapped <span class="hljs-type">bool</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUint64</span><span class="hljs-params">(addr *<span class="hljs-type">uint64</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-type">uint64</span>)</span></span> (swapped <span class="hljs-type">bool</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapUintptr</span><span class="hljs-params">(addr *<span class="hljs-type">uintptr</span>, old, <span class="hljs-built_in">new</span> <span class="hljs-type">uintptr</span>)</span></span> (swapped <span class="hljs-type">bool</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CompareAndSwapPointer</span><span class="hljs-params">(addr *unsafe.Pointer, old, <span class="hljs-built_in">new</span> unsafe.Pointer)</span></span> (swapped <span class="hljs-type">bool</span>)<br><br><span class="hljs-comment">// Read</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadInt32</span><span class="hljs-params">(addr *<span class="hljs-type">int32</span>)</span></span> (val <span class="hljs-type">int32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadInt64</span><span class="hljs-params">(addr *<span class="hljs-type">int64</span>)</span></span> (val <span class="hljs-type">int64</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUint32</span><span class="hljs-params">(addr *<span class="hljs-type">uint32</span>)</span></span> (val <span class="hljs-type">uint32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUint64</span><span class="hljs-params">(addr *<span class="hljs-type">uint64</span>)</span></span> (val <span class="hljs-type">uint64</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadUintptr</span><span class="hljs-params">(addr *<span class="hljs-type">uintptr</span>)</span></span> (val <span class="hljs-type">uintptr</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadPointer</span><span class="hljs-params">(addr *unsafe.Pointer)</span></span> (val unsafe.Pointer)<br><br><span class="hljs-comment">// Write</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreInt32</span><span class="hljs-params">(addr *<span class="hljs-type">int32</span>, val <span class="hljs-type">int32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreInt64</span><span class="hljs-params">(addr *<span class="hljs-type">int64</span>, val <span class="hljs-type">int64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUint32</span><span class="hljs-params">(addr *<span class="hljs-type">uint32</span>, val <span class="hljs-type">uint32</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUint64</span><span class="hljs-params">(addr *<span class="hljs-type">uint64</span>, val <span class="hljs-type">uint64</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StoreUintptr</span><span class="hljs-params">(addr *<span class="hljs-type">uintptr</span>, val <span class="hljs-type">uintptr</span>)</span></span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">StorePointer</span><span class="hljs-params">(addr *unsafe.Pointer, val unsafe.Pointer)</span></span><br></code></pre></td></tr></table></figure><h3 id="2-3-Atomic-Value"><a href="#2-3-Atomic-Value" class="headerlink" title="2.3 Atomic.Value"></a>2.3 Atomic.Value</h3><p>sync&#x2F;atomic çš„åŸå­è¯»å†™åªæä¾›äº† int32ã€int64ã€uint32ã€uint64ã€uintptr å’Œ unsafe.Pointer è¿™å‡ ä¸ªæ•°æ®ç±»å‹ã€‚å¦‚æœæ˜¯å…¶å®ƒæ•°æ®ç±»å‹çš„è¯å°±éœ€è¦ä½¿ç”¨ atomic.Value æ¥å®ç°åŸå­è¯»å†™äº†</p><h4 id="2-3-1-ç®€ä»‹"><a href="#2-3-1-ç®€ä»‹" class="headerlink" title="2.3.1 ç®€ä»‹"></a>2.3.1 ç®€ä»‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> pair <span class="hljs-keyword">struct</span> &#123;<br>    x, y <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    p := pair&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br>    <span class="hljs-keyword">var</span> v atomic.Value<br><br>    v.Store(p)<br>    fmt.Println(v.Load().(pair).x)<br>    fmt.Println(v.Load().(pair).y)<br>&#125;<br></code></pre></td></tr></table></figure><p>atomic.Valueåœ¨åº•å±‚çš„å®ç°ä¸­æ˜¯ä¸€ä¸ªinterfaceï¼Œä¸”æ˜¯ä¸€ä¸ªefaceWordsç±»å‹çš„interfaceã€‚ä»æ³¨é‡Šä¸­å¯ä»¥çœ‹åˆ°ï¼ŒValueçš„é›¶å€¼æ˜¯nilï¼Œä¸”ä½¿ç”¨åä¸å…è®¸è¢«æ‹·è´ã€‚<br>Valueå†™å…¥å€¼åï¼Œtypå­˜å‚¨æ•°æ®ç±»å‹ï¼Œdataå­˜å‚¨æ•°æ®å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A Value provides an atomic load and store of a consistently typed value.</span><br><span class="hljs-comment">// The zero value for a Value returns nil from Load.</span><br><span class="hljs-comment">// Once Store has been called, a Value must not be copied.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// A Value must not be copied after first use.</span><br><span class="hljs-keyword">type</span> Value <span class="hljs-keyword">struct</span> &#123;<br>    v any<br>&#125;<br><br><span class="hljs-comment">// efaceWords is interface&#123;&#125; internal representation.</span><br><span class="hljs-keyword">type</span> efaceWords <span class="hljs-keyword">struct</span> &#123;<br>    typ  unsafe.Pointer<br>    data unsafe.Pointer<br>&#125;<br></code></pre></td></tr></table></figure><p>Valueçš„æ ¸å¿ƒé€»è¾‘æ˜¯Storeå’ŒLoadï¼Œåˆ†åˆ«ä»‹ç»å¦‚ä¸‹</p><h4 id="2-3-2-Store"><a href="#2-3-2-Store" class="headerlink" title="2.3.2 Store"></a>2.3.2 Store</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Store å°†vçš„å€¼è®¾ç½®ä¸ºvalï¼ŒåŒä¸€ä¸ªValueåªèƒ½å­˜å‚¨ä¸€ä¸ªç±»å‹ï¼Œè€Œä¸”ä¸èƒ½å­˜å‚¨nilï¼Œå¦åˆ™ä¼španic</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *Value)</span></span> Store(val any) &#123;<br>    <span class="hljs-comment">// æ•°æ®æ ¡éªŒï¼Œå­˜å‚¨çš„å€¼ä¸èƒ½ä¸ºnil</span><br>    <span class="hljs-keyword">if</span> val == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync/atomic: store of nil value into Value&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">// è·å–vå’Œvalçš„æŒ‡é’ˆ</span><br>    vp := (*efaceWords)(unsafe.Pointer(v))<br>    vlp := (*efaceWords)(unsafe.Pointer(&amp;val))<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯é¦–æ¬¡å­˜å‚¨</span><br>        typ := LoadPointer(&amp;vp.typ)<br>        <span class="hljs-keyword">if</span> typ == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-comment">// é¦–æ¬¡storeæ—¶ä¼šè°ƒç”¨runtime_procPinç¦æ­¢å½“å‰Pè¢«æŠ¢å ï¼Œä¿è¯ä¸€æ¬¡Storeçš„å®Œæ•´æ€§</span><br>            runtime_procPin()<br>            <span class="hljs-comment">// ä½¿ç”¨CASæŠ¢å ä¹è§‚é”ï¼Œå°†typä¿®æ”¹ä¸ºä¸­é—´å€¼ï¼Œè¡¨ç¤ºæ­£åœ¨è¿›è¡Œé¦–æ¬¡å­˜å‚¨ï¼Œå¦‚æœæŠ¢é”å¤±è´¥ï¼Œç›´æ¥è·³å‡ºå¹¶è¿›è¡Œä¸‹ä¸€è½®æ“ä½œ</span><br>            <span class="hljs-keyword">if</span> !CompareAndSwapPointer(&amp;vp.typ, <span class="hljs-literal">nil</span>, unsafe.Pointer(&amp;firstStoreInProgress)) &#123;<br>                runtime_procUnpin()<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            <span class="hljs-comment">// æŠ¢é”æˆåŠŸåï¼Œå­˜å‚¨dataå’Œtyp</span><br>            StorePointer(&amp;vp.data, vlp.data)<br>            StorePointer(&amp;vp.typ, vlp.typ)<br>            runtime_procUnpin()<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœä¸æ˜¯é¦–æ¬¡å­˜å‚¨ï¼Œéœ€è¦çœ‹ä¸‹é¦–æ¬¡å­˜å‚¨æ˜¯ä¸æ˜¯è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå¦‚æœåœ¨è¿›è¡Œä¸­ï¼Œå°±åˆ°ç­‰å¾…é¦–æ¬¡å­˜å‚¨ç»“æŸ</span><br>        <span class="hljs-keyword">if</span> typ == unsafe.Pointer(&amp;firstStoreInProgress) &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœé¦–æ¬¡å­˜å‚¨å·²ç»ç»“æŸï¼Œæ ¡éªŒæ–°å­˜å‚¨çš„æ•°æ®å’Œç¬¬ä¸€æ¬¡çš„ç±»å‹æ˜¯å¦ä¸€è‡´ã€‚</span><br>        <span class="hljs-comment">// å¦‚æœä¸ä¸€è‡´ç›´æ¥æŠ¥é”™ï¼Œå¦‚æœä¸€è‡´åˆ™å®Œæˆæ•°æ®å­˜å‚¨</span><br>        <span class="hljs-keyword">if</span> typ != vlp.typ &#123;<br>            <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;sync/atomic: store of inconsistently typed value into Value&quot;</span>)<br>        &#125;<br>        StorePointer(&amp;vp.data, vlp.data)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¢³ç†ä¸‹æµç¨‹ï¼š<br>1ã€é¦–å…ˆåˆ¤æ–­ç±»å‹å¦‚æœä¸ºnilç›´æ¥panicï¼›<br>2ã€ç„¶åé€šè¿‡æœ‰ä¸ªforå¾ªç¯æ¥è¿ç»­åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œå€¼çš„å†™å…¥ï¼›<br>3ã€å¦‚æœæ˜¯typ &#x3D;&#x3D; nilè¡¨ç¤ºæ˜¯ç¬¬ä¸€æ¬¡å†™å…¥,ç„¶åç»™typeè®¾ç½®ä¸€ä¸ªæ ‡è¯†ä½ï¼Œæ¥è¡¨ç¤ºæœ‰goroutineæ­£åœ¨å†™å…¥ï¼›<br>4ã€ç„¶åå†™å…¥å€¼ï¼Œé€€å‡ºï¼›<br>5ã€å¦‚æœtypeä¸ä¸ºnilï¼Œä½†æ˜¯ç­‰äºæ ‡è¯†ä½ï¼Œè¡¨ç¤ºæœ‰æ­£åœ¨å†™å…¥çš„goroutineï¼Œç„¶åç»§ç»­å¾ªç¯ï¼›<br>6ã€æœ€åtypeä¸ä¸ºnilï¼Œå¹¶ä¸”ä¸ç­‰äºæ ‡è¯†ä½ï¼Œå¹¶ä¸”å’Œvalueé‡Œé¢çš„typeç±»å‹ä¸€æ ·ï¼Œå†™å…¥å†…å®¹ï¼Œç„¶åé€€å‡ºã€‚<br>æ³¨æ„ï¼šå…¶ä¸­ä½¿ç”¨äº†runtime_procPin()æ–¹æ³•ï¼Œå®ƒå¯ä»¥å°†ä¸€ä¸ªgoroutineæ­»æ­»å ç”¨å½“å‰ä½¿ç”¨çš„P(P-M-Gä¸­çš„processor)ï¼Œä¸å…è®¸å…¶å®ƒgoroutine&#x2F;MæŠ¢å ,è¿™æ ·å°±èƒ½ä¿è¯å­˜å‚¨é¡ºåˆ©å®Œæˆï¼Œä¸å¿…æ‹…å¿ƒç«äº‰çš„é—®é¢˜ã€‚é‡Šæ”¾pinçš„æ–¹æ³•æ˜¯runtime_procUnpinã€‚<br><img src="/img/Golang%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-Atomic/2.png">    </p><h4 id="2-3-3-Load"><a href="#2-3-3-Load" class="headerlink" title="2.3.3 Load"></a>2.3.3 Load</h4><p>ç†è§£äº†Storeçš„é€»è¾‘åï¼ŒLoadçš„é€»è¾‘å°±æ¯”è¾ƒç®€å•äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Load è¿”å›æœ€è¿‘ä¸€æ¬¡è®¾ç½®çš„å€¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *Value)</span></span> Load() (val any) &#123;<br>    <span class="hljs-comment">// é¦–å…ˆè·å–vçš„æŒ‡æ ‡å’Œç±»å‹</span><br>    vp := (*efaceWords)(unsafe.Pointer(v))<br>    typ := LoadPointer(&amp;vp.typ)<br>    <span class="hljs-comment">// å¦‚æœç±»å‹ä¸ºç©ºæˆ–è€…æ­£åœ¨è¿›è¡Œé¦–æ¬¡å­˜å‚¨ï¼Œè¯´æ˜æ²¡æœ‰å­˜å‚¨æ•°æ®ï¼Œè¿”å›nil</span><br>    <span class="hljs-keyword">if</span> typ == <span class="hljs-literal">nil</span> || typ == unsafe.Pointer(&amp;firstStoreInProgress) &#123;<br>        <span class="hljs-comment">// First store not yet completed.</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-comment">// è·å–dataï¼Œå¹¶ä¿å­˜</span><br>    data := LoadPointer(&amp;vp.data)<br>    vlp := (*efaceWords)(unsafe.Pointer(&amp;val))<br>    vlp.typ = typ<br>    vlp.data = data<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ğŸ“Œ ä½¿ç”¨Valueç±»å‹æ—¶éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š</p><ul><li>Valueä¸èƒ½ç”¨æ¥å­˜å‚¨nilå€¼ï¼Œå¦åˆ™ä¼španic</li><li>ä¸€ä¸ªValueå˜é‡ä¸èƒ½å­˜å‚¨ä¸åŒç±»å‹çš„å€¼ï¼Œå­˜å‚¨çš„ç±»å‹åªèƒ½æ˜¯ç¬¬ä¸€ä¸ªå­˜å‚¨å€¼çš„ç±»å‹ã€‚å¦åˆ™ä¼španic</li><li>å°½é‡ä¸è¦ä½¿ç”¨Valueå­˜å‚¨å¼•ç”¨ç±»å‹çš„å€¼ã€‚ä¿®æ”¹å¼•ç”¨ç±»å‹çš„å€¼ä¹Ÿä¼šåŒæ­¥ä¿®æ”¹Valueä¸­å­˜å‚¨çš„å€¼</li></ul></blockquote><h2 id="3-ç®€æ˜“åº”ç”¨"><a href="#3-ç®€æ˜“åº”ç”¨" class="headerlink" title="3 ç®€æ˜“åº”ç”¨"></a>3 ç®€æ˜“åº”ç”¨</h2><h3 id="3-1-åŸå­æ€§å¢åŠ å€¼"><a href="#3-1-åŸå­æ€§å¢åŠ å€¼" class="headerlink" title="3.1 åŸå­æ€§å¢åŠ å€¼"></a>3.1 åŸå­æ€§å¢åŠ å€¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> count <span class="hljs-type">int32</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            atomic.AddInt32(&amp;count, <span class="hljs-number">1</span>)            <span class="hljs-comment">// åŸå­æ€§å¢åŠ å€¼</span><br>            fmt.Println(atomic.LoadInt32(&amp;count)) <span class="hljs-comment">// åŸå­æ€§åŠ è½½</span><br><br>            wg.Done()<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>    fmt.Println(<span class="hljs-string">&quot;count: &quot;</span>, count)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-ç®€æ˜“è‡ªæ—‹é”"><a href="#3-2-ç®€æ˜“è‡ªæ—‹é”" class="headerlink" title="3.2 ç®€æ˜“è‡ªæ—‹é”"></a>3.2 ç®€æ˜“è‡ªæ—‹é”</h3><p>å­˜æ»¡10000åå…¨éƒ¨å–å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>    balance <span class="hljs-type">int32</span> = <span class="hljs-number">1000</span><br>    wg      sync.WaitGroup<br>)<br><br><span class="hljs-comment">// å­˜é’±</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deposit</span><span class="hljs-params">(value <span class="hljs-type">int32</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br><br>        fmt.Printf(<span class="hljs-string">&quot;ä½™é¢: %d\n&quot;</span>, balance)<br>        atomic.AddInt32(&amp;balance, value)<br>        fmt.Printf(<span class="hljs-string">&quot;å­˜ %d åçš„ä½™é¢: %d\n&quot;</span>, value, balance)<br>        <span class="hljs-keyword">if</span> balance == <span class="hljs-number">10000</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        time.Sleep(time.Millisecond * <span class="hljs-number">500</span>)<br>    &#125;<br>    wg.Done()<br>&#125;<br><br><span class="hljs-comment">// å–é’±</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">withdrawAll</span><span class="hljs-params">(value <span class="hljs-type">int32</span>)</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done()<br><br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;balance, value, <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        time.Sleep(time.Millisecond * <span class="hljs-number">500</span>)<br>    &#125;<br>    fmt.Printf(<span class="hljs-string">&quot;ä½™é¢: %d\n&quot;</span>, value)<br>    fmt.Printf(<span class="hljs-string">&quot;å– %d åçš„ä½™é¢: %d\n&quot;</span>, value, balance)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    wg.Add(<span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">go</span> deposit(<span class="hljs-number">1000</span>) <span class="hljs-comment">// æ¯æ¬¡å­˜1000</span><br>    <span class="hljs-keyword">go</span> withdrawAll(<span class="hljs-number">10000</span>)<br>    wg.Wait()<br><br>    fmt.Printf(<span class="hljs-string">&quot;å½“å‰ä½™é¢: %d\n&quot;</span>, balance)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-æ— ç¬¦å·æ•´æ•°å‡æ³•æ“ä½œ"><a href="#3-3-æ— ç¬¦å·æ•´æ•°å‡æ³•æ“ä½œ" class="headerlink" title="3.3 æ— ç¬¦å·æ•´æ•°å‡æ³•æ“ä½œ"></a>3.3 æ— ç¬¦å·æ•´æ•°å‡æ³•æ“ä½œ</h3><p>å¯¹äºuint32å’Œuint64ç±»å‹ï¼ŒAddæ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°åªèƒ½æ¥å—ç›¸åº”çš„æ— ç¬¦å·æ•´æ•°ï¼ŒatomicåŒ…æ²¡æœ‰æä¾›å‡æ³•SubstractTæ“ä½œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUint32</span><span class="hljs-params">(addr *<span class="hljs-type">uint32</span>, delta <span class="hljs-type">uint32</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">uint32</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddUint64</span><span class="hljs-params">(addr *<span class="hljs-type">uint64</span>, delta <span class="hljs-type">uint64</span>)</span></span> (<span class="hljs-built_in">new</span> <span class="hljs-type">uint64</span>)<br></code></pre></td></tr></table></figure><p>å¯¹äºæ— ç¬¦å·æ•´æ•°Vï¼Œæˆ‘ä»¬å¯ä»¥ä¼ é€’-Vç»™AddTæ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°å°±å¯ä»¥å®ç°å‡æ³•æ“ä½œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> i <span class="hljs-type">uint64</span> = <span class="hljs-number">100</span><br>    <span class="hljs-keyword">var</span> j <span class="hljs-type">uint64</span> = <span class="hljs-number">10</span><br><br>    <span class="hljs-keyword">var</span> k = <span class="hljs-number">5</span><br>    atomic.AddUint64(&amp;i, -j)<br>    <span class="hljs-built_in">println</span>(i)<br><br>    atomic.AddUint64(&amp;i, -<span class="hljs-type">uint64</span>(k))<br>    <span class="hljs-built_in">println</span>(i)<br><br>    <span class="hljs-comment">// ä¸‹é¢è¿™ç§æ“ä½œæ˜¯ä¸å¯ä»¥çš„ï¼Œä¼šæŠ¥é”™ï¼šconstant -5 overflows uint64</span><br>    <span class="hljs-comment">// atomic.AddUint64(&amp;i, -uint64(5))</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å‚è€ƒèµ„æ–™"><a href="#4-å‚è€ƒèµ„æ–™" class="headerlink" title="4. å‚è€ƒèµ„æ–™"></a>4. å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://juejin.cn/post/7010590496204521485">https://juejin.cn/post/7010590496204521485</a> </li><li><a href="https://golang-notes.readthedocs.io/en/latest/golang/golang-concurrent-synchronization-for-atomic-operation.html">https://golang-notes.readthedocs.io/en/latest/golang/golang-concurrent-synchronization-for-atomic-operation.html</a></li><li><a href="https://juejin.cn/post/6907091130039894023">https://juejin.cn/post/6907091130039894023</a></li><li><a href="https://boilingfrog.github.io/2021/03/04/go%E4%B8%AD%E7%9A%84atomic/">https://boilingfrog.github.io/2021/03/04/go%E4%B8%AD%E7%9A%84atomic/</a></li><li><a href="https://iswxw.blog.csdn.net/article/details/127827602">https://iswxw.blog.csdn.net/article/details/127827602</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>äº’æ–¥é”ä¸åŸå­æ“ä½œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Mutex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang äº’æ–¥é” sync.Mutex</title>
    <link href="/2024/11/08/Golang-Mutex%E8%A7%A3%E6%9E%90/"/>
    <url>/2024/11/08/Golang-Mutex%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>äº’æ–¥é”æ˜¯åœ¨å¹¶å‘ç¨‹åºä¸­å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®æ§åˆ¶çš„ä¸»è¦æ‰‹æ®µï¼Œå¯¹æ­¤ Go è¯­è¨€æä¾›äº†ç®€å•æ˜“ç”¨çš„ Mutexï¼Œå®ƒæ˜¯ä¸€ç§ç”¨äºå¹¶å‘ç¼–ç¨‹ä¸­çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚</p><span id="more"></span>  <h2 id="1-èƒŒæ™¯ä»‹ç»"><a href="#1-èƒŒæ™¯ä»‹ç»" class="headerlink" title="1. èƒŒæ™¯ä»‹ç»"></a>1. èƒŒæ™¯ä»‹ç»</h2><h3 id="1-1-åŸºæœ¬ä¿¡æ¯"><a href="#1-1-åŸºæœ¬ä¿¡æ¯" class="headerlink" title="1.1 åŸºæœ¬ä¿¡æ¯"></a>1.1 åŸºæœ¬ä¿¡æ¯</h3><p>äº’æ–¥é”æ˜¯åœ¨å¹¶å‘ç¨‹åºä¸­å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®æ§åˆ¶çš„ä¸»è¦æ‰‹æ®µï¼Œå¯¹æ­¤ Go è¯­è¨€æä¾›äº†ç®€å•æ˜“ç”¨çš„ Mutexï¼Œå®ƒæ˜¯ä¸€ç§ç”¨äºå¹¶å‘ç¼–ç¨‹ä¸­çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºç¡®ä¿åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚<br><strong>ä¸»è¦ç‰¹ç‚¹</strong>ï¼š</p><ul><li>äº’æ–¥æ€§ï¼šMutexçš„æ ¸å¿ƒç‰¹æ€§æ˜¯äº’æ–¥æ€§ï¼Œå³ä¿è¯åœ¨ä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥æŒæœ‰é”å¹¶è®¿é—®è¢«ä¿æŠ¤çš„å…±äº«èµ„æºã€‚è¿™æœ‰æ•ˆåœ°é˜²æ­¢äº†å¤šä¸ª goroutine åŒæ—¶å¯¹å…±äº«èµ„æºè¿›è¡Œè¯»å†™æ“ä½œè€Œå¯¼è‡´çš„æ•°æ®ç«äº‰å’Œä¸ä¸€è‡´é—®é¢˜ã€‚</li><li>åŸå­æ€§æ“ä½œï¼šåœ¨è·å–å’Œé‡Šæ”¾é”çš„è¿‡ç¨‹ä¸­ï¼ŒMutexçš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚è¿™æ„å‘³ç€åœ¨ä¸€ä¸ª goroutine å°è¯•è·å–é”æ—¶ï¼Œå…¶ä»– goroutine ä¸èƒ½åŒæ—¶è¿›è¡Œè·å–é”çš„æ“ä½œï¼Œç›´åˆ°å½“å‰æŒæœ‰é”çš„ goroutine é‡Šæ”¾é”ã€‚</li><li>ä¸å¯é‡å…¥æ€§ï¼šGoè¯­è¨€çš„Mutexåªè®°å½•äº†åŠ é”çŠ¶æ€ï¼Œæ²¡æœ‰è®°å½•é”çš„æ‰€æœ‰è€…ï¼Œæ‰€ä»¥ä¸æ”¯æŒå¯é‡å…¥ï¼Œè‡ªå·±åŠ çš„é”åˆ«äººä¹Ÿå¯ä»¥æ‰“å¼€</li></ul><h3 id="1-2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Mutex"><a href="#1-2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Mutex" class="headerlink" title="1.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Mutex"></a>1.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Mutex</h3><p>æˆ‘ä»¬çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼Œå¯åŠ¨ 10000 ä¸ªåç¨‹å°†å˜é‡ num åŠ 1ï¼Œå› æ­¤è‚¯å®šä¼šå­˜åœ¨å¹¶å‘ï¼›å¦‚æœæˆ‘ä»¬ä¸æ§åˆ¶å¹¶å‘ï¼Œ10000 ä¸ªåç¨‹éƒ½æ‰§è¡Œå®Œåï¼Œè¯¥å˜é‡çš„å€¼å¾ˆå¤§æ¦‚ç‡ä¸ç­‰äº 10000ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨å¹¶å‘çš„è¯ï¼Œæ€»èƒ½å¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    num := <span class="hljs-number">0</span><br>    threadCount := <span class="hljs-number">10000</span><br><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    wg.Add(threadCount)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; threadCount; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            num++<br>        &#125;()<br>    &#125;<br><br>    wg.Wait()        <span class="hljs-comment">// ç­‰å¾… 10000 ä¸ªåç¨‹éƒ½æ‰§è¡Œå®Œ</span><br>    fmt.Println(num) <span class="hljs-comment">// 9388(æ¯æ¬¡éƒ½å¯èƒ½ä¸ä¸€æ ·)</span><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    num := <span class="hljs-number">0</span><br>    threadCount := <span class="hljs-number">10000</span><br><br>    <span class="hljs-keyword">var</span> mutex sync.Mutex <span class="hljs-comment">// äº’æ–¥é”</span><br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    wg.Add(threadCount)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; threadCount; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            mutex.Lock()   <span class="hljs-comment">// åŠ é”</span><br>            num++          <span class="hljs-comment">// ä¸´ç•ŒåŒº</span><br>            mutex.Unlock() <span class="hljs-comment">// è§£é”</span><br>        &#125;()<br>    &#125;<br><br>    wg.Wait()        <span class="hljs-comment">// ç­‰å¾… 10000 ä¸ªåç¨‹éƒ½æ‰§è¡Œå®Œ</span><br>    fmt.Println(num) <span class="hljs-comment">// ç»“æœä¸º10000</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒMutexå¯ä»¥ä¿è¯å¹¶å‘ç¼–ç¨‹è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸€è‡´æ€§å’Œç¨³å®šæ€§ï¼Œå®ç°å¹¶å‘å®‰å…¨ç¼–ç¨‹ã€‚</p><h3 id="1-3-åŸºæœ¬æ“ä½œ"><a href="#1-3-åŸºæœ¬æ“ä½œ" class="headerlink" title="1.3 åŸºæœ¬æ“ä½œ"></a>1.3 åŸºæœ¬æ“ä½œ</h3><p>Mutex æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå¯¹å¤–æä¾› Lock()å’ŒUnlock()ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ç”¨æ¥åŠ é”å’Œè§£é”ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A Locker represents an object that can be locked and unlocked.</span><br><span class="hljs-keyword">type</span> Locker <span class="hljs-keyword">interface</span> &#123;<br>    Lock()<br>    Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>åŠ é”ï¼ˆLockï¼‰ï¼šå½“ä¸€ä¸ª goroutine éœ€è¦è®¿é—®è¢«äº’æ–¥é”ä¿æŠ¤çš„å…±äº«èµ„æºæ—¶ï¼Œå®ƒé¦–å…ˆéœ€è¦è°ƒç”¨äº’æ–¥é”çš„Lockæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°äº’æ–¥é”è¢«é‡Šæ”¾ï¼Œç„¶åå½“å‰çº¿ç¨‹è·å¾—é”å¹¶å¯ä»¥ç»§ç»­æ‰§è¡Œå¯¹å…±äº«èµ„æºçš„è®¿é—®æ“ä½œã€‚</li><li>è§£é”ï¼ˆUnlockï¼‰ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆå¯¹å…±äº«èµ„æºçš„è®¿é—®åï¼Œå®ƒåº”è¯¥è°ƒç”¨äº’æ–¥é”çš„Unlockæ–¹æ³•æ¥é‡Šæ”¾é”ï¼Œä»¥ä¾¿å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è·å¾—é”å¹¶è®¿é—®å…±äº«èµ„æºã€‚</li></ol><h2 id="2-æ ¸å¿ƒåŸç†"><a href="#2-æ ¸å¿ƒåŸç†" class="headerlink" title="2. æ ¸å¿ƒåŸç†"></a>2. æ ¸å¿ƒåŸç†</h2><h3 id="2-1-æ•°æ®ç»“æ„"><a href="#2-1-æ•°æ®ç»“æ„" class="headerlink" title="2.1 æ•°æ®ç»“æ„"></a>2.1 æ•°æ®ç»“æ„</h3><p>Go è¯­è¨€çš„ sync.Mutexç”±ä¸¤ä¸ªå­—æ®µ state å’Œ sema ç»„æˆã€‚å…¶ä¸­ state è¡¨ç¤ºå½“å‰äº’æ–¥é”çš„çŠ¶æ€ï¼Œè€Œ sema æ˜¯ç”¨äºæ§åˆ¶é”çŠ¶æ€çš„ä¿¡å·é‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Mutex <span class="hljs-keyword">struct</span> &#123;    <br>    state <span class="hljs-type">int32</span>  <span class="hljs-comment">// å¤åˆå­—æ®µï¼Œä¸ä»…èƒ½è¡¨ç¤ºé”çš„çŠ¶æ€ï¼Œè¿˜èƒ½è¡¨ç¤ºç­‰å¾…é”çš„åç¨‹ä¸ªæ•° </span><br>    sema  <span class="hljs-type">uint32</span> <span class="hljs-comment">// ä¿¡å·é‡ï¼Œåç¨‹é˜»å¡ä¼šç­‰å¾…è¯¥ä¿¡å·é‡ï¼Œè§£é”çš„åç¨‹é‡Šæ”¾ä¿¡å·é‡ä»è€Œå”¤é†’ç­‰å¾…ä¿¡å·é‡çš„åç¨‹</span><br>&#125;<br></code></pre></td></tr></table></figure><p>äº’æ–¥é”çš„çŠ¶æ€æ¯”è¾ƒå¤æ‚ï¼Œæœ€ä½ä¸‰ä½åˆ†åˆ«è¡¨ç¤º mutexLockedã€mutexWoken å’Œ mutexStarvingï¼Œå‰©ä¸‹çš„ä½ç½®ç”¨æ¥è¡¨ç¤ºå½“å‰æœ‰å¤šå°‘ä¸ª Goroutine åœ¨ç­‰å¾…äº’æ–¥é”çš„é‡Šæ”¾<br><img src="/img/Golang-Mutex%E8%A7%A3%E6%9E%90/1.png"><br>int32 ä¸­çš„ä¸åŒä½åˆ†åˆ«è¡¨ç¤ºäº†ä¸åŒçš„çŠ¶æ€ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼šäº’æ–¥é”çš„æ‰€æœ‰çŠ¶æ€ä½éƒ½æ˜¯ 0ï¼Œå³é»˜è®¤ä¸ºæœªé”å®šçŠ¶æ€</p><ul><li>mutexLocked â€” è¡¨ç¤ºäº’æ–¥é”çš„é”å®šçŠ¶æ€ï¼›</li><li>mutexWoken â€” è¡¨ç¤ºæ˜¯å¦æœ‰åç¨‹è¢«å”¤é†’ï¼›</li><li>mutexStarving â€” å½“å‰çš„äº’æ–¥é”è¿›å…¥é¥¥é¥¿çŠ¶æ€ï¼›</li><li>waitersCount â€” å½“å‰äº’æ–¥é”ä¸Šç­‰å¾…çš„ Goroutine ä¸ªæ•°<br>ç›¸å…³å¸¸é‡å®šä¹‰ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// sync/mutex.go 36</span><br><span class="hljs-keyword">const</span> (<br>    mutexLocked = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-literal">iota</span> <span class="hljs-comment">// 1 0001 å«ä¹‰ï¼šç”¨æœ€åä¸€ä½è¡¨ç¤ºå½“å‰å¯¹è±¡é”çš„çŠ¶æ€ï¼Œ0-æœªé”ä½ 1-å·²é”ä½</span><br>    mutexWoken <span class="hljs-comment">// 2 0010 å«ä¹‰ï¼šç”¨å€’æ•°ç¬¬äºŒä½è¡¨ç¤ºæ˜¯å¦å·²ç»æœ‰åç¨‹è¢«å”¤é†’ 0-æœªå”¤é†’ 1-å·²æœ‰åç¨‹å”¤é†’</span><br>    mutexStarving <span class="hljs-comment">// 4 0100 å«ä¹‰ï¼šç”¨å€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºå½“å‰Mutexæ˜¯å¦ä¸ºé¥¥é¥¿æ¨¡å¼ï¼Œ0ä¸ºæ­£å¸¸æ¨¡å¼ï¼Œ1ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚</span><br>    mutexWaiterShift = <span class="hljs-literal">iota</span> <span class="hljs-comment">// 3ï¼Œä»å€’æ•°ç¬¬å››ä½å¾€å‰çš„bitä½è¡¨ç¤ºåœ¨æ’é˜Ÿç­‰å¾…çš„goroutineæ•°</span><br>    <br>    starvationThresholdNs = <span class="hljs-number">1e6</span> <span class="hljs-comment">// 1ms åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼çš„é˜ˆå€¼</span><br>)<br></code></pre></td></tr></table></figure></li></ul><h3 id="2-2-Lock"><a href="#2-2-Lock" class="headerlink" title="2.2 Lock"></a>2.2 Lock</h3><p>æœ¬å°èŠ‚ä¸»è¦ä»‹ç»Mutexä¸­åŠ é”çš„åŸºæœ¬é€»è¾‘åŠä¸€äº›æ ¸å¿ƒæ€æƒ³ã€‚</p><h4 id="2-2-1-å¸¸è§„"><a href="#2-2-1-å¸¸è§„" class="headerlink" title="2.2.1 å¸¸è§„"></a>2.2.1 å¸¸è§„</h4><p>Mutexçš„åŠ é”æ“ä½œæ˜¯ä¸€ä¸ªé˜»å¡è°ƒç”¨ï¼Œå¦‚æœåœ¨åŠ é”æ—¶å·²ç»è¢«ä½¿ç”¨ï¼Œåˆ™å½“å‰åç¨‹ä¼šé˜»å¡ç›´è‡³è·å–åˆ°é”ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span></span> Lock() &#123;<br>    <span class="hljs-comment">// Fast path: grab unlocked mutex.</span><br>    <span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="hljs-number">0</span>, mutexLocked) &#123;<br>        <span class="hljs-keyword">if</span> race.Enabled &#123;<br>            race.Acquire(unsafe.Pointer(m))<br>        &#125;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">// Slow path (outlined so that the fast path can be inlined)</span><br>    m.lockSlow()<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªåç¨‹åœ¨åŠ é”æ—¶ï¼Œåˆ†ä¸ºFast pathå’ŒSlow Path, å¦‚æœFast Pathèƒ½åŠ é”æˆåŠŸï¼Œå°±ç›´æ¥è¿”å›äº†ï¼Œå¦åˆ™è¦è¿›å…¥å¤æ‚çš„Slow Pathä¸­ï¼Œè¿™é‡Œä¸è¯¦ç»†ä»‹ç»æ¯ä¸€æ­¥çš„æºç ï¼Œåªåˆ†ææ ¸å¿ƒçš„é€»è¾‘ã€‚</p><ul><li>Fast Pathï¼š<ul><li>å¦‚æœm.stateä¸º0ï¼Œè¯´æ˜å½“å‰é”å¤„äºæœªé”å®šçŠ¶æ€ï¼Œå°è¯•ä½¿ç”¨CASå°†å…¶å˜ä¸ºé”å®šçŠ¶æ€å¹¶ç›´æ¥è¿”å›</li></ul></li><li>Slow Pathï¼š<ul><li>åˆ¤æ–­å½“å‰åç¨‹èƒ½å¦è¿›å…¥è‡ªæ—‹</li><li>é€šè¿‡è‡ªæ—‹ç­‰å¾…äº’æ–¥é”çš„é‡Šæ”¾</li><li>è®¡ç®—äº’æ–¥é”çš„æœ€æ–°çŠ¶æ€ï¼ˆå¤„ç†å®Œè‡ªæ—‹ç‰¹æ®Šé€»è¾‘åï¼Œäº’æ–¥é”ä¼šæ ¹æ®ä¸Šä¸‹æ–‡è®¡ç®—å½“å‰äº’æ–¥é”æœ€æ–°çš„çŠ¶æ€ï¼‰</li><li>æ›´æ–°äº’æ–¥é”çš„çŠ¶æ€å¹¶å°è¯•è·å–é”<ul><li>å¦‚æœè·å–åˆ°é”ç›´æ¥è¿”å›</li><li>å¦‚æœæ²¡æœ‰è·å–åˆ°é”ï¼Œä¼šè°ƒç”¨runtime_SemacquireMutexä½¿åç¨‹é™·å…¥ä¼‘çœ å¹¶ç­‰å¾…è¢«å”¤é†’</li><li>å”¤é†’åå¦‚æœå¤„äºæ­£å¸¸æ¨¡å¼ï¼Œä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯ï¼›</li><li>å”¤é†’åå¦‚æœå¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå½“å‰ Goroutine ä¼šè·å¾—äº’æ–¥é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ Goroutineï¼Œäº’æ–¥é”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡ºï¼›119</li></ul></li></ul></li></ul><h4 id="2-2-2-è‡ªæ—‹"><a href="#2-2-2-è‡ªæ—‹" class="headerlink" title="2.2.2 è‡ªæ—‹"></a>2.2.2 è‡ªæ—‹</h4><p>è‡ªæ—‹å¯¹åº” CPU çš„ PAUSE æŒ‡ä»¤ï¼ŒCPU å¯¹è¯¥æŒ‡ä»¤ä»€ä¹ˆéƒ½ä¸åšï¼Œç›¸å½“äºç©ºè½¬ã€‚å¯¹ç¨‹åºè€Œè¨€ç›¸å½“äºsleepäº†å¾ˆå°ä¸€æ®µæ—¶é—´ï¼Œå¤§æ¦‚ 30ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚  </p><p><strong>è‡ªæ—‹æ¡ä»¶</strong><br>åŠ é”æ—¶runtime ä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å¯ä»¥è‡ªæ—‹ï¼Œæ— é™åˆ¶çš„è‡ªæ—‹å°†ç»™ CPU å¸¦æ¥å·¨å¤§å‹åŠ›ï¼Œè‡ªæ—‹å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>äº’æ–¥é”åªæœ‰åœ¨æ™®é€šæ¨¡å¼æ‰èƒ½è¿›å…¥è‡ªæ—‹ï¼›</li><li>è‡ªæ—‹æ¬¡æ•°è¦è¶³å¤Ÿå°‘ï¼Œé€šå¸¸ä¸º 4ï¼Œå³è‡ªæ—‹æœ€å¤š 4 æ¬¡ï¼›</li><li>CPU æ ¸æ•°è¦å¤§äº 1ï¼Œå¦åˆ™è‡ªæ—‹æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºæ­¤æ—¶ä¸å¯èƒ½æœ‰å…¶ä»–åç¨‹é‡Šæ”¾é”ï¼›</li><li>å½“å‰æœºå™¨ä¸Šè‡³å°‘å­˜åœ¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å¤„ç†å™¨ P å¹¶ä¸”å¤„ç†çš„è¿è¡Œé˜Ÿåˆ—ä¸ºç©ºï¼›<br>å¯è§è‡ªæ—‹çš„æ¡ä»¶æ˜¯å¾ˆè‹›åˆ»çš„ï¼Œç®€å•è¯´å°±æ˜¯ä¸å¿™çš„æ—¶å€™æ‰ä¼šå¯ç”¨è‡ªæ—‹ã€‚</li></ul><p><strong>è‡ªæ—‹ä¼˜åŠ¿</strong><br>è‡ªæ—‹çš„ä¼˜åŠ¿æ˜¯æ›´å……åˆ†åœ°åˆ©ç”¨ CPUï¼Œå°½é‡é¿å…åç¨‹åˆ‡æ¢ã€‚å› ä¸ºå½“å‰ç”³è¯·åŠ é”çš„åç¨‹æ‹¥æœ‰ CPUï¼Œå¦‚æœç»è¿‡çŸ­æ—¶é—´çš„è‡ªæ—‹å¯ä»¥è·å¾—é”ï¼Œåˆ™å½“å‰å†™æˆå¯ä»¥ç»§ç»­è¿è¡Œï¼Œä¸å¿…è¿›å…¥é˜»å¡çŠ¶æ€ã€‚  </p><p><strong>è‡ªæ—‹åŠ£åŠ¿</strong><br>å¦‚æœåœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­è·å¾—é”ï¼Œé‚£ä¹ˆä¹‹å‰è¢«é˜»å¡çš„åç¨‹å°±æ— æ³•è·å¾—ã€‚å¦‚æœåŠ é”çš„åç¨‹ç‰¹åˆ«å¤šï¼Œæ¯æ¬¡éƒ½é€šè¿‡è‡ªæ—‹è·å–é”ï¼Œåˆ™ä¹‹å‰è¢«é˜»å¡çš„åç¨‹å°†å¾ˆéš¾è·å–é”ã€‚</p><h4 id="2-2-3-Mutex-æ¨¡å¼"><a href="#2-2-3-Mutex-æ¨¡å¼" class="headerlink" title="2.2.3 Mutex æ¨¡å¼"></a>2.2.3 Mutex æ¨¡å¼</h4><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œé”é‡Šæ”¾å”¤é†’ç­‰å¾…åç¨‹æ—¶ï¼Œç­‰å¾…åç¨‹ä¼šå’Œæ­¤æ—¶æ–°åˆ°çš„åç¨‹ä»¥åŠå¤„äºè‡ªæ—‹çŠ¶æ€çš„åç¨‹ä¸€èµ·ç«äº‰é”ï¼Œå› ä¸ºéœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ–°å”¤é†’åç¨‹å¤§æ¦‚ç‡äº‰æŠ¢ä¸è¿‡æ–°åç¨‹ä»¥åŠè‡ªæ—‹çš„åç¨‹ï¼Œä¸ºäº†è§£å†³è¿™ç§æƒ…å†µä¸‹é˜»å¡é˜Ÿåˆ—ä¸­åç¨‹ä¸€ç›´è·å–ä¸åˆ°é”çš„é—®é¢˜ï¼ŒMutexå¼•å…¥äº†æ¨¡å¼çš„æ¦‚å¿µï¼Œåˆ†ä¸ºæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ã€‚  </p><p><strong>æ­£å¸¸æ¨¡å¼ Normal</strong>ï¼š<br>æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œé”çš„ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºè·å–é”ã€‚ä½†æ˜¯åˆšè¢«å”¤èµ·çš„åç¨‹ä¸æ–°åˆ›å»ºçš„åç¨‹ç«äº‰æ—¶ï¼Œå¤§æ¦‚ç‡ä¼šè·å–ä¸åˆ°é”ï¼Œä¸ºäº†å‡å°‘è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œä¸€æ—¦ Goroutine è¶…è¿‡ 1ms æ²¡æœ‰è·å–åˆ°é”ï¼Œå®ƒå°±ä¼šå°†å½“å‰äº’æ–¥é”åˆ‡æ¢é¥¥é¥¿æ¨¡å¼ï¼Œé˜²æ­¢éƒ¨åˆ† Goroutine è¢«é¥¿æ­»ã€‚ </p><blockquote><p>ğŸ“Œ å¼•å…¥é¥¥é¥¿æ¨¡å¼çš„ç›®çš„æ˜¯ä¿è¯äº’æ–¥é”çš„å…¬å¹³æ€§ã€‚  </p></blockquote><p><strong>é¥¥é¥¿æ¨¡å¼ Starving</strong>ï¼š<br>é¥¥é¥¿æ¨¡å¼ä¸­ï¼Œäº’æ–¥é”çš„æ‰€æœ‰æƒç›´æ¥ä»è§£é”çš„Goroutineäº¤ç»™ç­‰å¾…é˜Ÿåˆ—æœ€å‰é¢çš„ Goroutineã€‚æ–°çš„ Goroutine åœ¨è¯¥çŠ¶æ€ä¸‹ä¸èƒ½è·å–é”ã€ä¹Ÿä¸ä¼šè¿›å…¥è‡ªæ—‹çŠ¶æ€ï¼Œå®ƒä»¬åªä¼šåœ¨é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…ã€‚å¦‚æœä¸€ä¸ª Goroutine è·å¾—äº†äº’æ–¥é”å¹¶ä¸”å®ƒåœ¨é˜Ÿåˆ—çš„æœ«å°¾æˆ–è€…å®ƒç­‰å¾…çš„æ—¶é—´å°‘äº 1msï¼Œé‚£ä¹ˆå½“å‰çš„äº’æ–¥é”å°±ä¼šåˆ‡æ¢å›æ­£å¸¸æ¨¡å¼ã€‚<br>åœ¨Starvingæ¨¡å¼ä¸‹ï¼Œä¸ä¼šå¯åŠ¨è‡ªæ—‹è¿‡ç¨‹ï¼Œä¸€æ—¦æœ‰åç¨‹é‡Šæ”¾äº†é”ï¼Œä¸€å®šä¼šå”¤é†’åç¨‹ï¼Œè¢«å”¤é†’çš„åç¨‹å°†æˆåŠŸè·å–é”ï¼ŒåŒæ—¶ä¼šæŠŠç­‰å¾…è®¡æ•°å‡ 1ã€‚    </p><blockquote><p>ğŸ“Œ  ä¸é¥¥é¥¿æ¨¡å¼ç›¸æ¯”ï¼Œæ­£å¸¸æ¨¡å¼ä¸‹çš„äº’æ–¥é”èƒ½å¤Ÿæä¾›æ›´å¥½åœ°æ€§èƒ½ï¼Œé¥¥é¥¿æ¨¡å¼çš„èƒ½é¿å… Goroutine ç”±äºé™·å…¥ç­‰å¾…æ— æ³•è·å–é”è€Œé€ æˆçš„é•¿å°¾å»¶æ—¶ã€‚ </p></blockquote><h4 id="2-2-4-Woken-çŠ¶æ€"><a href="#2-2-4-Woken-çŠ¶æ€" class="headerlink" title="2.2.4 Woken çŠ¶æ€"></a>2.2.4 Woken çŠ¶æ€</h4><p>Woken çŠ¶æ€ç”¨äºåŠ é”å’Œè§£é”è¿‡ç¨‹ä¸­çš„é€šä¿¡ã€‚æ¯”å¦‚ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œä¸¤ä¸ªåç¨‹ä¸€ä¸ªåœ¨åŠ é”ï¼Œä¸€ä¸ªåœ¨è§£é”ï¼Œåœ¨åŠ é”çš„åç¨‹å¯èƒ½åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶æŠŠ Woken æ ‡è®°ä¸º 1ï¼Œç”¨äºé€šçŸ¥è§£é”åç¨‹ä¸å¿…é‡Šæ”¾ä¿¡å·é‡ï¼Œç±»ä¼¼çŸ¥ä¼šä¸€ä¸‹å¯¹æ–¹ï¼Œä¸ç”¨é‡Šæ”¾äº†ï¼Œæˆ‘é©¬ä¸Šå°±æ‹¿åˆ°é”äº†ã€‚</p><h3 id="2-3-UnLock"><a href="#2-3-UnLock" class="headerlink" title="2.3 UnLock"></a>2.3 UnLock</h3><p>ç›¸æ¯”äºåŠ é”ï¼Œè§£é”çš„é€»è¾‘ç®€å•è®¸å¤šï¼ŒåŒæ ·åˆ†ä¸ºFast pathå’ŒSlow Path</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span></span> Unlock() &#123;<br>    <span class="hljs-keyword">if</span> race.Enabled &#123;<br>        _ = m.state<br>        race.Release(unsafe.Pointer(m))<br>    &#125;<br><br>    <span class="hljs-comment">// Fast path: drop lock bit.</span><br>    <span class="hljs-built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span> != <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// Outlined slow path to allow inlining the fast path.</span><br>        <span class="hljs-comment">// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.</span><br>        m.unlockSlow(<span class="hljs-built_in">new</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>Fast Pathï¼š<ul><li>ä½¿ç”¨åŸå­æ“ä½œç›´æ¥å°†çŠ¶æ€ç§»é™¤é”æ ‡è®°ï¼Œå¦‚æœæ–°çŠ¶æ€ä¸º0ï¼Œå°±æˆåŠŸé‡Šæ”¾é”ï¼›å½“å‰æ“ä½œä¸‹è¯´æ˜æ²¡æœ‰ç­‰å¾…åç¨‹ä¹Ÿæ²¡æœ‰è¢«å”¤é†’åç¨‹ã€‚å¦åˆ™å°±è¿›å…¥Slow Path</li></ul></li><li>Slow Pathï¼š<ul><li>æ ¡éªŒé”çš„åˆæ³•æ€§ï¼Œé¿å…é”è¢«é‡å¤è§£é”</li><li>æ­£å¸¸æ¨¡å¼ï¼šå¦‚æœäº’æ–¥é”ä¸å­˜åœ¨ç­‰å¾…è€…æˆ–è€…äº’æ–¥é”çš„ mutexLockedã€mutexStarvingã€mutexWoken çŠ¶æ€ä¸æ˜¯å…¨éƒ¨ä¸º 0ï¼Œé‚£ä¹ˆå½“å‰æ–¹æ³•å¯ä»¥ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å”¤é†’å…¶ä»–ç­‰å¾…è€…ï¼›å¦‚æœäº’æ–¥é”å­˜åœ¨ç­‰å¾…è€…ï¼Œä¼šé€šè¿‡runtime_Semreleaseå”¤é†’ç­‰å¾…è€…å¹¶ç§»äº¤é”çš„æ‰€æœ‰æƒï¼›</li><li>é¥¥é¥¿æ¨¡å¼ï¼šç›´æ¥é‡Šæ”¾ä¿¡å·é‡å°†é”äº¤ç»™ä¸‹ä¸€ä¸ªç­‰å¾…è€…</li></ul></li></ul><h2 id="3-åº”ç”¨åœºæ™¯"><a href="#3-åº”ç”¨åœºæ™¯" class="headerlink" title="3. åº”ç”¨åœºæ™¯"></a>3. åº”ç”¨åœºæ™¯</h2><h3 id="3-1-ä¿æŠ¤å…±äº«èµ„æº"><a href="#3-1-ä¿æŠ¤å…±äº«èµ„æº" class="headerlink" title="3.1 ä¿æŠ¤å…±äº«èµ„æº"></a>3.1 ä¿æŠ¤å…±äº«èµ„æº</h3><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¤šä¸ª goroutine å¯èƒ½åŒæ—¶è®¿é—®å’Œä¿®æ”¹åŒä¸€ä¸ªå…±äº«èµ„æºã€‚ä¸ºäº†ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ï¼Œéœ€è¦ä½¿ç”¨äº’æ–¥é”æ¥ä¿æŠ¤å…±äº«èµ„æºã€‚ä¾‹å¦‚ï¼ŒMap å¹¶å‘è¯»å†™æ—¶ä¼šå‡ºç° panicï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Mutex æ¥ä¿æŠ¤ Map é˜²æ­¢å‡ºç° panicã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> SafeMap <span class="hljs-keyword">struct</span> &#123;<br>    m    <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span><br>    lock sync.Mutex<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SafeMap)</span></span> Put(key <span class="hljs-type">string</span>, value <span class="hljs-type">int</span>) &#123;<br>    s.lock.Lock()<br>    s.m[key] = value<br>    s.lock.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *SafeMap)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-type">int</span>, <span class="hljs-type">bool</span>) &#123;<br>    s.lock.Lock()<br>    value, ok := s.m[key]<br>    s.lock.Unlock()<br>    <span class="hljs-keyword">return</span> value, ok<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-åŒæ­¥Goroutine"><a href="#3-2-åŒæ­¥Goroutine" class="headerlink" title="3.2 åŒæ­¥Goroutine"></a>3.2 åŒæ­¥Goroutine</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œéœ€è¦ç¡®ä¿å¤šä¸ª goroutine æŒ‰ç…§ç‰¹å®šçš„é¡ºåºæ‰§è¡Œã€‚å¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥å®ç°è¿™ç§åŒæ­¥ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª goroutine éœ€è¦ç­‰å¾…å¦ä¸€ä¸ª goroutine å®ŒæˆæŸä¸ªä»»åŠ¡åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚å¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥ç¡®ä¿ä¸¤ä¸ª goroutine ä¹‹é—´çš„åŒæ­¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> mutex sync.Mutex<br><span class="hljs-keyword">var</span> done <span class="hljs-type">bool</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker1</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Worker 1 is working...&quot;</span>)<br>    mutex.Lock()<br>    done = <span class="hljs-literal">true</span><br>    mutex.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker2</span><span class="hljs-params">()</span></span> &#123;<br>    mutex.Lock()<br>    <span class="hljs-keyword">for</span> !done &#123;<br>        mutex.Unlock()<br>        mutex.Lock()<br>    &#125;<br>    fmt.Println(<span class="hljs-string">&quot;Worker 2 can start working...&quot;</span>)<br>    mutex.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">go</span> worker1()<br>    <span class="hljs-keyword">go</span> worker2()<br><br>    time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-é¿å…æ•°æ®ç«äº‰"><a href="#3-3-é¿å…æ•°æ®ç«äº‰" class="headerlink" title="3.3 é¿å…æ•°æ®ç«äº‰"></a>3.3 é¿å…æ•°æ®ç«äº‰</h3><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¦‚æœå¤šä¸ª goroutine åŒæ—¶è®¿é—®å’Œä¿®æ”¹åŒä¸€ä¸ªå˜é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚ä½¿ç”¨äº’æ–¥é”å¯ä»¥é¿å…è¿™ç§æ•°æ®ç«äº‰ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª goroutine æ­£åœ¨è¯»å–ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œè€Œå¦ä¸€ä¸ª goroutine æ­£åœ¨ä¿®æ”¹è¿™ä¸ªå˜é‡çš„å€¼ã€‚ä½¿ç”¨äº’æ–¥é”å¯ä»¥ç¡®ä¿åœ¨è¯»å–å’Œä¿®æ”¹æ“ä½œä¹‹é—´ä¸ä¼šè¢«å…¶ä»– goroutine å¹²æ‰°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> data <span class="hljs-type">int</span><br><span class="hljs-keyword">var</span> mutex sync.Mutex<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reader</span><span class="hljs-params">()</span></span> &#123;<br>    mutex.Lock()<br>    fmt.Println(<span class="hljs-string">&quot;Data:&quot;</span>, data)<br>    mutex.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writer</span><span class="hljs-params">()</span></span> &#123;<br>    mutex.Lock()<br>    data++<br>    mutex.Unlock()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            reader()<br>        &#125;()<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            writer()<br>        &#125;()<br>    &#125;<br>    wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-æ³¨æ„äº‹é¡¹"><a href="#4-æ³¨æ„äº‹é¡¹" class="headerlink" title="4. æ³¨æ„äº‹é¡¹"></a>4. æ³¨æ„äº‹é¡¹</h2><p>mutexä½¿ç”¨è¿‡ç¨‹ç®€å•ï¼Œåªæœ‰åŸºæœ¬çš„åŠ é”å’Œè§£é”æ“ä½œï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ol><li>Mutex æ˜¯å¯ä»¥åœ¨ goroutine A ä¸­åŠ é”ï¼Œåœ¨ goroutine B ä¸­è§£é”çš„ï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå°½é‡ä¿è¯åœ¨åŒä¸€ä¸ª goroutine ä¸­åŠ è§£é”ã€‚å¤šæ¬¡åŠ é”è€Œæœªè§£é”å¯èƒ½å¯¼è‡´ç¨‹åºâ€œå¡æ­»â€ï¼ˆä¹Ÿè¢«ç§°ä¸ºæ­»é”ï¼‰ã€‚å°è¯•è§£é”ä¸€ä¸ªæœªåŠ é”çš„äº’æ–¥é”å¯èƒ½å¼•å‘ç¨‹åºå´©æºƒï¼ˆpanicï¼‰ã€‚</li><li>Mutex çš„åŠ é”è§£é”åŸºæœ¬éƒ½æ˜¯æˆå¯¹å‡ºç°ï¼Œä¸ºäº†è§£å†³å¿˜è®°è§£é”ï¼Œå¯ä»¥ä½¿ç”¨ defer è¯­å¥ï¼Œåœ¨åŠ é”åç›´æ¥ defer mutex.Unlock()ï¼›ä½†æ˜¯å¦‚æœå¤„ç†å®Œä¸´ç•ŒåŒºèµ„æºåè¿˜æœ‰å¾ˆå¤šè€—æ—¶æ“ä½œï¼Œä¸ºäº†å°½æ—©é‡Šæ”¾é”ï¼Œä¸å»ºè®®ä½¿ç”¨ deferï¼Œè€Œæ˜¯åœ¨å¤„ç†å®Œä¸´ç•ŒåŒºèµ„æºåå°±è°ƒç”¨ mutex.Unlock() å°½æ—©é‡Šæ”¾é”ã€‚</li><li>Mutex ä¸èƒ½å¤åˆ¶ä½¿ç”¨ï¼›Mutex æ˜¯æœ‰çŠ¶æ€çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯¹ä¸€ä¸ª Mutex åŠ é”åï¼Œå†è¿›è¡Œå¤åˆ¶æ“ä½œï¼Œä¼šæŠŠå½“å‰çš„åŠ é”çŠ¶æ€ä¹Ÿç»™å¤åˆ¶è¿‡å»ï¼ŒåŸºäºåŠ é”çš„ Mutex å†åŠ é”è‚¯å®šä¸ä¼šæˆåŠŸã€‚è¿›è¡Œå¤åˆ¶æ“ä½œå¯èƒ½å¬èµ·æ¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒä½çº§çš„é”™è¯¯ï¼Œä½†æ˜¯æ— æ„é—´å¯èƒ½å°±ä¼šçŠ¯è¿™ç§é”™è¯¯ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> &#123;<br>    mutex sync.Mutex<br>    num   <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddFunc</span><span class="hljs-params">(c Counter)</span></span> &#123;<br>    c.mutex.Lock()<br>    <span class="hljs-keyword">defer</span> c.mutex.Unlock()<br>    c.num++<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> counter Counter<br>    counter.mutex.Lock()<br>    <span class="hljs-keyword">defer</span> counter.mutex.Unlock()<br><br>    counter.num++<br>    <span class="hljs-comment">// Goæ˜¯å€¼ä¼ é€’ï¼Œè¿™é‡Œå¤åˆ¶äº† counter</span><br>    <span class="hljs-comment">// æ­¤æ—¶ counter.mutex æ˜¯åŠ é”çŠ¶æ€ï¼Œåœ¨ SomeFunc æ— æ³•å†æ¬¡åŠ é”ï¼Œå°±ä¼šæ­»é”</span><br>    AddFunc(counter)<br>&#125;<br></code></pre></td></tr></table></figure></li><li>æ³¨æ„é”çš„ç²’åº¦ï¼šé”çš„ç²’åº¦æŒ‡çš„å°±æ˜¯ä¸´ç•ŒåŒºçš„å¤§å°ï¼Œä¸´ç•ŒåŒºçš„ä»£ç éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚å¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¹¶å‘åº¦é™ä½ï¼›å¦‚æœé”çš„ç²’åº¦å¤ªå°ï¼Œå¯èƒ½ä¼šå¢åŠ é”çš„ç®¡ç†å¼€é”€ã€‚åœ¨è®¾è®¡å¹¶å‘ç¨‹åºæ—¶ï¼Œåº”è¯¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©åˆé€‚çš„é”ç²’åº¦ã€‚</li><li>é¿å…æ­»é”ï¼šåœ¨ä½¿ç”¨äº’æ–¥é”æ—¶ï¼Œè¦æ³¨æ„é¿å…æ­»é”çš„å‘ç”Ÿã€‚æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ª goroutine ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´ç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œçš„æƒ…å†µã€‚ä¸ºäº†é¿å…æ­»é”ï¼Œå¯ä»¥æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å–å¤šä¸ªé”ï¼Œæˆ–è€…ä½¿ç”¨è¶…æ—¶æœºåˆ¶æ¥é¿å…æ— é™æœŸåœ°ç­‰å¾…é”ã€‚</li></ol><h2 id="5-æºç åˆ†æ"><a href="#5-æºç åˆ†æ" class="headerlink" title="5. æºç åˆ†æ"></a>5. æºç åˆ†æ</h2><h3 id="5-1-Lock"><a href="#5-1-Lock" class="headerlink" title="5.1 Lock"></a>5.1 Lock</h3><p>Lock()åŠ é”æ–¹æ³•åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ fast pathï¼Œå¯ä»¥ç†è§£ä¸ºå¿«æ·é€šé“ï¼Œå¦‚æœå½“å‰é”æ²¡è¢«å ç”¨ï¼Œç›´æ¥è·å¾—é”è¿”å›ï¼›å¦åˆ™éœ€è¦è¿›å…¥ slow pathã€‚</li><li>slow path åˆ¤æ–­å„ç§æ¡ä»¶å»ç«äº‰é”ï¼Œä¸»è¦é€»è¾‘éƒ½åœ¨æ­¤å¤„ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span></span> lockSlow() &#123;<br>    <span class="hljs-keyword">var</span> waitStartTime <span class="hljs-type">int64</span><br>    starving := <span class="hljs-literal">false</span><br>    awoke := <span class="hljs-literal">false</span><br>    iter := <span class="hljs-number">0</span><br>    old := m.state<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// å½“é”è¢«å ç”¨ä¸”ä¸å¤„äºé¥¥é¥¿çŠ¶æ€ä¸”å¯ä»¥æ‰§è¡Œè‡ªæ—‹æ—¶ï¼Œè¿›å…¥è‡ªæ—‹é€»è¾‘</span><br>        <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;<br>            <span class="hljs-comment">// å¦‚æœå½“å‰awokeræ ‡å¿—ä½ä¸ºfalseï¼Œä¸”ç­‰å¾…è€…ä¸ç­‰äº0ï¼ŒæŠŠè‡ªå·±æ ‡è®°ä¸ºå”¤é†’çš„åç¨‹</span><br>            <span class="hljs-comment">// è¯¥æ ‡è®°å¯ä»¥å‘Šè¯‰Unclockæ“ä½œä¸ç”¨å†å”¤é†’å…¶ä»–åç¨‹äº†(æˆ‘å·²ç»åœ¨ç­‰é”äº†ï¼Œä½ ä»¬ä¸ç”¨é†’äº†)</span><br>            <span class="hljs-keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="hljs-number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="hljs-number">0</span> &amp;&amp;<br>                atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;<br>                awoke = <span class="hljs-literal">true</span><br>            &#125;<br>            runtime_doSpin()<br>            iter++<br>            old = m.state<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜é€€å‡ºäº†è‡ªæ—‹ï¼Œå½“å‰é”å¯èƒ½ æ²¡è¢«å ç”¨ æˆ–è€… é”å¤„äºé¥¥é¥¿çŠ¶æ€ æˆ–è€… è‡ªæ—‹å¤ªå¤šäº†</span><br>        <span class="hljs-comment">// new ä»£è¡¨å½“å‰goroutineåŸºäºå½“å‰çŠ¶æ€æ¥ä¸‹æ¥è¦è®¾ç½®çš„æ–°çŠ¶æ€</span><br>        <span class="hljs-built_in">new</span> := old<br>        <span class="hljs-comment">// åªè¦ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œå°±è¯•å›¾è·å–é”ï¼ˆå¦‚æœæ˜¯é¥¥é¥¿çŠ¶æ€å°±ä¹–ä¹–å»æ’é˜Ÿï¼‰</span><br>        <span class="hljs-keyword">if</span> old&amp;mutexStarving == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-built_in">new</span> |= mutexLocked<br>        &#125;<br>        <span class="hljs-comment">// é”è¢«å ç”¨ æˆ–è€… å¤„äºé¥¥é¥¿çŠ¶æ€ä¸‹ï¼Œæ–°å¢ä¸€ä¸ªç­‰å¾…è€…</span><br>        <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-built_in">new</span> += <span class="hljs-number">1</span> &lt;&lt; mutexWaiterShift<br>        &#125;<br>        <br>        <span class="hljs-comment">// å½“å‰goroutineå·²ç»è¿›è¡Œé¥¥é¥¿çŠ¶æ€äº†ï¼Œä¸”é”è¿˜æ²¡é‡Šæ”¾ï¼Œéœ€è¦æŠŠMutexçš„çŠ¶æ€æ”¹ä¸ºé¥¥é¥¿</span><br>        <span class="hljs-keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-built_in">new</span> |= mutexStarving<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯è¢«å”¤é†’çš„ï¼ŒæŠŠå”¤é†’æ ‡å¿—ç½®0ï¼Œè¡¨ç¤ºå¤–é¢æ²¡æœ‰è¢«å”¤é†’çš„goroutineäº†</span><br>        <span class="hljs-comment">// è¿™æ®µçš„æ“ä½œæ˜¯ä¸ºäº†ä¸‹é¢çš„æŠ¢é”åšå‡†å¤‡ï¼ŒæŠ¢åˆ°å°±è·å–é”ï¼ŒæŠ¢ä¸åˆ°å°±ä¼‘çœ ï¼ŒæŠŠå”¤é†’æ ‡å¿—è®¾ç½®ä¸º0</span><br>        <span class="hljs-keyword">if</span> awoke &#123;<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>&amp;mutexWoken == <span class="hljs-number">0</span> &#123;<br>                throw(<span class="hljs-string">&quot;sync: inconsistent mutex state&quot;</span>)<br>            &#125;<br>            <span class="hljs-built_in">new</span> &amp;^= mutexWoken<br>        &#125;<br>        <span class="hljs-comment">// åˆ©ç”¨CASå°è¯•å°†é”çš„çŠ¶æ€åˆ‡åˆ‡æ¢æˆæ–°çš„ï¼Œå°±æ˜¯ä¸Šé¢çš„ä¸€å¨æ“ä½œ</span><br>        <span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="hljs-built_in">new</span>) &#123;<br>            <span class="hljs-comment">// çŠ¶æ€åˆ‡æ¢æˆåŠŸï¼Œä¸”åœ¨æ”¹çŠ¶æ€å‰ é”æœªè¢«å ç”¨ ä¸” å¤„äºæ­£å¸¸æ¨¡å¼ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºè·å–åˆ°é”äº†</span><br>            <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="hljs-number">0</span> &#123;<br>                <span class="hljs-keyword">break</span> <span class="hljs-comment">// locked the mutex with CAS</span><br>            &#125;<br>            <br>            <span class="hljs-comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜é”æ²¡æ­£å¸¸è·å–åˆ°</span><br>            <span class="hljs-comment">// åˆ¤æ–­ä¹‹å‰æ˜¯å¦ç­‰å¾…è¿‡ï¼Œä¹‹å‰ç­‰å¾…è¿‡çš„ï¼Œå†æ¬¡æ’é˜Ÿè¦æ”¾åœ¨é˜Ÿé¦–</span><br>            queueLifo := waitStartTime != <span class="hljs-number">0</span><br>            <span class="hljs-keyword">if</span> waitStartTime == <span class="hljs-number">0</span> &#123;<br>                waitStartTime = runtime_nanotime()<br>            &#125;<br>            <span class="hljs-comment">// ä¼‘çœ ç­‰å¾…ä¿¡å·é‡ï¼šä¹‹å‰æ’è¿‡é˜Ÿçš„è€äººï¼Œæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—é˜Ÿé¦–ï¼›æ–°äººæ”¾åˆ°é˜Ÿå°¾</span><br>            runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="hljs-number">1</span>)<br>            <br>            <span class="hljs-comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜é”è¢«é‡Šæ”¾ï¼Œå½“å‰åç¨‹è·å–åˆ°ä¿¡å·é‡è¢«å”¤é†’</span><br>            <span class="hljs-comment">// é‡æ–°è®¡ç®—å½“å‰goroutineçš„é¥¥é¥¿çŠ¶æ€</span><br>            starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs<br>            old = m.state<br>            <br>            <span class="hljs-comment">// å¦‚æœ state é¥¥é¥¿æ ‡è®°ä¸º1ï¼Œè¯´æ˜å½“å‰åœ¨é¥¥é¥¿æ¨¡å¼ï¼Œé¥¥é¥¿æ¨¡å¼ä¸‹è¢«å”¤é†’ï¼Œå·²ç»è·å–åˆ°é”äº†ï¼›</span><br>            <span class="hljs-comment">// é¥¥é¥¿çŠ¶æ€ä¸‹ï¼Œé‡Šæ”¾é”æ²¡æœ‰æ›´æ–°ç­‰å¾…è€…æ•°é‡å’Œé¥¥é¥¿æ ‡è®°ï¼Œéœ€è¦è·å¾—é”çš„goroutineå»æ›´æ–°çŠ¶æ€</span><br>            <span class="hljs-keyword">if</span> old&amp;mutexStarving != <span class="hljs-number">0</span> &#123;<br>                <span class="hljs-keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="hljs-number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="hljs-number">0</span> &#123;<br>                    throw(<span class="hljs-string">&quot;sync: inconsistent mutex state&quot;</span>)<br>                &#125;<br>                <span class="hljs-comment">// åŠ é”ï¼Œå‡å»ä¸€ä¸ªç­‰å¾…è€…</span><br>                delta := <span class="hljs-type">int32</span>(mutexLocked - <span class="hljs-number">1</span>&lt;&lt;mutexWaiterShift)<br>                <span class="hljs-keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="hljs-number">1</span> &#123;<br>                    <span class="hljs-comment">// å¦‚æœå½“å‰çš„ goroutine éé¥¥é¥¿ï¼Œæˆ–è€…ç­‰å¾…è€…åªæœ‰ä¸€ä¸ªï¼ˆä¹Ÿå°±æ˜¯åªæœ‰å½“å‰goroutineï¼Œç­‰å¾…é˜Ÿåˆ—ç©ºäº†ï¼‰ï¼Œ</span><br>                    <span class="hljs-comment">// å¯ä»¥å–æ¶ˆé¥¥é¥¿çŠ¶æ€ï¼Œè¿›å…¥æ­£å¸¸çŠ¶æ€</span><br>                    delta -= mutexStarving<br>                &#125;<br>                atomic.AddInt32(&amp;m.state, delta)<br>                <span class="hljs-keyword">break</span><br>            &#125;<br>            <span class="hljs-comment">// éé¥¥é¥¿çŠ¶æ€è¢«å”¤é†’ï¼Œæ ‡è®°ä¸ºawokeï¼Œé‡ç½®è‡ªæ—‹è¿­ä»£æ¬¡æ•°ï¼Œç»§ç»­å»è¿›è¡Œä¸‹ä¸€è½®çš„æŠ¢é”</span><br>            awoke = <span class="hljs-literal">true</span><br>            iter = <span class="hljs-number">0</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            old = m.state<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> race.Enabled &#123;<br>        race.Acquire(unsafe.Pointer(m))<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>Mutexæœ¬èº«æ˜¯å¤šä¸ªgoåç¨‹çš„å…±äº«å˜é‡ï¼Œä¸åŒçš„goåç¨‹åŒæ—¶æ‰§è¡Œè¯¥å‡½æ•°ï¼Œå‡½æ•°å†…ä¸´æ—¶å˜é‡æ˜¯goåç¨‹è‡ªå·±çš„çŠ¶æ€ã€‚æ¯æ¬¡æ‰§è¡Œå› ä¸ºçŠ¶æ€ä¸åŒå¤„åœ¨å‡½æ•°æ‰§è¡Œçš„ä¸åŒé˜¶æ®µï¼Œç›´åˆ°mutexçŠ¶æ€æ”¹å˜ã€‚</li></ol><h3 id="5-2-UnLock"><a href="#5-2-UnLock" class="headerlink" title="5.2 UnLock"></a>5.2 UnLock</h3><p>Unlock()è§£é”æ–¹æ³•ä¹Ÿåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ fast pathï¼Œå¯ä»¥ç†è§£ä¸ºå¿«æ·é€šé“ï¼Œç›´æ¥æŠŠé”çŠ¶æ€ä½æ¸…é™¤ï¼Œå¦‚æœæ­¤æ—¶ç³»ç»ŸçŠ¶æ€æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œè¯´æ˜æ²¡æœ‰ goroutine åœ¨æŠ¢é”ç­‰é”ï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥ slow pathï¼›</li><li>slow path ä¼šæ ¹æ®æ˜¯å¦ä¸ºé¥¥é¥¿çŠ¶æ€ï¼Œåšå‡ºä¸ä¸€æ ·çš„ååº”ï¼š<ol><li>æ­£å¸¸çŠ¶æ€ï¼šå”¤é†’ä¸€ä¸ª goroutine å»æŠ¢é”ï¼Œç­‰å¾…è€…æ•°é‡å‡ä¸€ï¼Œå¹¶å°†å”¤é†’çŠ¶æ€ç½®ä¸º 1ï¼›</li><li>é¥¥é¥¿çŠ¶æ€ï¼šç›´æ¥å”¤é†’ç­‰å¾…é˜Ÿåˆ—é˜Ÿé¦–çš„ goroutineï¼Œé”çš„æ‰€æœ‰æƒç›´æ¥ç§»äº¤ï¼ˆä¿®æ”¹ç­‰å¾…è€…æ•°é‡ã€æ˜¯å¦å–æ¶ˆé¥¥é¥¿æ ‡è®°ï¼Œç”±å”¤é†’çš„ goroutine å»å¤„ç†ï¼‰ã€‚</li></ol></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mutex)</span></span> unlockSlow(<span class="hljs-built_in">new</span> <span class="hljs-type">int32</span>) &#123;<br>    <span class="hljs-comment">// æ ¡éªŒæ˜¯å¦å¯¹å·²è§£é”çš„mutexå†æ¬¡è§£é”</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="hljs-number">0</span> &#123;<br>        fatal(<span class="hljs-string">&quot;sync: unlock of unlocked mutex&quot;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">// æ­£å¸¸æ¨¡å¼ï¼Œéé¥¥é¥¿</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">new</span>&amp;mutexStarving == <span class="hljs-number">0</span> &#123;<br>        old := <span class="hljs-built_in">new</span><br>        <span class="hljs-keyword">for</span> &#123;<br>            <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ç­‰å¾…è€…ï¼Œæˆ–è€…å·²ç»å­˜åœ¨è¢«å”¤é†’çš„åç¨‹ï¼Œæˆ–è€…å·²ç»æœ‰åç¨‹è·å¾—äº†é”ï¼Œæ— éœ€å”¤é†’åç¨‹ï¼Œç›´æ¥äº¤æ¥è¿”å›å³å¯</span><br>            <span class="hljs-keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="hljs-number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="hljs-number">0</span> &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            <span class="hljs-comment">// å‡å»ä¸€ä¸ªç­‰å¾…è€…ï¼Œå¹¶ä¸”å°† å”¤é†’æ ‡è®° ç½®ä¸º 1</span><br>            <span class="hljs-built_in">new</span> = (old - <span class="hljs-number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken<br>            <span class="hljs-keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="hljs-built_in">new</span>) &#123;<br>                runtime_Semrelease(&amp;m.sema, <span class="hljs-literal">false</span>, <span class="hljs-number">1</span>)<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            old = m.state<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œç›´æ¥é‡Šæ”¾ä¿¡å·é‡ï¼Œå°†é”çš„æ‰€æœ‰æƒï¼Œäº¤ç»™ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªç­‰å¾…è€…</span><br>        runtime_Semrelease(&amp;m.sema, <span class="hljs-literal">true</span>, <span class="hljs-number">1</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-å‚è€ƒèµ„æ–™"><a href="#6-å‚è€ƒèµ„æ–™" class="headerlink" title="6. å‚è€ƒèµ„æ–™"></a>6. å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://juejin.cn/post/7146236976399089700">åˆè§ Go Mutex</a></li><li><a href="https://juejin.cn/post/7086756462059323429">Golang Mutex åŸç†è§£æ</a></li><li><a href="https://www.lixueduan.com/posts/go/sync-mutex/">Goè¯­è¨€ä¹‹sync.Mutex æºç åˆ†æ</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>äº’æ–¥é”ä¸åŸå­æ“ä½œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Mutex</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangå¹¶å‘èµ‹å€¼çš„å®‰å…¨æ€§åˆ†æ</title>
    <link href="/2024/09/21/golang%E5%B9%B6%E5%8F%91%E8%B5%8B%E5%80%BC%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E8%AE%A8%E8%AE%BA/"/>
    <url>/2024/09/21/golang%E5%B9%B6%E5%8F%91%E8%B5%8B%E5%80%BC%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E8%AE%A8%E8%AE%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>å£°æ˜ï¼šæœ¬æ–‡éåŸåˆ›ï¼Œä¸»è¦å‚è€ƒæ‹å–µå¤§é²¤é±¼çš„åšå®¢ï¼š<a href="https://blog.csdn.net/K346K346/article/details/115099353">https://blog.csdn.net/K346K346/article/details/115099353</a> ï¼Œç¨å¾®åšäº›ä¿®æ”¹ã€‚</p></blockquote><span id="more"></span>  <h2 id="1-ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨"><a href="#1-ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨" class="headerlink" title="1. ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨"></a>1. ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨</h2><p>å¹¶å‘å®‰å…¨å°±æ˜¯ç¨‹åºåœ¨å¹¶å‘æƒ…å†µä¸‹æ‰§è¡Œçš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚<br>æ¯”å¦‚å¯¹ä¸€ä¸ªå˜é‡ç®€å•çš„è‡ªå¢æ“ä½œcount++ï¼Œåœ¨éå¹¶å‘ä¸‹å¾ˆå¥½ç†è§£ï¼Œè€Œåœ¨å¹¶å‘æƒ…å†µä¸‹å´å®¹æ˜“å‡ºç°é¢„æœŸä¹‹å¤–çš„ç»“æœï¼Œè¿™æ ·çš„ä»£ç å°±æ˜¯éå¹¶å‘å®‰å…¨çš„ã€‚<br>å› ä¸ºcount++å…¶å®æ˜¯åˆ†æˆä¸¤æ­¥æ‰§è¡Œçš„ï¼Œå½“åˆ†æˆäº†ä¸¤æ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆåœ¨å¹¶å‘æ—¶å¤šåç¨‹å°±å¯ä»¥è¶ç€è¿™ä¸ªæ—¶é—´é—´éš™ä½œæ€ªã€‚<br>æ¯”å¦‚aã€bä¸¤ä¸ªåç¨‹åŒæ—¶æ‰§è¡Œæ‰§è¡Œcount++ï¼Œæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥è¿”å›3ï¼Œä½†å®é™…è¿”å›äº†2</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">count:= <span class="hljs-number">1</span><br>a &gt; è¯»å–count : <span class="hljs-number">1</span><br>b &gt; è¯»å–count : <span class="hljs-number">1</span><br>a &gt; è®¡ç®—count+<span class="hljs-number">1</span> : <span class="hljs-number">2</span><br>b &gt; è®¡ç®—count+<span class="hljs-number">1</span> : <span class="hljs-number">2</span><br>a &gt; èµ‹å€¼count : <span class="hljs-number">2</span><br>b &gt; èµ‹å€¼count : <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h2 id="2-Structå¹¶å‘å®‰å…¨å—"><a href="#2-Structå¹¶å‘å®‰å…¨å—" class="headerlink" title="2. Structå¹¶å‘å®‰å…¨å—"></a>2. Structå¹¶å‘å®‰å…¨å—</h2><p>ğŸ’¡ ç»“è®ºï¼š  </p><p><strong>å¤šå­—æ®µç»“æ„ä½“å¹¶å‘èµ‹å€¼ä¸å®‰å…¨ï¼Œä½†æ˜¯å•å­—æ®µç»“æ„ä½“å¹¶å‘èµ‹å€¼æ˜¯å®‰å…¨çš„ã€‚</strong></p><h3 id="2-1-ç°è±¡"><a href="#2-1-ç°è±¡" class="headerlink" title="2.1 ç°è±¡"></a>2.1 ç°è±¡</h3><p>å¯¹ç®€å•çš„ä¸€ä¸ªå˜é‡è¿›è¡Œè‡ªå¢éƒ½ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œé‚£å¯¹ä¸€ä¸ªç»“æ„ä½“èµ‹å€¼ä¼šä¸ä¼šå‡ºç°é—®é¢˜å‘¢ã€‚åŸºäºæ­¤ï¼Œè®¾è®¡ä¸€ä¸ªä¸¤ä¸ªå­—æ®µçš„ç»“æ„ä½“ï¼Œé«˜é¢‘çš„è¿›è¡Œå¹¶å‘èµ‹å€¼å¹¶è§‚å¯Ÿç»“æœã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Test <span class="hljs-keyword">struct</span> &#123;<br>X <span class="hljs-type">int</span><br>Y <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> g Test<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = Test&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;<br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = Test&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;<br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> !((g.X == <span class="hljs-number">1</span> &amp;&amp; g.Y == <span class="hljs-number">2</span>) || (g.X == <span class="hljs-number">3</span> &amp;&amp; g.Y == <span class="hljs-number">4</span>)) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%+v\n&quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæ­¤æ®µä»£ç ï¼Œå‘ç°å¶å°”å‡ºç°ä»¥ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">concurrent assignment <span class="hljs-type">error</span>, i=<span class="hljs-number">199242</span> g=&#123;X:<span class="hljs-number">1</span> Y:<span class="hljs-number">4</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-åˆ†æ"><a href="#2-2-åˆ†æ" class="headerlink" title="2.2 åˆ†æ"></a>2.2 åˆ†æ</h3><p>å¯¹å«æœ‰å¤šä¸ªå­—æ®µçš„ç»“æ„ä½“è¿›è¡Œå¹¶å‘èµ‹å€¼æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®é”™ä¹±çš„é—®é¢˜ï¼šåç¨‹1èµ‹å€¼äº†Xå­—æ®µï¼Œè€Œåç¨‹2èµ‹å€¼äº†Yå­—æ®µã€‚<br>åŸå› ï¼šstructè¿›è¡Œå­—æ®µèµ‹å€¼æ—¶å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œå„ä¸ªå­—æ®µçš„èµ‹å€¼æ“ä½œæ˜¯ç‹¬ç«‹è¿›è¡Œçš„ï¼Œåœ¨å¹¶å‘çš„æƒ…å†µä¸‹ä¼šå‡ºç°å¼‚å¸¸ã€‚</p><p>æ‰©å±•ï¼šå¦‚æœä¸€ä¸ªstructåªæœ‰ä¸€ä¸ªå­—æ®µï¼Œé‚£å¹¶å‘èµ‹å€¼æ—¶å°±æ˜¯å®‰å…¨çš„ã€‚</p><h2 id="3-å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨"><a href="#3-å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨" class="headerlink" title="3. å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨"></a>3. å¦‚ä½•ä¿è¯å¹¶å‘å®‰å…¨</h2><p>Golangæä¾›ä¸€ä¸ªåŸå­ç±»å‹çš„atomic.Valueæ¥ä¿è¯å¹¶å‘èµ‹å€¼å®‰å…¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A Value provides an atomic load and store of a consistently typed value.</span><br><span class="hljs-comment">// The zero value for a Value returns nil from Load.</span><br><span class="hljs-comment">// Once Store has been called, a Value must not be copied.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// A Value must not be copied after first use.</span><br><span class="hljs-keyword">type</span> Value <span class="hljs-keyword">struct</span> &#123;<br>v <span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ ·ä¾‹ï¼šé€šè¿‡Loadå’ŒStoreæ–¹æ³•è¿›è¡Œæ•°æ®è¯»å–å’Œå­˜å‚¨ï¼Œä¿è¯å¹¶å‘èµ‹å€¼å®‰å…¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> v atomic.Value<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>v.Store(Test&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>&#125;)<br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>v.Store(Test&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;)<br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br>g := v.Load().(Test)<br><span class="hljs-keyword">if</span> (g.X == <span class="hljs-number">1</span> &amp;&amp; g.Y == <span class="hljs-number">2</span>) || (g.X == <span class="hljs-number">3</span> &amp;&amp; g.Y == <span class="hljs-number">4</span>) &#123;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%+v&quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-æ•°æ®ç±»å‹åˆ†æ"><a href="#4-æ•°æ®ç±»å‹åˆ†æ" class="headerlink" title="4. æ•°æ®ç±»å‹åˆ†æ"></a>4. æ•°æ®ç±»å‹åˆ†æ</h2><h3 id="4-1-åŸºæœ¬æ•°æ®ç±»å‹"><a href="#4-1-åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="4.1 åŸºæœ¬æ•°æ®ç±»å‹"></a>4.1 åŸºæœ¬æ•°æ®ç±»å‹</h3><p>ğŸ’¡ ç»“è®ºï¼š</p><ul><li>å­—èŠ‚å‹ã€å¸ƒå°”å‹ã€æ•´å½¢ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹ï¼šå¹¶å‘å®‰å…¨</li><li>å¤æ•°å‹ï¼šä¸å®‰å…¨</li><li>å­—ç¬¦ä¸²ï¼šä¸å®‰å…¨</li><li>åº•å±‚ç»“æ„ä¸ºstructç±»å‹çš„æ•°æ®ï¼Œä¸€èˆ¬å¹¶å‘èµ‹å€¼æ—¶éƒ½ä¸å®‰å…¨ï¼›ä½†ä¸å®‰å…¨ä¸ä»£è¡¨ä¸€å®šä¼šå‘ç”Ÿé”™è¯¯ï¼›</li></ul><h4 id="4-1-1-å­—èŠ‚å‹ã€å¸ƒå°”å‹ã€æ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹"><a href="#4-1-1-å­—èŠ‚å‹ã€å¸ƒå°”å‹ã€æ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹" class="headerlink" title="4.1.1 å­—èŠ‚å‹ã€å¸ƒå°”å‹ã€æ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹"></a>4.1.1 å­—èŠ‚å‹ã€å¸ƒå°”å‹ã€æ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹</h4><p>ç”±äºå­—èŠ‚å‹ã€å¸ƒå°”å‹ã€æ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹çš„ä½å®½ä¸ä¼šè¶…è¿‡ 64 ä½ï¼Œåœ¨ 64 ä½çš„æŒ‡ä»¤é›†æ¶æ„ä¸­å¯ä»¥ç”±ä¸€æ¡æœºå™¨æŒ‡ä»¤å®Œæˆï¼Œä¸å­˜åœ¨è¢«ç»†åˆ†ä¸ºæ›´å°çš„æ“ä½œå•ä½ï¼Œæ‰€ä»¥è¿™äº›ç±»å‹çš„å¹¶å‘èµ‹å€¼æ˜¯å®‰å…¨çš„ã€‚<br>ä»¥æµ®ç‚¹å‹ä¸ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> g <span class="hljs-type">float64</span><br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-number">1.1</span><br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-number">2.2</span><br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> g != <span class="hljs-number">1.1</span> &amp;&amp; g != <span class="hljs-number">2.2</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%+v&quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-1-2-å¤æ•°å‹"><a href="#4-1-2-å¤æ•°å‹" class="headerlink" title="4.1.2 å¤æ•°å‹"></a>4.1.2 å¤æ•°å‹</h4><p>å¤æ•°å‹åˆ†ä¸ºå®éƒ¨å’Œè™šéƒ¨ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒäºŒè€…çš„èµ‹å€¼æ˜¯åˆ†å¼€çš„ï¼ŒæŒ‰ç…§ä¸Šé¢çš„åˆ†æè¯´æ˜å¹¶å‘èµ‹å€¼éå®‰å…¨çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> g <span class="hljs-type">complex64</span><br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-built_in">complex</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-built_in">complex</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)<br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> g != <span class="hljs-built_in">complex</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) &amp;&amp; g != <span class="hljs-built_in">complex</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%+v \n&quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¶å°”ä¼šå¾—åˆ°å¦‚ä¸‹çš„æ•ˆæœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">concurrent assignment <span class="hljs-type">error</span>, i=<span class="hljs-number">466735</span> g=(<span class="hljs-number">1</span>+<span class="hljs-number">4i</span>)<br></code></pre></td></tr></table></figure><h4 id="4-1-3-å­—ç¬¦ä¸²"><a href="#4-1-3-å­—ç¬¦ä¸²" class="headerlink" title="4.1.3 å­—ç¬¦ä¸²"></a>4.1.3 å­—ç¬¦ä¸²</h4><p>åœ¨Goä¸­ï¼Œstringæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåªè¯»çš„å­—èŠ‚æ•°ç»„åˆ‡ç‰‡ï¼Œä»–æœ‰å‡ ä¸ªé‡è¦ç‰¹ç‚¹ï¼š</p><ul><li><p>stringå¯ä»¥ä¸ºç©ºï¼Œé•¿åº¦ä¸º0ä½†ä¸æ˜¯nilï¼Œè€Œæ˜¯â€â€</p></li><li><p>stringå¯¹è±¡ä¸å¯ä¿®æ”¹ï¼Œæ— æ³•é€šè¿‡ç´¢å¼•ç›´æ¥ä¿®æ”¹å­—ç¬¦ä¸²å†…å®¹ï¼Œéœ€è¦ä¿®æ”¹æ—¶å¯ä»¥é€šè¿‡[]byteæ•°ç»„è½¬æ¢ç­‰æ–¹å¼å®ç°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè¦ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚<br>åœ¨æºç åŒ…src&#x2F;runtime&#x2F;string.goæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° string çš„åº•å±‚æ•°æ®ç»“æ„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> stringStruct <span class="hljs-keyword">struct</span> &#123;<br>str unsafe.Pointer <span class="hljs-comment">// strä¸ºå­—ç¬¦ä¸²é¦–åœ°å€ </span><br><span class="hljs-built_in">len</span> <span class="hljs-type">int</span>            <span class="hljs-comment">// lenä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºstringçš„åº•å±‚ç»“æ„æ—¶ä¸€ä¸ªå¤šå­—æ®µçš„structï¼Œæ‰€ä»¥å¹¶å‘èµ‹å€¼æ˜¯ä¸å®‰å…¨çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> s <span class="hljs-type">string</span><br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>s = <span class="hljs-string">&quot;ab&quot;</span><br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>s = <span class="hljs-string">&quot;cde&quot;</span><br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> s != <span class="hljs-string">&quot;ab&quot;</span> &amp;&amp; s != <span class="hljs-string">&quot;cde&quot;</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v s=%v\n&quot;</span>, i, s)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¶ç°å¦‚ä¸‹ç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">concurrent assignment <span class="hljs-type">error</span>, i=<span class="hljs-number">348275</span> s=cd<br></code></pre></td></tr></table></figure><p>ğŸ“Œ æ³¨æ„ï¼š</p></li><li><p>åº•å±‚ç»“æ„æ˜¯structçš„ç±»å‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å¹¶å‘èµ‹å€¼éƒ½æ˜¯ä¸å®‰å…¨çš„</p></li><li><p>å¹¶å‘èµ‹å€¼ä¸å®‰å…¨ä¸ä»£è¡¨ä¸€å®šä¼šå‡ºé”™ï¼Œåªæ˜¯æœ‰å¯èƒ½å‡ºé”™ï¼›æ¯”å¦‚ä¸Šé¢çš„stringèµ‹å€¼ä¸­ï¼Œå¦‚æœå¹¶å‘èµ‹ä¸¤ä¸ªåºŠåº¦ç›¸åŒçš„å˜é‡ï¼Œå¯ä»¥ç­‰åŒé€€åŒ–ä¸ºåªæœ‰ä¸€ä¸ªå­—æ®µçš„ç»“æ„ä½“ï¼Œå˜æˆå¹¶å‘å®‰å…¨çš„åœºæ™¯ã€‚</p></li></ul><h3 id="4-2-å¤åˆæ•°æ®ç±»å‹"><a href="#4-2-å¤åˆæ•°æ®ç±»å‹" class="headerlink" title="4.2 å¤åˆæ•°æ®ç±»å‹"></a>4.2 å¤åˆæ•°æ®ç±»å‹</h3><p>ğŸ’¡ ç»“è®ºï¼š</p><ul><li>æŒ‡é’ˆï¼šå®‰å…¨</li><li>å‡½æ•°ï¼šå®‰å…¨</li><li>æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£ï¼šä¸å®‰å…¨</li><li>åº•å±‚ç»“æ„ä¸ºstructç±»å‹çš„æ•°æ®ï¼Œä¸€èˆ¬å¹¶å‘èµ‹å€¼æ—¶éƒ½ä¸å®‰å…¨ï¼›ä½†ä¸å®‰å…¨ä¸ä»£è¡¨ä¸€å®šä¼šå‘ç”Ÿé”™è¯¯ï¼›</li></ul><h4 id="4-2-1-æŒ‡é’ˆ"><a href="#4-2-1-æŒ‡é’ˆ" class="headerlink" title="4.2.1 æŒ‡é’ˆ"></a>4.2.1 æŒ‡é’ˆ</h4><p>æŒ‡é’ˆæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒä¿å­˜çš„æ˜¯å¦ä¸€ä¸ªå˜é‡çš„å†…å­˜åœ°å€ã€‚æŒ‡é’ˆçš„é›¶å€¼ä¸ºnilã€‚</p><p>å› ä¸ºæŒ‡é’ˆå­˜å‚¨çš„æ˜¯å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ä½å®½ä¸º 32ä½ï¼ˆx86å¹³å°ï¼‰æˆ– 64ä½ï¼ˆx64å¹³å°ï¼‰ï¼Œèµ‹å€¼æ“ä½œç”±ä¸€ä¸ªæœºå™¨æŒ‡ä»¤å³å¯å®Œæˆï¼Œä¸ä¼šè¢«ä¸­æ–­ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šå‡ºç°å¹¶å‘èµ‹å€¼ä¸å®‰å…¨çš„æƒ…å†µã€‚<br>è¿™åœ¨ä¸Šé¢è®¨è®º string ç­‰é•¿ä¸åŒå€¼å¹¶å‘èµ‹å€¼æ—¶ï¼Œå·²ç»éªŒè¯æ²¡æœ‰é—®é¢˜ã€‚</p><h4 id="4-2-2-å‡½æ•°"><a href="#4-2-2-å‡½æ•°" class="headerlink" title="4.2.2 å‡½æ•°"></a>4.2.2 å‡½æ•°</h4><p>Goä¸­ï¼Œå‡½æ•°å¯ä»¥åƒå€¼ä¸€æ ·è¿›è¡Œä¼ é€’ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥å®šä¹‰å‡½æ•°ç±»å‹ã€‚<br>å¸¸è§„çš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">some_func_name</span><span class="hljs-params">(arguments)</span></span> return_values<br></code></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªå‡½æ•°ç±»å‹æ—¶ï¼Œå»æ‰å‡½æ•°åå³å¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(arguments)</span></span> return_values<br></code></pre></td></tr></table></figure><p>å¯¹å‡½æ•°ç±»å‹è¿›è¡Œèµ‹å€¼æ—¶ï¼Œå®é™…èµ‹çš„æ˜¯å‡½æ•°åœ°å€ï¼Œä¸€æ¡æœºå™¨æŒ‡ä»¤å³å¯å®Œæˆï¼Œæ‰€ä»¥å¹¶å‘èµ‹å€¼æ˜¯å®‰å…¨çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> g MyFunc<br><br><span class="hljs-keyword">var</span> i <span class="hljs-type">int</span><br><span class="hljs-keyword">for</span> ; i &lt; <span class="hljs-number">10000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> x + y<br>&#125;<br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> x - y<br>&#125;<br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> !(g(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) == <span class="hljs-number">2</span> || g(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%+v&quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> i == <span class="hljs-number">10000000</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;no error&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨unsafe.Sizeof()å¯ä»¥æŸ¥çœ‹å‡½æ•°ç±»å‹çš„å®½åº¦ï¼ˆå­—èŠ‚ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Add <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span><br><span class="hljs-keyword">var</span> add Add<br>fmt.Println(unsafe.Sizeof(add)) <br><span class="hljs-comment">// è¾“å‡º 8</span><br></code></pre></td></tr></table></figure><h4 id="4-2-3-æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£"><a href="#4-2-3-æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£" class="headerlink" title="4.2.3 æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£"></a>4.2.3 æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£</h4><p>æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£ï¼Œè¿™äº›å¤åˆç±»å‹ï¼Œé™¤äº†æ•°ç»„ï¼Œå…¶ä»–åº•å±‚æ•°æ®ç»“æ„éƒ½æ˜¯ structï¼Œæ‰€ä»¥å¹¶å‘éƒ½ä¸æ˜¯å®‰å…¨çš„ï¼Œå½“ç„¶æ•°ç»„å¹¶å‘èµ‹å€¼ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚</p><ul><li>æ•°ç»„<br>æ•°ç»„æ˜¯ç›¸åŒç±»å‹å€¼çš„é›†åˆï¼Œæ•°ç»„çš„é•¿åº¦æ˜¯å…¶ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚æ•°ç»„èµ‹å€¼å’Œä¼ å‚éƒ½ä¼šæ‹·è´æ•´ä¸ªæ•°ç»„çš„æ•°æ®ï¼Œæ‰€ä»¥æ•°ç»„ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼›<br>æ•°ç»„çš„åº•å±‚æ•°æ®ç»“æ„å°±æ˜¯å…¶æœ¬èº«ï¼Œæ˜¯ä¸€ä¸ªç›¸åŒç±»å‹ä¸åŒå€¼çš„é¡ºåºæ’åˆ—ã€‚æ‰€ä»¥å¦‚æœæ•°ç»„ä½å®½ä¸å¤§äº 64 ä½ä¸”æ˜¯ 2 çš„æ•´æ•°æ¬¡å¹‚ï¼ˆ8ï¼Œ16ï¼Œ32ï¼Œ64ï¼‰ï¼Œé‚£ä¹ˆå…¶å¹¶å‘èµ‹å€¼æ˜¯å®‰å…¨çš„ï¼Œåªä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µå¹¶éå¦‚æ­¤ï¼Œæ‰€ä»¥å…¶å¹¶å‘èµ‹å€¼æ˜¯ä¸å®‰å…¨çš„ã€‚<br>ä»¥å­—èŠ‚æ•°ç»„ä¸ºä¾‹ï¼Œå½“ä½å®½ä¸è¶…è¿‡64æ—¶ï¼šå¹¶å‘èµ‹å€¼å®‰å…¨<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> g [<span class="hljs-number">4</span>]<span class="hljs-type">byte</span><br><br><span class="hljs-keyword">var</span> i <span class="hljs-type">int</span><br><span class="hljs-keyword">for</span> ; i &lt; <span class="hljs-number">10000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = [...]<span class="hljs-type">byte</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125;<br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = [...]<span class="hljs-type">byte</span>&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;<br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br><span class="hljs-keyword">if</span> !(g == [...]<span class="hljs-type">byte</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>&#125; || g == [...]<span class="hljs-type">byte</span>&#123;<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%+v&quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> i == <span class="hljs-number">10000000</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;no error&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>å¯ä»¥çœ‹åˆ°ï¼Œä½å®½ä¸º 32 ä½çš„æ•°ç»„ [4]byteï¼Œè™½ç„¶æœ‰å››ä¸ªå…ƒç´ ä½†æ˜¯èµ‹å€¼æ—¶ç”±ä¸€æ¡æœºå™¨æŒ‡ä»¤å®Œæˆï¼Œæ‰€ä»¥ä¹Ÿæ˜¯åŸå­æ“ä½œã€‚</li></ul><p>å¦‚æœæŠŠå­—èŠ‚æ•°ç»„çš„é•¿åº¦æ¢æˆä¸‹é¢è¿™æ ·å­ï¼Œå³ä½¿æ²¡æœ‰è¶…è¿‡ 64 ä½ï¼Œä¹Ÿéœ€è¦å¤šæ¡æŒ‡ä»¤å®Œæˆèµ‹å€¼ï¼Œå› ä¸º CPU ä¸­å¹¶æ²¡æœ‰è¿™æ ·ä½å®½çš„å¯„å­˜å™¨ï¼Œéœ€è¦æ‹†åˆ†ä¸ºå¤šæ¡æŒ‡ä»¤æ¥å®Œæˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">[<span class="hljs-number">3</span>]<span class="hljs-type">byte</span><br>[<span class="hljs-number">5</span>]<span class="hljs-type">byte</span><br>[<span class="hljs-number">7</span>]<span class="hljs-type">byte</span><br></code></pre></td></tr></table></figure><ul><li>åˆ‡ç‰‡<br>slice ä¹Ÿæ˜¯ç›¸åŒç±»å‹å€¼çš„é›†åˆï¼Œåªä¸è¿‡åˆ‡ç‰‡æ˜¯åŠ¨æ€è°ƒæ•´å¤§å°çš„ï¼Œå†…éƒ¨æ˜¯å¯¹æ•°ç»„çš„å¼•ç”¨ï¼Œç›¸å½“äºåŠ¨æ€æ•°ç»„ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œæ•°ç»„çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤åˆ‡ç‰‡ä¸ºæ•°ç»„æä¾›äº†æ›´çµæ´»çš„æ¥å£ã€‚<br>åˆ‡ç‰‡æ˜¯ä¸€ç§å¼•ç”¨ç±»å‹ï¼Œå®ƒå†…éƒ¨ç”±ä¸‰ä¸ªå­—æ®µè¡¨ç¤ºï¼š</li><li>æ•°ç»„åœ°å€</li><li>æ•°ç»„é•¿åº¦</li><li>å®¹é‡å¤§å°<br>åœ¨æºç åŒ…src&#x2F;runtime&#x2F;slice.goæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°åˆ‡ç‰‡çš„åº•å±‚æ•°æ®ç»“æ„ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> &#123;<br>array unsafe.Pointer<br><span class="hljs-built_in">len</span>   <span class="hljs-type">int</span><br><span class="hljs-built_in">cap</span>   <span class="hljs-type">int</span><br>&#125;<br></code></pre></td></tr></table></figure>å› ä¸ºå…¶æ˜¯ä¸€ä¸ª structï¼Œæ‰€ä»¥å¹¶å‘èµ‹å€¼æ˜¯ä¸å®‰å…¨çš„.</li><li>æ˜ å°„<br>mapæ˜¯å†…ç½®çš„k-væ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ä¸ªåŒç§ç±»å‹çš„æ— åºç»„ï¼Œå†…éƒ¨å…ƒç´ å¯ä»¥é€šè¿‡å”¯ä¸€é”®è¿›è¡Œç´¢å¼•ï¼Œmapçš„åº•å±‚ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰ä½äºsrc&#x2F;runtime&#x2F;map.goã€‚å¯¹mapçš„å¹¶å‘è¯»å†™ä¼šå¼•èµ·panic<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A header for a Go map.</span><br><span class="hljs-keyword">type</span> hmap <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span><br><span class="hljs-comment">// Make sure this stays in sync with the compiler&#x27;s definition.</span><br>count     <span class="hljs-type">int</span> <span class="hljs-comment">// # live cells == size of map.  Must be first (used by len() builtin)</span><br>flags     <span class="hljs-type">uint8</span><br>B         <span class="hljs-type">uint8</span>  <span class="hljs-comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span><br>noverflow <span class="hljs-type">uint16</span> <span class="hljs-comment">// approximate number of overflow buckets; see incrnoverflow for details</span><br>hash0     <span class="hljs-type">uint32</span> <span class="hljs-comment">// hash seed</span><br><br>buckets    unsafe.Pointer <span class="hljs-comment">// array of 2^B Buckets. may be nil if count==0.</span><br>oldbuckets unsafe.Pointer <span class="hljs-comment">// previous bucket array of half the size, non-nil only when growing</span><br>nevacuate  <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// progress counter for evacuation (buckets less than this have been evacuated)</span><br><br>extra *mapextra <span class="hljs-comment">// optional fields</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>é€šé“<br>channel åœ¨ goroutine ä¹‹é—´æä¾›åŒæ­¥å’Œé€šä¿¡ã€‚å¯ä»¥å°†å…¶è§†ä¸º goroutines é€šè¿‡å…¶å‘é€å€¼å’Œæ¥æ”¶å€¼çš„ç®¡é“ã€‚æ“ä½œç¬¦&lt;-ç”¨äºå‘é€æˆ–æ¥æ”¶æ•°æ®ï¼Œç®­å¤´æ–¹å‘æŒ‡å®šæ•°æ®æµçš„æ–¹å‘ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">ch &lt;- val    <span class="hljs-comment">// Sending a value present in var variable to channel</span><br>val := &lt;-cha<span class="hljs-comment">// Receive a value from  the channel and assign it to val variable</span><br></code></pre></td></tr></table></figure>channelä½œä¸ºæ•°æ®åŒæ­¥çš„é€šé“ï¼Œä»–åœ¨æ•°æ®è¯»å–å’Œå‘é€çš„è¿‡ç¨‹ä¸­ï¼Œchannel æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚å¤šä¸ª goroutine å¯ä»¥å®‰å…¨åœ°ä»åŒä¸€ä¸ª channel å‘é€æˆ–æ¥æ”¶æ•°æ®ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨é¢å¤–çš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é”ï¼‰ã€‚</li></ul><p>æœ¬æ–‡è®¨è®ºçš„æ˜¯å¯¹è±¡èµ‹å€¼çš„å®‰å…¨æ€§ï¼Œå³å°†ä¸€ä¸ªchannelèµ‹å€¼ç»™å¦å¤–ä¸€ä¸ªchannelï¼Œè¿™ä¸ªæ“ä½œä¸€èˆ¬ä¸ä¼šå‡ºç°ï¼Œä½†æ˜¯å¦‚æœä¸€å®šè¦è¿›è¡Œåˆ†æçš„è¯ï¼Œè¿™ç§æ“ä½œæ˜¯å¹¶å‘éå®‰å…¨çš„ï¼Œå› ä¸ºå®ƒçš„åº•å±‚ä¹Ÿæ˜¯ä¸€ä¸ªstructã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> hchan <span class="hljs-keyword">struct</span> &#123;<br>qcount   <span class="hljs-type">uint</span>           <span class="hljs-comment">// total data in the queue</span><br>dataqsiz <span class="hljs-type">uint</span>           <span class="hljs-comment">// size of the circular queue</span><br>buf      unsafe.Pointer <span class="hljs-comment">// points to an array of dataqsiz elements</span><br>elemsize <span class="hljs-type">uint16</span><br>closed   <span class="hljs-type">uint32</span><br>elemtype *_type <span class="hljs-comment">// element type</span><br>sendx    <span class="hljs-type">uint</span>   <span class="hljs-comment">// send index</span><br>recvx    <span class="hljs-type">uint</span>   <span class="hljs-comment">// receive index</span><br>recvq    waitq  <span class="hljs-comment">// list of recv waiters</span><br>sendq    waitq  <span class="hljs-comment">// list of send waiters</span><br><br><span class="hljs-comment">// lock protects all fields in hchan, as well as several</span><br><span class="hljs-comment">// fields in sudogs blocked on this channel.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Do not change another G&#x27;s status while holding this lock</span><br><span class="hljs-comment">// (in particular, do not ready a G), as this can deadlock</span><br><span class="hljs-comment">// with stack shrinking.</span><br>lock mutex<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ¥å£<br>æ¥å£æ˜¯Goä¸­çš„ä¸€ä¸ªç±»å‹ï¼Œä¸€èˆ¬å®ƒæ˜¯ä¸€ç»„æ–¹æ³•çš„é›†åˆã€‚ä»»æ„å®ç°è¯¥æ¥å£æ‰€æœ‰æ–¹æ³•çš„ç±»å‹éƒ½å±äºè¯¥æ¥å£ç±»å‹ã€‚æ¥å£çš„é›¶å€¼ä¸ºnilã€‚<br>å®šä¹‰ä¸€ä¸ªæ¥å£ç±»å‹çš„å˜é‡åï¼Œå¦‚æœæœ‰å…·ä½“ç±»å‹Aå®ç°äº†è¯¥æ¥å£çš„æ–¹æ³•ï¼Œåˆ™å¯ä»¥å°†ä»»ä½•Aç±»å‹çš„å€¼èµ‹å€¼ç»™è¿™ä¸ªå˜é‡ã€‚<br>Goä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„æƒ…å†µï¼Œå°±æ˜¯ç©ºæ¥å£ï¼Œå®ƒä¸åŒ…å«ä»»ä½•æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½•å…·ä½“ç±»å‹éƒ½å®ç°ç©ºæ¥å£ã€‚</li></ul><ol><li>ç©ºæ¥å£çš„åº•å±‚ç»“æ„ä¸ºruntime.eface</li><li>éç©ºæ¥å£çš„åº•å±‚ç»“æ„ä¸ºruntime.iface<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> eface <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 16 å­—èŠ‚</span><br>_type *_type<br>data  unsafe.Pointer<br>&#125;<br><br><span class="hljs-keyword">type</span> iface <span class="hljs-keyword">struct</span> &#123; <span class="hljs-comment">// 16 å­—èŠ‚</span><br>tab  *itab<br>data unsafe.Pointer<br>&#125;<br></code></pre></td></tr></table></figure>ç”±æ¥å£åº•å±‚ç»“æ„å¯ä»¥çœ‹åˆ°ï¼š</li></ol><ul><li>æ¥å£åº•å±‚æ•°æ®ç»“æ„åŒ…å«ä¸¤ä¸ªå­—æ®µï¼Œç›¸äº’èµ‹å€¼æ—¶å¦‚æœæ˜¯ç›¸åŒå…·ä½“ç±»å‹ä¸åŒå€¼å¹¶å‘èµ‹ç»™ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªå­—æ®µ data çš„å€¼æ˜¯ä¸åŒçš„ï¼Œæ­¤æ—¶é€€åŒ–æˆæŒ‡é’ˆçš„å¹¶å‘èµ‹å€¼ï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„ã€‚ä½†å¦‚æœæ˜¯ä¸åŒå…·ä½“ç±»å‹çš„å€¼å¹¶å‘èµ‹ç»™ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå¹¶å¼•å‘ panicã€‚</li><li>ä¸åŒç±»å‹éªŒè¯ä»£ç å¦‚ä¸‹ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> g <span class="hljs-keyword">interface</span>&#123;&#125;<br><br><span class="hljs-keyword">var</span> i <span class="hljs-type">int</span><br><span class="hljs-keyword">for</span> ; i &lt; <span class="hljs-number">10000000</span>; i++ &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-comment">// åç¨‹ 1</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-string">&quot;a&quot;</span><br>&#125;()<br><br><span class="hljs-comment">// åç¨‹ 2</span><br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>g = <span class="hljs-number">2</span><br>&#125;()<br>wg.Wait()<br><br><span class="hljs-comment">// èµ‹å€¼å¼‚å¸¸åˆ¤æ–­</span><br>v1, _ := g.(<span class="hljs-type">string</span>)<br>v2, _ := g.(<span class="hljs-type">int</span>)<br><span class="hljs-keyword">if</span> v1 != <span class="hljs-string">&quot;a&quot;</span> &amp;&amp; v2 != <span class="hljs-number">2</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;concurrent assignment error, i=%v g=%v &quot;</span>, i, g)<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> i == <span class="hljs-number">10000000</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;no error&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>æ‰§è¡Œæ—¶ä¼šæŠ¥é”™ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">anic: runtime <span class="hljs-type">error</span>: invalid memory address or <span class="hljs-literal">nil</span> pointer dereference<br>[signal SIGSEGV: segmentation violation code=<span class="hljs-number">0x2</span> addr=<span class="hljs-number">0x2</span> pc=<span class="hljs-number">0x10297598c</span>]<br></code></pre></td></tr></table></figure>æ›´å¤šå…³äºinterfaceçš„åˆ†æï¼Œå‚è€ƒï¼šã€ŠGolang Interfaceè§£æã€‹</li></ul><h2 id="5-å°ç»“"><a href="#5-å°ç»“" class="headerlink" title="5. å°ç»“"></a>5. å°ç»“</h2><p>Go å¤šåç¨‹å¹¶å‘çš„åœºæ™¯æ— å¤„ä¸åœ¨ï¼Œå¹¶å‘å¯¹åŒä¸€å˜é‡çš„èµ‹å€¼ä¹Ÿæ˜¯ç»å¸¸é‡åˆ°ã€‚æœ¬æ–‡å°è¯•æ¢è®¨äº† Go ä¸­æ‰€æœ‰ç±»å‹å¹¶å‘èµ‹å€¼çš„å®‰å…¨æ€§ã€‚</p><ul><li>ç”±ä¸€æ¡æœºå™¨æŒ‡ä»¤å®Œæˆèµ‹å€¼çš„ç±»å‹å¹¶å‘èµ‹å€¼æ˜¯å®‰å…¨çš„ï¼Œè¿™äº›ç±»å‹æœ‰ï¼šå­—èŠ‚å‹ï¼Œå¸ƒå°”å‹ã€æ•´å‹ã€æµ®ç‚¹å‹ã€å­—ç¬¦å‹ã€æŒ‡é’ˆã€å‡½æ•°ã€‚</li><li>æ•°ç»„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ç»„æˆï¼Œå¤§éƒ¨åˆ†æƒ…å†µå¹¶å‘ä¸å®‰å…¨ã€‚æ³¨æ„ï¼šå½“ä½å®½ä¸å¤§äº 64 ä½ä¸”æ˜¯ 2 çš„æ•´æ•°æ¬¡å¹‚ï¼ˆ8ï¼Œ16ï¼Œ32ï¼Œ64ï¼‰ï¼Œé‚£ä¹ˆå…¶å¹¶å‘èµ‹å€¼æ˜¯å®‰å…¨çš„ã€‚</li><li>struct æˆ–åº•å±‚æ˜¯ struct çš„ç±»å‹å¹¶å‘èµ‹å€¼å¤§éƒ¨åˆ†æƒ…å†µå¹¶å‘ä¸å®‰å…¨ï¼Œè¿™äº›ç±»å‹æœ‰ï¼šå¤æ•°ã€å­—ç¬¦ä¸²ã€ æ•°ç»„ã€åˆ‡ç‰‡ã€æ˜ å°„ã€é€šé“ã€æ¥å£ã€‚æ³¨æ„ï¼šå½“ struct èµ‹å€¼æ—¶é€€åŒ–ä¸ºå•ä¸ªå­—æ®µç”±ä¸€ä¸ªæœºå™¨æŒ‡ä»¤å®Œæˆèµ‹å€¼æ—¶ï¼Œå¹¶å‘èµ‹å€¼åˆæ˜¯å®‰å…¨çš„ã€‚è¿™ç§æƒ…å†µæœ‰ï¼š<ul><li>å®éƒ¨æˆ–è™šéƒ¨ç›¸åŒçš„å¤æ•°çš„å¹¶å‘èµ‹å€¼ï¼›</li><li>ç­‰é•¿å­—ç¬¦ä¸²çš„å¹¶å‘èµ‹å€¼ï¼›</li><li>åŒé•¿åº¦åŒå®¹é‡åˆ‡ç‰‡çš„å¹¶å‘èµ‹å€¼ï¼›</li><li>åŒä¸€ç§å…·ä½“ç±»å‹ä¸åŒå€¼å¹¶å‘èµ‹ç»™æ¥å£ã€‚</li></ul></li></ul><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/K346K346/article/details/115099353">https://blog.csdn.net/K346K346/article/details/115099353</a></p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¹¶å‘å®‰å…¨</tag>
      
      <tag>å¹¶å‘èµ‹å€¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang Channels è§£æ</title>
    <link href="/2024/09/08/golang-channels/"/>
    <url>/2024/09/08/golang-channels/</url>
    
    <content type="html"><![CDATA[<p>Channelæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„ç®¡é“ï¼Œå®ƒæä¾›äº†ä¸€ç§åŒæ­¥çš„æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å‘é€å’Œæ¥æ”¶ä¹‹é—´çš„é¡ºåºä»¥åŠæ­£ç¡®æ€§ã€‚é€šè¿‡ä½¿ç”¨channelï¼Œæˆ‘ä»¬å¯ä»¥é¿å…åœ¨å¤šä¸ªåç¨‹ä¹‹é—´å…±äº«æ•°æ®æ—¶å‡ºç°çš„ç«äº‰æ¡ä»¶å’Œå…¶ä»–å¹¶å‘é—®é¢˜ã€‚</p><span id="more"></span>  <h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>åœ¨Goè¯­è¨€ä¸­ï¼Œä¸€ç§å¹¿ä¸ºäººçŸ¥çš„å¹¶å‘ç¼–ç¨‹æ¨¡å‹æ˜¯CSP(Communicating Sequential Processes)æ¨¡å‹ï¼Œæå€¡é€šè¿‡é€šä¿¡å…±äº«å†…å­˜ï¼Œè€Œä¸æ˜¯é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ã€‚è€Œchannelæ­£æ˜¯è¿™æ ·ä¸€ç§ç‰¹æ®Šçš„ç±»å‹ï¼Œç”¨äºåœ¨å¹¶å‘ç¼–ç¨‹ä¸­å®ç°ä¸åŒåç¨‹ä¹‹é—´çš„é€šä¿¡å’ŒåŒæ­¥ã€‚  </p><p>Channelæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„ç®¡é“ï¼Œå®ƒæä¾›äº†ä¸€ç§åŒæ­¥çš„æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®å‘é€å’Œæ¥æ”¶ä¹‹é—´çš„é¡ºåºä»¥åŠæ­£ç¡®æ€§ã€‚é€šè¿‡ä½¿ç”¨channelï¼Œæˆ‘ä»¬å¯ä»¥é¿å…åœ¨å¤šä¸ªåç¨‹ä¹‹é—´å…±äº«æ•°æ®æ—¶å‡ºç°çš„ç«äº‰æ¡ä»¶å’Œå…¶ä»–å¹¶å‘é—®é¢˜ã€‚<br><img src="/img/golang-channels/1.png"><br>é€šé“ç±»å‹çš„å€¼æœ¬èº«æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œè¿™ä¹Ÿæ˜¯ Go è¯­è¨€è‡ªå¸¦çš„ã€å”¯ä¸€ä¸€ä¸ªå¯ä»¥æ»¡è¶³å¹¶å‘å®‰å…¨æ€§çš„ç±»å‹</p><h2 id="2-åŸºæœ¬ç‰¹æ€§"><a href="#2-åŸºæœ¬ç‰¹æ€§" class="headerlink" title="2. åŸºæœ¬ç‰¹æ€§"></a>2. åŸºæœ¬ç‰¹æ€§</h2><p>åœ¨Goä¸­ï¼Œchannelçš„å…³é”®å­—æ˜¯chanï¼Œé€šè¿‡ç®­å¤´è¡¨ç¤ºæ•°æ®æµå‘â†ï¼Œå…·æœ‰ä»¥ä¸‹åŸºæœ¬ç‰¹æ€§ï¼š</p><ul><li>Channelæ˜¯ç±»å‹ç›¸å…³çš„ï¼Œç‰¹å®šç±»å‹çš„Channelåªèƒ½å­˜æ”¾ç‰¹å®šç±»å‹çš„æ•°æ®ã€‚</li><li>channelåˆ†ç¼“å†²å‹(buffered)å’Œéç¼“å†²å‹(unbufferedï¼‰ï¼Œéç¼“å†²å‹çš„sizeæ˜¯0ï¼Œç¼“å†²å‹çš„sizeæ˜¯ç¼“å†²åŒºçš„å¤§å°ã€‚</li><li>ç¼“å†²å‹é€šé“è¯»å†™ç»è¿‡bufferï¼Œéç¼“å†²å‹é€šé“çš„æ•°æ®äº¤äº’ä¸ç»è¿‡é€šé“ï¼Œç›´æ¥é€šè¿‡å†…å­˜å†™ä¼ é€’ã€‚</li><li>channelåˆ†å•å‘å’ŒåŒå‘ï¼Œå•å‘çš„æ„æ€æ˜¯åªèƒ½è¯»ï¼ˆæˆ–å†™ï¼‰ï¼ŒåŒå‘æ˜¯æ—¢èƒ½è¯»ä¹Ÿèƒ½å†™ã€‚</li><li>channelæ»¡æ—¶â€œå†™â€ä¼šé˜»å¡ï¼Œchannelç©ºæ—¶â€œè¯»â€ä¼šé˜»å¡ã€‚</li></ul><h3 id="2-1-æ— ç¼“å†²é€šé“"><a href="#2-1-æ— ç¼“å†²é€šé“" class="headerlink" title="2.1 æ— ç¼“å†²é€šé“"></a>2.1 æ— ç¼“å†²é€šé“</h3><p>æ— ç¼“å†²çš„ channelï¼ˆunbuffered channelï¼‰ï¼Œå…¶ç¼“å†²åŒºå¤§å°åˆ™é»˜è®¤ä¸º 0ã€‚åœ¨åŠŸèƒ½ä¸Šå…¶æ¥å—è€…ä¼šé˜»å¡ç­‰å¾…å¹¶é˜»å¡åº”ç”¨ç¨‹åºï¼Œç›´è‡³æ”¶åˆ°é€šä¿¡å’Œæ¥æ”¶åˆ°æ•°æ®ã€‚<br><img src="/img/golang-channels/2.png"><br>æ— ç¼“å†²é€šé“åœ¨å¤„ç†æ—¶ï¼Œå¿…é¡»åŒæ—¶æœ‰å‘é€è€…å’Œæ¥æ”¶è€…ï¼Œä¸ç„¶å°±ä¼šé˜»å¡ã€‚å¦‚ä¸‹çš„æ¡ˆä¾‹ä¸­ï¼Œå¦‚æœå…ˆåœ¨mainä¸­å¾€chå†™æ•°æ®ï¼Œè¿è¡Œæ—¶å°±ä¼šæŠ›é”™ï¼šfatal error: all goroutines are asleep - deadlock!</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><span class="hljs-comment">// å¯ç”¨goroutineä»é€šé“æ¥æ”¶å€¼</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>ret := &lt;-ch<br>fmt.Println(<span class="hljs-string">&quot;æ¥æ”¶æˆåŠŸ: &quot;</span>, ret)<br>&#125;()<br><br>ch &lt;- <span class="hljs-number">10</span><br>fmt.Println(<span class="hljs-string">&quot;å‘é€æˆåŠŸ&quot;</span>)<br>time.Sleep(time.Second)<br>&#125;<br><span class="hljs-comment">// å‘é€æˆåŠŸ</span><br><span class="hljs-comment">// æ¥æ”¶æˆåŠŸ:  10</span><br></code></pre></td></tr></table></figure><h3 id="2-2-æœ‰ç¼“å†²é€šé“"><a href="#2-2-æœ‰ç¼“å†²é€šé“" class="headerlink" title="2.2 æœ‰ç¼“å†²é€šé“"></a>2.2 æœ‰ç¼“å†²é€šé“</h3><p><img src="/img/golang-channels/3.png"><br>è§£å†³æ— ç¼“å†²é€šé“ï¼ˆé˜»å¡ï¼‰æ­»é”çš„é—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨æœ‰ç¼“å†²çš„é€šé“ã€‚é€šè¿‡ç¼“å­˜çš„ä½¿ç”¨ï¼Œå¯ä»¥å°½é‡é¿å…é˜»å¡ï¼Œæä¾›åº”ç”¨çš„æ€§èƒ½ã€‚åªè¦é€šé“çš„å®¹é‡å¤§äºé›¶ï¼Œé‚£ä¹ˆè¯¥é€šé“å°±æ˜¯æœ‰ç¼“å†²çš„é€šé“ï¼Œé€šé“çš„å®¹é‡è¡¨ç¤ºé€šé“ä¸­èƒ½å­˜æ”¾å…ƒç´ çš„æ•°é‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º 1 çš„æœ‰ç¼“å†²åŒºçš„é€šé“</span><br><br>ch &lt;- <span class="hljs-number">10</span><br>fmt.Println(<span class="hljs-string">&quot;å‘é€æˆåŠŸ&quot;</span>)<br><br>ret := &lt;-ch<br>fmt.Println(<span class="hljs-string">&quot;æ¥æ”¶æˆåŠŸ: &quot;</span>, ret)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-å•å‘é€šé“"><a href="#2-3-å•å‘é€šé“" class="headerlink" title="2.3 å•å‘é€šé“"></a>2.3 å•å‘é€šé“</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å°†é€šé“ä½œä¸ºå‚æ•°åœ¨å¤šä¸ªå‡½æ•°é—´ä¼ é€’æ—¶ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„ä»»åŠ¡ç±»å‹å¯¹é€šé“è¿›è¡Œé™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶é€šé“åœ¨å‡½æ•°ä¸­åªèƒ½å‘é€æˆ–åªèƒ½æ¥æ”¶ã€‚<br>æ³¨æ„ï¼šå‘é€å’Œæ¥æ”¶æ˜¯é’ˆå¯¹channelè€Œè¨€ï¼Œæ¯”å¦‚å‘é€æ˜¯æŒ‡å‘channelå‘é€æ•°æ®ï¼Œæ¥æ”¶æ˜¯æŒ‡ä»channelæ¥æ”¶æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ç®­å¤´çš„æ•°æ®æµå‘æ¥æ ‡è¯†ç±»å‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>) <span class="hljs-comment">// å•å‘å‘é€é€šé“</span><br>ch := <span class="hljs-built_in">make</span>(&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>) <span class="hljs-comment">// å•å‘æ¥æ”¶é€šé“</span><br></code></pre></td></tr></table></figure><p>å¦‚ä¸‹ä¸€ä¸ªåœºæ™¯ä¸­ï¼Œé¦–å…ˆå¾€ä¸€ä¸ªå•å‘å‘é€é€šé“å†™å…¥æ•°æ®ï¼Œç„¶åç»ä¸­è½¬å°†æ•°æ®å†™å…¥å¦ä¸€ä¸ªé€šé“ï¼Œæœ€åå†ä»¥å•å‘æ¥æ”¶é€šé“çš„å½¢å¼è¯»å‡ºæ•°æ®</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å•å‘å‘é€é€šé“ï¼Œå°†æ•°æ®å†™å…¥channel</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">a</span><span class="hljs-params">(in <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>in &lt;- i<br>&#125;<br><span class="hljs-built_in">close</span>(in)<br>&#125;<br><br><span class="hljs-comment">// å•å‘å‘é€ in é€šé“ï¼Œ å•å‘æ¥æ”¶ out é€šé“ï¼Œå°†æ•°æ®ä»ä¸€ä¸ªchannelå†™å…¥å¦ä¸€ä¸ªchannel</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">a2b</span><span class="hljs-params">(in <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>, out &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> out &#123;<br>in &lt;- i * i<br>&#125;<br><span class="hljs-built_in">close</span>(in)<br>&#125;<br><br><span class="hljs-comment">// å•å‘æ¥æ”¶é€šé“ï¼Œä»channelè¯»å‡ºæ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">b</span><span class="hljs-params">(out &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> out &#123;<br>fmt.Println(i)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>in := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>out := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><span class="hljs-keyword">go</span> a(in)<br><span class="hljs-keyword">go</span> a2b(out, in)<br>b(out)<br>&#125;<br><span class="hljs-comment">// 0 1 4 9 16 25 36 49 64 81</span><br></code></pre></td></tr></table></figure><h3 id="2-4-Channelçš„éå†"><a href="#2-4-Channelçš„éå†" class="headerlink" title="2.4 Channelçš„éå†"></a>2.4 Channelçš„éå†</h3><p>å¦‚ä½•ä¼˜é›…çš„ä»é€šé“ä¸­è·å–æ•°æ®ï¼ŒGoæ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ul><li><code>for range</code>å¾ªç¯<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">3</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i = i + <span class="hljs-number">1</span> &#123;<br>c &lt;- i<br>&#125;<br><span class="hljs-built_in">close</span>(c)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> c &#123;<br>fmt.Println(i)<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;Finished&quot;</span>)<br>&#125;<br><span class="hljs-comment">// 0</span><br><span class="hljs-comment">// 1</span><br><span class="hljs-comment">// 2</span><br><span class="hljs-comment">// Finished</span><br></code></pre></td></tr></table></figure>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨éå†æ—¶å¦‚æœchannelÂ æ²¡æœ‰å…³é—­ï¼Œé‚£ä¹ˆä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œå‡ºç°Â deadlockÂ çš„é”™è¯¯ï¼›å¦‚æœåœ¨éå†æ—¶channelå·²ç»å…³é—­ï¼Œé‚£ä¹ˆåœ¨éå†å®Œæ•°æ®åè‡ªåŠ¨é€€å‡ºéå†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œfor rangeÂ çš„éå†æ–¹å¼æ˜¯é˜»å¡å‹çš„éå†æ–¹å¼ã€‚</li><li><code>for &#123;&#125;</code>æ­»å¾ªç¯<br>é€šè¿‡for{} æ­»å¾ªç¯+é€šé“å…³é—­åˆ¤æ–­çš„æ–¹å¼æ¥è¿›è¡Œå–å€¼<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i = i + <span class="hljs-number">1</span> &#123;<br>c &lt;- i<br>&#125;<br><span class="hljs-built_in">close</span>(c)<br>&#125;()<br><br><span class="hljs-keyword">for</span> &#123;<br>i, ok := &lt;-c <span class="hljs-comment">// é€šé“å…³é—­åå†å–å€¼ok=false</span><br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>fmt.Println(i)<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;Finished&quot;</span>)<br>&#125;<br><span class="hljs-comment">// 0</span><br><span class="hljs-comment">// 1</span><br><span class="hljs-comment">// 2</span><br><span class="hljs-comment">// Finished</span><br></code></pre></td></tr></table></figure></li><li><code>for select &#123;&#125;</code>æ“ä½œ<br>selectå¯ä»¥æ”¯æŒä¸€ç»„æ“ä½œå¤„ç†ï¼Œé€šè¿‡caseè¯­å¥æ ‡è¯†ä¸åŒçš„å¤„ç†åœºæ™¯ã€‚å¦‚æœæœ‰å¤šä¸ªcaseæ»¡è¶³æ¡ä»¶ï¼Œåˆ™goä¼šéšæœºé€‰æ‹©å…¶ä¸­ä¸€ä¸ªæ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„caseï¼Œåˆ™ä¼šé€‰æ‹©defaultè¯­å¥å¤„ç†ã€‚æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰defaultè¯­å¥ä¸”æ²¡æœ‰æ»¡è¶³çš„æ¡ä»¶æ—¶ï¼Œselectè¯­å¥ä¼šä¸€ç›´é˜»å¡ï¼Œä¸€èˆ¬é€šè¿‡select + default é¿å…é˜»å¡é—®é¢˜.<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fibonacci</span><span class="hljs-params">(c, quit <span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> &#123;<br>x, y := <span class="hljs-number">1</span>, <span class="hljs-number">2</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> c &lt;- x:<br>x, y = y, x+y<br><span class="hljs-keyword">case</span> &lt;-quit:<br>fmt.Println(<span class="hljs-string">&quot;quit&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>quit := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ &#123;<br>fmt.Println(&lt;-c)<br>&#125;<br>quit &lt;- <span class="hljs-number">0</span><br>&#125;()<br>fibonacci(c, quit)<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="2-5-å¼‚å¸¸æƒ…å†µ"><a href="#2-5-å¼‚å¸¸æƒ…å†µ" class="headerlink" title="2.5 å¼‚å¸¸æƒ…å†µ"></a>2.5 å¼‚å¸¸æƒ…å†µ</h3><p><img src="/img/golang-channels/4.png"> </p><h4 id="2-5-1-å‘ç”ŸPanic"><a href="#2-5-1-å‘ç”ŸPanic" class="headerlink" title="2.5.1 å‘ç”ŸPanic"></a>2.5.1 å‘ç”ŸPanic</h4><ul><li>å‘ä¸€ä¸ªå…³é—­çš„ channel è¿›è¡Œå†™æ“ä½œ</li><li>å…³é—­ä¸€ä¸ª nil çš„ channel</li><li>å…³é—­ä¸€ä¸ªå·²ç»å…³é—­çš„ channel</li></ul><h4 id="2-5-2-å‘ç”Ÿé˜»å¡"><a href="#2-5-2-å‘ç”Ÿé˜»å¡" class="headerlink" title="2.5.2 å‘ç”Ÿé˜»å¡"></a>2.5.2 å‘ç”Ÿé˜»å¡</h4><ul><li>è¯»ä¸€ä¸ª nil channel ä¼šè¢«é˜»å¡</li><li>å†™ä¸€ä¸ª nil channel ä¼šè¢«é˜»å¡</li><li>è¯»å†™ç¼“å†²ä¸ºç©ºæˆ–è€…å·²ç»æ»¡äº†ä¸”æ²¡æœ‰æŒ‚èµ·çš„æ¥æ”¶è€…å’Œå‘é€è€…ã€‚</li></ul><h2 id="3-å¸¸è§åº”ç”¨"><a href="#3-å¸¸è§åº”ç”¨" class="headerlink" title="3. å¸¸è§åº”ç”¨"></a>3. å¸¸è§åº”ç”¨</h2><h3 id="3-1-é€šçŸ¥ä¿¡å·"><a href="#3-1-é€šçŸ¥ä¿¡å·" class="headerlink" title="3.1 é€šçŸ¥ä¿¡å·"></a>3.1 é€šçŸ¥ä¿¡å·</h3><p>é€šè¿‡chæ¥å‘é€åœæ­¢ä¿¡å·ï¼Œå½“mainåç¨‹å°†å‡†å¤‡å·¥ä½œåšå¥½ä¹‹åï¼Œåªéœ€è¦å¾€chä¸­å†™å…¥æ•°æ®ï¼ˆæˆ–å…³é—­chan)ï¼Œå°±èƒ½å¤Ÿè®©æ–°èµ·çš„åç¨‹é€€å‡ºforå¾ªç¯ã€‚ä¸‹é¢ä¸­selectè¯­æ³•ç±»ä¼¼äºswitchï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œcaseåé¢åªèƒ½æ˜¯ä¸€ä¸ªé¢å‘channelçš„æ“ä½œã€‚å½“æ²¡æœ‰å‘½ä¸­caseæ—¶ï¼Œä¼šæ‰§è¡Œdefaultï¼Œå› æ­¤å¯ä»¥é€šè¿‡selectæ¥è¿›è¡Œéé˜»å¡çš„è¯»æˆ–å†™ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// do something recursively</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ch:<br>fmt.Println(<span class="hljs-string">&quot;channel received&quot;</span>)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;waiting&quot;</span>)<br>&#125;<br>&#125;<br>&#125;()<br><span class="hljs-comment">// do something until it is time to terminate goroutine</span><br>ch &lt;- <span class="hljs-literal">true</span> <span class="hljs-comment">// or close(ch)</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-å®šæ—¶ä»»åŠ¡"><a href="#3-2-å®šæ—¶ä»»åŠ¡" class="headerlink" title="3.2 å®šæ—¶ä»»åŠ¡"></a>3.2 å®šæ—¶ä»»åŠ¡</h3><p>ä¸ timer ç»“åˆï¼Œå®ç°å®šæ—¶ä»»åŠ¡æ‰§è¡Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span></span> &#123;<br>ticker := time.Tick(<span class="hljs-number">1</span> * time.Second)<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ticker:<br>fmt.Println(<span class="hljs-string">&quot;æ‰§è¡Œ 1s å®šæ—¶ä»»åŠ¡&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">go</span> worker()<br><br>time.Sleep(time.Second * <span class="hljs-number">5</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-ç”Ÿäº§æ¶ˆè´¹è§£è€¦"><a href="#3-3-ç”Ÿäº§æ¶ˆè´¹è§£è€¦" class="headerlink" title="3.3 ç”Ÿäº§æ¶ˆè´¹è§£è€¦"></a>3.3 ç”Ÿäº§æ¶ˆè´¹è§£è€¦</h3><p>æœåŠ¡å¯åŠ¨æ—¶ï¼Œå¯åŠ¨ n ä¸ª workerï¼Œä½œä¸ºå·¥ä½œåç¨‹æ± ï¼Œè¿™äº›åç¨‹å·¥ä½œåœ¨ä¸€ä¸ªÂ for {}Â æ— é™å¾ªç¯é‡Œï¼Œä»æŸä¸ª channel æ¶ˆè´¹å·¥ä½œä»»åŠ¡å¹¶æ‰§è¡Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>taskCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">10</span>)<br><span class="hljs-keyword">go</span> worker(taskCh)<br><br><span class="hljs-comment">// å¡ä»»åŠ¡</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>taskCh &lt;- i<br>&#125;<br><br><span class="hljs-comment">// ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span><br>time.Sleep(time.Second * <span class="hljs-number">5</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(taskCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">const</span> N = <span class="hljs-number">5</span><br><span class="hljs-comment">// å¯åŠ¨ 5 ä¸ªå·¥ä½œåç¨‹</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; N; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br>task := &lt;-taskCh<br>fmt.Printf(<span class="hljs-string">&quot;finish task: %d by worker %d\n&quot;</span>, task, id)<br>time.Sleep(time.Second)<br>&#125;<br>&#125;(i)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-4-å¹¶å‘æ•°æ§åˆ¶"><a href="#3-4-å¹¶å‘æ•°æ§åˆ¶" class="headerlink" title="3.4 å¹¶å‘æ•°æ§åˆ¶"></a>3.4 å¹¶å‘æ•°æ§åˆ¶</h3><p>æœ‰æ—¶éœ€è¦å®šæ—¶æ‰§è¡Œå‡ ç™¾ä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚æ¯å¤©å®šæ—¶æŒ‰åŸå¸‚æ¥æ‰§è¡Œä¸€äº›ç¦»çº¿è®¡ç®—çš„ä»»åŠ¡ã€‚ä½†æ˜¯å¹¶å‘æ•°åˆä¸èƒ½å¤ªé«˜ï¼Œå› ä¸ºä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¾èµ–ç¬¬ä¸‰æ–¹çš„ä¸€äº›èµ„æºï¼Œå¯¹è¯·æ±‚çš„é€Ÿç‡æœ‰é™åˆ¶ã€‚è¿™æ—¶å°±å¯ä»¥é€šè¿‡ channel æ¥æ§åˆ¶å¹¶å‘æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> limit = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">10</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> _, w := <span class="hljs-keyword">range</span> workers &#123;<br>limit &lt;- <span class="hljs-number">1</span> <span class="hljs-comment">// limit &lt;- 1åœ¨æ­¤å¤„ä¼šé™åˆ¶åˆ›å»ºçš„goroutineçš„ä¸ªæ•°</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>w()<br>&lt;-limit<br>&#125;()<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å®è·µé¿å‘"><a href="#4-å®è·µé¿å‘" class="headerlink" title="4. å®è·µé¿å‘"></a>4. å®è·µé¿å‘</h2><h3 id="4-1-æ­»é”"><a href="#4-1-æ­»é”" class="headerlink" title="4.1 æ­»é”"></a>4.1 æ­»é”</h3><p>go è¯­è¨€æ–°æ‰‹åœ¨ç¼–è¯‘æ—¶å¾ˆå®¹æ˜“ç¢°åˆ°è¿™ä¸ªæ­»é”çš„é—®é¢˜ï¼šfatal error: all goroutines are asleep - deadlock! åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œã€Œæ­»é”ã€å°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œè€—åœ¨é‚£é‡Œï¼Œæœ€åç¨‹åºä¸å¾—ä¸ç»ˆæ­¢ã€‚go è¯­è¨€ä¸­çš„ã€Œæ­»é”ã€ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä¸¤ä¸ª goroutine äº’ç›¸ç­‰å¾…ï¼Œå¯¼è‡´ç¨‹åºè€—åœ¨é‚£é‡Œï¼Œæ— æ³•ç»§ç»­è·‘ä¸‹å».</p><ul><li>åªæœ‰ç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…<br>channel çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¿…é¡»æˆå¯¹å‡ºç°ï¼Œå¦‚æœç¼ºä¹ä¸€ä¸ªï¼Œå°±ä¼šé€ æˆæ­»é”ï¼Œä¾‹å¦‚ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åªæœ‰ç”Ÿäº§è€…ï¼Œæ²¡æœ‰æ¶ˆè´¹è€…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f1</span><span class="hljs-params">()</span></span> &#123;<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>    ch &lt;- <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment">// åªæœ‰æ¶ˆè´¹è€…ï¼Œæ²¡æœ‰ç”Ÿäº§è€…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f2</span><span class="hljs-params">()</span></span> &#123;<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>    &lt;-ch<br>&#125;<br></code></pre></td></tr></table></figure></li><li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åœ¨åŒä¸€ä¸ªåç¨‹<br>é™¤äº†éœ€è¦æˆå¯¹å‡ºç°ï¼Œè¿˜éœ€è¦å‡ºç°åœ¨ä¸åŒçš„ goroutine ä¸­ï¼Œä¾‹å¦‚ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŒä¸€ä¸ª goroutine ä¸­åŒæ—¶å‡ºç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f3</span><span class="hljs-params">()</span></span> &#123;<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>    ch &lt;- <span class="hljs-number">1</span>  <span class="hljs-comment">// ç”±äºæ¶ˆè´¹è€…è¿˜æ²¡æ‰§è¡Œåˆ°ï¼Œè¿™é‡Œä¼šä¸€ç›´é˜»å¡ä½</span><br>    &lt;-ch<br>&#125;<br></code></pre></td></tr></table></figure></li><li>buffered channel å·²æ»¡ï¼Œä¸”åœ¨åŒä¸€ä¸ªgoroutineä¸­<br>buffered channel ä¼šå°†æ”¶åˆ°çš„å…ƒç´ å…ˆå­˜åœ¨ hchan ç»“æ„ä½“çš„ ringbuffer ä¸­ï¼Œç»§è€Œæ‰ä¼šå‘ç”Ÿé˜»å¡ã€‚è€Œå½“å‘ç”Ÿé˜»å¡æ—¶ï¼Œå¦‚æœé˜»å¡äº†ä¸» goroutine ï¼Œåˆ™ä¹Ÿä¼šå‡ºç°æ­»é”ã€‚<br>æ‰€ä»¥å®é™…ä½¿ç”¨ä¸­ï¼Œæ¨èå°½é‡ä½¿ç”¨ buffered channel ï¼Œä½¿ç”¨èµ·æ¥ä¼šæ›´å®‰å…¨</li></ul><h3 id="4-2-å†…å­˜æ³„æ¼"><a href="#4-2-å†…å­˜æ³„æ¼" class="headerlink" title="4.2 å†…å­˜æ³„æ¼"></a>4.2 å†…å­˜æ³„æ¼</h3><p>å†…å­˜æ³„æ¼ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ OOM(Out of Memory) å‘Šè­¦æˆ–è€…å‘å¸ƒè¿‡ç¨‹ä¸­å¯¹å†…å­˜çš„è§‚å¯Ÿå‘ç°çš„ï¼ŒæœåŠ¡å†…å­˜å¾€å¾€éƒ½æ˜¯ç¼“æ…¢ä¸Šå‡ï¼Œç›´åˆ°è¢«ç³»ç»Ÿ OOM æ‰æ¸…ç©ºå†…å­˜å†å‘¨è€Œå¤å§‹ã€‚åœ¨ go è¯­è¨€ä¸­ï¼Œé”™è¯¯åœ°ä½¿ç”¨ channel ä¼šå¯¼è‡´ goroutine æ³„æ¼ï¼Œè¿›è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚<br>è®© goroutine æ³„æ¼çš„æ ¸å¿ƒå°±æ˜¯ï¼šç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€… æ‰€åœ¨çš„ goroutine å·²ç»é€€å‡ºï¼Œè€Œå…¶å¯¹åº”çš„ æ¶ˆè´¹è€…&#x2F;ç”Ÿäº§è€… æ‰€åœ¨çš„ goroutine ä¼šæ°¸è¿œé˜»å¡ä½ï¼Œç›´åˆ°è¿›ç¨‹é€€å‡º</p><ul><li>ç”Ÿäº§è€…é˜»å¡å¯¼è‡´æ³„æ¼<br>ä½¿ç”¨channelåšè¶…æ—¶æ§åˆ¶æ—¶ï¼Œå‡è®¾å®¢æˆ·ç«¯è¶…æ—¶ä¸º 500msï¼Œè€Œå®é™…è¯·æ±‚è€—æ—¶ä¸º 2sï¼Œåˆ™ select ä¼šèµ°åˆ° timeout çš„é€»è¾‘ï¼Œè¿™æ—¶ g2 é€€å‡ºï¼Œchannel ch æ²¡æœ‰æ¶ˆè´¹è€…ï¼Œä¼šä¸€ç›´åœ¨ç­‰å¾…çŠ¶æ€ï¼›å¦‚æœè¿™æ˜¯åœ¨Â serverÂ ä»£ç ä¸­ï¼Œè¿™ä¸ªè¯·æ±‚å¤„ç†å®Œåï¼Œg1 å°±ä¼šæŒ‚èµ·ã€å‘ç”Ÿäº†æ³„æ¼ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">leak1</span><span class="hljs-params">()</span></span> &#123;<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>    <span class="hljs-comment">// g1</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        time.Sleep(<span class="hljs-number">2</span> * time.Second) <span class="hljs-comment">// æ¨¡æ‹Ÿ io æ“ä½œ</span><br>        ch &lt;- <span class="hljs-number">100</span>                   <span class="hljs-comment">// æ¨¡æ‹Ÿè¿”å›ç»“æœ</span><br>    &#125;()<br><br>    <span class="hljs-comment">// g2</span><br>    <span class="hljs-comment">// é˜»å¡ä½ï¼Œç›´åˆ°è¶…æ—¶æˆ–è¿”å›</span><br>    <span class="hljs-keyword">select</span> &#123;<br>    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">500</span> * time.Millisecond):<br>        fmt.Println(<span class="hljs-string">&quot;timeout! exit...&quot;</span>)<br>    <span class="hljs-keyword">case</span> result := &lt;-ch:<br>        fmt.Printf(<span class="hljs-string">&quot;result: %d\n&quot;</span>, result)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>æ¶ˆè´¹è€…é˜»å¡å¯¼è‡´æ³„æ¼<br>å¦‚æœç”Ÿäº§è€…ä¸ç»§ç»­ç”Ÿäº§ï¼Œæ¶ˆè´¹è€…æ‰€åœ¨çš„ goroutine ä¹Ÿä¼šé˜»å¡ä½ï¼Œä¸ä¼šé€€å‡ºï¼Œä¾‹å¦‚ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">leak2</span><span class="hljs-params">()</span></span> &#123;<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><br>    <span class="hljs-comment">// æ¶ˆè´¹è€… g1</span><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">for</span> result := <span class="hljs-keyword">range</span> ch &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;result: %d\n&quot;</span>, result)<br>        &#125;<br>    &#125;()<br><br>    <span class="hljs-comment">// ç”Ÿäº§è€… g2</span><br>    ch &lt;- <span class="hljs-number">1</span><br>    ch &lt;- <span class="hljs-number">2</span><br>    time.Sleep(time.Second)  <span class="hljs-comment">// æ¨¡æ‹Ÿè€—æ—¶</span><br>    fmt.Println(<span class="hljs-string">&quot;main goroutine g2 done...&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>è¿™ç§æƒ…å†µä¸‹ï¼Œåªéœ€è¦å¢åŠ  close(ch) çš„æ“ä½œå³å¯ï¼Œfor-range æ“ä½œåœ¨æ”¶åˆ° close çš„ä¿¡å·åä¼šé€€å‡ºã€goroutine ä¸å†é˜»å¡ï¼Œèƒ½å¤Ÿè¢«å›æ”¶ã€‚</li><li>å¦‚ä½•é¢„é˜²æ³„æ¼<br>é¢„é˜² goroutine æ³„æ¼çš„æ ¸å¿ƒå°±æ˜¯ï¼šåˆ›å»º goroutine æ—¶å°±è¦æƒ³æ¸…æ¥šå®ƒä»€ä¹ˆæ—¶å€™è¢«å›æ”¶ã€‚å…·ä½“åˆ°æ‰§è¡Œå±‚é¢ï¼ŒåŒ…æ‹¬ï¼š<ul><li>å½“ goroutine é€€å‡ºæ—¶ï¼Œéœ€è¦è€ƒè™‘å®ƒä½¿ç”¨çš„ channel æœ‰æ²¡æœ‰å¯èƒ½é˜»å¡å¯¹åº”çš„ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…çš„ goroutineï¼›</li><li>å°½é‡ä½¿ç”¨ buffered channel ä½¿ç”¨ buffered channel èƒ½å‡å°‘é˜»å¡å‘ç”Ÿã€å³ä½¿ç–å¿½äº†ä¸€äº›æç«¯æƒ…å†µï¼Œä¹Ÿèƒ½é™ä½ goroutine æ³„æ¼çš„æ¦‚ç‡ï¼›</li></ul></li></ul><h3 id="4-3-Close-Channel"><a href="#4-3-Close-Channel" class="headerlink" title="4.3 Close Channel"></a>4.3 Close Channel</h3><ul><li>æ˜¯å¦éœ€è¦close<br>é™¤éå¿…é¡»å…³é—­ chanï¼Œå¦åˆ™ä¸è¦ä¸»åŠ¨å…³é—­ã€‚å…³é—­ chan æœ€ä¼˜é›…çš„æ–¹å¼ï¼Œå°±æ˜¯ä¸è¦å…³é—­ chan~<br>å½“ä¸€ä¸ª chan æ²¡æœ‰ sender å’Œ receiver æ—¶ï¼Œå³ä¸å†è¢«ä½¿ç”¨æ—¶ï¼ŒGC ä¼šåœ¨ä¸€æ®µæ—¶é—´åæ ‡è®°ã€æ¸…ç†æ‰è¿™ä¸ª chanã€‚é‚£ä¹ˆä»€ä¹ˆæ—¶å€™å¿…é¡»å…³é—­ chan å‘¢ï¼Ÿ<br>æ¯”è¾ƒå¸¸è§çš„æ˜¯å°† close ä½œä¸ºä¸€ç§é€šçŸ¥æœºåˆ¶ï¼Œå°¤å…¶æ˜¯ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´æ˜¯ 1:M çš„å…³ç³»æ—¶ï¼Œé€šè¿‡ close å‘Šè¯‰ä¸‹æ¸¸ï¼šæˆ‘æ”¶å·¥äº†ï¼Œä½ ä»¬åˆ«è¯»äº†</li><li>è°æ¥å…³é—­channel<br>chan å…³é—­çš„åŸåˆ™:</li><li>Donâ€™t close a channel from the receiver side ä¸è¦åœ¨æ¶ˆè´¹è€…ç«¯å…³é—­ chan</li><li>Donâ€™t close a channel if the channel has multiple concurrent senders æœ‰å¤šä¸ªå¹¶å‘å†™çš„ç”Ÿäº§è€…æ—¶ä¹Ÿåˆ«å…³<br>åªè¦éµå¾ªè¿™ä¸¤æ¡åŸåˆ™ï¼Œå°±èƒ½é¿å…ä¸¤ç§ panic çš„åœºæ™¯ï¼Œå³ï¼šå‘ closed chan å‘é€æ•°æ®ï¼Œæˆ–è€…æ˜¯ close ä¸€ä¸ª closed chanã€‚<br>æŒ‰ç…§ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»å¯ä»¥æ‹†è§£æˆä»¥ä¸‹å‡ ç±»æƒ…å†µï¼š</li><li>ä¸€å†™ä¸€è¯»ï¼šç”Ÿäº§è€…å…³é—­å³å¯</li><li>ä¸€å†™å¤šè¯»ï¼šç”Ÿäº§è€…å…³é—­å³å¯ï¼Œå…³é—­æ—¶ä¸‹æ¸¸å…¨éƒ¨æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°é€šçŸ¥</li><li>å¤šå†™ä¸€è¯»ï¼šå¤šä¸ªç”Ÿäº§è€…ä¹‹é—´éœ€è¦å¼•å…¥ä¸€ä¸ªåè°ƒ channel æ¥å¤„ç†ä¿¡å·</li><li>å¤šå†™å¤šè¯»ï¼šä¸ 3 ç±»ä¼¼ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å¼•å…¥ä¸€ä¸ªä¸­é—´å±‚ä»¥åŠä½¿ç”¨ try-send çš„å¥—è·¯æ¥å¤„ç†éé˜»å¡çš„å†™å…¥.</li></ul><h2 id="5-åŸç†è§£æ"><a href="#5-åŸç†è§£æ" class="headerlink" title="5. åŸç†è§£æ"></a>5. åŸç†è§£æ</h2><h3 id="5-1-åº•å±‚ç»“æ„"><a href="#5-1-åº•å±‚ç»“æ„" class="headerlink" title="5.1 åº•å±‚ç»“æ„"></a>5.1 åº•å±‚ç»“æ„</h3><p>channelåº•å±‚æ˜¯ä½äºgo&#x2F;src&#x2F;runtime&#x2F;chan.goæ–‡ä»¶ä¸­çš„hchanç»“æ„ä½“</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// runtime package, chan.go</span><br><span class="hljs-keyword">type</span> hchan <span class="hljs-keyword">struct</span> &#123;<br>    qcount   <span class="hljs-type">uint</span>            <span class="hljs-comment">// é€šé“é‡Œå·²æœ‰å…ƒç´ çš„æ•°é‡</span><br>    dataqsiz <span class="hljs-type">uint</span>            <span class="hljs-comment">// é€šé“buffer(ç¯å½¢é˜Ÿåˆ—)çš„å®¹é‡</span><br>    buf      unsafe.Pointer  <span class="hljs-comment">// æŒ‡å‘bufferå†…å­˜çš„æŒ‡é’ˆï¼ˆåªé’ˆå¯¹æœ‰ç¼“å†²çš„ chanï¼‰</span><br>    elemsize <span class="hljs-type">uint16</span>          <span class="hljs-comment">// é€šé“ä¸­å…ƒç´ å¤§å°</span><br>    closed   <span class="hljs-type">uint32</span>          <span class="hljs-comment">// é€šé“æ˜¯å¦è¢«å…³é—­çš„æ ‡å¿—ã€‚0ï¼šæœªå…³é—­ï¼Œé0ï¼šå…³é—­ã€‚</span><br>    elemtype *_type          <span class="hljs-comment">// é€šé“ä¸­å…ƒç´ ç±»å‹</span><br>    sendx    <span class="hljs-type">uint</span>            <span class="hljs-comment">// é€šé“å†™æ—¶ï¼Œå†™åˆ°chan bufferä¸­çš„ä½ç½®çš„ç´¢å¼•</span><br>    recvx    <span class="hljs-type">uint</span>            <span class="hljs-comment">// é€šé“è¯»æ—¶ï¼Œè¯»çš„å…ƒç´ åœ¨é€šé“ä¸­çš„ä½ç½®çš„ç´¢å¼•</span><br>    recvq    waitq           <span class="hljs-comment">// å› ä¸ºé€šé“è¯»è€Œé˜»å¡çš„åç¨‹é˜Ÿåˆ—</span><br>    sendq    waitq           <span class="hljs-comment">// å› ä¸ºé€šé“å†™è€Œé˜»å¡çš„åç¨‹é˜Ÿåˆ—</span><br>    lock     mutex           <span class="hljs-comment">// äº’æ–¥é”ï¼Œä¿è¯é€šé“è¯»å†™çº¿ç¨‹å®‰å…¨</span><br>&#125;<br><br><span class="hljs-comment">// waitq æ˜¯ sudog çš„ä¸€ä¸ªåŒå‘é“¾è¡¨</span><br><span class="hljs-keyword">type</span> waitq <span class="hljs-keyword">struct</span> &#123;<br>   first *sudog<br>   last  *sudog<br>&#125;<br><br><span class="hljs-comment">// runtime/runtime2.go</span><br><span class="hljs-comment">// sudogæ˜¯å¯¹goçš„ä¸€ä¸ªå°è£…</span><br><span class="hljs-keyword">type</span> sudog <span class="hljs-keyword">struct</span> &#123;<br>    g       *g              <span class="hljs-comment">// é˜»å¡çš„ goroutine</span><br>    elem    unsafe.Pointer  <span class="hljs-comment">// elemç”¨æ¥å­˜å‚¨senderå‘é€æ•°æ®çš„åœ°å€æˆ–recveræ¥æ”¶å˜é‡çš„åœ°å€</span><br>    c       *hchan          <span class="hljs-comment">// é˜»å¡çš„ channel</span><br>    next     *sudog         <br>    prev     *sudog<br>    <span class="hljs-comment">// other fields...</span><br>&#125;<br><br>ch &lt;- <span class="hljs-number">1</span>            <span class="hljs-comment">// å› ä¸ºâ€œå†™â€è€Œé˜»å¡çš„goroutineçš„elemå­˜çš„æ˜¯â€œ1â€çš„åœ°å€</span><br>val, ok := &lt;- ch   <span class="hljs-comment">// å› ä¸ºâ€œè¯»â€è€Œé˜»å¡çš„goroutineçš„elemå­˜çš„æ˜¯â€œvalâ€çš„åœ°å€</span><br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªchannelçš„ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">4</span>)<br><span class="hljs-comment">// æœªé˜»å¡</span><br>ch &lt;- <span class="hljs-number">1</span><br>ch &lt;- <span class="hljs-number">2</span><br>ch &lt;- <span class="hljs-number">3</span><br><span class="hljs-comment">// å‘ç”Ÿé˜»å¡</span><br>ch &lt;- <span class="hljs-number">4</span><br>ch &lt;- <span class="hljs-number">5</span><br>ch &lt;- <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><p><img src="/img/golang-channels/5.png"><br><img src="/img/golang-channels/6.png"> </p><h3 id="5-2-Channelçš„åˆ›å»º"><a href="#5-2-Channelçš„åˆ›å»º" class="headerlink" title="5.2 Channelçš„åˆ›å»º"></a>5.2 Channelçš„åˆ›å»º</h3><p>channelçš„åˆ›å»ºéœ€è¦ä½¿ç”¨makeå…³é”®å­—ï¼Œé€šè¿‡make(type, size)æ¥åˆ›å»ºå„ç§ç±»å‹çš„é€šé“</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">a := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)            <span class="hljs-comment">// unbuffered channel of integers</span><br>b := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">0</span>)         <span class="hljs-comment">// unbuffered channel of integers</span><br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *os.File, <span class="hljs-number">100</span>)  <span class="hljs-comment">// buffered channel of pointers to Files</span><br><br>write := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>)        <span class="hljs-comment">// channel of integers only for writing</span><br>read := <span class="hljs-built_in">make</span>(&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)         <span class="hljs-comment">// channel of integers only for reading</span><br></code></pre></td></tr></table></figure><p>channelåˆå§‹åŒ–æ—¶åˆ†ä¸ºç¼“å†²å‹å’Œéç¼“å†²å‹ä¸¤ç§ï¼ŒäºŒè€…æœ€å¤§çš„åŒºåˆ«æ˜¯ç¼“å†²å‹channelåœ¨åˆå§‹åŒ–æ—¶ä¼šåˆ†é…ring bufï¼Œåº•å±‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚åœ¨åˆ†é…ç¼“å†²bufæ—¶ï¼Œå¦‚æœå…ƒç´ åŒ…å«æŒ‡é’ˆç±»å‹ï¼Œbufå’Œhchanåœ°å€æ˜¯ä¸è¿ç»­çš„ï¼Œå¦åˆ™å°±æ˜¯è¿ç»­çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makechan</span><span class="hljs-params">(t *chantype, size <span class="hljs-type">int</span>)</span></span> *hchan &#123;<br>elem := t.elem<br><br><span class="hljs-comment">// compiler checks this but be safe.</span><br><span class="hljs-keyword">if</span> elem.size &gt;= <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">16</span> &#123;<br>throw(<span class="hljs-string">&quot;makechan: invalid channel element type&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> hchanSize%maxAlign != <span class="hljs-number">0</span> || elem.align &gt; maxAlign &#123;<br>throw(<span class="hljs-string">&quot;makechan: bad alignment&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—ç¼“å†²åŒºéœ€è¦çš„æ€»å¤§å°ï¼ˆç¼“å†²åŒºå¤§å°*å…ƒç´ å¤§å°ï¼‰ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦è¶…å‡ºæœ€å¤§å¯åˆ†é…èŒƒå›´</span><br><span class="hljs-comment">// å¦‚æœæ˜¯éç¼“å†²é€šé“æˆ–è€…æ˜¯é€šé“å…ƒç´ çš„sizeä¸º0ï¼ˆæ¯”å¦‚struct&#123;&#125;ï¼‰ï¼Œé‚£ä¹ˆmemå°±æ˜¯0</span><br>mem, overflow := math.MulUintptr(elem.size, <span class="hljs-type">uintptr</span>(size))<br><span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc-hchanSize || size &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;makechan: size out of range&quot;</span>))<br>&#125;<br><br><span class="hljs-comment">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.</span><br><span class="hljs-comment">// buf points into the same allocation, elemtype is persistent.</span><br><span class="hljs-comment">// SudoG&#x27;s are referenced from their owning thread so they can&#x27;t be collected.</span><br><span class="hljs-comment">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.</span><br><span class="hljs-keyword">var</span> c *hchan<br><span class="hljs-keyword">switch</span> &#123;<br><span class="hljs-keyword">case</span> mem == <span class="hljs-number">0</span>:<br><span class="hljs-comment">// ç¼“å†²åŒºå¤§å°ä¸º0ï¼Œæˆ–è€…channelä¸­å…ƒç´ å¤§å°ä¸º0ï¼ˆstruct&#123;&#125;&#123;&#125;ï¼‰æ—¶ï¼Œåªéœ€åˆ†é…channelå¿…éœ€çš„ç©ºé—´å³å¯;ä¸åˆ†é…ç¼“å†²åŒºçš„å†…å­˜</span><br><span class="hljs-comment">// Queue or element size is zero.</span><br>c = (*hchan)(mallocgc(hchanSize, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>))<br><span class="hljs-comment">// Race detector uses this location for synchronization.</span><br><span class="hljs-comment">// bufæŒ‡é’ˆæ— å®é™…æ„ä¹‰</span><br>c.buf = c.raceaddr()<br><span class="hljs-keyword">case</span> elem.ptrdata == <span class="hljs-number">0</span>:<br><span class="hljs-comment">// channelä¸­å…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆï¼Œåˆ†é…ä¸€ç‰‡è¿ç»­å†…å­˜ç©ºé—´ï¼Œæ‰€éœ€ç©ºé—´ç­‰äº ç¼“å†²åŒºæ•°ç»„ç©ºé—´ + hchanå¿…éœ€çš„ç©ºé—´ã€‚</span><br><span class="hljs-comment">// Elements do not contain pointers.</span><br><span class="hljs-comment">// Allocate hchan and buf in one call.</span><br>c = (*hchan)(mallocgc(hchanSize+mem, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>))<br><span class="hljs-comment">// // bufæŒ‡å‘äº†ç¼“å†²åŒºå†…å­˜çš„é¦–åœ°å€</span><br>c.buf = add(unsafe.Pointer(c), hchanSize)<br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">// Elements contain pointers.</span><br><span class="hljs-comment">// å…ƒç´ åŒ…å«æŒ‡é’ˆæ—¶ åˆ†åˆ«åˆ†é… chan å’Œ buf çš„å†…å­˜</span><br>c = <span class="hljs-built_in">new</span>(hchan)<br>c.buf = mallocgc(mem, elem, <span class="hljs-literal">true</span>)<br>&#125;<br><br><span class="hljs-comment">// å…¶ä»–å­—æ®µè®¾ç½®</span><br>c.elemsize = <span class="hljs-type">uint16</span>(elem.size)<br>c.elemtype = elem<br>c.dataqsiz = <span class="hljs-type">uint</span>(size)<br>lockInit(&amp;c.lock, lockRankHchan)<br><br><span class="hljs-keyword">if</span> debugChan &#123;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;makechan: chan=&quot;</span>, c, <span class="hljs-string">&quot;; elemsize=&quot;</span>, elem.size, <span class="hljs-string">&quot;; dataqsiz=&quot;</span>, size, <span class="hljs-string">&quot;\n&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> c<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä½“é€»è¾‘è¾ƒä¸ºæ¸…æ™°ï¼š</p><ul><li>é¦–å…ˆæ ¡éªŒå…ƒç´ ç±»å‹å’Œç¼“å†²åŒºç©ºé—´å¤§å°ï¼Œç„¶ååˆ›å»ºhchanï¼Œåˆ†é…æ‰€éœ€ç©ºé—´ã€‚</li><li>è¿™é‡Œæœ‰ä¸‰ç§æƒ…å†µï¼š<ul><li>å½“ç¼“å†²åŒºå¤§å°ä¸º0ï¼Œæˆ–è€…channelä¸­å…ƒç´ å¤§å°ä¸º0æ—¶ï¼Œåªéœ€åˆ†é…channelå¿…éœ€çš„ç©ºé—´å³å¯ï¼›</li><li>å½“channelå…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆæ—¶ï¼Œåˆ™åªéœ€è¦ä¸ºhchanå’Œç¼“å†²åŒºåˆ†é…ä¸€ç‰‡è¿ç»­å†…å­˜ç©ºé—´ï¼Œç©ºé—´å¤§å°ä¸ºç¼“å†²åŒºæ•°ç»„ç©ºé—´åŠ ä¸Šhchanå¿…éœ€çš„ç©ºé—´ï¼›</li><li>é»˜è®¤æƒ…å†µï¼Œç¼“å†²åŒºåŒ…å«æŒ‡é’ˆï¼Œåˆ™éœ€è¦ä¸ºhchanå’Œç¼“å†²åŒºåˆ†åˆ«åˆ†é…å†…å­˜ã€‚</li></ul></li><li>æœ€åæ›´æ–°hchançš„å…¶ä»–å­—æ®µï¼ŒåŒ…æ‹¬elemsizeï¼Œelemtypeï¼Œdataqsizã€‚</li></ul><h3 id="5-3-å‘Channelå‘é€æ•°æ®"><a href="#5-3-å‘Channelå‘é€æ•°æ®" class="headerlink" title="5.3 å‘Channelå‘é€æ•°æ®"></a>5.3 å‘Channelå‘é€æ•°æ®</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>ch &lt;- <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>é€šé“å†™æ“ä½œä¼šè°ƒç”¨chansendå‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>, callerpc <span class="hljs-type">uintptr</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-comment">// channelä¸ºç©ºçš„åœºæ™¯ä¸‹ï¼Œå¦‚æœæ˜¯éé˜»å¡ï¼Œç›´æ¥è¿”å›å‘é€å¤±è´¥ï¼Œå¦‚æœæ˜¯é˜»å¡åœºæ™¯ä¸‹ï¼Œå°†å½“å‰åç¨‹æŒ‚èµ·é˜»å¡</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !block &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonChanSendNilChan, traceEvGoStop, <span class="hljs-number">2</span>)<br>throw(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">if</span> debugChan &#123;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;chansend: chan=&quot;</span>, c, <span class="hljs-string">&quot;\n&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>racereadpc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(chansend))<br>&#125;<br><br><span class="hljs-comment">// Fast path: check for failed non-blocking operation without acquiring the lock.</span><br><span class="hljs-comment">// å¯¹äºéé˜»å¡é˜Ÿåˆ—ä¸”channelæœªå…³é—­ã€å¦‚æœæ— ç¼“å†²åŒºä¸”æ²¡æœ‰ç­‰å¾…çš„æ¥æ”¶è€…æˆ–è€…æ¢å†²åŒºå·²æ»¡éƒ½ç›´æ¥è¿”å›false</span><br><span class="hljs-keyword">if</span> !block &amp;&amp; c.closed == <span class="hljs-number">0</span> &amp;&amp; full(c) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯é˜»å¡é˜Ÿåˆ—ï¼Œä¸»è¦çœ‹ä¸‹é¢çš„é€»è¾‘</span><br><br><span class="hljs-keyword">var</span> t0 <span class="hljs-type">int64</span><br><span class="hljs-keyword">if</span> blockprofilerate &gt; <span class="hljs-number">0</span> &#123;<br>t0 = cputicks()<br>&#125;<br><span class="hljs-comment">// åŠ é”ï¼Œä¿è¯åç¨‹å¹¶å‘å®‰å…¨</span><br>lock(&amp;c.lock)<br><span class="hljs-comment">// å¦‚æœchannelå·²å…³é—­ï¼Œç›´æ¥panic</span><br><span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;send on closed channel&quot;</span>))<br>&#125;<br><br><span class="hljs-comment">// é¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ç­‰å¾…æ¥æ”¶è€…</span><br><span class="hljs-keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// Found a waiting receiver. We pass the value we want to send</span><br><span class="hljs-comment">// directly to the receiver, bypassing the channel buffer (if any).</span><br><span class="hljs-comment">// æœ‰ç­‰å¾…æ¥æ”¶è€…çš„æ—¶å€™åˆ†ä¸¤ç§æƒ…å†µï¼Œæ— ç¼“å†²é˜Ÿåˆ—æˆ–è€…æ˜¯ç¼“å†²é˜Ÿåˆ—ä¸ºç©º</span><br><span class="hljs-comment">// è¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¯ç›´æ¥å”¤é†’ç­‰å¾…çš„åç¨‹ï¼Œç›´æ¥å°†æ•°æ®ç»™ç­‰å¾…è€…</span><br>send(c, sg, ep, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="hljs-number">3</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// å¦‚æœå½“å‰bufä¸­çš„æ•°é‡å°äºå®¹é‡ï¼Œè¯´æ˜è¿˜æœ‰ç©ºé—´ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥bufï¼Œå¹¶æ›´æ–°sendxå’Œqcountç­‰å­—æ®µ</span><br><span class="hljs-keyword">if</span> c.qcount &lt; c.dataqsiz &#123;<br><span class="hljs-comment">// Space is available in the channel buffer. Enqueue the element to send.</span><br>qp := chanbuf(c, c.sendx)<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>racenotify(c, c.sendx, <span class="hljs-literal">nil</span>)<br>&#125;<br>typedmemmove(c.elemtype, qp, ep)<br><span class="hljs-comment">// ç´¢å¼•æ›´æ–°åŠç¯å½¢é˜Ÿåˆ—å¤„ç†</span><br>c.sendx++<br><span class="hljs-keyword">if</span> c.sendx == c.dataqsiz &#123;<br>c.sendx = <span class="hljs-number">0</span><br>&#125;<br>c.qcount++<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-keyword">if</span> !block &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// Block on the channel. Some receiver will complete our operation for us.</span><br><span class="hljs-comment">// å¦‚æœé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œåˆ™éœ€è¦æ„é€ ä¸€ä¸ªsudogï¼Œå°†å‘é€åç¨‹åŠ å…¥å‘é€è€…é˜Ÿåˆ—</span><br>gp := getg()<br>mysg := acquireSudog()<br>mysg.releasetime = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> t0 != <span class="hljs-number">0</span> &#123;<br>mysg.releasetime = <span class="hljs-number">-1</span><br>&#125;<br><span class="hljs-comment">// No stack splits between assigning elem and enqueuing mysg</span><br><span class="hljs-comment">// on gp.waiting where copystack can find it.</span><br>mysg.elem = ep<br>mysg.waitlink = <span class="hljs-literal">nil</span><br>mysg.g = gp<br>mysg.isSelect = <span class="hljs-literal">false</span><br>mysg.c = c<br>gp.waiting = mysg<br>gp.param = <span class="hljs-literal">nil</span><br><span class="hljs-comment">// å½“å‰ goroutine è¿›å…¥å‘é€ç­‰å¾…é˜Ÿåˆ—</span><br>c.sendq.enqueue(mysg)<br><span class="hljs-comment">// æŒ‚èµ·åç¨‹</span><br>gp.parkingOnChan.Store(<span class="hljs-literal">true</span>)<br>gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, <span class="hljs-number">2</span>)<br><span class="hljs-comment">// Ensure the value being sent is kept alive until the</span><br><span class="hljs-comment">// receiver copies it out. The sudog has a pointer to the</span><br><span class="hljs-comment">// stack object, but sudogs aren&#x27;t considered as roots of the</span><br><span class="hljs-comment">// stack tracer.</span><br>KeepAlive(ep)<br><br><span class="hljs-comment">// someone woke us up.</span><br><span class="hljs-comment">// å¦‚æœåç¨‹è¢«å”¤é†’äº†ï¼Œè¯´æ˜æ•°æ®ä¼šè¢«è¯»å–èµ°ï¼›åç»­æ‰§è¡Œæ¸…ç†å·¥ä½œå¹¶é‡Šæ”¾sudogç»“æ„ä½“</span><br><span class="hljs-keyword">if</span> mysg != gp.waiting &#123;<br>throw(<span class="hljs-string">&quot;G waiting list is corrupted&quot;</span>)<br>&#125;<br>gp.waiting = <span class="hljs-literal">nil</span><br>gp.activeStackChans = <span class="hljs-literal">false</span><br>closed := !mysg.success<br>gp.param = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">if</span> mysg.releasetime &gt; <span class="hljs-number">0</span> &#123;<br>blockevent(mysg.releasetime-t0, <span class="hljs-number">2</span>)<br>&#125;<br>mysg.c = <span class="hljs-literal">nil</span><br>releaseSudog(mysg)<br><span class="hljs-keyword">if</span> closed &#123;<br><span class="hljs-keyword">if</span> c.closed == <span class="hljs-number">0</span> &#123;<br>throw(<span class="hljs-string">&quot;chansend: spurious wakeup&quot;</span>)<br>&#125;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;send on closed channel&quot;</span>))<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦æµç¨‹åˆ†ä¸‰ç§æƒ…å†µï¼š</p><ul><li>å­˜åœ¨ç­‰å¾…æ¥æ”¶çš„åç¨‹ï¼šè¯´æ˜æ— ç¼“å†²æˆ–è€…ç¼“å†²ä¸ºç©ºï¼Œç›´æ¥æŠŠæ•°æ®ç»™æ¥æ”¶è€…</li><li>æ²¡æœ‰ç­‰å¾…çš„æ¥æ”¶è€…ä¸”bufæœªæ»¡ï¼šæŠŠæ•°æ®æ”¾å…¥bufæœ«å°¾</li><li>æ²¡æœ‰ç­‰å¾…çš„æ¥æ”¶è€…ä¸”bufæ»¡äº†ï¼šå°†å‘é€è€…åŠ å…¥å‘é€ç­‰å¾…é˜Ÿåˆ—<br><img src="/img/golang-channels/7.png"></li></ul><h3 id="5-4-ä»Channelæ¥æ”¶æ•°æ®"><a href="#5-4-ä»Channelæ¥æ”¶æ•°æ®" class="headerlink" title="5.4 ä»Channelæ¥æ”¶æ•°æ®"></a>5.4 ä»Channelæ¥æ”¶æ•°æ®</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>value := &lt;- ch <span class="hljs-comment">// ä¸€ä¸ªæ¥æ”¶å€¼</span><br>value, ok := &lt;- ch <span class="hljs-comment">// ä¸¤ä¸ªæ¥æ”¶å€¼</span><br></code></pre></td></tr></table></figure><ul><li>ç¬¬3è¡Œä¸­ï¼Œç¬¬äºŒä¸ªæ¥æ”¶å€¼â€œokâ€è¡¨ç¤ºvalueæ˜¯å¦æ˜¯æœ‰æ•ˆæ•°æ®ï¼Œå³valueçš„å€¼æ˜¯å¦æ¥è‡ªsenderå‘é€çš„æ•°æ®ã€‚<br>ğŸ“Œ <blockquote><p>å¯ä»¥é€šè¿‡â€œokâ€æ¥åˆ¤æ–­chanæ˜¯å¦å…³é—­ï¼Œå³ok&#x3D;falseï¼Œåˆ™chanå…³é—­ã€‚ä½†ä¸èƒ½è®¤ä¸ºok&#x3D;trueï¼Œchanå°±æœªå…³é—­ï¼Œå› ä¸ºåœ¨æŸäº›chanå·²ç»å…³é—­çš„æƒ…å†µä¸‹ï¼ˆå¦‚chançš„bufferä¸­æœ‰æ•°æ®ï¼‰ï¼Œâ€œokâ€ä¾ç„¶æ˜¯trueã€‚<br>  å½“ok&#x3D;trueæ—¶ï¼Œchanå¯èƒ½å…³é—­æˆ–æœªå…³é—­ï¼›å½“ok&#x3D;falseæ—¶ï¼Œchanä¸€å®šæ˜¯å…³é—­äº†ã€‚</p></blockquote></li></ul><p>æ¥æ”¶æ•°æ®æ—¶ï¼Œæ ¸å¿ƒè°ƒç”¨çš„æ˜¯ chanrecvå‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-comment">// epï¼šç”¨æ¥æ¥æ”¶æ•°æ®çš„åœ°å€ã€‚å¦‚æœ ep æ˜¯ nilï¼Œè¯´æ˜å¿½ç•¥äº†æ¥æ”¶å€¼(-)ã€‚</span><br><span class="hljs-comment">// blockè¡¨ç¤ºé€šé“æ˜¯å¦æ˜¯é˜»å¡æ¨¡å¼ï¼Œæˆ‘ä»¬åˆ›å»ºçš„é€šé“éƒ½æ˜¯é˜»å¡æ¨¡å¼ï¼Œä¸‹é¢ä»£ç ä¸è€ƒè™‘éé˜»å¡æ¨¡å¼</span><br><span class="hljs-comment">// receivedè¡¨ç¤ºæ¥æ”¶åˆ°çš„æ˜¯å¦æ˜¯æœ‰æ•ˆæ•°æ®ï¼Œå³senderå‘é€çš„æ•°æ®ã€‚</span><br><span class="hljs-keyword">if</span> debugChan &#123;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;chanrecv: chan=&quot;</span>, c, <span class="hljs-string">&quot;\n&quot;</span>)<br>&#125;<br><span class="hljs-comment">// channelä¸ºç©ºåœºæ™¯ä¸‹ï¼Œå¦‚æœéé˜»å¡é˜Ÿåˆ—ç›´æ¥è¿”å›falseï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—ï¼Œç›´æ¥æŒ‚èµ·ç­‰å¾…</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> !block &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonChanReceiveNilChan, traceEvGoStop, <span class="hljs-number">2</span>)<br>throw(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// Fast path: check for failed non-blocking operation without acquiring the lock.</span><br><span class="hljs-comment">// éé˜»å¡æ¨¡å¼ä¸‹çš„å¿«é€Ÿé€€å‡ºåœºæ™¯ï¼Œä¸€èˆ¬æ— éœ€å…³æ³¨</span><br><span class="hljs-keyword">if</span> !block &amp;&amp; empty(c) &#123;<br><span class="hljs-keyword">if</span> atomic.Load(&amp;c.closed) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> empty(c) &#123;<br><span class="hljs-comment">// The channel is irreversibly closed and empty.</span><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>raceacquire(c.raceaddr())<br>&#125;<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemclr(c.elemtype, ep)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> t0 <span class="hljs-type">int64</span><br><span class="hljs-keyword">if</span> blockprofilerate &gt; <span class="hljs-number">0</span> &#123;<br>t0 = cputicks()<br>&#125;<br><br><span class="hljs-comment">// åŠ é” ä¿è¯åç¨‹å¹¶å‘å®‰å…¨æ€§</span><br>lock(&amp;c.lock)<br><br><br><span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// å¦‚æœchannelå·²ç»å…³é—­ä¸”ç¼“å†²åŒºæ— å…ƒç´ </span><br><span class="hljs-keyword">if</span> c.qcount == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>raceacquire(c.raceaddr())<br>&#125;<br>unlock(&amp;c.lock)<br><span class="hljs-comment">// ç»™epä¸€ä¸ªé›¶å€¼</span><br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemclr(c.elemtype, ep)<br>&#125;<br><span class="hljs-comment">// è¿”å›ï¼ˆtrue, falseï¼‰ï¼Œå³æ¥æ”¶åˆ°å€¼ï¼Œä½†ä¸æ˜¯ä»channelä¸­æ¥æ”¶çš„æœ‰æ•ˆå€¼</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// The channel has been closed, but the channel&#x27;s buffer have data.</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Just found waiting sender with not closed.</span><br><span class="hljs-comment">// å¸¸è§„æƒ…å†µ1: æœ‰ç­‰å¾…å‘é€çš„é˜Ÿåˆ—</span><br>        <span class="hljs-comment">// æœ‰ç­‰å¾…å‘é€çš„é˜Ÿåˆ—æ—¶ï¼Œè¯´æ˜æœ‰ä¸¤ç§æƒ…å†µï¼šéç¼“å†²é˜Ÿåˆ—æˆ–è€…ç¼“å†²å·²æ»¡ï¼›</span><br><span class="hljs-comment">// å¯¹äºéç¼“å†²æƒ…å†µï¼Œç›´æ¥ä»senderæ¥æ”¶æ•°æ®</span><br><span class="hljs-comment">// å¯¹äºç¼“å†²å·²æ»¡æƒ…å†µï¼Œä»bufé˜Ÿåˆ—å¤´éƒ¨æ¥æ”¶æ•°æ®ï¼Œå¹¶å°†senderæ•°æ®åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span><br><span class="hljs-keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// Found a waiting sender. If buffer is size 0, receive value</span><br><span class="hljs-comment">// directly from sender. Otherwise, receive from head of queue</span><br><span class="hljs-comment">// and add sender&#x27;s value to the tail of the queue (both map to</span><br><span class="hljs-comment">// the same buffer slot because the queue is full).</span><br>recv(c, sg, ep, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="hljs-number">3</span>)<br><span class="hljs-comment">// æ¥æ”¶æˆåŠŸ</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// å¸¸è§„æƒ…å†µ2: æ— ç­‰å¾…å‘é€é˜Ÿåˆ—ï¼Œä¸”bufæœ‰å€¼ï¼›</span><br><span class="hljs-comment">// ç›´æ¥ä»recvxå–æ•°æ®å³å¯ï¼Œå¹¶æ›´æ–°recvxå’Œqcountçš„å€¼</span><br><span class="hljs-keyword">if</span> c.qcount &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// Receive directly from queue</span><br>qp := chanbuf(c, c.recvx)<br><span class="hljs-keyword">if</span> raceenabled &#123;<br>racenotify(c, c.recvx, <span class="hljs-literal">nil</span>)<br>&#125;<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemmove(c.elemtype, ep, qp)<br>&#125;<br>typedmemclr(c.elemtype, qp)<br>c.recvx++<br><span class="hljs-keyword">if</span> c.recvx == c.dataqsiz &#123;<br>c.recvx = <span class="hljs-number">0</span><br>&#125;<br>c.qcount--<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-comment">// éé˜»å¡æ¨¡å¼ï¼Œæ²¡æœ‰æ•°æ®ï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> !block &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// é˜»å¡æ¨¡å¼ï¼Œæ²¡æœ‰æ•°æ®ï¼Œåˆ™æŒ‚èµ·åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸­</span><br><span class="hljs-comment">// no sender available: block on this channel.</span><br>gp := getg()<br>mysg := acquireSudog()<br>mysg.releasetime = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> t0 != <span class="hljs-number">0</span> &#123;<br>mysg.releasetime = <span class="hljs-number">-1</span><br>&#125;<br><span class="hljs-comment">// No stack splits between assigning elem and enqueuing mysg</span><br><span class="hljs-comment">// on gp.waiting where copystack can find it.</span><br>mysg.elem = ep<br>mysg.waitlink = <span class="hljs-literal">nil</span><br>gp.waiting = mysg<br>mysg.g = gp<br>mysg.isSelect = <span class="hljs-literal">false</span><br>mysg.c = c<br>gp.param = <span class="hljs-literal">nil</span><br>    <span class="hljs-comment">// åŠ å…¥åˆ°channelçš„ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—recvqä¸­</span><br>c.recvq.enqueue(mysg)<br><span class="hljs-comment">// stack shrinking.</span><br>gp.parkingOnChan.Store(<span class="hljs-literal">true</span>)<br>gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, <span class="hljs-number">2</span>)<br><br><span class="hljs-comment">// someone woke us up</span><br><span class="hljs-comment">// è¢«å”¤é†’ä¹‹åæ‰§è¡Œæ¸…ç†å·¥ä½œå¹¶é‡Šæ”¾sudogç»“æ„ä½“</span><br><span class="hljs-keyword">if</span> mysg != gp.waiting &#123;<br>throw(<span class="hljs-string">&quot;G waiting list is corrupted&quot;</span>)<br>&#125;<br>gp.waiting = <span class="hljs-literal">nil</span><br>gp.activeStackChans = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> mysg.releasetime &gt; <span class="hljs-number">0</span> &#123;<br>blockevent(mysg.releasetime-t0, <span class="hljs-number">2</span>)<br>&#125;<br>success := mysg.success<br>gp.param = <span class="hljs-literal">nil</span><br>mysg.c = <span class="hljs-literal">nil</span><br>releaseSudog(mysg)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, success<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ•´ä¸ªè¯»å–æ•°æ®çš„æµç¨‹ä¸­ï¼Œå’Œå‘é€æ•°æ®çš„æµç¨‹éå¸¸ç›¸ä¼¼ï¼Œä¸»è¦åˆ†ä¸º3ç§æƒ…å†µ</p><ul><li>å­˜åœ¨ç­‰å¾…å‘é€çš„åç¨‹ï¼šè¿™ç§åœºæ™¯è¯´æ˜æ— ç¼“å†²é€šé“æˆ–è€…ç¼“å†²bufå·²æ»¡<ul><li>å¦‚æœæ— ç¼“å†²åŒºï¼Œé‚£ä¹ˆç›´æ¥ä»senderæ¥æ”¶æ•°æ®ï¼› </li><li>å¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œä»bufé˜Ÿåˆ—çš„å¤´éƒ¨æ¥æ”¶æ•°æ®ï¼Œå¹¶æŠŠsenderçš„æ•°æ®åŠ åˆ°bufé˜Ÿåˆ—çš„å°¾éƒ¨ï¼› </li><li>æœ€åè°ƒç”¨goreadyå‡½æ•°å°†ç­‰å¾…å‘é€æ•°æ®çš„Goroutineçš„çŠ¶æ€ä»_Gwaitingç½®ä¸º_Grunnableï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒåº¦ã€‚</li></ul></li><li>æ²¡æœ‰ç­‰å¾…å‘é€çš„åç¨‹ä¸”bufå­˜åœ¨æ•°æ®ï¼Œç›´æ¥ä»bufä¸­å–æ•°æ®ã€‚</li><li>æ²¡æœ‰ç­‰å¾…å‘é€çš„åç¨‹ä¸”æ— æ•°æ®ï¼Œæ¥æ”¶è€…æŒ‚èµ·åŠ å…¥æ¥æ”¶è€…é˜Ÿåˆ—ã€‚<br><img src="/img/golang-channels/8.png"></li></ul><h3 id="5-5-å…³é—­Channel"><a href="#5-5-å…³é—­Channel" class="headerlink" title="5.5 å…³é—­Channel"></a>5.5 å…³é—­Channel</h3><p>æ”¶å‘å®Œæ•°æ®åï¼Œå°±æ˜¯å¯¹channelçš„å…³é—­æ“ä½œï¼Œå…³é—­æ“ä½œä¸»è¦æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p><ul><li>éå†recvqå’Œsendqï¼ˆå®é™…åªæœ‰recvqæˆ–è€…sendqï¼‰ï¼Œå–å‡ºsudogä¸­æŒ‚èµ·çš„GoroutineåŠ å…¥åˆ°gliståˆ—è¡¨ä¸­ï¼Œå¹¶æ¸…é™¤sudogä¸Šçš„ä¸€äº›ä¿¡æ¯å’ŒçŠ¶æ€ã€‚</li><li>éå†gliståˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªGoroutineè°ƒç”¨goreadyå‡½æ•°ï¼Œå°†æ‰€æœ‰Goroutineç½®ä¸º_GrunnableçŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦ã€‚</li><li>å½“Goroutineè¢«å”¤é†’ä¹‹åï¼Œä¼šç»§ç»­æ‰§è¡Œchansendå’Œchanrecvå‡½æ•°ä¸­å½“å‰Goroutineè¢«å”¤é†’åçš„å‰©ä½™é€»è¾‘ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">closechan</span><span class="hljs-params">(c *hchan)</span></span> &#123;<br><span class="hljs-comment">// å…³é—­ nil channelï¼Œpanic</span><br><span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;close of nil channel&quot;</span>))<br>&#125;<br><br>lock(&amp;c.lock)<br><span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>unlock(&amp;c.lock)<br><span class="hljs-comment">// å…³é—­closed channelï¼Œpanic</span><br><span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;close of closed channel&quot;</span>))<br>&#125;<br><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>callerpc := getcallerpc()<br>racewritepc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(closechan))<br>racerelease(c.raceaddr())<br>&#125;<br><span class="hljs-comment">// è®¾ç½®ä¸ºå…³é—­çŠ¶æ€</span><br>c.closed = <span class="hljs-number">1</span><br><br><span class="hljs-keyword">var</span> glist gList<br><br><span class="hljs-comment">// release all readers</span><br><span class="hljs-comment">// éå†recvqï¼Œæ¸…é™¤sudogçš„æ•°æ®ï¼Œå–å‡ºå…¶ä¸­å¤„äº_GwaitingçŠ¶æ€çš„GoroutineåŠ å…¥åˆ°glistä¸­</span><br><span class="hljs-keyword">for</span> &#123;<br>sg := c.recvq.dequeue()<br><span class="hljs-keyword">if</span> sg == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><span class="hljs-keyword">if</span> sg.elem != <span class="hljs-literal">nil</span> &#123;<br>typedmemclr(c.elemtype, sg.elem)<br>sg.elem = <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">if</span> sg.releasetime != <span class="hljs-number">0</span> &#123;<br>sg.releasetime = cputicks()<br>&#125;<br>gp := sg.g<br>gp.param = unsafe.Pointer(sg)<br>sg.success = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>raceacquireg(gp, c.raceaddr())<br>&#125;<br>glist.push(gp)<br>&#125;<br><br><span class="hljs-comment">// release all writers (they will panic)</span><br><span class="hljs-comment">// éå†sendqï¼Œæ¸…é™¤sudogçš„æ•°æ®ï¼Œå–å‡ºå…¶ä¸­å¤„äº_GwaitingçŠ¶æ€çš„GoroutineåŠ å…¥åˆ°glistä¸­</span><br><span class="hljs-keyword">for</span> &#123;<br>sg := c.sendq.dequeue()<br><span class="hljs-keyword">if</span> sg == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>sg.elem = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">if</span> sg.releasetime != <span class="hljs-number">0</span> &#123;<br>sg.releasetime = cputicks()<br>&#125;<br>gp := sg.g<br>gp.param = unsafe.Pointer(sg)<br>sg.success = <span class="hljs-literal">false</span><br><span class="hljs-keyword">if</span> raceenabled &#123;<br>raceacquireg(gp, c.raceaddr())<br>&#125;<br>glist.push(gp)<br>&#125;<br>unlock(&amp;c.lock)<br><br><span class="hljs-comment">// Ready all Gs now that we&#x27;ve dropped the channel lock.</span><br><span class="hljs-comment">// å°†glistä¸­æ‰€æœ‰Goroutineçš„çŠ¶æ€ç½®ä¸º_Grunnableï¼Œç­‰å¾…è°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦</span><br><span class="hljs-keyword">for</span> !glist.empty() &#123;<br>gp := glist.pop()<br>gp.schedlink = <span class="hljs-number">0</span><br>goready(gp, <span class="hljs-number">3</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://iswxw.blog.csdn.net/article/details/130785190">Go å¹¶å‘ä¹‹channel</a></p><p><a href="https://mp.weixin.qq.com/s/rFyMNeZF_cwKkBBJhHlEFQ">go channelè¯¦è§£</a></p><p><a href="https://mp.weixin.qq.com/s/XEdrrpIkdseFP3ZIdfOgVw">æ·±å…¥ç†è§£ channel</a></p><p><a href="https://www.ardanlabs.com/blog/2014/02/the-nature-of-channels-in-go.html">The Nature Of Channels In Go</a></p><p><a href="https://mp.weixin.qq.com/s/V7B9q4lZ6K3RjrP8Xd-cXw">ä¸€æ–‡å¸¦ä½ æ­ç§˜Goè¯­è¨€ä¹‹é€šé“channel</a></p><p><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-channel/">Channel</a></p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Channel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang Context è§£æ</title>
    <link href="/2024/08/31/Golang-Context%E8%A7%A3%E6%9E%90/"/>
    <url>/2024/08/31/Golang-Context%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>Context æ˜¯ Go è¯­è¨€ä¸­ç”¨äºå¤„ç†å¹¶å‘æ“ä½œçš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚åŒ…å« goroutine çš„è¿è¡ŒçŠ¶æ€ã€ç¯å¢ƒã€ç°åœºç­‰ä¿¡æ¯ã€‚Context ä¸»è¦ç”¨æ¥åœ¨ goroutine ä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šå–æ¶ˆä¿¡å·ã€è¶…æ—¶æ—¶é—´ã€æˆªæ­¢æ—¶é—´ã€Key-Valueç­‰ã€‚</p><span id="more"></span>  <h2 id="1-Context-ä»‹ç»"><a href="#1-Context-ä»‹ç»" class="headerlink" title="1. Context ä»‹ç»"></a>1. Context ä»‹ç»</h2><p>Context æ˜¯ Go è¯­è¨€ä¸­ç”¨äºå¤„ç†å¹¶å‘æ“ä½œçš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚Contextè¯‘ä½œâ€œä¸Šä¸‹æ–‡â€ï¼Œå‡†ç¡®è¯´å®ƒæ˜¯ goroutine çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« goroutine çš„è¿è¡ŒçŠ¶æ€ã€ç¯å¢ƒã€ç°åœºç­‰ä¿¡æ¯ã€‚Context ä¸»è¦ç”¨æ¥åœ¨ goroutine ä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šå–æ¶ˆä¿¡å·ã€è¶…æ—¶æ—¶é—´ã€æˆªæ­¢æ—¶é—´ã€Key-Valueç­‰ã€‚</p><p>æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">interface</span> &#123;<br>    Deadline() (deadline time.Time, ok <span class="hljs-type">bool</span>) <span class="hljs-comment">//è¿”å› context çš„è¿‡æœŸæ—¶é—´ï¼›</span><br>    Done() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">//è¿”å› context ä¸­çš„ channelï¼›</span><br>    Err() <span class="hljs-type">error</span> <span class="hljs-comment">//è¿”å›é”™è¯¯ï¼›</span><br>    Value(key <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-comment">//è¿”å› context ä¸­çš„å¯¹åº” key çš„å€¼.</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Deadline()</code>ï¼šè¯¥æ–¹æ³•è¿”å›ctxçš„è¶…æ—¶æ—¶é—´ï¼Œä»¥åŠæ˜¯å¦è®¾ç½®è¶…æ—¶æ—¶é—´çš„æ ‡è¯†ï¼›å¦‚æœæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåˆ™ok&#x3D;falseï¼Œdeadlineæ˜¯ä¸€ä¸ªåˆå§‹çš„time.Timeå€¼ã€‚</li><li><code>Done()</code>ï¼šè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåªè¯»çš„channelï¼Œå½“contextè¢«ä¸»åŠ¨å–æ¶ˆæˆ–è€…è¶…æ—¶è‡ªåŠ¨å–æ¶ˆæ—¶ï¼Œè¿™ä¸ªchannelä¼šè¢«å…³é—­ï¼›å…³é—­çš„channelæ˜¯å¯è¯»çš„ï¼Œåç¨‹å¯ä»¥æ­£å¸¸æ”¶åˆ°å…³é—­ä¿¡å·ï¼›å¦‚æœä¸€ä¸ªctxæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šè¿”å›nilï¼›ç»å¸¸åœ¨select-caseè¯­å¥ä¸­ä½¿ç”¨ï¼Œåˆ¤æ–­ctxæ˜¯å¦å…³é—­</li><li><code>Err()</code>ï¼šè¯¥æ–¹æ³•è¿”å›ctxå…³é—­çš„åŸå› ï¼Œå¦‚æœctxè¿˜æ²¡æœ‰å…³é—­ï¼Œå°±è¿”å›nilï¼Œå¦‚æœè¢«å…³é—­äº†ï¼Œè¿”å›çš„errä¹Ÿåªæœ‰ä¸¤ç§<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> Canceled = errors.New(<span class="hljs-string">&quot;context canceled&quot;</span>)        <span class="hljs-comment">// æ­£å¸¸å–æ¶ˆ</span><br><br><span class="hljs-keyword">var</span> DeadlineExceeded <span class="hljs-type">error</span> = deadlineExceededError&#123;&#125; <span class="hljs-comment">// è¶…æ—¶å–æ¶ˆ</span><br></code></pre></td></tr></table></figure></li><li><code>Value()</code>ï¼šgolangä¸­æœ‰ä¸€ç§åœ¨åç¨‹é—´ä¼ é€’ä¿¡æ¯çš„ctxï¼Œä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥æ ¹æ®keyæŸ¥è¯¢mapä¸­çš„value</li></ul><h2 id="2-Context-æ´¾ç”Ÿ"><a href="#2-Context-æ´¾ç”Ÿ" class="headerlink" title="2. Context æ´¾ç”Ÿ"></a>2. Context æ´¾ç”Ÿ</h2><p>Contextåœ¨è®¾è®¡ä¸Šå®é™…åªå®šä¹‰äº†æ¥å£ï¼Œå‡¡æ˜¯å®ç°æ”¹æ¥å£çš„ç»“æ„ä½“éƒ½å¯ä»¥ç§°ä¸ºContextï¼Œå®˜æ–¹çš„åŒ…ä¸­å®ç°äº†ä»¥ä¸‹å‡ ç±»ç»“æ„ä½“ã€‚ </p><p><img src="/img/Golang-Context%E8%A7%A3%E6%9E%90/1.png">    </p><ul><li><code>emptyCtx</code>ï¼šç©ºç»“æ„ä½“ï¼Œä½¿ç”¨Background()å‡½æ•°å’ŒTODO()å‡½æ•°åˆ›å»º</li><li><code>valueCtx</code>ï¼šå€¼ä¼ é€’çš„contextï¼Œä½¿ç”¨WithValue()å‡½æ•°åˆ›å»º</li><li><code>cancelCtx</code>ï¼šå¸¦æœ‰å–æ¶ˆå‡½æ•°çš„contextï¼Œä½¿ç”¨WithCancel()å‡½æ•°åˆ›å»º</li><li><code>timerCtx</code>ï¼šå¸¦æœ‰è¶…æ—¶æ—¶é—´çš„contextï¼Œä½¿ç”¨WithDeadline()å’ŒWithTimeout()å‡½æ•°åˆ›å»º</li></ul><h2 id="3-ä½¿ç”¨åœºæ™¯"><a href="#3-ä½¿ç”¨åœºæ™¯" class="headerlink" title="3. ä½¿ç”¨åœºæ™¯"></a>3. ä½¿ç”¨åœºæ™¯</h2><p>Contextåœ¨æ—¥å¸¸ä½¿ç”¨ä¸­ï¼Œä¸€èˆ¬å¤šç”¨äºè¶…æ—¶æ§åˆ¶ã€ä¿¡å·ä¼ é€’ã€å…±äº«å˜é‡ç­‰åœºæ™¯ï¼Œä¸‹é¢åˆ†åˆ«ç®€å•ä»‹ç»ä¸€ä¸‹</p><h3 id="3-1-å–æ¶ˆä¿¡å·ä¼ é€’"><a href="#3-1-å–æ¶ˆä¿¡å·ä¼ é€’" class="headerlink" title="3.1 å–æ¶ˆä¿¡å·ä¼ é€’"></a>3.1 å–æ¶ˆä¿¡å·ä¼ é€’</h3><ul><li>åœ¨ä¸»åç¨‹ä¸­ä¸»åŠ¨å–æ¶ˆctxï¼Œå­åç¨‹æ”¶åˆ°å–æ¶ˆè¯·æ±‚åå…³é—­æ“ä½œ<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Worker received cancellation signal: %v\n&quot;</span>, ctx.Err())<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br>time.Sleep(<span class="hljs-number">500</span> * time.Millisecond)<br>fmt.Println(<span class="hljs-string">&quot;Working...&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>parentCtx, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">go</span> worker(parentCtx)<br><br>time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// æ¨¡æ‹Ÿä¸»ç¨‹åºæ‰§è¡Œ</span><br><br>cancel() <span class="hljs-comment">// å–æ¶ˆworkerçš„ctx</span><br><br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>&#125;<br><span class="hljs-comment">// Working...</span><br><span class="hljs-comment">// Working...</span><br><span class="hljs-comment">// Worker received cancellation signal: context canceled</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="3-2-è¶…æ—¶æ§åˆ¶"><a href="#3-2-è¶…æ—¶æ§åˆ¶" class="headerlink" title="3.2 è¶…æ—¶æ§åˆ¶"></a>3.2 è¶…æ—¶æ§åˆ¶</h3><ul><li>ä½¿ç”¨å¸¦æœ‰è¶…æ—¶æ—¶é—´çš„ctxï¼Œæ—¶é—´åˆ°åï¼Œå‡½æ•°è‡ªåŠ¨ä¸­æ–­å¤„ç†<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">operation</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">3</span> * time.Second): <span class="hljs-comment">// Simulate some long operation</span><br>fmt.Println(<span class="hljs-string">&quot;Operation completed.&quot;</span>)<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Println(<span class="hljs-string">&quot;Operation canceled due to timeout.&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>timeoutCtx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">2</span>*time.Second)<br><span class="hljs-keyword">defer</span> cancel()<br><br>operation(timeoutCtx)<br>&#125;<br><span class="hljs-comment">// Operation canceled due to timeout.</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="3-3-æˆªæ­¢æ—¶é—´"><a href="#3-3-æˆªæ­¢æ—¶é—´" class="headerlink" title="3.3 æˆªæ­¢æ—¶é—´"></a>3.3 æˆªæ­¢æ—¶é—´</h3><ul><li>ctxå¸¦æœ‰æˆªæ­¢æ—¶é—´ï¼Œåœ¨deadlineä¹‹å‰å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œdeadlineåä¼šæŠ¥é”™<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">operation</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>deadline, ok := ctx.Deadline()<br><span class="hljs-keyword">if</span> ok &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Operation deadline: %s\n&quot;</span>, deadline)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;No deadline for the operation.&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// Simulate some operation</span><br>time.Sleep(<span class="hljs-number">3</span> * time.Second)<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Println(<span class="hljs-string">&quot;Operation canceled due to context deadline.&quot;</span>)<br><span class="hljs-keyword">default</span>:<br>fmt.Println(<span class="hljs-string">&quot;Operation completed within the deadline.&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>deadline := time.Now().Add(<span class="hljs-number">2</span> * time.Second)<br>deadlineCtx, cancel := context.WithDeadline(context.Background(), deadline)<br><span class="hljs-keyword">defer</span> cancel()<br><br>operation(deadlineCtx)<br>&#125;<br><span class="hljs-comment">// Operation deadline: 2024-08-31 12:21:15.279442 +0800 CST m=+2.000158542</span><br><span class="hljs-comment">// Operation canceled due to context deadline.</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="3-4-å€¼ä¼ é€’"><a href="#3-4-å€¼ä¼ é€’" class="headerlink" title="3.4 å€¼ä¼ é€’"></a>3.4 å€¼ä¼ é€’</h3><ul><li>é€šè¿‡ctx valueä¼ é€’userId<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequest</span><span class="hljs-params">(ctx context.Context, requestID <span class="hljs-type">int</span>)</span></span> &#123;<br>userID, ok := ctx.Value(<span class="hljs-string">&quot;id&quot;</span>).(<span class="hljs-type">int</span>)<br><span class="hljs-keyword">if</span> !ok &#123;<br>fmt.Println(<span class="hljs-string">&quot;failed to get id from context.&quot;</span>)<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;processing request %d for user %d\n&quot;</span>, requestID, userID)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>parentCtx := context.WithValue(context.Background(), <span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">123</span>)<br><br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(requestID <span class="hljs-type">int</span>)</span></span> &#123;<br>childCtx := context.WithValue(parentCtx, <span class="hljs-string">&quot;requestID&quot;</span>, requestID)<br>processRequest(childCtx, requestID)<br>wg.Done()<br>&#125;(i)<br>&#125;<br>wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="4-æºç åˆ†æ"><a href="#4-æºç åˆ†æ" class="headerlink" title="4. æºç åˆ†æ"></a>4. æºç åˆ†æ</h2><h3 id="4-1-emptyCtx"><a href="#4-1-emptyCtx" class="headerlink" title="4.1 emptyCtx"></a>4.1 emptyCtx</h3><p>contextåŒ…ä¸­å®šä¹‰äº†ä¸€ä¸ªç©ºçš„contextï¼Œ åä¸ºemptyCtxï¼Œç”¨äºcontextçš„æ ¹èŠ‚ç‚¹ï¼Œç©ºçš„contextåªæ˜¯ç®€å•çš„å®ç°äº†Contextï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•å€¼ï¼Œä»…ç”¨äºå…¶ä»–contextçš„çˆ¶èŠ‚ç‚¹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç©ºçš„ctxæœ¬è´¨ä¸Šä¸€ä¸ªæ•´å‹ï¼Œå®ƒä¸ä¼šè¢«å–æ¶ˆã€æ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¿‡æœŸæ—¶é—´</span><br><span class="hljs-keyword">type</span> emptyCtx <span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span></span> Deadline() (deadline time.Time, ok <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span></span> Done() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span></span> Err() <span class="hljs-type">error</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(*emptyCtx)</span></span> Value(key any) any &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>emptyCtxé€šè¿‡ä¸‹é¢ä¸¤ä¸ªå¯¼å‡ºçš„å‡½æ•°ï¼ˆé¦–å­—æ¯å¤§å†™ï¼‰å¯¹å¤–å…¬å¼€ï¼šæˆ‘ä»¬æ‰€å¸¸ç”¨çš„Â context.Background()Â  å’ŒÂ context.TODO()Â æ–¹æ³•ã€‚æœ¬è´¨ä¸ŠäºŒè€…å¹¶æ— å·®åˆ«</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// context.Background()å‡½æ•°è¿”å›ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œè¢«è§†ä¸ºæ‰€æœ‰ä¸Šä¸‹æ–‡æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä¸éœ€è¦ä¼ é€’å€¼æˆ–å–æ¶ˆä¿¡å·ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Background</span><span class="hljs-params">()</span></span> Context &#123;<span class="hljs-keyword">return</span> background&#125;<br><span class="hljs-comment">//context.TODO()å‡½æ•°è¿”å›ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç”¨äºè¯¥éƒ¨åˆ†ä»£ç è¿˜æœªç¡®å®šå…·ä½“éœ€è¦å“ªç§ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TODO</span><span class="hljs-params">()</span></span> Context &#123;<span class="hljs-keyword">return</span> todo&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-valueCtx"><a href="#4-2-valueCtx" class="headerlink" title="4.2 valueCtx"></a>4.2 valueCtx</h3><p>valueCtxåœ¨ç©ºctxçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†key-valé”®å€¼å¯¹ï¼Œç”¨äºä¿å­˜ä¸€äº›æ•°æ®ä¾›ä¸Šä¸‹æ–‡ä½¿ç”¨ã€‚åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­é€šè¿‡WithValue()å‡½æ•°æ„é€ ã€‚</p><ul><li><p><code>valueCtx</code> ç»“æ„ä½“å®šä¹‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€šè¿‡ç»„åˆContextçš„æ–¹å¼ï¼Œæºå¸¦ä¸€ä¸ªkey-valå¯¹</span><br><span class="hljs-keyword">type</span> valueCtx <span class="hljs-keyword">struct</span> &#123;<br>Context<br>key, val any<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><code>WithValue()</code> æºç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithValue</span><span class="hljs-params">(parent Context, key, val any)</span></span> Context &#123;<br><span class="hljs-keyword">if</span> parent == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;cannot create context from nil parent&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> key == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;nil key&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> !reflectlite.TypeOf(key).Comparable() &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;key is not comparable&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> &amp;valueCtx&#123;parent, key, val&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼ŒvalueCtxçš„æ¯æ¬¡æ„å»ºï¼Œéƒ½æ˜¯åœ¨ä¸Šä¸€ä¸ªctxçš„åŸºç¡€ä¸Šç”Ÿæˆä¸€ä¸ªæ–°çš„ctxï¼Œæ¯ä¸€ä¸ªvalueCtxåªæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå¤šä¸ªé”®å€¼å¯¹æ„æˆä¸€ä¸ªä¸²å‹çš„æ•°æ®ç»“æ„ã€‚<br><img src="/img/Golang-Context%E8%A7%A3%E6%9E%90/2.png">   </p></li><li><p><code>valueCtx.Value()</code>å‡½æ•°<br>Value()å‡½æ•°ä»å½“å‰çš„ctxå¼€å§‹æ‰¾keyçš„å€¼ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œç»§ç»­æ‰¾çˆ¶ctxï¼Œç›´è‡³æ‰¾åˆ°emptyCtxä¸ºæ­¢</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *valueCtx)</span></span> Value(key any) any &#123;<br><span class="hljs-keyword">if</span> c.key == key &#123;<br><span class="hljs-keyword">return</span> c.val<br>&#125;<br><span class="hljs-keyword">return</span> value(c.Context, key)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">value</span><span class="hljs-params">(c Context, key any)</span></span> any &#123;<br><span class="hljs-comment">// ä»åº•å±‚å¾ªç¯å¾€çˆ¶å±‚å¯»æ‰¾æŒ‡å®škeyçš„å€¼</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">switch</span> ctx := c.(<span class="hljs-keyword">type</span>) &#123;<br><span class="hljs-keyword">case</span> *valueCtx:<br><span class="hljs-keyword">if</span> key == ctx.key &#123;<br><span class="hljs-keyword">return</span> ctx.val<br>&#125;<br>c = ctx.Context<br><span class="hljs-comment">// cancelCtxKey æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„keyï¼Œå¦‚æœå±äºcancelCtxæˆ–è€…timerCtxä¸”keyä¸ºç‰¹æ®Škeyï¼Œåˆ™è¿”å›è¿™ä¸ªcancelCtx</span><br><span class="hljs-keyword">case</span> *cancelCtx:<br><span class="hljs-keyword">if</span> key == &amp;cancelCtxKey &#123;<br><span class="hljs-keyword">return</span> c<br>&#125;<br>c = ctx.Context<br><span class="hljs-keyword">case</span> *timerCtx:<br><span class="hljs-keyword">if</span> key == &amp;cancelCtxKey &#123;<br><span class="hljs-keyword">return</span> ctx.cancelCtx<br>&#125;<br>c = ctx.Context<br><span class="hljs-keyword">case</span> *emptyCtx:<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> c.Value(key)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ç‰¹ç‚¹</p><ul><li>ä¸€ä¸ª valueCtx åªèƒ½å­˜ä¸€ä¸ª kv å¯¹ï¼Œn ä¸ª kv å¯¹ä¼šåµŒå¥— n ä¸ª valueCtxï¼Œé€ æˆç©ºé—´æµªè´¹ï¼Œä¸é€‚åˆå¤§é‡å­˜å‚¨ï¼›</li><li>åŸºäº k å¯»æ‰¾ v çš„è¿‡ç¨‹æ˜¯çº¿æ€§çš„ï¼Œæ—¶é—´å¤æ‚åº¦ O(N)ï¼›</li><li>ä¸æ”¯æŒåŸºäº k çš„å»é‡ï¼Œç›¸åŒ k å¯èƒ½é‡å¤å­˜åœ¨ï¼Œå¹¶åŸºäºèµ·ç‚¹çš„ä¸åŒï¼Œè¿”å›ä¸åŒçš„ v.</li><li>valueCtxç»“æ„å¯¹äºContextæ¥å£åªé‡å†™äº†Valueæ–¹æ³•ï¼Œå…¶ä»–ä¸‰ä¸ªæ–¹æ³•ç›´æ¥è°ƒç”¨åµŒå…¥çš„Contextã€‚</li></ul></li></ul><h3 id="4-3-cancelCtx"><a href="#4-3-cancelCtx" class="headerlink" title="4.3 cancelCtx"></a>4.3 cancelCtx</h3><p>contextåŒ…ä¸­ç¬¬ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„ctxæ˜¯cancelCtxï¼Œé¡¾åæ€ä¹‰æ˜¯å¯ä»¥å–æ¶ˆçš„contextï¼Œè¯¥contextåœ¨æ„å»ºæ—¶è¿”å›ä¸€ä¸ªå–æ¶ˆå‡½æ•°ï¼Œå¯ä»¥ä¾›ä¸»åŠ¨å–æ¶ˆã€‚</p><ul><li><p><code>cancelCtx</code>ç»“æ„å®šä¹‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> cancelCtx <span class="hljs-keyword">struct</span> &#123;<br>Context                        <span class="hljs-comment">// åµŒå…¥çš„Context</span><br><br>mu       sync.Mutex            <span class="hljs-comment">// äº’æ–¥é”ï¼Œä¿æŠ¤ä»¥ä¸‹å­—æ®µ</span><br>done     atomic.Value          <span class="hljs-comment">// åŸå­é€šé“ï¼Œæƒ°æ€§åˆ›å»º,ç¬¬ä¸€æ¬¡è¢«cancelè°ƒç”¨å…³é—­</span><br>children <span class="hljs-keyword">map</span>[canceler]<span class="hljs-keyword">struct</span>&#123;&#125; <span class="hljs-comment">// å­˜å‚¨å­æ ‘ä¸­ç¬¬ä¸€ä¸ªå¯ä»¥è¢«cancelçš„ctx</span><br>err      <span class="hljs-type">error</span>                 <span class="hljs-comment">// å­˜å‚¨errorä¿¡æ¯</span><br>cause    <span class="hljs-type">error</span>                 <span class="hljs-comment">// å­˜å‚¨å¸¦æœ‰åŸå› çš„errorä¿¡æ¯</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><code>cancelCtx</code> ä¸»è¦æ–¹æ³•<br>  cancelCtxä½œä¸ºContextæ¥å£çš„å®ç°ï¼Œé‡å†™äº†Doneã€Errå’ŒValueæ–¹æ³•ï¼Œåˆ†åˆ«ç®€å•ä»‹ç»å¦‚ä¸‹</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Done æ–¹æ³•è¿”å›ä¸€ä¸ªé€šé“ï¼Œä½¿ç”¨äº†æƒ°æ€§åŠ è½½çš„æœºåˆ¶ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨Doneæ–¹æ³•æ—¶æ‰ä¼šè¢«åˆ›å»º</span><br><span class="hljs-comment">// å°†é€šé“æ”¾åˆ°atomic.Valueä¸­ ä¿è¯é€šé“æ“ä½œçš„åŸå­æ€§</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span></span> Done() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125; &#123;<br>d := c.done.Load()<br><span class="hljs-keyword">if</span> d != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> d.(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>&#125;<br><span class="hljs-comment">// åŠ é”çš„æ–¹å¼åšäºŒæ¬¡æ£€æŸ¥ï¼Œé¿å…å¤šå¹¶å‘åœºæ™¯ä¸‹è¢«é‡å¤åˆ›å»º</span><br>c.mu.Lock()<br><span class="hljs-keyword">defer</span> c.mu.Unlock()<br>d = c.done.Load()<br><span class="hljs-keyword">if</span> d == <span class="hljs-literal">nil</span> &#123;<br>d = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>c.done.Store(d)<br>&#125;<br><span class="hljs-keyword">return</span> d.(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>&#125;<br><br><span class="hljs-comment">// Valueæ–¹æ³•å¤ç”¨valueCtxçš„é€’å½’é€»è¾‘ï¼Œåªæ˜¯æœ‰ä¸€ç§ç‰¹æ®Šçš„å¤„ç†æƒ…å†µ</span><br><span class="hljs-comment">// å½“keyæ˜¯cancelCtxKeyçš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯cancelCtxæœ¬èº«</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span></span> Value(key any) any &#123;<br><span class="hljs-keyword">if</span> key == &amp;cancelCtxKey &#123;<br><span class="hljs-keyword">return</span> c<br>&#125;<br><span class="hljs-keyword">return</span> value(c.Context, key)<br>&#125;<br><br><span class="hljs-comment">// Err è¿”å›ç»“æ„ä½“err</span><br><span class="hljs-comment">// cancelCtx.err é»˜è®¤æ˜¯nilï¼Œåœ¨è¢«cancelçš„æ—¶å€™æŒ‡å®šä¸€ä¸ªerrorå˜é‡ï¼šâ€œcontext canceledâ€</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span></span> Err() <span class="hljs-type">error</span> &#123;<br>c.mu.Lock()<br>err := c.err<br>c.mu.Unlock()<br><span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><code>WithCancel()</code> æ„é€ æ–¹æ³•<br>WithCancelæ˜¯contextå®˜æ–¹åŒ…å¯¹å¤–æä¾›çš„å‡½æ•°ä¹‹ä¸€ï¼Œå‡½æ•°æ¥å—ä¸€ä¸ªçˆ¶ä¸Šä¸‹æ–‡å¯¹è±¡parent ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡cancelCtxå¯¹è±¡ctx åŠå…¶å¯¹åº”çš„å–æ¶ˆå‡½æ•°cancel ã€‚å½“è°ƒç”¨å–æ¶ˆå‡½æ•°æ—¶ï¼Œè¯¥ctxå¯¹è±¡åŠå…¶æ‰€æœ‰åä»£ctxå¯¹è±¡å‡ä¼šè¢«å–æ¶ˆã€‚æ ¸å¿ƒä»£ç é€»è¾‘ä»‹ç»å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span></span> (ctx Context, cancel CancelFunc) &#123;<br>c := withCancel(parent)<br><span class="hljs-comment">// å°†æ„é€ çš„cancelCtxè¿”å›ï¼ŒåŒæ—¶è¿”å›ç»ˆæ­¢è¯¥cancelCtxçš„é—­åŒ…å‡½æ•°cancelï¼›ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ trueï¼Œä¹Ÿå°±æ˜¯è¯´å–æ¶ˆçš„æ—¶å€™ï¼Œéœ€è¦å°†è‡ªå·±ä»çˆ¶èŠ‚ç‚¹é‡Œåˆ é™¤ã€‚</span><br><span class="hljs-keyword">return</span> c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c.cancel(<span class="hljs-literal">true</span>, Canceled, <span class="hljs-literal">nil</span>) &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">withCancel</span><span class="hljs-params">(parent Context)</span></span> *cancelCtx &#123;<br><span class="hljs-comment">// å¦‚æœçˆ¶ctxä¸ºç©ºï¼Œåˆ™æ— æ³•æ„å»º</span><br><span class="hljs-keyword">if</span> parent == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;cannot create context from nil parent&quot;</span>)<br>&#125;<br><span class="hljs-comment">// æ„å»ºä¸€ä¸ªæ–°çš„cancelCtx</span><br>c := newCancelCtx(parent)<br><span class="hljs-comment">// æ ¸å¿ƒé€»è¾‘ï¼Œæ„å»ºcancelä¼ æ’­é“¾</span><br>propagateCancel(parent, c)<br><span class="hljs-keyword">return</span> c<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç”±äºcancelCtxçš„å¯¹è±¡åœ¨å–æ¶ˆæ—¶ï¼Œè¦åŒæ­¥å–æ¶ˆå…¶åä»£Ctxå¯¹è±¡ï¼Œå› æ­¤åœ¨cancelCtxçš„æ„å»ºæ—¶ï¼Œè¦è¿›è¡Œcancelä¿¡æ¯çš„æ§åˆ¶é“¾ä¼ é€’ï¼Œå»ºç«‹çˆ¶å­å…³ç³»ï¼Œå°†æœ¬æ¬¡æ–°å»ºçš„cancelCtxæ”¾åœ¨é“¾è·¯ä¸­ä¸Šä¸€ä¸ªcancelCtxçš„children mapä¸­ã€‚å¦‚æœä¸€ä¸ªcancelCtxå¯¹è±¡çš„åä»£ä¸æ˜¯cancelCtxå¯¹è±¡ï¼Œé‚£è¿™ä¸ªåä»£çš„done channelæœ¬èº«å°±æ˜¯cancelCtxçš„done channelï¼Œæ— éœ€é¢å¤–å…³è”ã€‚å› æ­¤åœ¨æ§åˆ¶é“¾çš„ä¼ é€’ä¸­ï¼Œåªéœ€å…³è”cancelCtxçš„çˆ¶å­å…³ç³»å³å¯ã€‚</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// parentä¸ºçˆ¶ctxï¼Œchildä¸ºæœ¬æ¬¡åˆ›å»ºçš„cancelCtx</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">propagateCancel</span><span class="hljs-params">(parent Context, child canceler)</span></span> &#123;<br>done := parent.Done()<br><span class="hljs-comment">// å¦‚æœçˆ¶ctxä¸ä¼šè¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›å³å¯</span><br><span class="hljs-keyword">if</span> done == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <br>&#125;<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-done:<br><span class="hljs-comment">// å¦‚æœçˆ¶ctxå·²è¢«å–æ¶ˆåˆ™ç›´æ¥ä¸­æ­¢æœ¬æ¬¡æ„å»ºçš„cancelCtxï¼Œå¹¶ç”¨çˆ¶ctxçš„å–æ¶ˆåŸå› ä½œä¸ºå­ctxçš„å–æ¶ˆåŸå› </span><br>child.cancel(<span class="hljs-literal">false</span>, parent.Err(), Cause(parent))<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br>&#125;<br><br><span class="hljs-comment">// å¯»æ‰¾parent ctxçš„ç¬¬ä¸€ä¸ªcancelCtxç¥–å…ˆ(è¿™ä¸ªå¯ä»¥æ˜¯parentè‡ªå·±,ç”±cancelCtx.Valueå‡½æ•°çš„å®ç°å†³å®š)ï¼Œæœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯æ‰¾child ctxçš„ç¬¬ä¸€ä¸ªcancelCtxçš„ç¥–å…ˆ</span><br><span class="hljs-keyword">if</span> p, ok := parentCancelCtx(parent); ok &#123;<br>p.mu.Lock()<br><span class="hljs-keyword">if</span> p.err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// å¦‚æœçˆ¶ctxå·²è¢«å–æ¶ˆåˆ™ç›´æ¥ä¸­æ­¢æœ¬æ¬¡æ„å»ºçš„cancelCtx</span><br>child.cancel(<span class="hljs-literal">false</span>, p.err, p.cause)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// å°†æœ¬æ¬¡æ–°æ„å»ºçš„child ctxåŠ å…¥åˆ°æœ€è¿‘çš„cancelCtxç¥–å…ˆçš„childrenä¸­</span><br><span class="hljs-keyword">if</span> p.children == <span class="hljs-literal">nil</span> &#123;<br>p.children = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[canceler]<span class="hljs-keyword">struct</span>&#123;&#125;)<br>&#125;<br>p.children[child] = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;<br>p.mu.Unlock()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// å¦‚æœparentä¸æ˜¯cancelCtxï¼Œä½†æ˜¯åˆå­˜åœ¨cancelçš„èƒ½åŠ›ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘æ§parentçš„çŠ¶æ€ï¼Œå¦‚æœparentç»ˆæ­¢ï¼Œä¹ŸåŠæ—¶ç»ˆæ­¢child ctxï¼Œå¹¶ä¼ é€’parentçš„error</span><br>goroutines.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-parent.Done():<br>child.cancel(<span class="hljs-literal">false</span>, parent.Err(), Cause(parent))<br><span class="hljs-keyword">case</span> &lt;-child.Done():<br>&#125;<br>&#125;()<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// parentCancelCtx è¿”å›è¾“å…¥parentçš„ç¬¬ä¸ªcancelCtxç¥–å…ˆï¼Œå¯èƒ½æ˜¯parentè‡ªå·±</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">parentCancelCtx</span><span class="hljs-params">(parent Context)</span></span> (*cancelCtx, <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-comment">// parent.Done() è¿”å›æ§åˆ¶é“¾ä¸­ç¬¬ä¸€ä¸ªå®ç°éç©ºDone()æ–¹æ³•çš„Context</span><br><span class="hljs-comment">// åœ¨valueCtxã€cancelCtxã€timerCtxä¸‰è€…ä¸­ï¼Œåªæœ‰cancleCtxå®ç°äº†éç©ºçš„Doneæ–¹æ³•ï¼Œå› æ­¤parent.Doneæ­£å¸¸æƒ…å†µä¸‹ä¼šè¿”å›ç¬¬ä¸€ä¸ªç¥–å…ˆcancelCtxçš„done channelã€‚ä½†å¦‚æœContextæ ‘ä¸­æœ‰ç¬¬ä¸‰æ–¹å®ç°çš„Contextæ¥å£å®ä¾‹æ—¶ï¼Œparent.Doneå¯èƒ½è¿”å›å…¶ä»–channel</span><br>done := parent.Done()<br><span class="hljs-keyword">if</span> done == closedchan || done == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br><br><span class="hljs-comment">// é€šè¿‡cancelCtxKeyæ‰¾åˆ°ç¬¬ä¸€ä¸ªç¥–å…ˆcancelCtx</span><br>p, ok := parent.Value(&amp;cancelCtxKey).(*cancelCtx)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// å¦‚æœp.doneä¸ç­‰äºdoneï¼Œè¯´æ˜æ§åˆ¶é“¾ä¸­ç¢°åˆ°çš„ç¬¬ä¸€ä¸ªå®ç°éç©ºDone()çš„Contextæ˜¯ç¬¬ä¸‰æ–¹Contextï¼Œä¸æ˜¯cancelCtx</span><br>pdone, _ := p.done.Load().(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><span class="hljs-keyword">if</span> pdone != done &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-keyword">return</span> p, <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Golang-Context%E8%A7%A3%E6%9E%90/3.png"><br>å¦‚ä¸Šå›¾ï¼Œç”±C3ç”ŸæˆC4æ—¶ï¼ŒC3çš„parentCancelCtxæ˜¯C1ï¼ŒC3è°ƒç”¨Done()æ–¹æ³•è¿”å›çš„ä¹Ÿæ˜¯C1çš„ done channelï¼Œå› æ­¤å°†C4æ”¾å…¥C1çš„childrenä¸­</p><ul><li><code>cancelCtx.cancel()</code> æ–¹æ³•<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cancelCtx)</span></span> cancel(removeFromParent <span class="hljs-type">bool</span>, err, cause <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;context: internal error: missing cancel error&quot;</span>)<br>&#125;<br><span class="hljs-keyword">if</span> cause == <span class="hljs-literal">nil</span> &#123;<br>cause = err<br>&#125;<br>c.mu.Lock()<br><span class="hljs-comment">// å¦‚æœå·²ç»è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> c.err != <span class="hljs-literal">nil</span> &#123;<br>c.mu.Unlock()<br><span class="hljs-keyword">return</span> <br>&#125;<br><br><span class="hljs-comment">// è®°ä¸‹é”™è¯¯ä¿¡æ¯ï¼Œå¹¶å…³é—­channel</span><br>c.err = err<br>c.cause = cause<br>d, _ := c.done.Load().(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><span class="hljs-keyword">if</span> d == <span class="hljs-literal">nil</span> &#123;<br>c.done.Store(closedchan)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">close</span>(d)<br>&#125;<br><span class="hljs-comment">// çº§è”å–æ¶ˆchild cancelCtx</span><br><span class="hljs-keyword">for</span> child := <span class="hljs-keyword">range</span> c.children &#123;<br>child.cancel(<span class="hljs-literal">false</span>, err, cause)<br>&#125;<br>c.children = <span class="hljs-literal">nil</span><br>c.mu.Unlock()<br><br><span class="hljs-comment">// å°†å½“å‰ctxä»ctxçš„çˆ¶ctxä¸­ç§»é™¤</span><br><span class="hljs-keyword">if</span> removeFromParent &#123;<br>removeChild(c.Context, c)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><code>WithCacelCause()</code> æ”¯æŒä¼ é€’å–æ¶ˆåŸå› çš„cancelCtx<br>æ—©æœŸçš„cancelCtxåœ¨cancelæ—¶ï¼Œèƒ½å†™å…¥çš„errä¿¡æ¯åŠå…¶æœ‰é™ï¼Œåªæœ‰è¶…æ—¶å–æ¶ˆå’Œå¤–éƒ¨å–æ¶ˆï¼ŒGo  1.20ç‰ˆæœ¬æ–°å¢ä¸€ä¸ªå¯ä»¥è®¾ç½®å–æ¶ˆåŸå› çš„æ–¹æ³•ï¼Œä»–åœ¨è°ƒç”¨cancelçš„æ—¶å€™ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªerrorå‚æ•°ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancelCause</span><span class="hljs-params">(parent Context)</span></span> (ctx Context, cancel CancelCauseFunc) &#123;<br>c := withCancel(parent)<br><span class="hljs-keyword">return</span> c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cause <span class="hljs-type">error</span>)</span></span> &#123; c.cancel(<span class="hljs-literal">true</span>, Canceled, cause) &#125;<br>&#125;<br><br>ctx, cancelFunc := context.WithCancelCause(parentCtx)<br><span class="hljs-keyword">defer</span> cancelFunc(errors.New(<span class="hljs-string">&quot;åŸå› &quot;</span>))<br></code></pre></td></tr></table></figure></li></ul><h3 id="4-4-timerCtx"><a href="#4-4-timerCtx" class="headerlink" title="4.4 timerCtx"></a>4.4 timerCtx</h3><p>timerCtxåœ¨cancelCtxçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œé™¤äº†ç»§æ‰¿cancelCtxçš„èƒ½åŠ›å¤–ï¼Œæ–°å¢äº†ä¸€ä¸ªtime.Timerçš„è®¡æ—¶å™¨ç”¨äºå®šæ—¶ç»ˆæ­¢contextï¼Œå¦å¤–æ–°å¢äº†ä¸€ä¸ªdeadlineå­—æ®µç”¨äºtimerCtxçš„è¿‡æœŸæ—¶é—´ã€‚</p><ul><li><code>timerCtx</code> ç»“æ„ä½“<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> timerCtx <span class="hljs-keyword">struct</span> &#123;<br>*cancelCtx<br>timer *time.Timer <span class="hljs-comment">// Under cancelCtx.mu.</span><br><br>deadline time.Time<br>&#125;<br><br><span class="hljs-comment">// é‡å†™Contextæ¥å£çš„Deadline()æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *timerCtx)</span></span> Deadline() (deadline time.Time, ok <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-keyword">return</span> c.deadline, <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><code>WithDeadline()</code> æ„é€ æ–¹æ³•<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithDeadline</span><span class="hljs-params">(parent Context, d time.Time)</span></span> (Context, CancelFunc) &#123;<br><span class="hljs-comment">// æ ¡éªŒparent ctxæ˜¯å¦ä¸ºç©º</span><br><span class="hljs-keyword">if</span> parent == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;cannot create context from nil parent&quot;</span>)<br>&#125;<br><span class="hljs-comment">// æ ¡éªŒparentçš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ¯”è‡ªå·±æ—©ï¼Œå¦‚æœæ¯”è‡ªå·±æ—©ï¼Œç›´æ¥æ„é€ ä¸€ä¸ªåŸºäºparentçš„cancelCtxå³å¯</span><br><span class="hljs-keyword">if</span> cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123;<br><span class="hljs-comment">// The current deadline is already sooner than the new one.</span><br><span class="hljs-keyword">return</span> WithCancel(parent)<br>&#125;<br><span class="hljs-comment">// æ„é€ æ–°çš„timerCtx</span><br>c := &amp;timerCtx&#123;<br>cancelCtx: newCancelCtx(parent),<br>deadline:  d,<br>&#125;<br><span class="hljs-comment">// ctxæ§åˆ¶é“¾çš„å–æ¶ˆå…³ç³»åŒæ­¥ï¼Œæ–¹å¼ä¸cancelCtxä¸€æ ·</span><br>propagateCancel(parent, c)<br><span class="hljs-comment">// åˆ¤æ–­è¿‡æœŸæ—¶é—´æ˜¯å¦å·²åˆ°ï¼Œè‹¥æ˜¯ï¼Œç›´æ¥ cancel timerCtxï¼Œå¹¶è¿”å› DeadlineExceeded çš„é”™è¯¯ï¼›</span><br>dur := time.Until(d)<br><span class="hljs-keyword">if</span> dur &lt;= <span class="hljs-number">0</span> &#123;<br>c.cancel(<span class="hljs-literal">true</span>, DeadlineExceeded, <span class="hljs-literal">nil</span>) <span class="hljs-comment">// deadline has already passed</span><br><span class="hljs-keyword">return</span> c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c.cancel(<span class="hljs-literal">false</span>, Canceled, <span class="hljs-literal">nil</span>) &#125;<br>&#125;<br><span class="hljs-comment">// å¯åŠ¨å®šæ—¶å™¨ï¼Œæ—¶é—´åˆ°äº†åå–æ¶ˆè¯¥ctx</span><br>c.mu.Lock()<br><span class="hljs-keyword">defer</span> c.mu.Unlock()<br><span class="hljs-keyword">if</span> c.err == <span class="hljs-literal">nil</span> &#123;<br>c.timer = time.AfterFunc(dur, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>c.cancel(<span class="hljs-literal">true</span>, DeadlineExceeded, <span class="hljs-literal">nil</span>)<br>&#125;)<br>&#125;<br><span class="hljs-keyword">return</span> c, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; c.cancel(<span class="hljs-literal">true</span>, Canceled, <span class="hljs-literal">nil</span>) &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><code>WithTimeout()</code> æ„é€ æ–¹æ³•<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// WithTimeout ç›´æ¥å¤ç”¨WithDeadlineæ–¹æ³•ï¼Œåœ¨å½“å‰æ—¶åˆ»åŠ ä¸Šæ—¶é—´æ®µå°±æ˜¯æœ€åçš„è¶…æ—¶æ—¶é—´</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc) &#123;<br><span class="hljs-keyword">return</span> WithDeadline(parent, time.Now().Add(timeout))<br>&#125;<br></code></pre></td></tr></table></figure></li><li><code>timerCtx.cancel()</code> æ–¹æ³•<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *timerCtx)</span></span> cancel(removeFromParent <span class="hljs-type">bool</span>, err, cause <span class="hljs-type">error</span>) &#123;<br><span class="hljs-comment">// ç›´æ¥å¤ç”¨cancelCtxçš„å–æ¶ˆèƒ½åŠ›</span><br>c.cancelCtx.cancel(<span class="hljs-literal">false</span>, err, cause)<br><span class="hljs-comment">// ä»parent ctxä¸­ç§»é™¤çˆ¶å­å…³ç³»</span><br><span class="hljs-keyword">if</span> removeFromParent &#123;<br><span class="hljs-comment">// Remove this timerCtx from its parent cancelCtx&#x27;s children.</span><br>removeChild(c.cancelCtx.Context, c)<br>&#125;<br><span class="hljs-comment">// åœæ­¢è®¡æ—¶å™¨</span><br>c.mu.Lock()<br><span class="hljs-keyword">if</span> c.timer != <span class="hljs-literal">nil</span> &#123;<br>c.timer.Stop()<br>c.timer = <span class="hljs-literal">nil</span><br>&#125;<br>c.mu.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="5-æ³¨æ„äº‹é¡¹"><a href="#5-æ³¨æ„äº‹é¡¹" class="headerlink" title="5. æ³¨æ„äº‹é¡¹"></a>5. æ³¨æ„äº‹é¡¹</h2><ul><li>ä¸è¦åœ¨ç»“æ„ç±»å‹ä¸­åŠ å…¥ Context å‚æ•°ï¼Œè€Œæ˜¯å°†å®ƒæ˜¾å¼åœ°ä¼ é€’ç»™éœ€è¦å®ƒçš„æ¯ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å®ƒåº”è¯¥æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé€šå¸¸å‘½åä¸º ctx:</li><li>Context æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æ”¾å¿ƒåœ°åœ¨å¤šä¸ª goroutine ä¸­ä½¿ç”¨ã€‚</li><li>å½“ä½ æŠŠ Context ä¼ é€’ç»™å¤šä¸ª goroutine ä½¿ç”¨æ—¶ï¼Œåªè¦æ‰§è¡Œä¸€æ¬¡ cancel æ“ä½œï¼Œæ‰€æœ‰çš„ goroutine å°±å¯ä»¥æ”¶åˆ° å–æ¶ˆçš„ä¿¡å·</li><li>ä¸è¦æŠŠåŸæœ¬å¯ä»¥ç”±å‡½æ•°å‚æ•°æ¥ä¼ é€’çš„å˜é‡ï¼Œäº¤ç»™ Context çš„ Value æ¥ä¼ é€’ã€‚<ul><li>ctxä¸€èˆ¬åªå­˜å‚¨è¯·æ±‚ç»´åº¦çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ã€logIdç­‰ï¼Œåªä¿ç•™å‘ŠçŸ¥ç±»å‹çš„æ•°æ®ï¼Œè€Œä¸ä¿ç•™æ§åˆ¶æ€§è´¨çš„æ•°æ®ï¼Œå³ä¸å­˜å‚¨ä¸šåŠ¡é€»è¾‘ä¸Šçš„æ§åˆ¶å‚æ•°æ•°æ®ã€‚</li></ul></li><li>å½“ä¸€ä¸ªå‡½æ•°éœ€è¦æ¥æ”¶ä¸€ä¸ª Context æ—¶ï¼Œä½†æ˜¯æ­¤æ—¶ä½ è¿˜ä¸çŸ¥é“è¦ä¼ é€’ä»€ä¹ˆ Context æ—¶ï¼Œå¯ä»¥å…ˆç”¨ context.TODO æ¥ä»£æ›¿ï¼Œè€Œä¸è¦é€‰æ‹©ä¼ é€’ä¸€ä¸ª nilã€‚</li><li>å½“ä¸€ä¸ª Context è¢« cancel æ—¶ï¼Œç»§æ‰¿è‡ªè¯¥ Context çš„æ‰€æœ‰ å­ Context éƒ½ä¼šè¢« cancelã€‚</li></ul><h2 id="6-å‚è€ƒèµ„æ–™"><a href="#6-å‚è€ƒèµ„æ–™" class="headerlink" title="6. å‚è€ƒèµ„æ–™"></a>6. å‚è€ƒèµ„æ–™</h2><p><a href="https://juejin.cn/post/7265880174381727759">Golang contextå®ç°åŸç†ä¸æºç åˆ†æ</a></p><p><a href="https://blog.51cto.com/u_15533611/5202001">Golang ç¬”è®°</a></p><p><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-context/">Goè¯­è¨€å¹¶å‘ç¼–ç¨‹-ä¸Šä¸‹æ–‡Context</a> </p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
      <category>å¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Context</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BigCacheè§£æ</title>
    <link href="/2024/08/10/BigCache%E8%A7%A3%E6%9E%90/"/>
    <url>/2024/08/10/BigCache%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>BigCacheæ˜¯ä¸€ä¸ªå¿«é€Ÿï¼Œæ”¯æŒå¹¶å‘è®¿é—®ï¼Œè‡ªæ·˜æ±°çš„å†…å­˜å‹ç¼“å­˜ï¼Œå¯ä»¥åœ¨å­˜å‚¨å¤§é‡å…ƒç´ çš„åŸºç¡€ä¸Šä¾ç„¶ä¿æŒé«˜æ€§èƒ½ã€‚BigCacheå°†å…ƒç´ ä¿å­˜åœ¨å †ä¸Šçš„åŒæ—¶é¿å…äº†GCçš„å¼€é”€ã€‚</p><span id="more"></span>  <h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>ç¼“å­˜æ˜¯ç³»ç»Ÿæå‡å¹¶å‘èƒ½åŠ›ã€é™ä½æ—¶å»¶çš„åˆ©å™¨ï¼Œæ ¹æ®å­˜å‚¨ä»‹è´¨å’Œä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬åˆ†ä¸ºæœ¬åœ°ç¼“å­˜ä¸åˆ†å¸ƒå¼ç¼“å­˜ä¸¤ç§ï¼š</p><ul><li>æœ¬åœ°ç¼“å­˜ï¼šä¸€èˆ¬åœ¨è¿›ç¨‹å†…ï¼Œæœ€ç®€å•çš„sync.Mapå°±å¯ä»¥æ˜¯ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„æœ¬åœ°ç¼“å­˜ã€‚å¸¸è§çš„æœ‰LocalCacheã€BigCacheç­‰ã€‚</li><li>åˆ†å¸ƒå¼ç¼“å­˜ï¼šä¸€èˆ¬ä¼šç”¨åˆ°Redis&#x2F;MemCachedç­‰åˆ†å¸ƒå¼å†…å­˜æ•°æ®åº“å®ç°ï¼Œæƒ³æ¯”å¦‚æœ¬åœ°ç¼“å­˜ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“å¢åŠ äº†ç½‘ç»œå¼€é”€</li></ul><p>BigCacheæ˜¯ä¸€ä¸ªå¿«é€Ÿï¼Œæ”¯æŒå¹¶å‘è®¿é—®ï¼Œè‡ªæ·˜æ±°çš„å†…å­˜å‹ç¼“å­˜ï¼Œå¯ä»¥åœ¨å­˜å‚¨å¤§é‡å…ƒç´ çš„åŸºç¡€ä¸Šä¾ç„¶ä¿æŒé«˜æ€§èƒ½ã€‚BigCacheå°†å…ƒç´ ä¿å­˜åœ¨å †ä¸Šçš„åŒæ—¶é¿å…äº†GCçš„å¼€é”€ã€‚</p><p>æºç åœ°å€ï¼š<a href="https://github.com/allegro/bigcache">https://github.com/allegro/bigcache</a><br>æœ¬æ–‡ç¤ºä¾‹ä»£ç å–è‡ªç‰ˆæœ¬ v1.2.1  </p><h2 id="2-è®¾è®¡æ€æƒ³"><a href="#2-è®¾è®¡æ€æƒ³" class="headerlink" title="2. è®¾è®¡æ€æƒ³"></a>2. è®¾è®¡æ€æƒ³</h2><h3 id="2-1-æ•´ä½“è®¾è®¡"><a href="#2-1-æ•´ä½“è®¾è®¡" class="headerlink" title="2.1 æ•´ä½“è®¾è®¡"></a>2.1 æ•´ä½“è®¾è®¡</h3><ul><li>å¤šï¼šÂ ç¼“å­˜çš„å…ƒç´ æ•°é‡éå¸¸å¤§ï¼Œå¯ä»¥è¾¾åˆ°ç™¾ä¸‡çº§æˆ–åƒä¸‡çº§ã€‚</li><li>å¿«ï¼šÂ å¯¹å»¶è¿Ÿæœ‰éå¸¸é«˜çš„è¦æ±‚ï¼Œå¹³å‡å»¶è¿Ÿè¦æ±‚åœ¨5æ¯«ç§’ä»¥å†…ã€‚æ”¯æŒ10k rpsçº§åˆ«çš„è®¿é—®é€Ÿåº¦ã€‚</li><li>ç¨³ï¼šÂ 99.9åˆ†ä½å»¶è¿Ÿåº”åœ¨10æ¯«ç§’å·¦å³ï¼Œ99.999åˆ†ä½å»¶è¿Ÿåº”åœ¨400æ¯«ç§’å·¦å³ã€‚</li></ul><p>ç›®å‰æœ‰è®¸å¤šå¼€æºçš„cacheåº“ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯åŸºäºmapå®ç°çš„ï¼Œä¾‹å¦‚go-cache,ttl-cacheç­‰ã€‚bigcacheæ˜ç¡®æŒ‡å‡ºï¼Œå½“æ•°æ®é‡å·¨å¤§æ—¶ï¼Œç›´æ¥åŸºäºmapå®ç°çš„cacheåº“å°†å‡ºç°ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ä»–ä»¬è®¾è®¡äº†ä¸€ä¸ªå…¨æ–°çš„cacheåº“çš„åŸå› ã€‚</p><ul><li>æ ¸å¿ƒè®¾è®¡æ€æƒ³<ul><li>æ•°æ®åˆ†ç‰‡å­˜å‚¨ï¼Œä»¥é™ä½é”å†²çªå¹¶æå‡å¹¶å‘é‡ã€‚</li><li>é¿å…åœ¨mapä¸­å­˜å‚¨æŒ‡é’ˆï¼Œä»è€Œé¿å…åœ¨GCæ—¶å¯¹mapè¿›è¡Œéå†æ‰«æã€‚</li><li>é‡‡ç”¨FIFOå¼çš„Ring Bufferè®¾è®¡ï¼Œç®€åŒ–æ•´ä½“å†…å­˜è®¾è®¡é€»è¾‘ã€‚</li></ul></li></ul><p><img src="/img/BigCache%E8%A7%A3%E6%9E%90/1.png"></p><h3 id="2-2-æ•°æ®åˆ†ç‰‡-Shard"><a href="#2-2-æ•°æ®åˆ†ç‰‡-Shard" class="headerlink" title="2.2 æ•°æ®åˆ†ç‰‡ Shard"></a>2.2 æ•°æ®åˆ†ç‰‡ Shard</h3><p>ä½¿ç”¨mapåšç¼“å­˜æ—¶ï¼Œå®ç°å¹¶å‘å®‰å…¨çš„æ–¹å¼å°±æ˜¯åŠ ä¸€æŠŠé”ã€‚ä½†æ˜¯å¦‚æœæ•°æ®è¿‡å¤šæ—¶ï¼Œå¹¶å‘è¯·æ±‚ä¼šå¯¼è‡´è¾ƒå¤šçš„é”å†²çªï¼Œä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼ŒBigCacheé‡‡ç”¨äº†åˆ†ç‰‡çš„æ–¹å¼é™ä½é”ç²’åº¦ã€‚åœ¨å£°æ˜ä¸€ä¸ªBigCacheæ—¶ï¼Œè¡¨é¢ä¸Šçœ‹æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåº•å±‚åˆ†æˆäº†Nä¸ªäº’ä¸å…³è”çš„éƒ¨åˆ†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> BigCache <span class="hljs-keyword">struct</span> &#123;<br>shards       []*cacheShard<br>lifeWindow   <span class="hljs-type">uint64</span><br>clock        clock<br>hash         Hasher<br>config       Config<br>shardMask    <span class="hljs-type">uint64</span><br>maxShardSize <span class="hljs-type">uint32</span><br><span class="hljs-built_in">close</span>        <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨Setæˆ–è€…Getæ•°æ®æ—¶ï¼Œå…ˆå¯¹keyè®¡ç®—hashå€¼ï¼Œæ ¹æ®hashå€¼å–ä½™å¾—åˆ°ç›®æ ‡shardï¼Œä¹‹åæ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½æ˜¯åœ¨å„è‡ªçš„shardä¸Šè¿›è¡Œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *BigCache)</span></span> Set(key <span class="hljs-type">string</span>, entry []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> &#123;<br>hashedKey := c.hash.Sum64(key)<br>shard := c.getShard(hashedKey)<br><span class="hljs-keyword">return</span> shard.set(key, hashedKey, entry)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è®¡ç®—åˆ†ç‰‡æ•°æ—¶ï¼Œå–ä½™æ“ä½œä½¿ç”¨çš„æ˜¯ä½è¿ç®—ï¼Œæ‰€æœ‰åˆ†ç‰‡æ•°è¦è®¾ç½®ä¸º2çš„å¹‚æ¬¡æ–¹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *BigCache)</span></span> getShard(hashedKey <span class="hljs-type">uint64</span>) (shard *cacheShard) &#123;<br><span class="hljs-keyword">return</span> c.shards[hashedKey&amp;c.shardMask]<br>&#125;<br><span class="hljs-comment">// shardMask = shardNum - 1</span><br></code></pre></td></tr></table></figure><ul><li>ç‰¹ç‚¹ï¼š<ul><li>å‡å°‘é”å†²çªï¼Œæå‡å¹¶å‘é‡ï¼šå½“ä¸€ä¸ªshardè¢«åŠ ä¸ŠLockçš„æ—¶å€™ï¼Œå…¶ä»–shardçš„è¯»å†™ä¸å—å½±å“ã€‚</li><li>shardä¸€æ—¦å»ºå¥½ï¼Œå°†ä¸å†æ”¹å˜ï¼Œæ— éœ€è€ƒè™‘shardå˜åŒ–æ—¶çš„æ•°æ®è¿ç§»é—®é¢˜ï¼Œshardä¹‹é—´æ“ä½œæ— éœ€åŠ é”ã€‚</li><li>shardä¸ªæ•°å¿…é¡»æ˜¯2çš„å¹³æ–¹æ•°ã€‚å¯¹2çš„å¹³æ–¹æ•°å–ä½™å¯ä»¥æ”¹æˆä½è¿ç®—ï¼Œä¼šæ¯”ä¼ ç»Ÿçš„%å¿«å¾ˆå¤š</li></ul></li></ul><h3 id="2-3-Map-GCä¼˜åŒ–"><a href="#2-3-Map-GCä¼˜åŒ–" class="headerlink" title="2.3 Map GCä¼˜åŒ–"></a>2.3 Map GCä¼˜åŒ–</h3><p>åœ¨golangä¸­ï¼Œmapçš„keyå’Œvalueä¸€æ—¦æ¶‰åŠåˆ°æŒ‡é’ˆç±»å‹ï¼Œåœ¨GCçš„æ—¶å€™å°±ä¼šè§¦å‘éå†æ‰«æï¼Œå½“æ•°æ®é‡çº§å¾ˆå¤§æ—¶ï¼Œ GCå»¶è¿Ÿä¸¥é‡ã€‚<br>åœ¨bigcacheçš„è®¾è®¡ä¸­ï¼Œmapå®šä¹‰ä¸ºmap[uint64]uint32Â ï¼Œé¿å…äº†å­˜å‚¨ä»»ä½•æŒ‡é’ˆã€‚ç»“æ„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> cacheShard <span class="hljs-keyword">struct</span> &#123;<br>hashmap     <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-type">uint32</span><br>entries     queue.BytesQueue<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><ul><li>hashmapçš„keyæ˜¯cache keyçš„hashå€¼ï¼Œè€Œvalueä»…ä»…æ˜¯ä¸ªuint32ã€‚valueå­˜å‚¨çš„ä¸å†æ˜¯å®é™…å€¼ï¼Œè€Œæ˜¯valueåœ¨ BytesQueueä¸­çš„ç´¢å¼•ã€‚</li><li>entrieså­˜å‚¨çš„æ˜¯å®é™…valueå€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªring bufferçš„å†…å­˜ç»“æ„ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸ªè¶…å¤§çš„[]byteæ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾äº†æ‰€æœ‰çš„åŸå§‹æ•°æ®ã€‚æ¯ä¸ªåŸå§‹æ•°æ®å°±å­˜æ”¾åœ¨è¿™ä¸ªå¤§[]byteæ•°ç»„ä¸­çš„å…¶ä¸­ä¸€æ®µã€‚<br>ä¹‹æ‰€ä»¥ç”¨ä¸€ä¸ªå¤§çš„[]byteæ•°ç»„å’Œring bufferç»“æ„ï¼Œé™¤äº†æ–¹ä¾¿ç®¡ç†å’Œå¤ç”¨å†…å­˜ä¹‹å¤–ï¼Œä¸€ä¸ªæ›´é‡è¦çš„åŸå› æ˜¯ï¼šå¯¹äº[]byteæ•°ç»„, GCæ—¶åªç”¨çœ‹åšä¸€ä¸ªå˜é‡æ‰«æï¼Œæ— éœ€å†éå†å…¨éƒ¨æ•°ç»„ã€‚è¿™æ ·åˆé¿å…äº†æµ·é‡æ•°æ®å¯¹GCé€ æˆçš„è´Ÿæ‹…ã€‚</li></ul><h3 id="2-4-BytesQueueå†…å­˜"><a href="#2-4-BytesQueueå†…å­˜" class="headerlink" title="2.4 BytesQueueå†…å­˜"></a>2.4 BytesQueueå†…å­˜</h3><p>BigCacheä¸­çš„æ¯ä¸€ä¸ªshardéƒ½é‡‡ç”¨ç±»ä¼¼RingBufferçš„ç»“æ„</p><ul><li>å¯¹äºmapä¸­æ¯ä¸ªå…ƒç´ è€Œè¨€ï¼Œkeyå­˜å‚¨çš„æ˜¯ cache keyçš„hashå€¼ï¼Œvalueå­˜å‚¨çš„æ˜¯å®é™…å€¼åœ¨byteæ•°ç»„ä¸­çš„ä½ç½®ã€‚</li><li>æ•°æ®å­˜å‚¨å®Œå…¨é‡‡ç”¨FIFOçš„å½¢å¼ï¼Œæ‰€æœ‰æ•°æ®çš„æ–°å¢ã€åŒ…æ‹¬è€æ•°æ®çš„ä¿®æ”¹ï¼Œéƒ½æ˜¯ç›´æ¥è¿½åŠ åˆ°æ•°ç»„çš„åé¢ï¼Œç„¶åä¿®æ”¹mapçš„ä½ç½®å€¼å³å¯ã€‚<br><img src="/img/BigCache%E8%A7%A3%E6%9E%90/2.png"></li></ul><p>å…·ä½“åˆ°æ¯ä¸€ä¸ªæ•°æ®çš„å­˜å‚¨ï¼Œå¹¶ä¸æ˜¯å®Œå…¨åªå­˜å‚¨valå€¼ï¼Œä¼šæŠŠä¸€äº›ç›¸å…³çš„ä¿¡æ¯ä¸€èµ·å­˜å‚¨ï¼Œæ„æˆæ•°æ®headerå’Œbodyï¼Œï¼Œä¸€ä¸ªheaderå’Œä¸€ä¸ªbodyæ„æˆä¸€ä¸ªå®Œæ•´çš„æ¡ç›®ï¼Œå…¶ä¸­ï¼š</p><ul><li>Block Sizeï¼šæ ‡è®°headerå’ŒBodyï¼Œä¹Ÿå°±æ˜¯Entryçš„æ€»é•¿åº¦</li><li>headerï¼šåŒ…æ‹¬ æ’å…¥æ—¶é—´æˆ³ï¼Œkeyçš„hashå€¼ï¼Œkeyçš„é•¿åº¦ï¼Œ headerçš„é•¿åº¦å›ºå®š</li><li>bodyï¼škeyçš„åŸå§‹å€¼ï¼Œvalueçš„åŸå§‹å€¼</li><li>æœ‰äº†BlockSizeã€Header Lengthä»¥åŠKeyçš„é•¿åº¦ï¼Œå°±å¯ä»¥ç¡®å®švalueçš„è¾¹ç•Œå¹¶æ­£å¸¸è¿›è¡Œæ•°æ®è¯»å–äº†ã€‚<br><img src="/img/BigCache%E8%A7%A3%E6%9E%90/3.png"></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br><span class="hljs-comment">// headerä¸­çš„æ—¶é—´æˆ³ã€hashå€¼å’Œkeyé•¿åº¦å ç”¨å­—èŠ‚æ•°å›ºå®šï¼Œå¯ä»¥æ–¹ä¾¿æ‰¾åˆ°keyåŸå§‹å€¼çš„èµ·å§‹ä½ç½®</span><br>timestampSizeInBytes = <span class="hljs-number">8</span>       <span class="hljs-comment">// Number of bytes used for timestamp</span><br>hashSizeInBytes      = <span class="hljs-number">8</span>       <span class="hljs-comment">// Number of bytes used for hash</span><br>keySizeInBytes       = <span class="hljs-number">2</span>       <span class="hljs-comment">// Number of bytes used for size of entry key</span><br>headersSizeInBytes   = timestampSizeInBytes + hashSizeInBytes + keySizeInBytes <span class="hljs-comment">// Number of bytes used for all headers</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">wrapEntry</span><span class="hljs-params">(timestamp <span class="hljs-type">uint64</span>, hash <span class="hljs-type">uint64</span>, key <span class="hljs-type">string</span>, entry []<span class="hljs-type">byte</span>, buffer *[]<span class="hljs-type">byte</span>)</span></span> []<span class="hljs-type">byte</span> &#123;<br>keyLength := <span class="hljs-built_in">len</span>(key)<br>blobLength := <span class="hljs-built_in">len</span>(entry) + headersSizeInBytes + keyLength<br><br><span class="hljs-keyword">if</span> blobLength &gt; <span class="hljs-built_in">len</span>(*buffer) &#123;<br>*buffer = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, blobLength)<br>&#125;<br>blob := *buffer<br><br><span class="hljs-comment">// æŒ‰ç…§å°ç«¯åºçš„æ–¹å¼ï¼Œé¡ºåºå†™å…¥æ—¶é—´æˆ³ã€keyçš„hashå€¼ã€keyçš„é•¿åº¦ã€keyçš„å®é™…å€¼ä»¥åŠvalueçš„å®é™…å€¼</span><br>binary.LittleEndian.PutUint64(blob, timestamp)<br>binary.LittleEndian.PutUint64(blob[timestampSizeInBytes:], hash)<br>binary.LittleEndian.PutUint16(blob[timestampSizeInBytes+hashSizeInBytes:], <span class="hljs-type">uint16</span>(keyLength))<br><span class="hljs-built_in">copy</span>(blob[headersSizeInBytes:], key)<br><span class="hljs-built_in">copy</span>(blob[headersSizeInBytes+keyLength:], entry)<br><br><span class="hljs-keyword">return</span> blob[:blobLength]<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>RingBufferæ»¡æ—¶ï¼ŒbigCacheå¦‚ä½•å¤„ç†ï¼Ÿ<ul><li>å¦‚æœentries queue.BytesQueueÂ æœªè¾¾åˆ°è®¾å®šçš„HardMaxCacheSizeï¼ˆæœ€å¤§å†…å­˜ä¸Šé™ï¼‰ï¼Œæˆ–è€…æ— HardMaxCacheSizeè¦æ±‚ï¼Œåˆ™ç›´æ¥æ‰©å®¹queue.BytesQueueÂ ç›´åˆ°è¾¾åˆ°ä¸Šé™ã€‚ä¸è¿‡æ‰©å®¹çš„æ—¶å€™ï¼Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç©º[]byteæ•°ç»„ï¼ŒæŠŠåŸæœ‰æ•°æ®copyè¿‡å»ã€‚</li><li>å¦‚æœå†…å­˜å·²è¾¾ä¸Šé™ï¼Œæ— æ³•ç»§ç»­æ‰©å®¹ï¼Œåˆ™ä¼šå°è¯•åˆ é™¤æœ€æ—§æ•°æ®ï¼ˆæ— è®ºæ˜¯å¦è¿‡æœŸï¼‰ï¼Œç›´è‡³å¯ä»¥å°†æ•°æ®æ”¾åˆ°BytesQueueä¸­ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™æ–°æ•°æ®éå¸¸å¤§ï¼Œå¯èƒ½ä¼šä¸ºæ­¤æ·˜æ±°æ‰è®¸å¤šæ—§æ•°æ®ã€‚</li></ul></li></ul><h3 id="2-5-é”å†²çª"><a href="#2-5-é”å†²çª" class="headerlink" title="2.5 é”å†²çª"></a>2.5 é”å†²çª</h3><p>BigCacheä½¿ç”¨Keyçš„hashå€¼æŸ¥æ‰¾æ•°æ®ï¼Œä¸å¯é¿å…çš„ä¼šå¯¼è‡´hashå†²çªé—®é¢˜ã€‚é”å†²çªåœ¨å†™å…¥å’Œè¯»å–çš„è¿‡ç¨‹ä¸­éƒ½æœ‰å¯èƒ½å‘ç”Ÿã€‚ä¸‹é¢åˆ†åˆ«åˆ†æSetå’ŒGetçš„è¿‡ç¨‹ï¼Œé¡ºä¾¿çœ‹çœ‹é”å†²çªæ˜¯å¦‚ä½•è§£å†³çš„ã€‚</p><ul><li>Setæµç¨‹<ul><li>è®¡ç®—keyçš„hashå€¼ï¼Œå¾—åˆ°å¯¹åº”çš„shard</li><li>å°†keyå’Œvalueç­‰ä¿¡æ¯åºåˆ—åŒ–æˆæŒ‡å®šæ ¼å¼çš„[]byte, pushåˆ°BytesQueueä¸­ã€‚</li><li>æ ¹æ®BytesQueueè¿”å›çš„åç§»é‡(ä¹Ÿå°±æ˜¯æ•°ç»„ä¸‹æ ‡)ï¼Œå°†key(hashå€¼)å’Œvalue(æ•°ç»„ä¸‹æ ‡)è®¾ç½®hashmapä¸­ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *cacheShard)</span></span> set(key <span class="hljs-type">string</span>, hashedKey <span class="hljs-type">uint64</span>, entry []<span class="hljs-type">byte</span>) <span class="hljs-type">error</span> &#123;<br>currentTimestamp := <span class="hljs-type">uint64</span>(s.clock.epoch())<br><br>s.lock.Lock()<br><span class="hljs-comment">// ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå‘ç°å­˜åœ¨å·²æœ‰çš„hashKeyï¼ˆå¯èƒ½æ˜¯å†²çªï¼Œä¹Ÿå¯èƒ½æ˜¯æœ¬æ¥å°±å­˜åœ¨ï¼‰ï¼Œbigcacheå¹¶ä¸ä¼šåšç‰¹æ®Šå¤„ç†ï¼Œè€Œæ˜¯ç›´æ¥å°†åŸæœ¬çš„ä½ç½®resetï¼Œå¹¶å°†æ–°çš„å€¼pushåˆ°æœ€åï¼Œç„¶åæ›¿æ¢è¿™ä¸ªkeyçš„ä¸‹æ ‡</span><br><span class="hljs-keyword">if</span> previousIndex := s.hashmap[hashedKey]; previousIndex != <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> previousEntry, err := s.entries.Get(<span class="hljs-type">int</span>(previousIndex)); err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// resetKeyFromEntry ä¼šå°†æ¡ç›®ä¸­keyçš„hashå€¼ç½®é›¶</span><br>resetKeyFromEntry(previousEntry)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> oldestEntry, err := s.entries.Peek(); err == <span class="hljs-literal">nil</span> &#123;<br>s.onEvict(oldestEntry, currentTimestamp, s.removeOldestEntry)<br>&#125;<br><br><span class="hljs-comment">// æ„å»ºä¸€ä¸ªæ•°æ®æ¡ç›®</span><br>w := wrapEntry(currentTimestamp, hashedKey, key, entry, &amp;s.entryBuffer)<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// å°†æ•°æ®æ¡ç›®pushåˆ°æœ€åï¼Œå¹¶ä¿®æ”¹hashmapçš„å€¼ï¼Œå°±å®Œæˆäº†å¢åŠ æˆ–è€…æ›´æ–°</span><br><span class="hljs-keyword">if</span> index, err := s.entries.Push(w); err == <span class="hljs-literal">nil</span> &#123;<br>s.hashmap[hashedKey] = <span class="hljs-type">uint32</span>(index)<br>s.lock.Unlock()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">if</span> s.removeOldestEntry(NoSpace) != <span class="hljs-literal">nil</span> &#123;<br>s.lock.Unlock()<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;entry is bigger than max shard size&quot;</span>)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li>Getæµç¨‹<ul><li>è¯»æ•°æ®ï¼Œhashå†²çªæ—¶ç›´æ¥è¿”å›æ•°æ®ä¸å­˜åœ¨ï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯å­˜å‚¨keyå®é™…å€¼çš„æ„ä¹‰æ‰€åœ¨ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *cacheShard)</span></span> get(key <span class="hljs-type">string</span>, hashedKey <span class="hljs-type">uint64</span>) ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>s.lock.RLock()<br>itemIndex := s.hashmap[hashedKey]<br><br><span class="hljs-comment">// bigcache ä¸­ï¼Œ ringbuffer çš„ç¬¬ 0 ä½å¹¶ä¸ç”¨æ¥å­˜æ”¾ä»»ä½•æ•°æ®ï¼Œ</span><br><span class="hljs-comment">// å¦‚æœå‘ç° åˆ†ç‰‡ map ä¸­å¾—åˆ°æ•°æ®çš„ index ä¸º 0ï¼Œå°±å¯ä»¥ç›´æ¥è®¤ä¸ºæ²¡æœ‰å¯¹åº”çš„ç¼“å­˜æ•°æ®</span><br><span class="hljs-keyword">if</span> itemIndex == <span class="hljs-number">0</span> &#123;<br>s.lock.RUnlock()<br>s.miss()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, ErrEntryNotFound<br>&#125;<br><br><span class="hljs-comment">// ä»ringbuffä¸­è·å–åˆ°æŒ‡å®škeyçš„æ¡ç›®æ•°æ®</span><br>wrappedEntry, err := s.entries.Get(<span class="hljs-type">int</span>(itemIndex))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>s.lock.RUnlock()<br>s.miss()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-comment">// ä»æ•°æ®ä¸­è§£æå‡ºå®é™…å­˜å‚¨çš„key</span><br><span class="hljs-comment">// å¦‚æœå®é™…å­˜å‚¨çš„keyè·ŸæŸ¥è¯¢çš„keyä¸ä¸€è‡´ï¼Œè¯´æ˜äº§ç”Ÿäº†hashå†²çªï¼Œç›´æ¥è¿”å›ç©º</span><br><span class="hljs-keyword">if</span> entryKey := readKeyFromEntry(wrappedEntry); key != entryKey &#123;<br><span class="hljs-keyword">if</span> s.isVerbose &#123;<br>s.logger.Printf(<span class="hljs-string">&quot;Collision detected. Both %q and %q have the same hash %x&quot;</span>, key, entryKey, hashedKey)<br>&#125;<br>s.lock.RUnlock()<br>s.collision()<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, ErrEntryNotFound<br>&#125;<br>entry := readEntry(wrappedEntry)<br>s.lock.RUnlock()<br>s.hit()<br><span class="hljs-keyword">return</span> entry, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="2-6-æ•°æ®åˆ é™¤"><a href="#2-6-æ•°æ®åˆ é™¤" class="headerlink" title="2.6 æ•°æ®åˆ é™¤"></a>2.6 æ•°æ®åˆ é™¤</h3><p>BigCacheçš„åˆ é™¤æ¯”è¾ƒç®€å•ï¼Œæœ¬è´¨ä¸Šåªæ˜¯å°†keyä»mapä¸­åˆ é™¤ï¼Œå¹¶æ²¡æœ‰å®é™…åˆ é™¤BytesQueueä¸­çš„æ•°æ®ï¼Œæ ¸å¿ƒé€»è¾‘åªæœ‰ä¸¤è¡Œã€‚å®é™…å€¼çš„åˆ é™¤ä¼šç­‰åˆ°æ•°æ®æ¸…ç†æˆ–è€…Bufferæ»¡çš„æ—¶å€™æ·˜æ±°æ‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">...<br><span class="hljs-comment">// ä»hashmapä¸­åˆ é™¤keyï¼Œä½¿æ•°æ®ä¸å¯è¯»</span><br><span class="hljs-built_in">delete</span>(s.hashmap, hashedKey)<br>...<br><span class="hljs-comment">// å°†entryæ¡ç›®çš„keyçš„hashå€¼ç½®é›¶</span><br>resetHashFromEntry(wrappedEntry)<br>...<br></code></pre></td></tr></table></figure><h3 id="2-7-è¿‡æœŸæ·˜æ±°"><a href="#2-7-è¿‡æœŸæ·˜æ±°" class="headerlink" title="2.7 è¿‡æœŸæ·˜æ±°"></a>2.7 è¿‡æœŸæ·˜æ±°</h3><p>BigCacheä¸­çš„æ•°æ®åœ¨åˆ é™¤æ•°æ®æˆ–è€…Setæ•°æ®æ—¶ï¼Œå¦‚æœç¢°åˆ°å°±å€¼ï¼Œåªæ˜¯åˆ é™¤æˆ–è€…ä¿®æ”¹hashmapä¸­çš„å€¼ï¼Œå¹¶ä¸ä¼šå®é™…åˆ é™¤æ•°æ®ã€‚å®é™…çš„æ•°æ®åˆ é™¤å‘ç”Ÿåœ¨è¿‡æœŸæ·˜æ±°æ—¶ã€‚</p><p>ğŸ“Œ <font color="red">BigCacheæ²¡æœ‰å¼€æ”¾å•ä¸ªå…ƒç´ çš„å¯è¿‡æœŸæ—¶é—´ï¼Œæ‰€æœ‰å…ƒç´ çš„cacheæ—¶é•¿éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™å°±æ„å‘³ç€æ‰€æœ‰å…ƒç´ çš„è¿‡æœŸæ—¶é—´åœ¨é˜Ÿåˆ—ä¸­å¤©ç„¶æœ‰åºã€‚</font>    </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *cacheShard)</span></span> cleanUp(currentTimestamp <span class="hljs-type">uint64</span>) &#123;<br>s.lock.Lock()<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// åªè¦å­˜åœ¨å…ƒç´ ï¼Œå°±é€ä¸ªä¾¿åˆ©</span><br><span class="hljs-keyword">if</span> oldestEntry, err := s.entries.Peek(); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">break</span><br><span class="hljs-comment">// ç›´è‡³æŸä¸ªå…ƒç´ ä¸è¿‡æœŸä¸ºæ­¢</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> evicted := s.onEvict(oldestEntry, currentTimestamp, s.removeOldestEntry); !evicted &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br>&#125;<br>s.lock.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-æ³¨æ„äº‹é¡¹"><a href="#3-æ³¨æ„äº‹é¡¹" class="headerlink" title="3. æ³¨æ„äº‹é¡¹"></a>3. æ³¨æ„äº‹é¡¹</h2><h3 id="3-1-æ•°æ®è¿‡æœŸå¤„ç†"><a href="#3-1-æ•°æ®è¿‡æœŸå¤„ç†" class="headerlink" title="3.1 æ•°æ®è¿‡æœŸå¤„ç†"></a>3.1 æ•°æ®è¿‡æœŸå¤„ç†</h3><p>åœ¨bigcacheä¸­ï¼ŒLifeWindowå’ŒCleanWindowæ˜¯ä¸¤ä¸ªç”¨äºç¼“å­˜ç®¡ç†çš„é‡è¦å‚æ•°ï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„ä½œç”¨ã€‚</p><ul><li>LifeWindow æ˜¯ç¼“å­˜æ¡ç›®çš„ç”Ÿå­˜æ—¶é—´ï¼Œå†³å®šäº†æ¡ç›®åœ¨å¤šé•¿æ—¶é—´å†…ä¼šè¢«è§†ä¸ºè¿‡æœŸã€‚</li><li>CleanWindow æ˜¯æ¸…ç†è¿‡ç¨‹çš„æ—¶é—´é—´éš”ï¼Œå†³å®šäº†è¿‡æœŸæ¡ç›®å®é™…è¢«æ¸…é™¤çš„é¢‘ç‡ã€‚</li></ul><p>è¿™ç§æœºåˆ¶ä½¿å¾—bigcacheåœ¨è®¾è®¡ä¸Šå…è®¸è¯»å–è¿‡æœŸæ•°æ®ã€‚å®ƒä¸ä¼šä¸»åŠ¨é˜»æ­¢è®¿é—®å·²ç»è¿‡æœŸçš„ç¼“å­˜æ¡ç›®ï¼Œé™¤éè¿™äº›æ¡ç›®åœ¨CleanWindowæœŸé—´è¢«æ¸…ç†æ‰ã€‚</p><p>bigcacheçš„è¿™ç§è®¾è®¡æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå› ä¸ºåœ¨æ¯æ¬¡è®¿é—®ç¼“å­˜æ—¶éƒ½æ£€æŸ¥æ¡ç›®æ˜¯å¦è¿‡æœŸä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚é€šè¿‡å¼‚æ­¥æ¸…ç†è¿‡æœŸæ¡ç›®ï¼Œbigcacheèƒ½å¤Ÿåœ¨ä¸å½±å“è®¿é—®é€Ÿåº¦çš„æƒ…å†µä¸‹æä¾›ç¼“å­˜åŠŸèƒ½ã€‚</p><p>å¦‚æœå¯¹æ•°æ®çš„æ—¶æ•ˆæ€§è¦æ±‚å¾ˆé«˜ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨è¯»å–åæ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">item, err := cache.Get(<span class="hljs-string">&quot;myKey&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-comment">// Handle the error</span><br>&#125;<br><br>timestamp := extractTimestamp(item) <span class="hljs-comment">// è§£ææ•°æ®ä¸­çš„æ—¶é—´æˆ³</span><br><span class="hljs-keyword">if</span> time.Since(timestamp) &gt; cacheLifeWindow &#123;<br>    <span class="hljs-comment">// Data is considered stale</span><br>    <span class="hljs-comment">// Handle the stale data case</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-å‚è€ƒæ–‡çŒ®"><a href="#4-å‚è€ƒæ–‡çŒ®" class="headerlink" title="4. å‚è€ƒæ–‡çŒ®"></a>4. å‚è€ƒæ–‡çŒ®</h2><p><a href="https://juejin.cn/post/7107635176263385118">https://juejin.cn/post/7107635176263385118</a></p><p><a href="https://www.cyhone.com/articles/bigcache/">https://www.cyhone.com/articles/bigcache/</a> </p><p><a href="https://mp.weixin.qq.com/s/e-ku-fLsLk0Ok2eTkdx6Dw">https://mp.weixin.qq.com/s/e-ku-fLsLk0Ok2eTkdx6Dw</a></p><p><a href="https://juejin.cn/post/7258840980428750885">https://juejin.cn/post/7258840980428750885</a></p><p><a href="https://xiaorui.cc/archives/7385">https://xiaorui.cc/archives/7385</a></p>]]></content>
    
    
    <categories>
      
      <category>ç³»ç»Ÿè®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>BigCache</tag>
      
      <tag>æœ¬åœ°ç¼“å­˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¸ƒéš†è¿‡æ»¤å™¨</title>
    <link href="/2024/08/03/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
    <url>/2024/08/03/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆè‹±è¯­ï¼šBloom Filterï¼‰æ˜¯ 1970 å¹´ç”±å¸ƒéš†æå‡ºçš„ã€‚å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡å’Œä¸€ç³»åˆ—éšæœºæ˜ å°„å‡½æ•°ã€‚ä¸»è¦ç”¨äºåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚</p><span id="more"></span>  <h2 id="1-èƒŒæ™¯"><a href="#1-èƒŒæ™¯" class="headerlink" title="1. èƒŒæ™¯"></a>1. èƒŒæ™¯</h2><p>é€šå¸¸æˆ‘ä»¬è¦åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨æŸä¸ªé›†åˆä¸­æ—¶ï¼Œç»å¸¸æƒ³åˆ°çš„æ–¹å¼æ˜¯å°†é›†åˆä¸­æ‰€æœ‰å…ƒç´ ä¿å­˜èµ·æ¥ï¼Œç„¶åé€šè¿‡æ¯”è¾ƒè¿›è¡Œç¡®å®šã€‚é“¾è¡¨ã€æ ‘ã€æ•£åˆ—è¡¨ï¼ˆåˆå«å“ˆå¸Œè¡¨ï¼ŒHash tableï¼‰ç­‰æ•°æ®ç»“æ„éƒ½æ˜¯è¿™ç§æ€è·¯ã€‚ä½†æ˜¯éšç€é›†åˆä¸­å…ƒç´ æ•°é‡çš„å¢åŠ ï¼Œè¿™å‡ ç§æ–¹å¼éœ€è¦çš„å­˜å‚¨ç©ºé—´ä¹Ÿä¼šå‘ˆç°çº¿æ€§å¢é•¿ï¼Œæœ€ç»ˆè¾¾åˆ°ç“¶é¢ˆã€‚ä¸Šè¿°ä¸‰ç§ç»“æ„çš„æ£€ç´¢æ—¶é—´å¤æ‚åº¦åˆ†åˆ«ä¸ºO(n)ï¼ŒO(logn)ï¼ŒO(1)ã€‚</p><h2 id="2-ç®—æ³•ä»‹ç»"><a href="#2-ç®—æ³•ä»‹ç»" class="headerlink" title="2. ç®—æ³•ä»‹ç»"></a>2. ç®—æ³•ä»‹ç»</h2><h3 id="2-1-åŸç†"><a href="#2-1-åŸç†" class="headerlink" title="2.1 åŸç†"></a>2.1 åŸç†</h3><p>å¸ƒéš†è¿‡æ»¤å™¨åŒ…å«ä¸€ä¸ªä½æ•°ç»„å’Œä¸€ç»„å“ˆå¸Œå‡½æ•°ã€‚ä½æ•°ç»„æ¯ä¸ªå…ƒç´ å­˜å‚¨çš„éƒ½æ˜¯æ¯”ç‰¹ä½ï¼Œå…ƒç´ å ç”¨ç©ºé—´å¾ˆå°ï¼›ä½¿ç”¨ä¸€ç»„å“ˆå¸Œå‡½æ•°çš„åŸå› æ˜¯ä¸ºäº†é™ä½å“ˆå¸Œå†²çªã€‚</p><ul><li>åˆå§‹çŠ¶æ€ï¼šä¸€ä¸ªä½æ•°ç»„ï¼Œå…¨éƒ¨ä½ç½®éƒ½ç½®ä¸º0<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/1.png"></li><li>æ•°æ®åŠ å…¥ï¼šåˆ†åˆ«ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ å€¼è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°ä¸€ç»„å“ˆå¸Œå€¼ï¼Œå°†å¯¹åº”å“ˆå¸Œå€¼ä¸‹æ ‡çš„æ•°ç»„å€¼ç½®ä¸º1<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/2.png"></li><li>æ•°æ®æŸ¥æ‰¾ï¼šå¯¹ç»™å®šå…ƒç´ è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè®¡ç®—ï¼Œåˆ¤æ–­æ¯ä¸ªä½ç½®çš„å€¼æ˜¯å¦éƒ½ä¸º1ã€‚å¦‚æœå€¼éƒ½ä¸º1ï¼Œå°±è®¤ä¸ºè¿™ä¸ªå…ƒç´ å­˜åœ¨ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå€¼ä¸å”¯ä¸€ï¼Œå°±è¯´æ˜è¿™ä¸ªå€¼ä¸å­˜åœ¨ã€‚</li></ul><p>ğŸ“Œ <font color="red">æ³¨æ„ï¼šå¸ƒéš†è¿‡æ»¤å™¨è¿”å›çš„ç»“æœæ˜¯â€œå¯èƒ½å­˜åœ¨â€å’Œâ€œä¸€å®šä¸å­˜åœ¨â€ï¼Œä¸èƒ½æä¾›â€œä¸€å®šå­˜åœ¨â€çš„è¯­ä¹‰ä¿è¯ã€‚å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªå…ƒç´ æ˜ å°„åˆ°åŒä¸€ä¸ªä½ç½®ï¼Œå¯¼è‡´è¯¯åˆ¤ã€‚</font>    </p><h3 id="2-2-è¯¯åˆ¤"><a href="#2-2-è¯¯åˆ¤" class="headerlink" title="2.2 è¯¯åˆ¤"></a>2.2 è¯¯åˆ¤</h3><p>è¯¯åˆ¤ç‡ï¼ˆå‡é˜³æ€§ï¼‰ï¼šä¸€ä¸ªä¸å­˜åœ¨çš„å…ƒç´ ï¼Œå¯èƒ½ä¼šè¢«è¯¯åˆ¤ä¸ºå­˜åœ¨</p><h4 id="2-2-1-è¯¯åˆ¤åŸå› "><a href="#2-2-1-è¯¯åˆ¤åŸå› " class="headerlink" title="2.2.1 è¯¯åˆ¤åŸå› "></a>2.2.1 è¯¯åˆ¤åŸå› </h4><ul><li>å“ˆå¸Œå‡½æ•°å†²çªï¼šä¸åŒçš„å“ˆå¸Œå‡½æ•°å¯¹å…ƒç´ è¿›è¡Œæ˜ å°„æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå†²çªï¼Œå¯¼è‡´ä¸åŒå…ƒç´ å› ç´ åˆ°ä½æ•°ç»„çš„ç›¸åŒä½ç½®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šwçš„ä½ç½®éƒ½å·²ç»æ˜¯1ï¼Œè¢«è®¤ä¸ºwå­˜åœ¨ã€‚</li><li>ä½æ•°ç»„å¤§å°é™åˆ¶ï¼šä¸ºå‡å°‘ç©ºé—´å ç”¨ï¼Œä½æ•°ç»„å¤§å°æœ‰é™ã€‚å½“å­˜å‚¨çš„å…ƒç´ æ•°é‡è¾ƒå¤šæ—¶ï¼Œæ•°æ®å†²çªå¯èƒ½æ€§å‡é«˜ã€‚<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/3.png"></li></ul><h4 id="2-2-2-è¯¯åˆ¤æ¦‚ç‡"><a href="#2-2-2-è¯¯åˆ¤æ¦‚ç‡" class="headerlink" title="2.2.2 è¯¯åˆ¤æ¦‚ç‡"></a>2.2.2 è¯¯åˆ¤æ¦‚ç‡</h4><p>å¸ƒéš†è¿‡æ»¤å™¨çš„è¯¯åˆ¤ï¼Œä¸»è¦æ˜¯å› ä¸ºå“ˆå¸Œå‡½æ•°å­˜åœ¨å†²çªå¯¼è‡´ï¼Œå³ä¸åŒçš„å€¼å¯èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªä½ç½®ã€‚åœ¨è¿›è¡Œè¯¯åˆ¤ç‡çš„åˆ†ææ—¶ï¼Œä¸»è¦å—åˆ°ä»¥ä¸‹å˜é‡çš„åˆ¶çº¦ï¼š</p><ul><li><p>mï¼šå¸ƒéš†è¿‡æ»¤å™¨çš„é•¿åº¦ï¼Œå³æ•°ç»„çš„é•¿åº¦</p></li><li><p>nï¼š é›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°</p></li><li><p>kï¼š å“ˆå¸Œå‡½æ•°çš„ä¸ªæ•°<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/4.png"></p></li><li><p>è¯¯åˆ¤ç‡ï¼šæŒ‡å®šmã€nã€kæƒ…å†µä¸‹çš„è¯¯åˆ¤ç‡è®¡ç®—<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/5.png"></p></li><li><p>é•¿åº¦ï¼šæ•°ç»„é•¿åº¦å¯ä»¥æ ¹æ®æœŸæœ›çš„è¯¯åˆ¤ç‡å’Œå…ƒç´ ä¸ªæ•°æ¥åˆ¤æ–­<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/6.png"></p></li><li><p>å“ˆå¸Œå‡½æ•°è®¡ç®—ï¼šæŒ‡å®šmå’Œnçš„æƒ…å†µä¸‹ï¼Œå‡å°‘è¯¯åˆ¤çš„æœ€ä½³å“ˆå¸Œä¸ªæ•°<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/7.png"></p></li></ul><p>æ¨å¯¼è¿‡ç¨‹ï¼š</p><ul><li>æ·»åŠ 1ä¸ªå…ƒç´ ï¼Œåˆ™ä»»ä¸€æ¯”ç‰¹ä¸º1çš„æ¦‚ç‡ä¸ºï¼š1&#x2F;mï¼Œä»»ä¸€æ¯”ç‰¹ä¸º0çš„æ¦‚ç‡ï¼š1-1&#x2F;mï¼›</li><li>æ·»åŠ 1ä¸ªå…ƒç´ ï¼Œæ‰§è¡Œkæ¬¡æ•£åˆ—ä¹‹åï¼Œåˆ™ä»»ä¸€æ¯”ç‰¹ä¸º0çš„æ¦‚ç‡ï¼š(1-1&#x2F;m)^kï¼Œä»»ä¸€æ¯”ç‰¹ä¸º1çš„æ¦‚ç‡ï¼š1-(1-1&#x2F;m)^kï¼›</li><li>å¦‚æœæ·»åŠ nä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆä»»ä¸€æ¯”ç‰¹ä¸º0çš„æ¦‚ç‡ï¼š(1-1&#x2F;m)^knï¼Œä»»ä¸€æ¯”ç‰¹ä¸º1çš„æ¦‚ç‡ï¼š1-(1-1&#x2F;m)^knï¼›</li><li>å¦‚æœå°†1ä¸ªæ–°çš„å…ƒç´ ï¼Œæ·»åŠ åˆ°å·²å­˜åœ¨nä¸ªå…ƒç´ çš„å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œåˆ™ä»»ä¸€æ¯”ç‰¹å·²ç»ä¸º1çš„æ¦‚ç‡ä¸ä¸Šé¢ç›¸åŒï¼Œæ¦‚ç‡ä¸ºï¼š1-(1-1&#x2F;m)^knã€‚å› æ­¤ï¼Œkä¸ªæ¯”ç‰¹éƒ½ä¸º1çš„æ¦‚ç‡ä¸ºï¼š(1-(1-1&#x2F;m)^kn)^kï¼Œæ­¤å³ä¸ºæ–°æ’å…¥å…ƒç´ çš„è¯¯è¯†åˆ«ç‡ã€‚</li></ul><h3 id="2-3-æ— æ³•åˆ é™¤"><a href="#2-3-æ— æ³•åˆ é™¤" class="headerlink" title="2.3 æ— æ³•åˆ é™¤"></a>2.3 æ— æ³•åˆ é™¤</h3><p>å¸ƒéš†è¿‡æ»¤å™¨ä¸å…è®¸åˆ é™¤å…ƒç´ ï¼šå¦‚æœåˆ é™¤æŸä¸ªå…ƒç´ ï¼Œå¯¼è‡´å¯¹åº”ä½ç½®ä¸º0ï¼Œä½†æ˜¯å¯èƒ½æœ‰å¤šä¸ªå…ƒç´ æ˜ å°„åˆ°ç›¸åŒçš„ä½ç½®ä¸Šé¢ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªå­˜åœ¨çš„å…ƒç´ è¢«åˆ¤æ–­ä¸ºä¸å­˜åœ¨ã€‚ç ´åäº†â€œä¸€å®šä¸å­˜åœ¨â€çš„è¯­ä¹‰ä¿è¯ã€‚</p><p>ğŸ“Œ <font color="red">ä¸å…è®¸åˆ é™¤çš„æœºåˆ¶ä¼šå¯¼è‡´å…¶ä¸­çš„æ— æ•ˆå…ƒç´ å¯èƒ½ä¼šè¶Šæ¥è¶Šå¤šï¼Œå³å®é™…å·²ç»åœ¨ç£ç›˜åˆ é™¤ä¸­çš„å…ƒç´ ï¼Œä½†åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­è¿˜è®¤ä¸ºå¯èƒ½å­˜åœ¨ï¼Œè¿™ä¼šé€ æˆè¶Šæ¥è¶Šå¤šçš„è¯¯åˆ¤</font>   </p><h3 id="2-4-ä¼˜ç¼ºç‚¹æ€»ç»“"><a href="#2-4-ä¼˜ç¼ºç‚¹æ€»ç»“" class="headerlink" title="2.4 ä¼˜ç¼ºç‚¹æ€»ç»“"></a>2.4 ä¼˜ç¼ºç‚¹æ€»ç»“</h3><p>ä¼˜ç‚¹ï¼š</p><ul><li>æ’å…¥ã€æŸ¥è¯¢çš„æ•ˆç‡é«˜ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºå¸¸æ•°O(k)</li><li>ç©ºé—´å ç”¨å°ï¼ˆå­˜å‚¨ç©ºé—´å ç”¨æ˜¯ä¸€ä¸ªå›ºå®šé•¿åº¦çš„bitæ•°ç»„ï¼‰</li><li>æ•£åˆ—å‡½æ•°ç›¸äº’ä¹‹é—´æ²¡æœ‰å…³ç³»ï¼Œå¯ä»¥å¹¶è¡ŒHash</li><li>ä¸å­˜å‚¨åŸå§‹æ•°æ®ï¼Œåœ¨ä¸¥æ ¼è¦æ±‚ä¿å¯†çš„åœºæ™¯ä¸‹æœ‰ä¼˜åŠ¿<br>ç¼ºç‚¹ï¼š</li><li>å­˜åœ¨è¯¯æŠ¥çš„å¯èƒ½æ€§ï¼Œå°¤å…¶æ•°æ®é‡è¶Šå¤§è¶Šå®¹æ˜“è¯¯æŠ¥</li><li>åªæ”¯æŒæ–°å¢ï¼Œä¸æ”¯æŒåˆ é™¤</li><li>æ•°ç»„é•¿åº¦å’Œhashå‡½æ•°ä¸ªæ•°ç¡®å®šå¤æ‚</li><li>å½“è¿‡æ»¤å™¨æ•°ç»„è¿‡é•¿æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½å·®ï¼ˆå¤šä¸ªå“ˆå¸Œå¾—åˆ°çš„ä¸‹æ ‡è·¨åº¦å¾ˆå¤§ï¼ŒCPUç¼“å­˜å‘½ä¸­ç‡ä½ï¼‰</li></ul><h2 id="3-åº”ç”¨åœºæ™¯"><a href="#3-åº”ç”¨åœºæ™¯" class="headerlink" title="3. åº”ç”¨åœºæ™¯"></a>3. åº”ç”¨åœºæ™¯</h2><p>å¸ƒéš†è¿‡æ»¤å™¨åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­å¯ä»¥å¿«é€Ÿåœ°è§£å†³ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ç½‘é¡µ URL å»é‡ã€åƒåœ¾é‚®ä»¶è¯†åˆ«ã€å¤§é›†åˆä¸­é‡å¤å…ƒç´ çš„åˆ¤æ–­å’Œç¼“å­˜ç©¿é€ç­‰é—®é¢˜ã€‚<br>å…¸å‹åº”ç”¨æœ‰ï¼š</p><ul><li>æ•°æ®åº“é˜²æ­¢ç©¿åº“ã€‚ Google Bigtableï¼ŒHBase å’Œ Cassandra ä»¥åŠ Postgresql ä½¿ç”¨BloomFilterå‡å°‘ä¸å­˜åœ¨çš„è¡Œæˆ–åˆ—çš„ç£ç›˜æŸ¥æ‰¾ã€‚é¿å…ä»£ä»·é«˜æ˜‚çš„ç£ç›˜æŸ¥æ‰¾ä¼šå¤§å¤§æé«˜æ•°æ®åº“æŸ¥è¯¢æ“ä½œçš„æ€§èƒ½ã€‚</li><li>ä¸šåŠ¡åœºæ™¯ä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦é˜…è¯»è¿‡æŸè§†é¢‘æˆ–æ–‡ç« ï¼šæ¯”å¦‚æŠ–éŸ³æˆ–å¤´æ¡ï¼Œå½“ç„¶ä¼šå¯¼è‡´ä¸€å®šçš„è¯¯åˆ¤ï¼Œä½†ä¸ä¼šè®©ç”¨æˆ·çœ‹åˆ°é‡å¤çš„å†…å®¹ã€‚</li><li>ç¼“å­˜ç©¿é€åœºæ™¯ã€‚åœ¨ä¸€äº›æ¶æ„è¯·æ±‚ä¸­ï¼Œè¯·æ±‚å‚æ•°éƒ½æ˜¯ç¼“å­˜å’Œæ•°æ®ä¸­ä¸å­˜åœ¨çš„å€¼ï¼Œä¸ºäº†é¿å…ç¼“å­˜ç©¿é€ï¼Œå¯ä»¥ç”¨å¸ƒéš†è¿‡æ»¤å™¨å…ˆç­›é€‰ä¸€éï¼Œåªæœ‰åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œæ‰å»æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœæ²¡æŸ¥è¯¢åˆ°ï¼Œåˆ™ç©¿é€åˆ°dbã€‚å¦‚æœä¸åœ¨å¸ƒéš†å™¨ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li><li>WEBæ‹¦æˆªå™¨ï¼Œå¦‚æœç›¸åŒè¯·æ±‚åˆ™æ‹¦æˆªï¼Œé˜²æ­¢é‡å¤è¢«æ”»å‡»ã€‚å¯ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚Squid ç½‘é¡µä»£ç†ç¼“å­˜æœåŠ¡å™¨åœ¨ cache digests ä¸­å°±ä½¿ç”¨äº†å¸ƒéš†è¿‡æ»¤å™¨ã€‚Google Chromeæµè§ˆå™¨ä½¿ç”¨äº†å¸ƒéš†è¿‡æ»¤å™¨åŠ é€Ÿå®‰å…¨æµè§ˆæœåŠ¡</li></ul><h2 id="4-å®ç°"><a href="#4-å®ç°" class="headerlink" title="4. å®ç°"></a>4. å®ç°</h2><p>åŸºäºGolangå®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-string">&quot;github.com/bits-and-blooms/bitset&quot;</span><br>)<br><br><span class="hljs-comment">// è®¾ç½®å“ˆå¸Œæ•°ç»„é»˜è®¤å¤§å°ä¸º16</span><br><span class="hljs-keyword">const</span> DefaultSize = <span class="hljs-number">16</span><br><br><span class="hljs-comment">// è®¾ç½®ç§å­ï¼Œä¿è¯ä¸åŒå“ˆå¸Œå‡½æ•°æœ‰ä¸åŒçš„è®¡ç®—æ–¹å¼</span><br><span class="hljs-keyword">var</span> seeds = []<span class="hljs-type">uint</span>&#123;<span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">13</span>, <span class="hljs-number">31</span>, <span class="hljs-number">37</span>, <span class="hljs-number">61</span>&#125;<br><br><span class="hljs-comment">// æ„é€ 6ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œæ¯ä¸ªå“ˆå¸Œå‡½æ•°æœ‰å‚æ•°seedä¿è¯è®¡ç®—æ–¹å¼çš„ä¸åŒ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildHash</span><span class="hljs-params">()</span></span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(seed <span class="hljs-type">uint</span>, value <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">uint</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(seed <span class="hljs-type">uint</span>, value <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">uint</span> &#123;<br><span class="hljs-keyword">var</span> result <span class="hljs-type">uint</span> = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(value); i++ &#123;<br>result = result*seed + <span class="hljs-type">uint</span>(value[i])<br>&#125;<br><span class="hljs-keyword">return</span> result &amp; (DefaultSize - <span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// å¸ƒéš†è¿‡æ»¤å™¨ç»“æ„ï¼ŒåŒ…æ‹¬äºŒè¿›åˆ¶æ•°ç»„å’Œå¤šä¸ªå“ˆå¸Œå‡½æ•°</span><br><span class="hljs-keyword">type</span> BloomFilter <span class="hljs-keyword">struct</span> &#123;<br>set       *bitset.BitSet<br>hashFuncs [<span class="hljs-number">6</span>]<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(seed <span class="hljs-type">uint</span>, value <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">uint</span><br>&#125;<br><br><span class="hljs-comment">// æ„é€ ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬æ•°ç»„å’Œå“ˆå¸Œå‡½æ•°çš„åˆå§‹åŒ–</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBloomFilter</span><span class="hljs-params">()</span></span> *BloomFilter &#123;<br>bf := <span class="hljs-built_in">new</span>(BloomFilter)<br>bf.set = bitset.New(DefaultSize)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(bf.hashFuncs); i++ &#123;<br>bf.hashFuncs[i] = buildHash()<br>&#125;<br><span class="hljs-keyword">return</span> bf<br>&#125;<br><br><span class="hljs-comment">// Add æ·»åŠ å…ƒç´ ï¼Œå°†å“ˆå¸Œå‡½æ•°è®¡ç®—ç»“æœå¯¹åº”çš„æ•°ç»„ä½ç½®1</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *BloomFilter)</span></span> Add(value <span class="hljs-type">string</span>) &#123;<br><span class="hljs-keyword">for</span> i, f := <span class="hljs-keyword">range</span> b.hashFuncs &#123;<br>b.set.Set(f(seeds[i], value))<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Contains æŸ¥è¯¢å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œè°ƒç”¨æ¯ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå¹¶ä¸”åˆ¤æ–­æ•°ç»„å¯¹åº”ä½æ˜¯å¦ä¸º1 å¦‚æœä¸ä¸º1ï¼Œç›´æ¥è¿”å›falseï¼Œè¡¨æ˜ä¸€å®šä¸å­˜åœ¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *BloomFilter)</span></span> Contains(value <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">for</span> i, f := <span class="hljs-keyword">range</span> b.hashFuncs &#123;<br><span class="hljs-keyword">if</span> !b.set.Test(f(seeds[i], value)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>filter := NewBloomFilter()<br>filter.Add(<span class="hljs-string">&quot;hello&quot;</span>)<br>filter.Add(<span class="hljs-string">&quot;world&quot;</span>)<br>fmt.Println(filter.Contains(<span class="hljs-string">&quot;hello&quot;</span>))<br>fmt.Println(filter.Contains(<span class="hljs-string">&quot;world&quot;</span>))<br>fmt.Println(filter.Contains(<span class="hljs-string">&quot;xiao&quot;</span>))<br>fmt.Println(filter.Contains(<span class="hljs-string">&quot;xiaoming&quot;</span>)) <span class="hljs-comment">// å‡ºç°è¯¯åˆ¤</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-æ¼”è¿›å˜ä½“"><a href="#5-æ¼”è¿›å˜ä½“" class="headerlink" title="5. æ¼”è¿›å˜ä½“"></a>5. æ¼”è¿›å˜ä½“</h2><p>é’ˆå¯¹å¸ƒéš†è¿‡æ»¤å™¨çš„ä¸Šè¿°ä¸€äº›é—®é¢˜ï¼Œé€æ­¥äº§ç”Ÿäº†ä¸€äº›å¸ƒéš†è¿‡æ»¤å™¨çš„å˜ä½“ï¼Œç®€å•ä»‹ç»å¦‚ä¸‹ï¼š</p><h3 id="5-1-è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨-Counting-Bloom-Filter"><a href="#5-1-è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨-Counting-Bloom-Filter" class="headerlink" title="5.1 è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ Counting Bloom Filter"></a>5.1 è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ Counting Bloom Filter</h3><ul><li>ç‰¹ç‚¹ï¼šæ”¯æŒåˆ é™¤</li><li>åŸç†ï¼šCountingBloomFilteræ˜¯BloomFilterçš„ä¸€ä¸ªå˜ç§ï¼Œå®ƒæ‰©å±•æ ‡å‡†å¸ƒéš†è¿‡æ»¤å™¨çš„æ•°æ®ç»“æ„ï¼Œå°†åº•å±‚æ•°ç»„çš„æ¯ä¸€ä½æ‰©å±•ä¸ºä¸€ä¸ª4ä½å¤§å°çš„è®¡æ•°å™¨Counterï¼Œç”¨æ¥å­˜å‚¨æŸä¸ªä¸‹æ ‡æ˜ å°„æˆåŠŸçš„é¢‘æ¬¡ã€‚å®ƒä»¥å ç”¨æ›´å¤šçš„ç©ºé—´æ¥æ¢å–æ”¯æŒåˆ é™¤æ“ä½œã€‚</li></ul><ol><li>æ’å…¥å…ƒç´ æ—¶ï¼Œé€šè¿‡kä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°kä¸ªè®¡æ•°å™¨ï¼Œè¿™äº›å‘½ä¸­çš„è®¡æ•°å™¨å€¼å¢åŠ 1ï¼›</li><li>åˆ é™¤å…ƒç´ æ—¶ï¼Œåˆ é™¤å…ƒç´ çš„æ—¶å€™ï¼Œé€šè¿‡kä¸ªæ•£åˆ—å‡½æ•°æ˜ å°„åˆ°kä¸ªè®¡æ•°å™¨ï¼Œè¿™äº›è®¡æ•°å™¨å€¼å‡å°‘1ã€‚<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/8.png"></li></ol><p>ä¼˜ç‚¹ï¼š</p><ul><li>é™¤äº†å ç”¨å­˜å‚¨ç©ºé—´ç¿»ï¼ˆå¤šï¼‰å€ï¼Œç»§æ‰¿äº†å¸ƒéš†è¿‡æ»¤å™¨çš„æ‰€æœ‰ä¼˜ç‚¹ï¼›æ”¯æŒåˆ é™¤ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>è¯¯æŠ¥çš„æ¦‚ç‡ä»ç„¶å­˜åœ¨</li><li>éœ€è¦é¢å¤–è€ƒè™‘ Counter æ•°ç»„ä¸­æ¯ä¸ª Counter çš„å¤§å°ï¼ˆæœ€å¥½å…·å¤‡æº¢å‡ºç­–ç•¥ï¼‰</li><li>å­˜å‚¨ç©ºé—´è¾ƒå¸ƒéš†è¿‡æ»¤å™¨ç¿»ï¼ˆå¤šï¼‰å€</li></ul><h3 id="5-2-æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨-Scalable-Bloom-Filter"><a href="#5-2-æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨-Scalable-Bloom-Filter" class="headerlink" title="5.2 æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨ Scalable Bloom Filter"></a>5.2 æ‰©å±•å¸ƒéš†è¿‡æ»¤å™¨ Scalable Bloom Filter</h3><ul><li>ç‰¹ç‚¹ï¼šæ”¯æŒæ‰©å®¹</li><li>åŸç†ï¼šScalable Bloom Filteråªä¼šå‘æœ€åä¸€å±‚æ’å…¥æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿä»æœ€åä¸€å±‚å¼€å§‹æŸ¥è¯¢ï¼Œç›´åˆ°æŸ¥è¯¢è‡³ BF0 å±‚ã€‚<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/9.png"></li></ul><ol><li>æ’å…¥è¿‡ç¨‹ï¼šåªä¼šå‘æœ€åä¸€å±‚æ’å…¥æ•°æ®<ol><li>åˆå§‹ï¼ŒSBFåªåŒ…å«BF0è¿™ä¸€å±‚ï¼Œæ’å…¥äº†aã€bã€cä¸‰ä¸ªå…ƒç´ ã€‚</li><li>ç„¶åï¼Œå‡è®¾BF0å·²ç»æ— æ³•ä¿è¯ç”¨æˆ·è®¾å®šçš„è¯¯åˆ¤ç‡ï¼Œæ­¤æ—¶å°±éœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œå› æ­¤æ–°çš„ä¸€å±‚BF1è¢«åˆ›å»ºå¹¶åŠ å…¥è¿›æ¥ã€‚åæ¥çš„dã€eã€få…ƒç´ éƒ½ä¼šè¢«æ’å…¥åˆ°BF1ä¸­ã€‚</li><li>åŒç†ï¼Œå½“BF1ä¹Ÿæ— æ³•æ»¡è¶³è¯¥å±‚äº‹å…ˆè®¾å®šçš„è¯¯åˆ¤ç‡æ—¶ï¼Œæ–°çš„ä¸€å±‚BF2ä¹Ÿå°†è¢«åŠ å…¥è¿›æ¥ï¼Œå¦‚æ­¤è¿›è¡Œä¸‹å»ã€‚</li></ol></li><li>æŸ¥è¯¢è¿‡ç¨‹ï¼šä»æœ€åä¸€å±‚å¼€å§‹ç”±åå‘å‰æŸ¥è¯¢<ol><li>é¦–å…ˆåœ¨BF1ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢æ˜¾ç¤ºå­˜åœ¨ï¼Œåˆ™ç›´æ¥å“åº”å®¢æˆ·ç«¯ï¼›</li><li>å¦‚æœæŸ¥è¯¢æ˜¾ç¤ºä¸å­˜åœ¨ï¼Œåˆ™ç»§ç»­æŸ¥è¯¢BF0ã€‚å¦‚æœBF0ä¸­æ˜¾ç¤ºå­˜åœ¨gï¼Œåˆ™å“åº”å®¢æˆ·ç«¯gå­˜åœ¨ã€‚å¦åˆ™ï¼Œå› ä¸ºBF0å·²ç»æ˜¯æœ€åä¸€å±‚äº†ï¼Œåˆ™å“åº”å®¢æˆ·ç«¯gä¸å­˜åœ¨ã€‚</li></ol></li></ol><p>ç¼ºç‚¹ï¼š</p><ul><li>æŸ¥è¯¢å¼€é”€ï¼šéœ€è¦æŸ¥è¯¢å¤šä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¾ƒå•ä¸€å¸ƒéš†è¿‡æ»¤å™¨å¢åŠ äº†ä¸€å®šçš„æŸ¥è¯¢æ—¶é—´å¼€é”€ã€‚</li><li>ç®¡ç†å¤æ‚åº¦ï¼šç»´æŠ¤å¤šä¸ªå¸ƒéš†è¿‡æ»¤å™¨çš„ç­–ç•¥ç›¸å¯¹å¤æ‚ã€‚</li></ul><h3 id="5-2-å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨-Cuckoo-Filter"><a href="#5-2-å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨-Cuckoo-Filter" class="headerlink" title="5.2 å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ Cuckoo Filter"></a>5.2 å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ Cuckoo Filter</h3><p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨æ˜¯å¸ƒéš†è¿‡æ»¤å™¨çš„å˜ä½“ï¼Œæä¾›äº†åˆ é™¤å…ƒç´ çš„åŠŸèƒ½ã€‚å®ƒä¸»è¦åŸºäºå¸ƒè°·é¸Ÿå“ˆå¸Œå’ŒæŒ‡çº¹æŠ€æœ¯ã€‚å½“æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨å­˜å‚¨è¯¥å…ƒç´ çš„â€œæŒ‡çº¹â€åˆ°å“ˆå¸Œè¡¨çš„æŸä¸ªä½ç½®ä¸Šã€‚å¦‚æœè¯¥ä½ç½®å·²è¢«å ç”¨ï¼Œç°æœ‰çš„å…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½®ï¼Œå¦‚æ­¤è¿­ä»£ä¸‹å»ï¼Œç›´åˆ°æ¯ä¸ªå…ƒç´ éƒ½æœ‰è‡ªå·±çš„ä½ç½®ä¸ºæ­¢ã€‚</p><p>æœ€ç®€å•çš„å¸ƒè°·é¸Ÿå“ˆå¸Œç»“æ„æ˜¯ä¸€ç»´æ•°ç»„ç»“æ„</p><ol><li>æ¯ä¸ªå…ƒç´ éƒ½ç”±å“ˆå¸Œå‡½æ•°h1(x)å’Œh2(x)ç¡®å®šä¸¤ä¸ªå€™é€‰ä½ç½®ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ä¼šæ£€æŸ¥ä¸¤ä¸ªä½ç½®æ˜¯å¦ä»»æ„ä¸€ä¸ªä½ç½®ä¸ºç©ºã€‚</li><li>å¦‚æœä¸¤ä¸ªä½ç½®ä¸­ä»»ä½•ä¸€ä¸ªæ˜¯ç©ºçš„ï¼Œåˆ™ç®—æ³•å°†å…ƒç´ æ’å…¥åˆ°è¯¥ç©ºä½ç½®ä¸­ï¼Œæ’å…¥å®Œæˆï¼›</li><li>å¦‚æœä¸¤ä¸ªä½ç½®éƒ½æ˜¯æ»¡çš„ï¼Œä¼šé€‰æ‹©ä¸€ä¸ªå€™é€‰ä½ç½®è¸¢å‡ºå»ç°æœ‰çš„å…ƒç´ (é¸ å é¹Šå·¢)ï¼Œå¹¶å°†æ­¤è¢«è¸¢å‡ºå…ƒç´ é‡æ–°æ’å…¥åˆ°å®ƒçš„å¤‡ç”¨ä½ç½®ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šé‡å¤ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªç©ºä½ç½®æˆ–è¾¾åˆ°æœ€å¤§ä½ç§»æ¬¡æ•°ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç©ºä½ç½®ï¼Œåˆ™è®¤ä¸ºæ­¤å“ˆå¸Œè¡¨å¤ªæ»¡ï¼Œåˆ™è¿›è¡Œæ‰©å®¹å’ŒReHashåï¼Œå†æ¬¡æ’å…¥ã€‚<br><img src="/img/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/10.png"></li></ol><h2 id="6-å‚è€ƒèµ„æ–™"><a href="#6-å‚è€ƒèµ„æ–™" class="headerlink" title="6. å‚è€ƒèµ„æ–™"></a>6. å‚è€ƒèµ„æ–™</h2><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼š<br><a href="https://segmentfault.com/a/1190000021136424">https://segmentfault.com/a/1190000021136424</a><br><a href="https://segmentfault.com/a/1190000024566947">https://segmentfault.com/a/1190000024566947</a></p><p>è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼š<br><a href="https://juejin.cn/post/7362729128477638675">https://juejin.cn/post/7362729128477638675</a> </p><p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼š<br><a href="https://www.cnblogs.com/zhaodongge/p/15067657.html">https://www.cnblogs.com/zhaodongge/p/15067657.html</a><br><a href="https://dbwu.tech/posts/cuckoo_filter/">https://dbwu.tech/posts/cuckoo_filter/</a></p>]]></content>
    
    
    <categories>
      
      <category>ç³»ç»Ÿè®¾è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¸ƒéš†è¿‡æ»¤å™¨</tag>
      
      <tag>ç³»ç»Ÿè®¾è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangä¸­çš„Deferã€Panicå’ŒRecover</title>
    <link href="/2024/07/13/Golang%E4%B8%ADdefer-panic-recvover%E5%88%86%E6%9E%90/"/>
    <url>/2024/07/13/Golang%E4%B8%ADdefer-panic-recvover%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>Golangä¸­æ²¡æœ‰ç±»ä¼¼javaçš„try catchæœºåˆ¶è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œè€Œæ˜¯å¼•å…¥äº†deferã€panicå’Œrecoveræ¥è§¦å‘å¼‚å¸¸å’Œç»ˆæ­¢å¼‚å¸¸ã€‚</p><span id="more"></span>  <h2 id="1-Defer"><a href="#1-Defer" class="headerlink" title="1. Defer"></a>1. Defer</h2><p>deferæ˜¯goè¯­è¨€æä¾›çš„ä¸€ç§ç”¨äºæ³¨å†Œå»¶è¿Ÿè°ƒç”¨çš„æœºåˆ¶ï¼šè®©å‡½æ•°æˆ–è€…è¯­å¥å¯ä»¥åœ¨å½“å‰å‡½æ•°æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œï¼ˆåŒ…æ‹¬é€šè¿‡returnæ­£å¸¸ç»“æŸæˆ–è€…panicå¯¼è‡´çš„å¼‚å¸¸ç»“æŸï¼‰ã€‚</p><p>å¸¸ç”¨äºä¸€äº›æ“ä½œåçš„æ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚å…³é—­è¿æ¥ã€é‡Šæ”¾é”ã€å…³é—­æ–‡ä»¶ç­‰ï¼Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒä¼˜é›…ã€‚  </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs golang">f, _ := os.Open(<span class="hljs-string">&quot;defer.txt&quot;</span>)<br><span class="hljs-keyword">defer</span> f.Close()  <br></code></pre></td></tr></table></figure><h3 id="1-1-DeferåŸºæœ¬åŸç†"><a href="#1-1-DeferåŸºæœ¬åŸç†" class="headerlink" title="1.1 DeferåŸºæœ¬åŸç†"></a>1.1 DeferåŸºæœ¬åŸç†</h3><p>deferä½¿ç”¨å‡†åˆ™</p><ul><li><p>æ¯æ¬¡deferè¯­å¥æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæŠŠå‡½æ•°â€œå‹æ ˆâ€ï¼Œå‡½æ•°å‚æ•°ä¼šè¢«æ‹·è´ä¸‹æ¥ï¼Œä½†æ˜¯é—­åŒ…å¼•ç”¨ä¸ä¼š</p><ul><li>ä½œä¸ºå‡½æ•°å‚æ•°ï¼šåœ¨deferå®šä¹‰æ—¶å°±æŠŠå€¼ä¼ é€’ç»™deferï¼Œå¹¶è¢«cacheèµ·æ¥ï¼Œåç»­ä¸ä¼šå†æ”¹å˜</li><li>ä½œä¸ºé—­åŒ…å¼•ç”¨ï¼šåœ¨deferå‡½æ•°çœŸæ­£è°ƒç”¨æ—¶æ ¹æ®æ•´ä¸ªä¸Šä¸‹æ–‡ç¡®å®šå½“å‰çš„å€¼ã€‚</li></ul></li><li><p>å½“å¤–å±‚é€»è¾‘é€€å‡ºæ—¶ï¼Œdeferå‡½æ•°æŒ‰ç…§å®šä¹‰çš„é€†åºæ‰§è¡Œï¼›ã€å…ˆå…¥åå‡ºï¼Œå‹æ ˆè¿›è¡Œã€‘</p></li><li><p>æ°å½“çš„ä½¿ç”¨deferæ–¹æ³•å¯ä»¥ä¿®æ”¹è¿”å›å€¼  </p></li><li><p>å…ˆå…¥åå‡º</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">a</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++ &#123;<br><span class="hljs-keyword">defer</span> fmt.Println(i)<br>&#125;<br>&#125; <br><span class="hljs-comment">// è¾“å‡º 3 2 1</span><br></code></pre></td></tr></table></figure></li><li><p>deferå‡½æ•°çš„å‚æ•°å¼•ç”¨æ–¹å¼</p><ul><li>ä½œä¸ºå‡½æ•°å…¥å‚ï¼Œåœ¨å‡½æ•°å®šä¹‰æ—¶å°±å·²ç»ä¼ é€’ç»™deferå‡½æ•°ï¼Œåç»­ä¸ä¼šå†æ”¹å˜  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">b</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++ &#123;<br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a <span class="hljs-type">int</span>)</span></span> &#123;<br>            fmt.Println(a)<br>        &#125;(i)<br>    &#125;<br>&#125;<br><span class="hljs-comment">// è¾“å‡º 3 2 1</span><br></code></pre></td></tr></table></figure></li><li>ä½œä¸ºé—­åŒ…çš„å¼•ç”¨æ—¶ï¼Œåœ¨æœ€åæ‰§è¡Œçš„æ—¶å€™ç¡®å®šä¸Šä¸‹æ–‡çš„å€¼  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">c</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++ &#123;<br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            fmt.Println(i)<br>        &#125;()<br>    &#125;<br>&#125;<br><span class="hljs-comment">// è¾“å‡º 4 4 4 </span><br><span class="hljs-comment">// i = 3 æ—¶å®šä¹‰æœ€åä¸€ä¸ªdeferï¼Œåˆè¿›è¡Œäº†+1æ“ä½œåï¼Œæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œdeferå‡½æ•°</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="1-2-deferå‘½ä»¤æ‹†è§£"><a href="#1-2-deferå‘½ä»¤æ‹†è§£" class="headerlink" title="1.2 deferå‘½ä»¤æ‹†è§£"></a>1.2 deferå‘½ä»¤æ‹†è§£</h3><p>ä¸Šé¢è¯´deferå¯ä»¥æ“ä½œè¿”å›å€¼ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åœ¨å«æœ‰deferå‡½æ•°çš„ä»£ç ä¸­ï¼Œä¸€ä¸ª return xxxçš„è¯­å¥å¯ä»¥è¿›è¡Œæ‹†è§£ï¼Œè¿™æ¡è¯­å¥åœ¨å®é™…æ‰§è¡Œæ—¶åˆ†ä¸‰æ­¥è¿›è¡Œï¼š</p><blockquote><ol><li>è¿”å›å€¼ &#x3D; xxx</li><li>æ‰§è¡Œdeferå‡½æ•°</li><li>ç©ºçš„return</li></ol></blockquote><p>å…¸å‹æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">d</span><span class="hljs-params">()</span></span> (r <span class="hljs-type">int</span>) &#123;<br>t := <span class="hljs-number">5</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>t = t + <span class="hljs-number">5</span><br>&#125;()<br><span class="hljs-keyword">return</span> t<br>&#125;<br><span class="hljs-comment">// è¿”å› 5</span><br><span class="hljs-comment">// r=t; t=t+5; return </span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">e</span><span class="hljs-params">()</span></span> (r <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r <span class="hljs-type">int</span>)</span></span> &#123;<br>r = r + <span class="hljs-number">5</span><br>&#125;(r)<br><span class="hljs-keyword">return</span> <span class="hljs-number">5</span><br>&#125;<br><span class="hljs-comment">// è¿”å› 5</span><br><span class="hljs-comment">// r = 5ï¼› r=r+5ï¼ˆè¿™ä¸ªrä¸ºå½¢å‚rï¼Œä¸æ˜¯è¿”å›å€¼rï¼‰ï¼› return</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> (r <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>r = r + <span class="hljs-number">5</span><br>&#125;()<br><span class="hljs-keyword">return</span> <span class="hljs-number">5</span><br>&#125;<br><br><span class="hljs-comment">// è¿”å› 10</span><br><span class="hljs-comment">// r = 5ï¼› r=r+5ï¼› return</span><br></code></pre></td></tr></table></figure><p>ä»ä»¥ä¸Šçš„å®é™…æ¡ˆä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p><p>ğŸ“Œ <font color="red">èƒ½é€šè¿‡deferä¿®æ”¹è¿”å›å€¼çš„åœºæ™¯ï¼Œä¸€å®šæ˜¯æœ‰å‘½åè¿”å›å€¼çš„å‡½æ•°åœºæ™¯ã€‚</font>  </p><h2 id="2-Paincå’ŒRecover"><a href="#2-Paincå’ŒRecover" class="headerlink" title="2. Paincå’ŒRecover"></a>2. Paincå’ŒRecover</h2><p>å½“goåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘é€å¼‚å¸¸æ—¶ï¼ŒGoè¿è¡Œæ—¶ä¼šè§¦å‘è¿è¡Œæ—¶panicï¼Œå¹¶åœ¨è°ƒç”¨å®ƒçš„å‡½æ•°ä¸­å‘æœ¬å±‚ä»¥åŠæ‰€æœ‰ä¸Šå±‚é€çº§æŠ›å‡ºï¼Œè‹¥ä¸€ç›´æ²¡æœ‰recoveræ•è·ï¼Œç¨‹åºæœ€ç»ˆä¼šç»ˆæ­¢ã€‚  </p><p>è‹¥åœ¨æŸå±‚deferè¯­å¥ä¸­è¢«recoveræ•è·ï¼Œæ§åˆ¶æµç¨‹å°†è¿›å…¥åˆ°recoverä¹‹åçš„è¯­å¥ä¸­ã€‚é€šè¿‡panicã€deferå’Œrecoverï¼Œå¯ä»¥å®ç°ç±»ä¼¼try catchçš„åŠŸèƒ½ã€‚  </p><p>ä¾‹å¦‚ï¼š </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;defer in&quot;</span>)<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>&#125;<br>&#125;()<br><br>fmt.Println(<span class="hljs-string">&quot;panic begin&quot;</span>)<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;hello, I&#x27;m panic&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;panic end&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// panic begin</span><br><span class="hljs-comment">// defer in</span><br><span class="hljs-comment">// hello, I&#x27;m panic</span><br></code></pre></td></tr></table></figure><p>ğŸ“Œ <font color="red">æ³¨æ„ï¼šdeferä¸­çš„recoverä»…å¯¹å½“å‰åç¨‹ç”Ÿæ•ˆï¼Œä¸”ä»…åœ¨ç›´æ¥è¢«deferå‡½æ•°è°ƒç”¨æ‰æœ‰æ•ˆ</font>    </p><h3 id="2-1-Recoverä½¿ç”¨è§„åˆ™"><a href="#2-1-Recoverä½¿ç”¨è§„åˆ™" class="headerlink" title="2.1 Recoverä½¿ç”¨è§„åˆ™"></a>2.1 Recoverä½¿ç”¨è§„åˆ™</h3><p>Recoveråœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬ä¼šåˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸ºç©ºï¼Œå½“è¿”å›å€¼ä¸ºç©ºçš„æ—¶å€™ä»£è¡¨æ²¡æœ‰æ­£å¸¸æ•è·é—®é¢˜ã€‚golangå®˜æ–¹ä»‹ç»äº†å‡ ç§Recoverè¿”å›ä¸ºç©ºçš„åœºæ™¯ã€‚</p><ol><li>panicçš„å‚æ•°ä¸ºç©º</li><li>å½“å‰åç¨‹æ²¡æœ‰panic</li><li>recoveræ²¡æœ‰ç›´æ¥è¢«deferå‡½æ•°è°ƒç”¨</li></ol><p>åˆ†åˆ«ä»‹ç»å¦‚ä¸‹ï¼š</p><ul><li><p>panicå‚æ•°ä¸ºç©ºï¼Œå¯ä»¥æ­£å¸¸æ•è· &#x2F;&#x2F; æœ¬èº«panicå‚æ•°ä¸ºnilæ—¶å€™ç­‰åŒäºæ²¡æœ‰å‘é€panic</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Printf(<span class="hljs-string">&quot;panic: %v&quot;</span>, err)<br>&#125;<br>&#125;()<br><br><span class="hljs-built_in">panic</span>(<span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è·¨åç¨‹è°ƒç”¨recoverå‡½æ•°ï¼Œæ— æ³•æ•è·å¼‚å¸¸</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// panicè·Ÿrecoverä¸åœ¨ä¸€ä¸ªåç¨‹ï¼Œæ— æ³•æ•è·å¼‚å¸¸</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>log.Println(<span class="hljs-built_in">recover</span>())<br>&#125;()<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;A bad boy stole a server&quot;</span>)<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ä¸åœ¨deferå‡½æ•°ä¸­ç›´æ¥è°ƒç”¨ï¼Œæ— æ³•æ•è·å¼‚å¸¸</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Test</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// å¯¹ recoverè¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œæ— æ³•æ­£å¸¸ç”Ÿæ•ˆ</span><br>Recover(<span class="hljs-string">&quot;Panic in goroutine&quot;</span>)<br>&#125;()<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;A bad boy stole the server&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Recover</span><span class="hljs-params">(funcName <span class="hljs-type">string</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>log.Printf(<span class="hljs-string">&quot;panic para: %v, panic info: %v\n&quot;</span>, funcName, err)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>è¿›é˜¶åˆ†æ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// recoveræ˜¯åœ¨åŒ¿åå‡½æ•°/é—­åŒ…ä¸­ä½¿ç”¨ï¼Œå®é™…æ‰§è¡Œæ—¶å–å€¼ï¼Œè§¦å‘panicåæœ‰å€¼</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>log.Print(<span class="hljs-built_in">recover</span>(), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;, a handsome police catch him.\n\n&quot;</span><br>&#125;())<br>&#125;()<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;A bad boy stole a server&quot;</span>)<br>&#125;()<br><br>time.Sleep(<span class="hljs-number">3</span> * time.Second)<br><br><span class="hljs-comment">// recoverä½œä¸ºå‡½æ•°å‚æ•°ä½¿ç”¨ï¼Œå®šä¹‰æ—¶å°±å®Œæˆå€¼æ‹·è´ï¼Œåˆšå¼€å§‹æ²¡æŠ¥é”™ï¼Œæœ€åä¹Ÿä¸ä¼šæœ‰å€¼ã€‚</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> log.Print(<span class="hljs-built_in">recover</span>(), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;, but a handsome police catch nothing.\n&quot;</span><br>&#125;())<br><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;A bad boy stole a server, again.&quot;</span>)<br>&#125;()<br>time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="2-2-Deferã€Panicã€RecoveråŸç†æµ…æ"><a href="#2-2-Deferã€Panicã€RecoveråŸç†æµ…æ" class="headerlink" title="2.2 Deferã€Panicã€RecoveråŸç†æµ…æ"></a>2.2 Deferã€Panicã€RecoveråŸç†æµ…æ</h3><p><img src="/img/Golang%E4%B8%ADdefer-panic-recvover%E5%88%86%E6%9E%90/2.png"><br>å¼‚å¸¸æ¢å¤æµç¨‹å¯ä»¥æ€»ç»“æˆä»¥ä¸‹ä¸»è¦æµç¨‹ï¼š</p><ul><li>è§¦å‘panicæµç¨‹ï¼španicç»ˆæ­¢ç¨‹åºçš„è¿‡ç¨‹æ˜¯ç”±ç¼–è¯‘å™¨å°†å…³é”®å­— panic è½¬æ¢æˆ runtime.gopanic() å†…ç½®å‡½æ•°ã€‚å¼‚å¸¸æ¢å¤çš„æµç¨‹åŸºæœ¬éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼š<ul><li>é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª_panicç»“æ„ä½“ç”¨æ¥è®°å½•å½“å‰panicï¼Œå¹¶ä¸”å°†å½“å‰panicåŠ å…¥å½“å‰goroutineçš„_panicé“¾è¡¨</li><li>ç„¶åå¾ªç¯ä»å½“å‰ goroutine çš„_deferé“¾è¡¨ä¸­è·å–runtime._deferå¹¶è°ƒç”¨runtime.reflectcall()è¿è¡Œdeferå‡½æ•°ã€‚</li></ul></li><li>æ¢å¤æµç¨‹ï¼šå¦‚æœdeferå‡½æ•°ä¸­å¦‚æœrecoverè°ƒç”¨ï¼Œrecoverä¼šè¢«æ±‡ç¼–è½¬æ¢æˆruntime.gorecoverè°ƒç”¨ï¼Œè¯¥å‡½æ•°ä¼šæ ‡è®°è¯¥panicå·²ç»è¢«recoverã€‚åœ¨æ‰§è¡Œå®ŒæŸä¸ªdeferåï¼Œå¦‚æœè¯¥panicè¢«æ ‡è®°ä¸ºrecoverï¼Œåˆ™ä¼šè°ƒç”¨runtime.recoveryæ¢å¤goroutineçš„æ‰§è¡Œã€‚</li><li>å´©æºƒæµç¨‹ï¼šå¦‚æœ_deferé“¾è¡¨ä¸ºç©ºï¼Œæˆ–è€…æ‰§è¡Œå®Œæ‰€æœ‰çš„deferéƒ½ä¸åŒ…å«recoverè°ƒç”¨ï¼Œåˆ™ä¼šè°ƒç”¨runtime.fatalpanicæ‰“å°panicä¿¡æ¯ï¼Œç„¶åä¸­æ­¢&#x2F;é€€å‡ºç¨‹åºã€‚</li></ul><h2 id="3-å‚è€ƒèµ„æ–™"><a href="#3-å‚è€ƒèµ„æ–™" class="headerlink" title="3. å‚è€ƒèµ„æ–™"></a>3. å‚è€ƒèµ„æ–™</h2><p><a href="https://zhuanlan.zhihu.com/p/487749806">https://zhuanlan.zhihu.com/p/487749806</a> </p><p><a href="https://zhuanlan.zhihu.com/p/689615742">https://zhuanlan.zhihu.com/p/689615742</a></p><p><a href="https://go101.org/article/panic-and-recover-use-cases.html">https://go101.org/article/panic-and-recover-use-cases.html</a> </p><p><a href="https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-panic-recover/">https://draveness.me/golang/docs/part2-foundation/ch05-keyword/golang-panic-recover/</a></p>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>å¼‚å¸¸å¤„ç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDBæŸ¥è¯¢æ€§èƒ½åˆ†æ-Explain</title>
    <link href="/2024/06/30/MongoDB%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90-Explain/"/>
    <url>/2024/06/30/MongoDB%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90-Explain/</url>
    
    <content type="html"><![CDATA[<p>åœ¨æ—¥å¸¸çš„MongoDBå¼€å‘å’Œä½¿ç”¨ä¸­ï¼Œä¸å¯é¿å…çš„ä¼šç¢°åˆ°ä¸€äº›æ…¢æŸ¥è¯¢çš„é—®é¢˜ï¼Œé’ˆå¯¹è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥ä½¿ç”¨ explain æ–¹æ³•æ¥è·å–æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’å’Œæ€§èƒ½åˆ†æä¿¡æ¯ã€‚ä½¿ç”¨explainæ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£æŸ¥è¯¢æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œä»¥åŠè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œä¼˜åŒ–å¯¹è±¡ã€‚</p><span id="more"></span>   <h2 id="1-Explainç®€ä»‹"><a href="#1-Explainç®€ä»‹" class="headerlink" title="1. Explainç®€ä»‹"></a>1. Explainç®€ä»‹</h2><h3 id="1-1-åŸºæœ¬ä½¿ç”¨"><a href="#1-1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="1.1 åŸºæœ¬ä½¿ç”¨"></a>1.1 åŸºæœ¬ä½¿ç”¨</h3><p>ä½¿ç”¨ explain æ–¹æ³•ï¼›ä½ å¯ä»¥åœ¨ä»»ä½•æŸ¥è¯¢ã€æ›´æ–°æˆ–åˆ é™¤æ“ä½œä¸­ä½¿ç”¨ explain æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åŸºæœ¬ç¤ºä¾‹ã€‚<br>å‡è®¾ä½ æœ‰ä¸€ä¸ªé›†åˆ myCollectionï¼Œä½ å¯ä»¥å¦‚ä¸‹è¿›è¡Œæ“ä½œï¼š</p><ul><li><p>å¯¹æŸ¥è¯¢æ“ä½œä½¿ç”¨ explain   </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.myCollection.find(&#123; a: &#123; $gt: <span class="hljs-number">1</span>, $lt: <span class="hljs-number">2</span> &#125; &#125;).explain() <br></code></pre></td></tr></table></figure><p>è¿™å°†è¿”å›æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼ŒåŒ…æ‹¬æ‰«æç±»å‹ã€ç´¢å¼•ä½¿ç”¨æƒ…å†µå’Œå…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚</p></li><li><p>å¯¹æ›´æ–°æ“ä½œä½¿ç”¨ explain   </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.myCollection.updateMany(&#123; a: &#123; $gt: <span class="hljs-number">1</span>, $lt: <span class="hljs-number">2</span> &#125; &#125;, &#123; $<span class="hljs-keyword">set</span>: &#123; b: <span class="hljs-number">1</span> &#125; &#125;).explain() <br></code></pre></td></tr></table></figure></li><li><p>å¯¹åˆ é™¤æ“ä½œä½¿ç”¨ explain    </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.myCollection.deleteMany(&#123; a: &#123; $gt: <span class="hljs-number">1</span>, $lt: <span class="hljs-number">2</span> &#125; &#125;).explain() <br></code></pre></td></tr></table></figure></li></ul><h3 id="1-2-è¾“å‡ºå«ä¹‰è§£æ"><a href="#1-2-è¾“å‡ºå«ä¹‰è§£æ" class="headerlink" title="1.2 è¾“å‡ºå«ä¹‰è§£æ"></a>1.2 è¾“å‡ºå«ä¹‰è§£æ</h3><p>explain æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„æ–‡æ¡£ï¼š</p><ul><li><p>queryPlannerï¼šæè¿°æŸ¥è¯¢è®¡åˆ’çš„ä¿¡æ¯ã€‚</p><ul><li>plannerVersionï¼šæŸ¥è¯¢è§„åˆ’å™¨çš„ç‰ˆæœ¬ã€‚</li><li>namespaceï¼šæŸ¥è¯¢çš„å‘½åç©ºé—´ï¼ˆå³æ•°æ®åº“å’Œé›†åˆï¼‰ã€‚</li><li>indexFilterSetï¼šæ˜¯å¦è®¾ç½®äº†ç´¢å¼•è¿‡æ»¤ã€‚</li><li>parsedQueryï¼šè§£æåçš„æŸ¥è¯¢æ¡ä»¶ã€‚</li><li>winningPlanï¼šå®é™…æ‰§è¡Œçš„æŸ¥è¯¢è®¡åˆ’ã€‚<font color="red">ï¼ˆwinningPlanæ¯”è¾ƒé‡è¦ï¼Œä¸€èˆ¬å¯ä»¥çœ‹å‡ºå½“å‰æŸ¥è¯¢è¯­å¥ä½¿ç”¨çš„ç´¢å¼•è®¡åˆ’ç­‰ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥ï¼‰</font></li><li>rejectedPlansï¼šè¢«æ‹’ç»çš„æŸ¥è¯¢è®¡åˆ’ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</li></ul></li><li><p>executionStatsï¼šæä¾›æŸ¥è¯¢æ‰§è¡Œçš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆä»…åœ¨ä½¿ç”¨ executionStats æˆ– allPlansExecution æ¨¡å¼æ—¶ï¼‰ã€‚</p><ul><li>executionSuccessï¼šæŸ¥è¯¢æ˜¯å¦æˆåŠŸæ‰§è¡Œã€‚</li><li>nReturnedï¼šè¿”å›çš„æ–‡æ¡£æ•°é‡ã€‚</li><li>executionTimeMillisï¼šæŸ¥è¯¢æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚</li><li>totalKeysExaminedï¼šæ£€æŸ¥çš„ç´¢å¼•é”®æ•°é‡ã€‚</li><li>totalDocsExaminedï¼šæ£€æŸ¥çš„æ–‡æ¡£æ•°é‡ã€‚</li><li>serverInfoï¼šæœ‰å…³æœåŠ¡å™¨çš„ä¿¡æ¯ã€‚</li></ul></li></ul><h3 id="1-3-æ¨¡å¼å·®åˆ«"><a href="#1-3-æ¨¡å¼å·®åˆ«" class="headerlink" title="1.3 æ¨¡å¼å·®åˆ«"></a>1.3 æ¨¡å¼å·®åˆ«</h3><p>explain æ–¹æ³•æœ‰ä¸‰ç§æ¨¡å¼, å¯ä»¥é€šè¿‡ä¼ é€’å‚æ•°æ¥æŒ‡å®šæ¨¡å¼ã€‚</p><ul><li>queryPlannerï¼ˆé»˜è®¤ï¼‰ï¼šåªè¿”å›æŸ¥è¯¢è®¡åˆ’ï¼Œä¸åŒ…å«å®é™…æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚  </li><li>executionStatsï¼šè¿”å›æŸ¥è¯¢è®¡åˆ’å’Œæ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚  </li><li>allPlansExecutionï¼šè¿”å›æ‰€æœ‰æ‰§è¡Œè®¡åˆ’å’Œå®ƒä»¬çš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚</li></ul><h3 id="1-4-å…·ä½“æ¡ˆä¾‹åˆ†æ"><a href="#1-4-å…·ä½“æ¡ˆä¾‹åˆ†æ" class="headerlink" title="1.4 å…·ä½“æ¡ˆä¾‹åˆ†æ"></a>1.4 å…·ä½“æ¡ˆä¾‹åˆ†æ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.myCollection.find(&#123; a: &#123; $gt: <span class="hljs-number">1</span>, $lt: <span class="hljs-number">2</span> &#125; &#125;).explain(&quot;executionStats&quot;) <br></code></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ª explain æ–¹æ³•çš„ç¤ºä¾‹è¾“å‡ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;queryPlanner&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;plannerVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;myDatabase.myCollection&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;indexFilterSet&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;parsedQuery&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;$gt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;$lt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;winningPlan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;FETCH&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;inputStage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IXSCAN&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;keyPattern&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_1&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isMultiKey&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;multiKeyPaths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isUnique&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isSparse&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isPartial&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;direction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;forward&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexBounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;(1.0, 2.0)&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;rejectedPlans&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;executionStats&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;executionSuccess&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;nReturned&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;executionTimeMillis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;totalKeysExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;totalDocsExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;executionStages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;FETCH&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;nReturned&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;executionTimeMillisEstimate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;works&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;advanced&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;needTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;needFetch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;saveState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;restoreState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;isEOF&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;docsExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;alreadyHasObj&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;inputStage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IXSCAN&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;nReturned&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;executionTimeMillisEstimate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;works&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;advanced&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;needTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;needFetch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;saveState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;restoreState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isEOF&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;keyPattern&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_1&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isMultiKey&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;multiKeyPaths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isUnique&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isSparse&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isPartial&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;direction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;forward&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexBounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;(1.0, 2.0)&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;keysExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;seeks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;dupsTested&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;dupsDropped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;seenInvalidated&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;serverInfo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;localhost&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">27017</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;4.2.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;gitVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2b62a68cfa4efae44c9a66b09a38df7e48fdbe73&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æ explain è¾“å‡ºï¼Œä½ å¯ä»¥äº†è§£æŸ¥è¯¢æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œå¹¶æ®æ­¤ä¼˜åŒ–ç´¢å¼•å’ŒæŸ¥è¯¢è¯­å¥ã€‚</p><h2 id="2-ExecutionStatsä¸­çš„æ—¶é—´åˆ†æ"><a href="#2-ExecutionStatsä¸­çš„æ—¶é—´åˆ†æ" class="headerlink" title="2 ExecutionStatsä¸­çš„æ—¶é—´åˆ†æ"></a>2 ExecutionStatsä¸­çš„æ—¶é—´åˆ†æ</h2><p>åœ¨ MongoDB çš„ explain è¾“å‡ºä¸­ï¼ŒexecutionStats éƒ¨åˆ†åŒ…å«äº†æŸ¥è¯¢çš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚å…¶ä¸­åŒ…æ‹¬æ‰§è¡Œè¯„ä¼°æ—¶é—´ï¼ˆexecutionTimeMillisEstimateï¼‰å’Œå®é™…æ‰§è¡Œæ—¶é—´ï¼ˆexecutionTimeMillisï¼‰ã€‚è¿™ä¸¤ä¸ªæ—¶é—´æŒ‡æ ‡æœ‰ä¸åŒçš„å«ä¹‰å’Œç”¨é€”ï¼š</p><ul><li>executionTimeMillisEstimateï¼š<ul><li>å«ä¹‰ï¼šæ‰§è¡Œè¯„ä¼°æ—¶é—´ï¼ˆæˆ–æ‰§è¡Œæ—¶é—´ä¼°è®¡ï¼‰ã€‚</li><li>ä½œç”¨ï¼šè¿™æ˜¯å¯¹ç‰¹å®šé˜¶æ®µæˆ–æ­¥éª¤çš„æ‰§è¡Œæ—¶é—´çš„ä¼°è®¡å€¼ã€‚è¿™ä¸ªå€¼æ˜¯ç”± MongoDB æŸ¥è¯¢å¼•æ“å†…éƒ¨è®¡ç®—å¾—å‡ºçš„ï¼Œç”¨äºæä¾›ä¸€ä¸ªå¤§è‡´çš„æ—¶é—´ä¼°è®¡ï¼Œå¸®åŠ©äº†è§£æŸ¥è¯¢å„ä¸ªé˜¶æ®µæ‰€æ¶ˆè€—çš„æ—¶é—´ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šåœ¨åˆ†ææŸ¥è¯¢è®¡åˆ’ä¸­å„ä¸ªé˜¶æ®µçš„æ€§èƒ½æ—¶ï¼ŒexecutionTimeMillisEstimate å¯ä»¥å¸®åŠ©ç¡®å®šæ¯ä¸ªé˜¶æ®µçš„å¤§è‡´æ‰§è¡Œæ—¶é—´ï¼Œä»è€Œè¯†åˆ«å¯èƒ½çš„æ€§èƒ½ç“¶é¢ˆã€‚</li></ul></li><li>executionTimeMillisï¼š<ul><li>å«ä¹‰ï¼šå®é™…æ‰§è¡Œæ—¶é—´ã€‚</li><li>ä½œç”¨ï¼šè¿™æ˜¯æŸ¥è¯¢ä»å¼€å§‹åˆ°ç»“æŸå®é™…èŠ±è´¹çš„æ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚è¿™ä¸ªæ—¶é—´åŒ…æ‹¬æ•´ä¸ªæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ­¥éª¤å’Œé˜¶æ®µã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šexecutionTimeMillis æä¾›äº†æŸ¥è¯¢çš„æ€»ä½“æ‰§è¡Œæ—¶é—´ï¼Œç”¨äºè¡¡é‡æŸ¥è¯¢çš„æ•´ä½“æ€§èƒ½ã€‚</li></ul></li></ul><p>å‡è®¾æœ‰ä»¥ä¸‹ explain è¾“å‡ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;executionStats&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;executionSuccess&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;nReturned&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;executionTimeMillis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;totalKeysExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;totalDocsExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;executionStages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;FETCH&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;nReturned&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;executionTimeMillisEstimate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;works&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;advanced&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;needTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;needFetch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;saveState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;restoreState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;isEOF&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;docsExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;alreadyHasObj&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;inputStage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IXSCAN&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;nReturned&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;executionTimeMillisEstimate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;works&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;advanced&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;needTime&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;needFetch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;saveState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;restoreState&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isEOF&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;keyPattern&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_1&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isMultiKey&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;multiKeyPaths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isUnique&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isSparse&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;isPartial&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;direction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;forward&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;indexBounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-string">&quot;(1.0, 2.0)&quot;</span><br>          <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;keysExamined&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;seeks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;dupsTested&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;dupsDropped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;seenInvalidated&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ul><li>executionTimeMillisï¼šæ•´ä¸ªæŸ¥è¯¢å®é™…æ‰§è¡Œæ—¶é—´ä¸º 5 æ¯«ç§’ã€‚</li><li>executionTimeMillisEstimateï¼ˆFETCH é˜¶æ®µï¼‰ï¼šè¿™ä¸ªé˜¶æ®µçš„æ‰§è¡Œæ—¶é—´ä¼°è®¡ä¸º 2 æ¯«ç§’ã€‚</li><li>executionTimeMillisEstimateï¼ˆIXSCAN é˜¶æ®µï¼‰ï¼šè¿™ä¸ªé˜¶æ®µçš„æ‰§è¡Œæ—¶é—´ä¼°è®¡ä¸º 1 æ¯«ç§’ã€‚</li></ul><p>é€šè¿‡ç»“åˆè¿™ä¸¤ä¸ªæ—¶é—´æŒ‡æ ‡ï¼Œå¯ä»¥æ›´å¥½åœ°ä¼˜åŒ–æŸ¥è¯¢ï¼Œæ”¹è¿›æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªé˜¶æ®µçš„ executionTimeMillisEstimate ç‰¹åˆ«é«˜ï¼Œå¯ä»¥è€ƒè™‘ä¼˜åŒ–è¯¥é˜¶æ®µçš„ç´¢å¼•æˆ–æŸ¥è¯¢é€»è¾‘ã€‚</p><h2 id="3-WinningPalnä¸­çš„Stageæœ‰å“ªäº›"><a href="#3-WinningPalnä¸­çš„Stageæœ‰å“ªäº›" class="headerlink" title="3. WinningPalnä¸­çš„Stageæœ‰å“ªäº›"></a>3. WinningPalnä¸­çš„Stageæœ‰å“ªäº›</h2><p>åœ¨ MongoDB æŸ¥è¯¢è®¡åˆ’ï¼ˆexplain è¾“å‡ºçš„ winningPlan éƒ¨åˆ†ï¼‰ä¸­ï¼ŒæŸ¥è¯¢è®¡åˆ’ç”±å¤šä¸ªé˜¶æ®µï¼ˆStageï¼‰ç»„æˆï¼Œæ¯ä¸ªé˜¶æ®µä»£è¡¨æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªæ­¥éª¤ã€‚ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ç±»å‹ï¼š</p><ul><li>COLLSCANï¼ˆCollection Scanï¼‰ï¼š<ul><li>æ‰«ææ•´ä¸ªé›†åˆçš„æ‰€æœ‰æ–‡æ¡£ï¼Œé€šå¸¸æ˜¯å› ä¸ºæ²¡æœ‰å¯ç”¨çš„ç´¢å¼•ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæ²¡æœ‰é€‚ç”¨çš„ç´¢å¼•ï¼Œæˆ–è€…æ˜¯å…¨è¡¨æ‰«æã€‚-</li></ul></li><li>IXSCANï¼ˆIndex Scanï¼‰ï¼š<ul><li>æ‰«æç´¢å¼•ï¼ŒæŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ç´¢å¼•æ¡ç›®ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢æ¡ä»¶å¯ä»¥åˆ©ç”¨ç´¢å¼•ã€‚</li></ul></li><li>FETCHï¼š<ul><li>ä»ç£ç›˜ä¸­è¯»å–æ–‡æ¡£ï¼Œé€šå¸¸è·Ÿåœ¨ IXSCAN ä¹‹åï¼Œé€šè¿‡ç´¢å¼•æŸ¥æ‰¾åè·å–å®é™…æ–‡æ¡£ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šé€šè¿‡ç´¢å¼•æŸ¥æ‰¾åï¼Œéœ€è¦è·å–å®Œæ•´æ–‡æ¡£ã€‚</li></ul></li><li>LIMITï¼š<ul><li>é™åˆ¶ç»“æœé›†çš„æ•°é‡ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨ limit æ“ä½œã€‚</li></ul></li><li>SKIPï¼š<ul><li>è·³è¿‡ç»“æœé›†ä¸­çš„å‰è‹¥å¹²ä¸ªæ–‡æ¡£ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨ skip æ“ä½œã€‚</li></ul></li><li>SORTï¼š<ul><li>å¯¹ç»“æœé›†è¿›è¡Œæ’åºã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨ sort æ“ä½œã€‚</li></ul></li><li>PROJECTIONï¼š<ul><li>å¯¹ç»“æœé›†è¿›è¡Œå­—æ®µæŠ•å½±ï¼Œåªè¿”å›æŒ‡å®šçš„å­—æ®µã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨å­—æ®µé€‰æ‹©å™¨ã€‚</li></ul></li><li>SHARD_MERGEï¼š<ul><li>ä»å¤šä¸ªåˆ†ç‰‡ä¸­åˆå¹¶ç»“æœé›†ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šåœ¨åˆ†ç‰‡é›†ç¾¤ç¯å¢ƒä¸­ï¼Œè·¨åˆ†ç‰‡æŸ¥è¯¢ã€‚</li></ul></li><li>TEXTï¼š<ul><li>æ‰§è¡Œå…¨æ–‡æœç´¢æŸ¥è¯¢ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨ $text æ“ä½œç¬¦ã€‚</li></ul></li><li>GEO_NEARï¼š<ul><li>æ‰§è¡Œåœ°ç†ä½ç½®æŸ¥è¯¢ï¼ŒæŸ¥æ‰¾è·ç¦»æŸç‚¹æœ€è¿‘çš„æ–‡æ¡£ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨ $near æˆ– $geoNear æ“ä½œç¬¦ã€‚</li></ul></li><li>GROUPï¼š<ul><li>æ‰§è¡Œåˆ†ç»„æ“ä½œï¼Œç±»ä¼¼äº SQL çš„ GROUP BYã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨èšåˆç®¡é“ä¸­çš„ $group æ“ä½œç¬¦ã€‚</li></ul></li><li>UNWINDï¼š<ul><li>æ‹†åˆ†æ•°ç»„å­—æ®µï¼Œå°†æ¯ä¸ªæ•°ç»„å…ƒç´ ä½œä¸ºå•ç‹¬çš„æ–‡æ¡£ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨èšåˆç®¡é“ä¸­çš„ $unwind æ“ä½œç¬¦ã€‚</li></ul></li><li>LOOKUPï¼š<ul><li>æ‰§è¡Œè”è¡¨æŸ¥è¯¢ï¼Œå°†ä¸€ä¸ªé›†åˆä¸­çš„æ–‡æ¡£ä¸å¦ä¸€ä¸ªé›†åˆä¸­çš„æ–‡æ¡£è¿›è¡Œè¿æ¥ã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨èšåˆç®¡é“ä¸­çš„ $lookup æ“ä½œç¬¦ã€‚</li></ul></li><li>REDUCEï¼š<ul><li>åœ¨ MapReduce æ“ä½œä¸­ï¼Œæ‰§è¡Œ reduce é˜¶æ®µã€‚</li><li>ä½¿ç”¨åœºæ™¯ï¼šä½¿ç”¨ MapReduce æ‰§è¡Œå¤æ‚èšåˆæ“ä½œã€‚</li></ul></li></ul><p>å‡è®¾æœ‰ä¸€ä¸ªé›†åˆ myCollectionï¼Œä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢å¹¶ç»“åˆ explain æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’ï¼š  </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">db.myCollection.find(&#123; a: &#123; $gt: <span class="hljs-number">1</span>, $lt: <span class="hljs-number">2</span> &#125; &#125;).sort(&#123; b: <span class="hljs-number">-1</span> &#125;).limit(<span class="hljs-number">5</span>).explain()<br></code></pre></td></tr></table></figure><p>å¾—åˆ°çš„ explain è¾“å‡ºå¯èƒ½åŒ…å«ä»¥ä¸‹é˜¶æ®µï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;queryPlanner&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;winningPlan&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;LIMIT&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;limitAmount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;inputStage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SORT&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sortPattern&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;b&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;inputStage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;FETCH&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;inputStage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;IXSCAN&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;keyPattern&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;indexName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a_1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;isMultiKey&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;direction&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;forward&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;indexBounds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;a&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;(1.0, 2.0)&quot;</span><br>              <span class="hljs-punctuation">]</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>LIMIT é˜¶æ®µï¼šé™åˆ¶ç»“æœé›†æ•°é‡ä¸º 5ã€‚</li><li>SORT é˜¶æ®µï¼šæŒ‰ b å­—æ®µè¿›è¡Œé™åºæ’åºã€‚</li><li>FETCH é˜¶æ®µï¼šé€šè¿‡ç´¢å¼•æŸ¥æ‰¾åï¼Œä»ç£ç›˜ä¸­è¯»å–å®Œæ•´æ–‡æ¡£ã€‚</li><li>IXSCAN é˜¶æ®µï¼šæ‰«æ a_1 ç´¢å¼•ï¼ŒæŸ¥æ‰¾ a å­—æ®µåœ¨ (1, 2) èŒƒå›´å†…çš„ç´¢å¼•æ¡ç›®ã€‚</li></ul><p>é€šè¿‡ç†è§£è¿™äº›é˜¶æ®µï¼Œå¯ä»¥æ›´å¥½åœ°åˆ†æå’Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œç¡®ä¿æŸ¥è¯¢å°½å¯èƒ½åˆ©ç”¨ç´¢å¼•ï¼Œå‡å°‘å…¨è¡¨æ‰«æï¼ˆCOLLSCANï¼‰ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>MongoDB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ€§èƒ½åˆ†æ</tag>
      
      <tag>Explain</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang Json Unmarshal å¤§æ•°ç²¾åº¦ä¸¢å¤±é—®é¢˜</title>
    <link href="/2024/05/08/Golang-Json-Unmarshal-%E5%A4%A7%E6%95%B0%E7%B2%BE%E5%BA%A6%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/"/>
    <url>/2024/05/08/Golang-Json-Unmarshal-%E5%A4%A7%E6%95%B0%E7%B2%BE%E5%BA%A6%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>åœ¨Golangä¸­ï¼Œä½¿ç”¨Unmarshalå°†ä¸€ä¸ªJsonæ•°å­—è§£æä¸º<code>interface&#123;&#125;</code>æ—¶, int64ç­‰å¤§ç±»å‹æ•°å­—ä¼šå­˜åœ¨ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ã€‚    </p><p>ä¸€èˆ¬æ¥è¯´ï¼Œé•¿åº¦è¶…è¿‡16ä½çš„æ•°å­—æ˜“å‘ç”Ÿæ•°æ®æˆªæ–­ï¼Œè€Œä¸”æ•°æ®å€¼å˜æˆäº†ç§‘å­¦è®¡æ•°æ³•ã€‚</p><span id="more"></span>   <h2 id="1-æ¡ˆä¾‹ä»‹ç»"><a href="#1-æ¡ˆä¾‹ä»‹ç»" class="headerlink" title="1. æ¡ˆä¾‹ä»‹ç»"></a>1. æ¡ˆä¾‹ä»‹ç»</h2><p>å‡è®¾æœ‰ä¸€ä¸ªé•¿åº¦ä¸º17çš„jsonå¤§æ•°å­—</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">var</span> str = <span class="hljs-string">`&#123;&quot;id&quot;:10000649949036001&#125;`</span><br></code></pre></td></tr></table></figure><p>å¦‚æœç›´æ¥ä½¿ç”¨jsonçš„interfaceè¿›è¡Œè§£æ, ä¼šå¾—åˆ° 10000649949036000, è€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„10000649949036001 </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParseWithInterface</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> test <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br><br><span class="hljs-keyword">if</span> err := json.Unmarshal([]<span class="hljs-type">byte</span>(str), &amp;test); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>&#125;<br><br>fmt.Println(test)<br><br>dataBytes, err := json.Marshal(test)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;%+s\n&quot;</span>, <span class="hljs-type">string</span>(dataBytes))<br>&#125;<br><br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// map[id:1.0000649949036e+16]</span><br><span class="hljs-comment">// &#123;&quot;id&quot;:10000649949036000&#125;  </span><br><br></code></pre></td></tr></table></figure><h2 id="2-åŸå› åˆ†æ"><a href="#2-åŸå› åˆ†æ" class="headerlink" title="2. åŸå› åˆ†æ"></a>2. åŸå› åˆ†æ</h2><p>åŸå› å°±å‡ºåœ¨äº†interface{}ä¸Šï¼Œåœ¨golangä¸­ï¼Œå½“æ•°æ®ç»“æ„æœªçŸ¥ï¼Œä½¿ç”¨map[string]interface{}æ¥æ”¶ååºåˆ—åŒ–ç»“æœæ—¶ï¼Œä¼šä½¿ç”¨float64æ¥è¿›è¡Œç»“æœè§£æï¼Œè€Œfloatç±»å‹åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­æ—¶ä¼šæœ‰ç²¾åº¦ä¸¢å¤±çš„ï¼Œä¸€èˆ¬è¶…è¿‡16ä½å°±ä¼šå‘ç”Ÿï¼ŒåŒæ—¶float64åœ¨å¤„ç†çš„æ•°æ®çš„æ—¶å€™ï¼Œä¸€èˆ¬è¶…è¿‡6ä½å°±ä¼šå˜æˆç§‘å­¦è®°æ•°æ³•ã€‚ä½¿ç”¨float64å¯¹json numberè¿›è¡Œè§£æå¯ä»¥åœ¨jsonçš„å®˜æ–¹ä»£ç ä¸­æ‰¾åˆ°ã€‚</p><blockquote><p>&#x2F;&#x2F; To unmarshal JSON into an interface value,<br>&#x2F;&#x2F; Unmarshal stores one of these in the interface value:<br>&#x2F;&#x2F;<br>&#x2F;&#x2F;bool, for JSON booleans<br>&#x2F;&#x2F;float64, for JSON numbers<br>&#x2F;&#x2F;string, for JSON strings<br>&#x2F;&#x2F;[]interface{}, for JSON arrays<br>&#x2F;&#x2F;map[string]interface{}, for JSON objects<br>&#x2F;&#x2F;nil for JSON null</p></blockquote><h2 id="3-è§£å†³æ–¹æ¡ˆ"><a href="#3-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="3. è§£å†³æ–¹æ¡ˆ"></a>3. è§£å†³æ–¹æ¡ˆ</h2><p>æ—¢ç„¶ä¸Šæ–‡å·²ç»è¯´äº†int64ååºåˆ—åŒ–ç²¾åº¦ä¸¢å¤±çš„åŸå› æ˜¯ä½¿ç”¨äº†float64è¿›è¡Œè§£æï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨è§£ææ—¶å¼ºè¡ŒæŒ‡å®šä¸ä½¿ç”¨float64è§£æå³å¯ã€‚</p><h3 id="3-1-ä½¿ç”¨Int64è§£æ"><a href="#3-1-ä½¿ç”¨Int64è§£æ" class="headerlink" title="3.1 ä½¿ç”¨Int64è§£æ"></a>3.1 ä½¿ç”¨Int64è§£æ</h3><p>åœ¨çŸ¥é“å…·ä½“ç±»å‹çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥å®šä¹‰ç»“æ„ä½“ä¸ºmap[string]int64, è¿™æ ·åœ¨è§£ææ—¶ï¼Œå°±ä¼šä½¿ç”¨int64è¿›è¡Œè§£æã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParseWithInt64</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> data <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int64</span><br>str := <span class="hljs-string">`&#123;&quot;id&quot;:10000649949036001&#125;`</span><br>err := json.Unmarshal([]<span class="hljs-type">byte</span>(str), &amp;data)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>&#125;<br><br>fmt.Println(data)<br>&#125;<br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// map[id:10000649949036001]</span><br></code></pre></td></tr></table></figure><h3 id="3-2-åˆ©ç”¨UseNumber"><a href="#3-2-åˆ©ç”¨UseNumber" class="headerlink" title="3.2 åˆ©ç”¨UseNumber"></a>3.2 åˆ©ç”¨UseNumber</h3><p>golang jsonæä¾›äº†ä¸€ç§é¢å¤–çš„è§£ææ–¹å¼ï¼Œå¯ä»¥åœ¨è§£æçš„è¿‡ç¨‹ä½¿ç”¨æŒ‡å®šä½¿ç”¨Numberç±»å‹è€Œä¸æ˜¯float64è¿›è¡Œè§£æï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ç²¾åº¦ä¸¢å¤±çš„é—®é¢˜ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// convertNumber converts the number literal s to a float64 or a Number</span><br><span class="hljs-comment">// depending on the setting of d.useNumber.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *decodeState)</span></span> convertNumber(s <span class="hljs-type">string</span>) (any, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">if</span> d.useNumber &#123;<br><span class="hljs-keyword">return</span> Number(s), <span class="hljs-literal">nil</span><br>&#125;<br>f, err := strconv.ParseFloat(s, <span class="hljs-number">64</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, &amp;UnmarshalTypeError&#123;Value: <span class="hljs-string">&quot;number &quot;</span> + s, Type: reflect.TypeOf(<span class="hljs-number">0.0</span>), Offset: <span class="hljs-type">int64</span>(d.off)&#125;<br>&#125;<br><span class="hljs-keyword">return</span> f, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParseUseNumber</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> test <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br><br>d := json.NewDecoder(bytes.NewReader([]<span class="hljs-type">byte</span>(str)))<br>d.UseNumber()<br><span class="hljs-keyword">if</span> err := d.Decode(&amp;test); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br>&#125;<br><br>fmt.Println(test)<br>&#125;<br><br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// map[id:10000649949036001]</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>JSON</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang Empty åˆ‡ç‰‡ vs Nil åˆ‡ç‰‡</title>
    <link href="/2024/04/10/Golang-Empty-Nil-Slice/"/>
    <url>/2024/04/10/Golang-Empty-Nil-Slice/</url>
    
    <content type="html"><![CDATA[<p>åˆ‡ç‰‡ï¼ˆSliceï¼‰ï¼Œæ˜¯Golangå¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€ç§åŸºç¡€æ•°æ®ç»“æ„ï¼Œå’Œæ•°ç»„æ¯”è¾ƒç›¸ä¼¼ã€‚åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œç»å¸¸è§åˆ°nilåˆ‡ç‰‡ã€ç©ºåˆ‡ç‰‡å’Œé›¶åˆ‡ç‰‡çš„æ¦‚å¿µã€‚ä»Šå¤©ä¸»è¦åˆ†äº«ä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ã€‚</p><span id="more"></span>  <h2 id="1-åŸºæœ¬å¯¹æ¯”"><a href="#1-åŸºæœ¬å¯¹æ¯”" class="headerlink" title="1. åŸºæœ¬å¯¹æ¯”"></a>1. åŸºæœ¬å¯¹æ¯”</h2><h3 id="1-1-ç»“è®º"><a href="#1-1-ç»“è®º" class="headerlink" title="1.1 ç»“è®º"></a>1.1 ç»“è®º</h3><p>empty slice vs nil slice     </p><ul><li>ç›¸åŒç‚¹   <ul><li>they both have zero length and capacity,   </li><li>they can be used with the same effect in for loops and append functions,</li><li>and they even look the same when printed.</li></ul></li><li>ä¸åŒç‚¹   <ul><li>nilåˆ‡ç‰‡å’Œnilæ¯”è¾ƒçš„ç»“æœæ˜¯true  </li><li>emptyåˆ‡ç‰‡å’Œnilæ¯”è¾ƒçš„ç»“æœæ˜¯false</li></ul></li></ul><h3 id="1-2-nil-åˆ‡ç‰‡"><a href="#1-2-nil-åˆ‡ç‰‡" class="headerlink" title="1.2 nil åˆ‡ç‰‡"></a>1.2 nil åˆ‡ç‰‡</h3><blockquote><p>nil slice: é•¿åº¦å’Œå®¹é‡éƒ½ä¸º0ï¼Œå¹¶ä¸”å’Œnilæ¯”è¾ƒçš„ç»“æœtrueçš„åˆ‡ç‰‡<br>ä¸€èˆ¬å¯ä»¥é€šè¿‡ç›´æ¥å®šä¹‰å˜é‡æˆ–è€…newåˆ›å»º   </p></blockquote><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">var</span> slice1 []<span class="hljs-type">int</span><br><span class="hljs-keyword">var</span> slice2 = *<span class="hljs-built_in">new</span>([]<span class="hljs-type">int</span>)<br>fmt.Println(slice1, <span class="hljs-built_in">len</span>(slice1), <span class="hljs-built_in">cap</span>(slice1), slice1 == <span class="hljs-literal">nil</span>)<br>fmt.Println(slice2, <span class="hljs-built_in">len</span>(slice2), <span class="hljs-built_in">cap</span>(slice2), slice2 == <span class="hljs-literal">nil</span>) Â <br><span class="hljs-comment">// [] 0 0 true</span><br><span class="hljs-comment">// [] 0 0 true</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥ç®€å•ç†è§£ä¸ºnilåˆ‡ç‰‡æ˜¯åªå£°æ˜ä½†æ˜¯æœªåˆå§‹åŒ–çš„åˆ‡ç‰‡ã€‚   </p><h3 id="1-3-empty-åˆ‡ç‰‡"><a href="#1-3-empty-åˆ‡ç‰‡" class="headerlink" title="1.3 empty åˆ‡ç‰‡"></a>1.3 empty åˆ‡ç‰‡</h3><blockquote><p>empty slice: é•¿åº¦å’Œå®¹é‡éƒ½ä¸º0ï¼Œä½†æ˜¯å’Œnilæ¯”è¾ƒçš„ç»“æœä¸ºfalseçš„åˆ‡ç‰‡<br>ä¸€èˆ¬å¯ä»¥é€šè¿‡å£°æ˜ä¸€ä¸ªé•¿åº¦ä¸º0çš„åˆ‡ç‰‡åˆ›å»º  </p></blockquote><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">var</span> slice3 = []<span class="hljs-type">int</span>&#123;&#125;<br><span class="hljs-keyword">var</span> slice4 = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>)<br>fmt.Println(slice3, <span class="hljs-built_in">len</span>(slice3), <span class="hljs-built_in">cap</span>(slice3), slice3 == <span class="hljs-literal">nil</span>)<br>fmt.Println(slice4, <span class="hljs-built_in">len</span>(slice4), <span class="hljs-built_in">cap</span>(slice4), slice4 == <span class="hljs-literal">nil</span>) Â <br><span class="hljs-comment">// [] 0 0 false</span><br><span class="hljs-comment">// [] 0 0 false</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥ç®€å•ç†è§£emptyåˆ‡ç‰‡æ˜¯å£°æ˜ååˆ‡åˆå§‹åŒ–äº†é•¿åº¦ä¸º0çš„åˆ‡ç‰‡ã€‚</p><h3 id="1-4-é›¶-åˆ‡ç‰‡"><a href="#1-4-é›¶-åˆ‡ç‰‡" class="headerlink" title="1.4 é›¶ åˆ‡ç‰‡"></a>1.4 é›¶ åˆ‡ç‰‡</h3><blockquote><p>é›¶åˆ‡ç‰‡ï¼š å«æ³•ä¸å¸¸è§ï¼Œä¸»è¦æ˜¯å€¼é•¿åº¦éƒ¨ä½0ï¼Œä½†æ˜¯å†…éƒ¨æ•°ç»„å…ƒç´ éƒ½æ˜¯é›¶å€¼æˆ–è€…nilçš„åˆ‡ç‰‡<br>ä½¿ç”¨makeåˆ›å»ºçš„é•¿åº¦ä¸ä¸º0çš„åˆå§‹åˆ‡ç‰‡å°±æ˜¯é›¶åˆ‡ç‰‡  </p></blockquote><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang">slice5 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">5</span>)  <span class="hljs-comment">// 0 0 0 0 0</span><br>slice6 := <span class="hljs-built_in">make</span>([]*<span class="hljs-type">int</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// nil nil nil nil nil</span><br>fmt.Println(slice5, <span class="hljs-built_in">len</span>(slice5), <span class="hljs-built_in">cap</span>(slice5), slice5 == <span class="hljs-literal">nil</span>)<br>fmt.Println(slice6, <span class="hljs-built_in">len</span>(slice6), <span class="hljs-built_in">cap</span>(slice6), slice6 == <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">// [0 0 0 0 0] 5 5 false</span><br><span class="hljs-comment">// [nil nil nil nil nil] 5 5 false</span><br></code></pre></td></tr></table></figure><h2 id="2-åº•å±‚åŸç†"><a href="#2-åº•å±‚åŸç†" class="headerlink" title="2. åº•å±‚åŸç†"></a>2. åº•å±‚åŸç†</h2><p>golangçš„sliceåº•å±‚ç»“æ„ä½“ç”±3ä¸ªå­—æ®µæ„æˆï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span>&#123;<br>    ptr unsafe.Pointer <br>    <span class="hljs-built_in">len</span> <span class="hljs-type">int</span> <br>    <span class="hljs-built_in">cap</span> <span class="hljs-type">int</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>å…¶ä¸­lenå’Œcapåˆ†åˆ«æ˜¯åˆ‡ç‰‡çš„é•¿åº¦å’Œå®¹é‡ï¼Œè€Œptråˆ™æ˜¯æŒ‡å‘åº•å±‚æ•°ç»„çš„æŒ‡é’ˆã€‚    </p><p>æ‰€è°“nilåˆ‡ç‰‡ï¼Œå°±æ˜¯ptræŒ‡å‘çš„æŒ‡é’ˆä¹Ÿä¸ºnil<br><img src="/img/Golang-Empty-Nil-Slice/1.jpg">     </p><p>å¯ä»¥é€šè¿‡ä¸€ä¸ªå°å®éªŒéªŒè¯æŒ‡é’ˆçš„æ•°æ®ï¼š  </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">var</span> s1 []<span class="hljs-type">int</span>  <br>s2 := []<span class="hljs-type">int</span>&#123;&#125;  <br>s3 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>)<br><br>fmt.Printf(<span class="hljs-string">&quot;s1 (addr: %p): %+8v\n&quot;</span>, &amp;s1, *(*reflect.SliceHeader)(unsafe.Pointer(&amp;s1)))<br>fmt.Printf(<span class="hljs-string">&quot;s2 (addr: %p): %+8v\n&quot;</span>, &amp;s2, *(*reflect.SliceHeader)(unsafe.Pointer(&amp;s2))) <br>fmt.Printf(<span class="hljs-string">&quot;s3 (addr: %p): %+8v\n&quot;</span>, &amp;s3, *(*reflect.SliceHeader)(unsafe.Pointer(&amp;s3))) <br><span class="hljs-comment">// s1 (addr: 0xc0000080d8): &#123;Data:       0 Len:       0 Cap:       0&#125;</span><br><span class="hljs-comment">// s2 (addr: 0xc0000080f0): &#123;Data:12760120 Len:       0 Cap:       0&#125;</span><br><span class="hljs-comment">// s3 (addr: 0xc000008108): &#123;Data:12760120 Len:       0 Cap:       0&#125;</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>Slice</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥ç†è§£Golangæ³›å‹</title>
    <link href="/2024/03/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3golang%E6%B3%9B%E5%9E%8B/"/>
    <url>/2024/03/03/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3golang%E6%B3%9B%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<p>æ³›å‹ï¼ˆGenericsï¼‰æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œå®ƒå…è®¸åœ¨ç¼–å†™ä»£ç æ—¶ä½¿ç”¨æœªçŸ¥çš„ç±»å‹ã€‚æ³›å‹å¯ä»¥å¢åŠ ä»£ç çš„çµæ´»æ€§å’Œå¯å¤ç”¨æ€§ï¼ŒåŒæ—¶è¿˜èƒ½æé«˜ä»£ç çš„å®‰å…¨æ€§å’Œå¯è¯»æ€§ã€‚Goä»1.18å¼€å§‹æ”¯æŒæ³›å‹çš„å®ç°å¹¶åœ¨åç»­çš„ç‰ˆæœ¬ä¸­é€æ¸å®Œå–„ã€‚</p><span id="more"></span>  <h2 id="1-Golangæ³›å‹"><a href="#1-Golangæ³›å‹" class="headerlink" title="1. Golangæ³›å‹"></a>1. Golangæ³›å‹</h2><ul><li>ä¸¾ä¸ªæ —å­, ç°åœ¨æœ‰ä¸€ä¸ªa+bçš„å‡½æ•°  <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(a <span class="hljs-type">int</span>, b <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span>&#123;<br>    <span class="hljs-keyword">return</span> a + b<br>&#125;<br></code></pre></td></tr></table></figure>å‡½æ•°æ¯”è¾ƒç®€å•ï¼Œä¸€çœ‹å°±æ˜¯ä¸¤ä¸ªintç±»å‹çš„æ•°æ®ç›¸åŠ ã€‚ç°åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œåœ¨golangæ³›å‹å‡ºç°ä¹‹å‰ï¼Œå¦‚æœæƒ³å®ç°ä¸¤ä¸ªfloatç›¸åŠ è¯¥å¦‚ä½•å¤„ç†ï¼Ÿä¸€èˆ¬å­˜åœ¨ä¸¤ç§æ–¹å¼ï¼š</li><li>å†å†™ä¸€ä¸ªå‡½æ•°   <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(a <span class="hljs-type">float64</span>, b <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">float64</span>&#123;<br>    <span class="hljs-keyword">return</span> a + b<br>&#125; <br></code></pre></td></tr></table></figure></li><li>æŠŠå‡½æ•°æ”¹é€ æˆåå°„å‡½æ•°  <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Add</span><span class="hljs-params">(a <span class="hljs-keyword">interface</span>&#123;&#125;, b <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>    <span class="hljs-keyword">switch</span> a.(<span class="hljs-keyword">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-type">int</span>:<br>        <span class="hljs-keyword">return</span> a.(<span class="hljs-type">int</span>) + b.(<span class="hljs-type">int</span>)<br>    <span class="hljs-keyword">case</span> <span class="hljs-type">float32</span>:<br>        <span class="hljs-keyword">return</span> a.(<span class="hljs-type">float32</span>) + b.(<span class="hljs-type">float32</span>)<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ul><p>ç°åœ¨golangæ”¯æŒæ³›å‹ä»¥åï¼Œè¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ   </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Add</span>[<span class="hljs-title">T</span> <span class="hljs-title">int</span> | <span class="hljs-title">float32</span> | <span class="hljs-title">float64</span>]<span class="hljs-params">(a, b T)</span></span> T &#123;<br><span class="hljs-keyword">return</span> a + b<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(Add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))<br>fmt.Println(Add(<span class="hljs-number">1.1</span>, <span class="hljs-number">2.1</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯golangä¸­æœ€æ–°æ”¯æŒçš„æ³›å‹å‡½æ•°ã€‚é™¤äº†æ³›å‹å‡½æ•°å¤–ï¼Œè¿˜æ”¯æŒæ³›å‹ç±»å‹å’Œæ³›å‹æ¥å£ã€‚  </p><ul><li>æ³›å‹å‡½æ•°  </li><li>æ³›å‹ç±»å‹  </li><li>æ³›å‹æ¥å£</li></ul><h2 id="2-æ³›å‹åŸºæœ¬ç‰¹æ€§"><a href="#2-æ³›å‹åŸºæœ¬ç‰¹æ€§" class="headerlink" title="2. æ³›å‹åŸºæœ¬ç‰¹æ€§"></a>2. æ³›å‹åŸºæœ¬ç‰¹æ€§</h2><p>æ³›å‹ä½œä¸ºå’Œå¸¸è§„ç±»å‹ä¸åŒçš„åŒºåˆ«å°±åœ¨äºå®ƒå¯ä»¥æ”¯æŒå¤šç§ç±»å‹çš„å‚æ•°ï¼Œæ‰€ä»¥åœ¨å®šä¹‰å’Œä½¿ç”¨æ—¶ä¹Ÿæœ‰ç€ä¸¤ä¸ªåŸºæœ¬çš„ç‰¹æ€§ï¼šç±»å‹å‚æ•°å’Œç±»å‹çº¦æŸã€‚<br><img src="/img/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3golang%E6%B3%9B%E5%9E%8B/1.jpg">   </p><h3 id="2-1-ç±»å‹å‚æ•°"><a href="#2-1-ç±»å‹å‚æ•°" class="headerlink" title="2.1 ç±»å‹å‚æ•°"></a>2.1 ç±»å‹å‚æ•°</h3><ul><li>ç±»å‹å‚æ•°æ˜¯æ³›å‹å‡½æ•°æˆ–ç±»å‹çš„ä¸€ä¸ªå ä½ç¬¦ï¼Œè¡¨ç¤ºä¸€ä¸ªæœªçŸ¥çš„ç±»å‹ã€‚  </li><li>ç±»å‹å‚æ•°åˆ—è¡¨å‡ºç°åœ¨å¸¸è§„å‚æ•°ä¹‹å‰ã€‚ä¸ºäº†åŒºåˆ†ç±»å‹å‚æ•°åˆ—è¡¨å’Œå¸¸è§„å‚æ•°åˆ—è¡¨ï¼Œç±»å‹å‚æ•°åˆ—è¡¨ä½¿ç”¨æ–¹æ‹¬å·[]è€Œä¸æ˜¯åœ†æ‹¬å·()</li></ul><h3 id="2-2-ç±»å‹çº¦æŸ"><a href="#2-2-ç±»å‹çº¦æŸ" class="headerlink" title="2.2 ç±»å‹çº¦æŸ"></a>2.2 ç±»å‹çº¦æŸ</h3><p>åœ¨ä½¿ç”¨æ³›å‹æ—¶ï¼Œæœ‰æ—¶éœ€è¦å¯¹æ³›å‹ç±»å‹è¿›è¡Œä¸€å®šçš„çº¦æŸã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¸Œæœ›æŸä¸ªæ³›å‹å‡½æ•°æˆ–ç±»å‹åªèƒ½æ¥å—ç‰¹å®šç±»å‹çš„å‚æ•°ï¼Œæˆ–è€…ç‰¹å®šç±»å‹çš„å‚æ•°å¿…é¡»å®ç°æŸä¸ªæ¥å£ã€‚åœ¨ Go ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ³›å‹çº¦æŸæ¥å®ç°è¿™äº›éœ€æ±‚ã€‚   </p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒTå°±æ˜¯è¯¥æ³›å‹å‡½æ•°çš„å‚æ•°ï¼Œanyå°±æ˜¯å‚æ•°çš„ç±»å‹ï¼Œè¾¾æ ‡ä»»æ„ç±»å‹å³å¯ã€‚   </p><p>å¯¹äºæ³›å‹ç±»å‹çš„çº¦æŸæ–¹æ³•ï¼Œå¸¸è§çš„æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š  </p><h4 id="2-2-1-å¸¸è§„ç±»å‹çº¦æŸ"><a href="#2-2-1-å¸¸è§„ç±»å‹çº¦æŸ" class="headerlink" title="2.2.1 å¸¸è§„ç±»å‹çº¦æŸ"></a>2.2.1 å¸¸è§„ç±»å‹çº¦æŸ</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Add</span>[<span class="hljs-title">T</span> <span class="hljs-title">int</span> | <span class="hljs-title">float32</span> | <span class="hljs-title">float64</span>]<span class="hljs-params">(a, b T)</span></span> T &#123;<br><span class="hljs-keyword">return</span> a + b<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“å‰è¿™ç§ç±»å‹çº¦æŸæ–¹å¼ç®€å•æ˜äº†ï¼Œä»£è¡¨å‡½æ•°å¯ä»¥æ”¯æŒintï¼Œfloat32å’Œfloat64ä¸‰ç§å‚æ•°çš„ç±»å‹ã€‚ </p><h4 id="2-2-2-ç±»å‹é›†çº¦æŸ"><a href="#2-2-2-ç±»å‹é›†çº¦æŸ" class="headerlink" title="2.2.2 ç±»å‹é›†çº¦æŸ"></a>2.2.2 ç±»å‹é›†çº¦æŸ</h4><p>ç±»å‹é›†è¡¨ç¤ºä¸€å †ç±»å‹çš„é›†åˆï¼Œç”¨æ¥åœ¨æ³›å‹å‡½æ•°çš„å£°æ˜ä¸­çº¦æŸç±»å‹å‚æ•°çš„èŒƒå›´. å¦‚æœéœ€è¦æ”¯æŒçš„ç±»å‹æ¯”è¾ƒå¤šï¼Œå¯ä»¥å†™åœ¨ç±»å‹é›†ä¸­ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// ä¸€å †ç±»å‹çš„é›†åˆï¼Œç”¨æ¥åœ¨èŒƒå‹å‡½æ•°çš„å£°æ˜ä¸­çº¦æŸç±»å‹å‚æ•°çš„èŒƒå›´</span><br><span class="hljs-keyword">type</span> numbers <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-type">int</span> | <span class="hljs-type">int32</span> | <span class="hljs-type">uint32</span> | <span class="hljs-type">int64</span> | <span class="hljs-type">uint64</span> | <span class="hljs-type">float32</span> | <span class="hljs-type">float64</span><br>&#125;<br><br><span class="hljs-comment">// çº¦æŸTå¯ä»¥ä¸ºnumberä¸­çš„ä»»ä¸€ä¸ªå…ƒç´ </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sub</span>[<span class="hljs-title">T</span> <span class="hljs-title">numbers</span>]<span class="hljs-params">(a, b T)</span></span> T &#123;<br><span class="hljs-keyword">return</span> a - b<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-3-è”åˆçº¦æŸå…ƒç´ "><a href="#2-2-3-è”åˆçº¦æŸå…ƒç´ " class="headerlink" title="2.2.3 è”åˆçº¦æŸå…ƒç´ "></a>2.2.3 è”åˆçº¦æŸå…ƒç´ </h4><p>è”åˆå…ƒç´ ï¼Œå†™æˆä¸€ç³»åˆ—ç”±ç«–çº¿ ( |) åˆ†éš”çš„çº¦æŸå…ƒç´ ã€‚ä¾‹å¦‚ï¼šint | float32æˆ–~int8 | ~int16 | ~int32 | ~int64  </p><ul><li>~int ä»£è¡¨æ‰€æœ‰intçš„è¡ç”Ÿç±»å‹ï¼Œæ¯”å¦‚è‡ªå®šä¹‰çš„åˆ«åï¼›type myInt int; myIntå°±æ˜¯ ~intç±»å‹ã€‚</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> Integer <span class="hljs-keyword">interface</span> &#123;<br>~<span class="hljs-type">int</span> | ~<span class="hljs-type">int8</span> | ~<span class="hljs-type">int16</span> | ~<span class="hljs-type">int32</span> | ~<span class="hljs-type">int64</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AddInteger</span>[<span class="hljs-title">T</span> <span class="hljs-title">Integer</span>]<span class="hljs-params">(a, b T)</span></span> T &#123;<br><span class="hljs-keyword">return</span> a + b<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-4-æ¨èå†™æ³•"><a href="#2-2-4-æ¨èå†™æ³•" class="headerlink" title="2.2.4 æ¨èå†™æ³•"></a>2.2.4 æ¨èå†™æ³•</h4><p>åœ¨ä½¿ç”¨ç±»å‹æ¨èæ—¶ï¼Œå°½é‡å°†ç±»å‹é™åˆ¶åœ¨æœ€ç®€å•çš„åŸºæœ¬ç±»å‹ä¸­ï¼Œæ¯”å¦‚åŒæ ·æ˜¯ç±»å‹Tçš„æ•°ç»„ã€‚ </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// æ¨è</span><br><span class="hljs-keyword">type</span> Student1[T <span class="hljs-type">int</span> | <span class="hljs-type">string</span>] <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>Data []T<br>&#125;<br><br><span class="hljs-keyword">type</span> Student2[T []<span class="hljs-type">int</span> | []<span class="hljs-type">string</span>] <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>Data T<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-æ³›å‹å®è·µ"><a href="#3-æ³›å‹å®è·µ" class="headerlink" title="3. æ³›å‹å®è·µ"></a>3. æ³›å‹å®è·µ</h2><p>Golang æ³›å‹å¯ä»¥åº”ç”¨äºå„ç§æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œä¾‹å¦‚æ’åºã€æœç´¢ã€æ˜ å°„ç­‰ï¼›ä¹Ÿå¯ä½¿ç”¨æ³›å‹ç±»å‹å®ç°ä¸€äº›é€šç”¨çš„æ•°æ®ç»“æ„ã€‚</p><h3 id="3-1-å·¥å…·å‡½æ•°"><a href="#3-1-å·¥å…·å‡½æ•°" class="headerlink" title="3.1 å·¥å…·å‡½æ•°"></a>3.1 å·¥å…·å‡½æ•°</h3><ul><li>æ’åº<br>åœ¨ Golang ä¸­ï¼Œä½¿ç”¨ sort åŒ…å¯ä»¥å¯¹ä»»æ„ç±»å‹çš„åˆ‡ç‰‡è¿›è¡Œæ’åºã€‚  <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sort</span>[<span class="hljs-title">T</span> <span class="hljs-title">int</span> | <span class="hljs-title">int32</span> | <span class="hljs-title">float32</span>]<span class="hljs-params">(s []T)</span></span> &#123;<br>sort.Slice(s, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> s[i] &lt; s[j]<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure></li><li>æœç´¢<br>åœ¨ Golang ä¸­ï¼Œä½¿ç”¨ search åŒ…å¯ä»¥å¯¹ä»»æ„ç±»å‹çš„åˆ‡ç‰‡è¿›è¡Œæœç´¢.   <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Search</span>[<span class="hljs-title">T</span> <span class="hljs-title">int</span> | <span class="hljs-title">int32</span> | <span class="hljs-title">int64</span>]<span class="hljs-params">(s []T, x T)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> sort.Search(<span class="hljs-built_in">len</span>(s), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> s[i] &gt;= x<br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure></li><li>æ˜ å°„<br>åœ¨ Golang ä¸­ï¼Œä½¿ç”¨ map ç±»å‹å¯ä»¥å®ç°æ˜ å°„ã€‚ä¸ºäº†æ”¯æŒæ³›å‹æ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ³›å‹å‡½æ•° Map[K comparable, V any]ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Map</span>[<span class="hljs-title">K</span> <span class="hljs-title">comparable</span>, <span class="hljs-title">V</span> <span class="hljs-title">any</span>]<span class="hljs-params">(s []K, f <span class="hljs-keyword">func</span>(K)</span></span> V) <span class="hljs-keyword">map</span>[K]V &#123;<br>result := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[K]V)<br><span class="hljs-keyword">for</span> _, k := <span class="hljs-keyword">range</span> s &#123;<br>result[k] = f(k)<br>&#125;<br><span class="hljs-keyword">return</span> result<br>&#125;  <br><br>words := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;apple&quot;</span>, <span class="hljs-string">&quot;banana&quot;</span>, <span class="hljs-string">&quot;cherry&quot;</span>, <span class="hljs-string">&quot;durian&quot;</span>, <span class="hljs-string">&quot;elderberry&quot;</span>, <span class="hljs-string">&quot;fig&quot;</span>&#125;<br>uppercased := generics.Map(words, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(word <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">return</span> strings.ToUpper(word)<br>&#125;)<br>fmt.Println(uppercased)<br></code></pre></td></tr></table></figure></li></ul><h3 id="3-2-æ•°æ®ç»“æ„"><a href="#3-2-æ•°æ®ç»“æ„" class="headerlink" title="3.2 æ•°æ®ç»“æ„"></a>3.2 æ•°æ®ç»“æ„</h3><p>ç®€å•çš„å®ç°ä¸€ä¸ªåŸºäºæ³›å‹çš„é˜Ÿåˆ—ã€‚  </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// Queue - é˜Ÿåˆ—</span><br><span class="hljs-keyword">type</span> Queue[T any] <span class="hljs-keyword">struct</span> &#123;<br>items []T<br>&#125;<br><br><span class="hljs-comment">// Put å°†æ•°æ®æ”¾å…¥é˜Ÿåˆ—å°¾éƒ¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue[T])</span></span> Put(value T) &#123;<br>q.items = <span class="hljs-built_in">append</span>(q.items, value)<br>&#125;<br><br><span class="hljs-comment">// Pop ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºå¹¶ä»å¤´éƒ¨åˆ é™¤å¯¹åº”æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue[T])</span></span> Pop() (T, <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-keyword">var</span> value T<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(q.items) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> value, <span class="hljs-literal">true</span><br>&#125;<br><br>value = q.items[<span class="hljs-number">0</span>]<br>q.items = q.items[<span class="hljs-number">1</span>:]<br><span class="hljs-keyword">return</span> value, <span class="hljs-built_in">len</span>(q.items) == <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-comment">// Size é˜Ÿåˆ—å¤§å°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q Queue[T])</span></span> Size() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(q.items)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-æ¥å£"><a href="#4-æ¥å£" class="headerlink" title="4. æ¥å£"></a>4. æ¥å£</h2><ul><li>åœ¨æ³›å‹å‡ºæ¥ä¹‹å‰ï¼Œæ¥å£çš„å®šä¹‰æ˜¯ï¼šæ¥å£æ˜¯ä¸€ä¸ªæ–¹æ³•é›†   <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> <span class="hljs-type">error</span> <span class="hljs-keyword">interface</span>&#123;<br>Error() <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>åœ¨æ³›å‹å‡ºæ¥ä¹‹åï¼Œæ¥å£çš„å®šä¹‰æ˜¯ï¼šæ¥å£æ˜¯ä¸€ä¸ªç±»å‹é›†  <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> number <span class="hljs-keyword">interface</span>&#123;<br><span class="hljs-type">int</span> | <span class="hljs-type">float32</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="4-1-å¹¶é›†ã€äº¤é›†ã€ç©ºé›†"><a href="#4-1-å¹¶é›†ã€äº¤é›†ã€ç©ºé›†" class="headerlink" title="4.1 å¹¶é›†ã€äº¤é›†ã€ç©ºé›†"></a>4.1 å¹¶é›†ã€äº¤é›†ã€ç©ºé›†</h3><ul><li>å¹¶é›†ï¼šä½¿ç”¨|è¿æ¥çš„å°±æ˜¯å¹¶é›†      <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// number æ˜¯ä¸‹åˆ—åŸºç¡€ç±»å‹çš„å¹¶é›†</span><br><span class="hljs-keyword">type</span> number <span class="hljs-keyword">interface</span>&#123;<br><span class="hljs-type">int</span> | <span class="hljs-type">int32</span> | <span class="hljs-type">uint32</span> | <span class="hljs-type">int64</span> | <span class="hljs-type">uint64</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>äº¤é›†ï¼šå¦‚æœä¸€ä¸ªæ¥å£çš„å®šä¹‰åŒ…å«å¤šè¡Œç±»å‹ï¼Œå°±å–ä»–ä»¬çš„äº¤é›†ã€‚  <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> Int <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-type">int</span> | <span class="hljs-type">int8</span> | <span class="hljs-type">int16</span> | <span class="hljs-type">int32</span> | <span class="hljs-type">int64</span> | <span class="hljs-type">uint</span> | <span class="hljs-type">uint8</span> | <span class="hljs-type">uint16</span> | <span class="hljs-type">uint32</span> | <span class="hljs-type">uint64</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Uint <span class="hljs-keyword">interface</span> &#123;<br>    <span class="hljs-type">uint</span> | <span class="hljs-type">uint8</span> | <span class="hljs-type">uint16</span> | <span class="hljs-type">uint32</span> | <span class="hljs-type">uint64</span><br>&#125;<br><br><span class="hljs-comment">// æ¥å£Statusä»£è¡¨ Intå’ŒUintçš„äº¤é›†</span><br><span class="hljs-keyword">type</span> Status <span class="hljs-keyword">interface</span> &#123;  <br>    Int<br>    Uint<br>&#125;<br></code></pre></td></tr></table></figure></li><li>ç©ºé›†ï¼šå¦‚æœå¤šè¡Œç±»å‹æ²¡æœ‰äº¤é›†ï¼Œå°±æ˜¯ç©ºé›†.    <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// ç±»å‹ ~int å’Œ ~float æ²¡æœ‰ç›¸äº¤çš„ç±»å‹ï¼Œæ‰€ä»¥æ¥å£ Bad ä»£è¡¨çš„ç±»å‹é›†ä¸ºç©º</span><br><span class="hljs-keyword">type</span> Bad <span class="hljs-keyword">interface</span> &#123;<br>    ~<span class="hljs-type">int</span><br>    ~float <br>&#125; <br></code></pre></td></tr></table></figure></li></ul><h3 id="4-2-æ¥å£ç±»å‹"><a href="#4-2-æ¥å£ç±»å‹" class="headerlink" title="4.2 æ¥å£ç±»å‹"></a>4.2 æ¥å£ç±»å‹</h3><ul><li>åŸºæœ¬æ¥å£: æ¥å£çš„å®šä¹‰ä¸­åªæœ‰æ–¹æ³•    <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// æ¥å£ä¸­åªæœ‰æ–¹æ³•ï¼Œæ‰€ä»¥æ˜¯åŸºæœ¬æ¥å£</span><br><span class="hljs-keyword">type</span> MyError <span class="hljs-keyword">interface</span> &#123; <br>    Error() <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>ä¸€èˆ¬æ¥å£: æ¥å£çš„å®šä¹‰ä¸­ä¸ä»…æœ‰æ–¹æ³•ï¼Œè¿˜æœ‰ç±»å‹    <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// æ¥å£ Uint ä¸­æœ‰ç±»å‹ï¼Œæ‰€ä»¥æ˜¯ä¸€èˆ¬æ¥å£</span><br><span class="hljs-keyword">type</span> Uint <span class="hljs-keyword">interface</span> &#123; <br>    ~<span class="hljs-type">uint</span> | ~<span class="hljs-type">uint8</span> | ~<span class="hljs-type">uint16</span> | ~<span class="hljs-type">uint32</span> | ~<span class="hljs-type">uint64</span><br>&#125;<br><br><span class="hljs-comment">// ReadWriter æ¥å£æ—¢æœ‰æ–¹æ³•ä¹Ÿæœ‰ç±»å‹ï¼Œæ‰€ä»¥æ˜¯ä¸€èˆ¬æ¥å£</span><br><span class="hljs-keyword">type</span> ReadWriter <span class="hljs-keyword">interface</span> &#123;  <br>    ~<span class="hljs-type">string</span> | ~[]<span class="hljs-type">rune</span><br><br>    Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>)<br>    Write(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-comment">// ä¸€èˆ¬æ¥å£ç±»å‹ä¸èƒ½ç”¨æ¥å®šä¹‰å˜é‡ï¼Œåªèƒ½ç”¨äºæ³›å‹çš„ç±»å‹çº¦æŸä¸­  </span><br><br><span class="hljs-comment">// é”™è¯¯ã€‚Uintæ˜¯ä¸€èˆ¬æ¥å£ï¼Œåªèƒ½ç”¨äºç±»å‹çº¦æŸï¼Œä¸å¾—ç”¨äºå˜é‡å®šä¹‰</span><br><span class="hljs-keyword">var</span> uintInf Uint   <br></code></pre></td></tr></table></figure></li><li>å¦‚ä½•å®ç°ä¸€èˆ¬æ¥å£ï¼Ÿ <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// å…ˆå®šä¹‰ä¸€ä¸ªå…·ä½“çš„ç±»å‹ï¼Œç„¶åå†å®ç°å…·ä½“çš„æ–¹æ³• </span><br><br><span class="hljs-comment">// StringReadWriter å®ç°äº†æ¥å£ ReadWriter</span><br><span class="hljs-keyword">type</span> StringReadWriter <span class="hljs-type">string</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s StringReadWriter)</span></span> Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s StringReadWriter)</span></span> Write(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="5-å‚è€ƒèµ„æ–™"><a href="#5-å‚è€ƒèµ„æ–™" class="headerlink" title="5. å‚è€ƒèµ„æ–™"></a>5. å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.kunkkawu.com/archives/shen-ru-li-jie-golang-de-fan-xing">https://www.kunkkawu.com/archives/shen-ru-li-jie-golang-de-fan-xing</a>  </li><li><a href="https://juejin.cn/post/7229462763947917367">https://juejin.cn/post/7229462763947917367</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>æ³›å‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDBå¤åˆç´¢å¼•çš„ESRåŸåˆ™</title>
    <link href="/2024/02/21/MongoDB%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84ESR%E5%8E%9F%E5%88%99/"/>
    <url>/2024/02/21/MongoDB%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84ESR%E5%8E%9F%E5%88%99/</url>
    
    <content type="html"><![CDATA[<p>æåˆ°ç´¢å¼•ï¼Œå¤§å®¶éƒ½ä¸ä¼šé™Œç”Ÿï¼Œå®ƒçš„é‡è¦æ€§åœ¨æ•°æ®åº“ä¸­ä¸è¨€è€Œå–»ã€‚å¸¸è§çš„å­˜å‚¨å¦‚MysQLï¼ŒMongoDBéƒ½æ”¯æŒå¤šç§ç±»å‹çš„ç´¢å¼•ã€‚æœ¬æ–‡ä¸»è¦ä»¥å®é™…å·¥ä½œä¸­ç¢°åˆ°çš„ä¾‹å­èŠä¸€ä¸‹MongoDBä¸­çš„å¤åˆç´¢å¼•ã€‚</p><span id="more"></span>  <p>æ‰€è°“å¤åˆç´¢å¼•ï¼Œå°±æ˜¯åŒ…å«å¤šä¸ªå­—æ®µçš„ç´¢å¼•ï¼Œæ¯”å¦‚index(a,b)ã€‚å¤åˆç´¢å¼•åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¸»è¦æœ‰ä¸¤ä¸ªåŸåˆ™ï¼š </p><ul><li>æœ€å·¦åŒ¹é…åŸåˆ™ </li><li>ESRåŸåˆ™</li></ul><h3 id="1-æœ€å·¦åŒ¹é…åŸåˆ™"><a href="#1-æœ€å·¦åŒ¹é…åŸåˆ™" class="headerlink" title="1. æœ€å·¦åŒ¹é…åŸåˆ™"></a>1. æœ€å·¦åŒ¹é…åŸåˆ™</h3><p>æœ€å·¦åŒ¹é…åŸåˆ™æ¯”è¾ƒå¥½ç†è§£ï¼Œä»–å’ŒMySQLä¸­çš„æœ€å·¦åŒ¹é…åŸåˆ™ä¸€è‡´ï¼Œå³æœ€å·¦ä¼˜å…ˆï¼šåœ¨æ£€ç´¢æ•°æ®æ—¶ä»å¤åˆç´¢å¼•çš„æœ€å·¦è¾¹å¼€å§‹åŒ¹é…ã€‚</p><p>å¤åˆç´¢å¼•åˆ›å»ºæ—¶ä¸€ä¸ªåŸºæœ¬çš„åŸåˆ™å°±æ˜¯ï¼šå°†é€‰æ‹©æ€§æœ€å¼ºçš„åˆ—æ”¾åˆ°æœ€å‰é¢ã€‚</p><p>é€‰æ‹©æ€§æœ€é«˜æŒ‡çš„æ˜¯æ•°æ®çš„é‡å¤å€¼æœ€å°‘ï¼Œå› ä¸ºåŒºåˆ†åº¦é«˜çš„åˆ—èƒ½å¤Ÿå¾ˆå®¹æ˜“è¿‡æ»¤æ‰å¾ˆå¤šçš„æ•°æ®ã€‚å¦‚æœç»„åˆç´¢å¼•ä¸­ç¬¬ä¸€æ¬¡èƒ½å¤Ÿè¿‡æ»¤æ‰å¾ˆå¤šçš„æ•°æ®ï¼Œåé¢çš„ç´¢å¼•æŸ¥è¯¢çš„æ•°æ®èŒƒå›´å°±å°äº†å¾ˆå¤šäº†ã€‚</p><h3 id="2-ESRåŸåˆ™"><a href="#2-ESRåŸåˆ™" class="headerlink" title="2. ESRåŸåˆ™"></a>2. ESRåŸåˆ™</h3><p><a href="https://www.mongodb.com/docs/manual/tutorial/equality-sort-range-rule/">The ESR (Equality, Sort, Range) Rules</a> </p><p>ç®€å•æ¥è¯´å°±æ˜¯æˆ‘ä»¬åœ¨æ„å»ºå¤åˆç´¢å¼•æ—¶ï¼Œéœ€è¦æ ¹æ®ä»¥ä¸‹ä¸‰é¡¹åŸåˆ™çš„é¡ºåºè¿›è¡Œæ„å»ºï¼š  </p><ul><li>ç­‰å€¼æŸ¥è¯¢å­—æ®µæ”¾åœ¨æœ€å‰é¢</li><li>ä¸­é—´æ”¾æ’åºå­—æ®µ</li><li>æœ€åæ˜¯èŒƒå›´æŸ¥è¯¢å­—æ®µ</li></ul><p>E æ”¾åœ¨å‰é¢æ¯”è¾ƒå¥½ç†è§£ï¼Œç­‰å€¼åŒ¹é…è¿‡æ»¤æ‰å¤§é‡æ•°æ®ï¼Œã€Œé‚£ä¸ºä»€ä¹ˆæ˜¯ ESR ä¸æ˜¯ ERS å‘¢?ã€<br><img src="/img/MongoDB%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84ESR%E5%8E%9F%E5%88%99/1.png"><br>å¦‚å›¾æ‰€ç¤ºï¼Œå¦‚æœæŠŠèŒƒå›´åŒ¹é…æ”¾åœ¨ä¸­é—´ï¼Œé‚£ä¹ˆåç»­æˆ‘ä»¬æ’åºçš„æ—¶å€™åªèƒ½è¿›è¡Œã€Œå†…å­˜æ’åºã€ï¼Œå†…å­˜æ’åºæ˜¯æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„ï¼Œæ•°æ®é‡å¤§æ—¶å¯èƒ½ä¼šé¢ä¸´ç€ã€Œå¤šæ¬¡çš„ç£ç›˜è¯»å–åˆ·å†…å­˜æ“ä½œã€ï¼Œå¯¹æ€§èƒ½å½±å“æ¯”è¾ƒæ˜¾è‘—ã€‚</p><h3 id="3-å®é™…æ¡ˆä¾‹åˆ†æ"><a href="#3-å®é™…æ¡ˆä¾‹åˆ†æ" class="headerlink" title="3. å®é™…æ¡ˆä¾‹åˆ†æ"></a>3. å®é™…æ¡ˆä¾‹åˆ†æ</h3><p>ä»¥ä¸Šä¸¤ä¸ªåŸåˆ™çœ‹èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†ç¬”è€…åœ¨å®é™…åº”ç”¨ä¸­è¿˜æ˜¯è¸©äº†ä¸€äº›å‘ã€‚</p><p>æˆ‘æœ‰ä¸€ä¸ªè¿™æ ·çš„mongoé›†åˆï¼š </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Demo <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// QueueID é˜Ÿåˆ—id</span><br>QueueID <span class="hljs-type">string</span> <span class="hljs-string">`bson:&quot;queue_id,omitempty&quot;`</span><br><br><span class="hljs-comment">// Status ä»»åŠ¡çŠ¶æ€</span><br>Status <span class="hljs-type">int</span> <span class="hljs-string">`bson:&quot;status,omitempty&quot;`</span><br><br><span class="hljs-comment">// UpdateTime æ›´æ–°æ—¶é—´</span><br>UpdateTime time.Time <span class="hljs-string">`bson:&quot;update_time,omitempty&quot;`</span><br><br><span class="hljs-comment">// å…¶ä»–å­—æ®µ</span><br>xxxxx<br><br>&#125; <br></code></pre></td></tr></table></figure><p>mongoåœ¨æŸ¥è¯¢æ—¶éœ€è¦æ‰§è¡Œç±»ä¼¼å¦‚ä¸‹æ¡ä»¶çš„æŸ¥è¯¢ï¼š</p><pre><code class="go">db.collections.find(&#123; queue_id: 123, status: &#123; $in: [1, 2, 3] &#125; &#125;).sort(&#123; updateTime: 1 &#125;).limit(1)</code></pre><p>å³ï¼šæŸ¥è¯¢æŒ‡å®šqueue_id, æŒ‡å®šstatusèŒƒå›´ï¼Œå¹¶æŒ‰ç…§updateTimeè¿›è¡Œå‡åºçš„ä¸€æ¡è®°å½•ã€‚   </p><p>åœ¨åˆæ­¥äº†è§£ESRåŸåˆ™åï¼Œæˆ‘ä¸€æƒ³ï¼Œè¿™ä¸å°±æ˜¯queue_idä¸ºç­‰å€¼æŸ¥è¯¢ã€updateTimeä¸ºæ’åºæŸ¥è¯¢ã€statusä¸ºèŒƒå›´æŸ¥è¯¢çš„ç»å…¸æƒ…å†µå—ï¼Œå¤§æ‰‹ä¸€æŒ¥å°±åˆ›å»ºäº†ä¸€ä¸ªï¼ˆqueue_id, updateTime, statusï¼‰çš„å¤åˆç´¢å¼•å¹¶æ„‰å¿«çš„ä¸Šçº¿äº†ã€‚</p><p>ç„¶è€Œå¾…æ•°æ®é‡å¢å¤§åï¼Œå‘ç°ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼ŒMongoå®ä¾‹çš„CPUé£™åˆ°äº†60%ï¼Œæ’æŸ¥åŸå› å‘ç°ç´¢å¼•æ‰§è¡Œä¸å¤ªæ­£å¸¸ã€‚</p><p>å‚è€ƒå®˜æ–¹èµ„æ–™åï¼Œå‘ç°inåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½æ˜¯ç­‰å€¼æŸ¥è¯¢ä¹Ÿå¯èƒ½æ˜¯èŒƒå›´æŸ¥è¯¢<br><img src="/img/MongoDB%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84ESR%E5%8E%9F%E5%88%99/2.png">    </p><ul><li>å¦‚æœinå•ç‹¬ä½¿ç”¨ï¼Œå°±æ˜¯ç­‰å€¼æŸ¥è¯¢</li><li>å¦‚æœinå’Œsortä¸€èµ·ä½¿ç”¨ï¼Œå°±æ˜¯èŒƒå›´æŸ¥è¯¢ï¼ˆé’ˆå¯¹åŒä¸€ä¸ªå­—æ®µï¼‰</li></ul><p>æ‰€ä»¥åœ¨æœ¬ä¾‹ä¸­ï¼Œstatusçš„ä½¿ç”¨æ˜¯ç­‰å€¼æŸ¥è¯¢ï¼Œåº”è¯¥æ”¾åœ¨updateTimeçš„å‰é¢ï¼Œå°†ç´¢å¼•ä¿®æ”¹ä¸ºï¼ˆqueue_id, status, updateTimeï¼‰åï¼ŒCPUä½¿ç”¨ç‡å³åˆ»ä¸‹é™åˆ°30%å·¦å³ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>MongoDB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MongoDB</tag>
      
      <tag>ç´¢å¼•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafkaé«˜æ€§èƒ½åˆ†æ</title>
    <link href="/2024/02/17/kafka%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    <url>/2024/02/17/kafka%E9%AB%98%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kafka</tag>
      
      <tag>é«˜å¯ç”¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kafkaé«˜å¯ç”¨åˆ†æ</title>
    <link href="/2024/02/17/kafka%E9%AB%98%E5%8F%AF%E7%94%A8%E5%88%86%E6%9E%90/"/>
    <url>/2024/02/17/kafka%E9%AB%98%E5%8F%AF%E7%94%A8%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>Kafka</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kafka</tag>
      
      <tag>é«˜å¯ç”¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangé™æµå™¨</title>
    <link href="/2024/01/07/Golang%E9%99%90%E6%B5%81/"/>
    <url>/2024/01/07/Golang%E9%99%90%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<p>åœ¨é«˜å¹¶å‘ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œä¿æŠ¤ç³»ç»Ÿæ—¶ï¼Œå¸¸ç”¨çš„â€ä¸‰æ¿æ–§â€æœ‰ï¼šâ€ç†”æ–­ã€é™çº§å’Œé™æµâ€ã€‚æœ¬æ–‡ä¸»è¦è®°å½•golangä¸­å¸¸ç”¨çš„é™æµç®—æ³•çš„å®ç°æ–¹å¼ã€‚è¿™é‡Œæ‰€è¯´çš„é™æµå¹¶éæ˜¯ç½‘å…³å±‚é¢æˆ–è€…æœåŠ¡è°ƒåº¦ä¹‹é—´çš„é™æµï¼Œè€Œæ˜¯ä¸šåŠ¡ä»£ç ä¸­çš„é€»è¾‘é™æµã€‚</p><span id="more"></span>   <p>é™æµç®—æ³•å¸¸ç”¨çš„å‡ ç§å®ç°æ–¹å¼æœ‰å¦‚ä¸‹å››ç§ï¼š</p><ul><li>è®¡æ•°å™¨</li><li>æ»‘åŠ¨çª—å£</li><li>æ¼æ¡¶</li><li>ä»¤ç‰Œæ¡¶</li></ul><h2 id="1-è®¡æ•°å™¨"><a href="#1-è®¡æ•°å™¨" class="headerlink" title="1. è®¡æ•°å™¨"></a>1. è®¡æ•°å™¨</h2><h3 id="1-1-åŸç†"><a href="#1-1-åŸç†" class="headerlink" title="1.1 åŸç†"></a>1.1 åŸç†</h3><p>è®¡æ•°å™¨æ˜¯ä¸€ç§æœ€ç®€å•é™æµç®—æ³•ï¼Œå…¶åŸç†å°±æ˜¯ï¼š<strong>åœ¨ä¸€æ®µæ—¶é—´é—´éš”å†…ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¡æ•°ï¼Œä¸é˜€å€¼è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­æ˜¯å¦éœ€è¦é™æµï¼Œä¸€æ—¦åˆ°äº†æ—¶é—´ä¸´ç•Œç‚¹ï¼Œå°†è®¡æ•°å™¨æ¸…é›¶ã€‚</strong></p><ul><li>å¯ä»¥åœ¨ç¨‹åºä¸­è®¾ç½®ä¸€ä¸ªå˜é‡ countï¼Œå½“è¿‡æ¥ä¸€ä¸ªè¯·æ±‚æˆ‘å°±å°†è¿™ä¸ªæ•° +1ï¼ŒåŒæ—¶è®°å½•è¯·æ±‚æ—¶é—´ã€‚</li><li>å½“ä¸‹ä¸€ä¸ªè¯·æ±‚æ¥çš„æ—¶å€™åˆ¤æ–­ count çš„è®¡æ•°å€¼æ˜¯å¦è¶…è¿‡è®¾å®šçš„é¢‘æ¬¡ï¼Œä»¥åŠå½“å‰è¯·æ±‚çš„æ—¶é—´å’Œç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶é—´æ˜¯å¦åœ¨ 1 åˆ†é’Ÿå†…ã€‚</li><li>å¦‚æœåœ¨ 1 åˆ†é’Ÿå†…å¹¶ä¸”è¶…è¿‡è®¾å®šçš„é¢‘æ¬¡åˆ™è¯æ˜è¯·æ±‚è¿‡å¤šï¼Œåé¢çš„è¯·æ±‚å°±æ‹’ç»æ‰ã€‚</li><li>å¦‚æœè¯¥è¯·æ±‚ä¸ç¬¬ä¸€ä¸ªè¯·æ±‚çš„é—´éš”æ—¶é—´å¤§äºè®¡æ•°å‘¨æœŸï¼Œä¸” count å€¼è¿˜åœ¨é™æµèŒƒå›´å†…ï¼Œå°±é‡ç½® countã€‚</li></ul><p><img src="/img/Golang%E9%99%90%E6%B5%81/1.png"> </p><h3 id="1-2-ç¼ºç‚¹"><a href="#1-2-ç¼ºç‚¹" class="headerlink" title="1.2 ç¼ºç‚¹"></a>1.2 ç¼ºç‚¹</h3><p>è®¡æ•°å™¨ç®—æ³•å­˜åœ¨â€œæ—¶é—´ä¸´ç•Œç‚¹â€ç¼ºé™·ã€‚æ¯”å¦‚æ¯ä¸€åˆ†é’Ÿé™åˆ¶200ä¸ªè¯·æ±‚ï¼Œå¯ä»¥åœ¨00:00:00-00:00:58ç§’é‡Œé¢éƒ½æ²¡æœ‰è¯·æ±‚ï¼Œåœ¨00:00:59ç¬é—´å‘é€200ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªå¯¹äºè®¡æ•°å™¨ç®—æ³•æ¥æ˜¯å…è®¸çš„ï¼Œç„¶ååœ¨00:01:00å†æ¬¡å‘é€200ä¸ªè¯·æ±‚ï¼Œæ„å‘³ç€åœ¨çŸ­çŸ­1så†…å‘é€äº†400ä¸ªè¯·æ±‚ï¼Œå¦‚æœé‡æ›´å¤§å‘¢ï¼Œç³»ç»Ÿå¯èƒ½ä¼šæ‰¿å—ä¸ä½ç¬é—´æµé‡ï¼Œå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚<br><img src="/img/Golang%E9%99%90%E6%B5%81/2.png"></p><h2 id="2-æ»‘åŠ¨çª—å£"><a href="#2-æ»‘åŠ¨çª—å£" class="headerlink" title="2. æ»‘åŠ¨çª—å£"></a>2. æ»‘åŠ¨çª—å£</h2><h3 id="2-1-åŸç†"><a href="#2-1-åŸç†" class="headerlink" title="2.1 åŸç†"></a>2.1 åŸç†</h3><p>æ»‘åŠ¨çª—å£ç®—æ³•å°†ä¸€ä¸ªå¤§çš„æ—¶é—´çª—å£åˆ†æˆå¤šä¸ªå°çª—å£ï¼Œæ¯æ¬¡å¤§çª—å£å‘åæ»‘åŠ¨ä¸€ä¸ªå°çª—å£ï¼Œå¹¶ä¿è¯å¤§çš„çª—å£å†…æµé‡ä¸ä¼šè¶…å‡ºæœ€å¤§å€¼ï¼Œè¿™ç§å®ç°æ¯”å›ºå®šçª—å£çš„æµé‡æ›²çº¿æ›´åŠ å¹³æ»‘ã€‚</p><p>æ™®é€šæ—¶é—´çª—å£æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚çª—å£æœŸå†…è¯·æ±‚çš„ä¸Šé™æ˜¯200ï¼Œå‡è®¾æœ‰200ä¸ªè¯·æ±‚é›†ä¸­åœ¨å‰1sçš„å100msï¼Œ200ä¸ªè¯·æ±‚é›†ä¸­åœ¨å1sçš„å‰100msï¼Œå…¶å®åœ¨è¿™200mså†…å°±å·²ç»è¯·æ±‚è¶…é™äº†ï¼Œä½†æ˜¯ç”±äºæ—¶é—´çª—æ¯ç»è¿‡1så°±ä¼šé‡ç½®è®¡æ•°ï¼Œå°±æ— æ³•è¯†åˆ«åˆ°è¿™ç§è¯·æ±‚è¶…é™ã€‚</p><p><img src="/img/Golang%E9%99%90%E6%B5%81/3.png"><br>å¯¹äºæ»‘åŠ¨æ—¶é—´çª—å£ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ1msçš„æ—¶é—´çª—å£åˆ’åˆ†æˆä¸€äº›å°çª—å£ï¼Œä¸Šå›¾ä¸­æˆ‘ä»¬ç”¨çº¢è‰²çš„è™šçº¿ä»£è¡¨ä¸€ä¸ªæ—¶é—´çª—å£ï¼ˆä¸€åˆ†é’Ÿï¼‰ï¼Œæ¯ä¸ªæ—¶é—´çª—å£æœ‰ 6 ä¸ªæ ¼å­ï¼Œæ¯ä¸ªæ ¼å­æ˜¯ 10 ç§’é’Ÿã€‚æ¯è¿‡ 10 ç§’é’Ÿæ—¶é—´çª—å£å‘å³ç§»åŠ¨ä¸€æ ¼ï¼Œå¯ä»¥çœ‹çº¢è‰²ç®­å¤´çš„æ–¹å‘ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ªæ ¼å­éƒ½è®¾ç½®ä¸€ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ Counterï¼Œå‡å¦‚ä¸€ä¸ªè¯·æ±‚åœ¨ 0:45 è®¿é—®äº†é‚£ä¹ˆæˆ‘ä»¬å°†ç¬¬äº”ä¸ªæ ¼å­çš„è®¡æ•°å™¨ +1ï¼ˆä¹Ÿæ˜¯å°±æ˜¯ 0:40~0:50ï¼‰ï¼Œåœ¨åˆ¤æ–­é™æµçš„æ—¶å€™éœ€è¦æŠŠæ‰€æœ‰æ ¼å­çš„è®¡æ•°åŠ èµ·æ¥å’Œè®¾å®šçš„é¢‘æ¬¡è¿›è¡Œæ¯”è¾ƒå³å¯ã€‚   </p><p>å½“ç”¨æˆ·åœ¨0:59 ç§’é’Ÿå‘é€äº† 200 ä¸ªè¯·æ±‚å°±ä¼šè¢«ç¬¬å…­ä¸ªæ ¼å­çš„è®¡æ•°å™¨è®°å½• +200ï¼Œå½“ä¸‹ä¸€ç§’çš„æ—¶å€™æ—¶é—´çª—å£å‘å³ç§»åŠ¨äº†ä¸€ä¸ªï¼Œæ­¤æ—¶è®¡æ•°å™¨å·²ç»è®°å½•äº†è¯¥ç”¨æˆ·å‘é€çš„ 200 ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥å†å‘é€çš„è¯å°±ä¼šè§¦å‘é™æµï¼Œåˆ™æ‹’ç»æ–°çš„è¯·æ±‚ã€‚ </p><h3 id="2-2-ç¼ºç‚¹"><a href="#2-2-ç¼ºç‚¹" class="headerlink" title="2.2 ç¼ºç‚¹"></a>2.2 ç¼ºç‚¹</h3><p>æ»‘åŠ¨çª—å£ç®—æ³•æ˜¯è®¡æ•°å™¨ç®—æ³•çš„ä¸€ç§æ”¹è¿›[è®¡æ•°å™¨å°±æ˜¯åªæœ‰ä¸€ä¸ªæ ¼å­çš„æ»‘åŠ¨çª—å£]ï¼Œä½†ä»æ ¹æœ¬ä¸Šå¹¶æ²¡æœ‰çœŸæ­£è§£å†³å›ºå®šçª—å£ç®—æ³•çš„ä¸´ç•Œçªå‘æµé‡é—®é¢˜ã€‚æƒ³è®©é™æµåšçš„æ›´ç²¾ç¡®åªèƒ½åˆ’åˆ†æ›´å¤šçš„æ ¼å­ã€‚</p><h2 id="3-æ¼æ¡¶ç®—æ³•"><a href="#3-æ¼æ¡¶ç®—æ³•" class="headerlink" title="3. æ¼æ¡¶ç®—æ³•"></a>3. æ¼æ¡¶ç®—æ³•</h2><h3 id="3-1-åŸç†"><a href="#3-1-åŸç†" class="headerlink" title="3.1 åŸç†"></a>3.1 åŸç†</h3><p>æ¼æ¡¶ç®—æ³•æ˜¯é¦–å…ˆæƒ³è±¡æœ‰ä¸€ä¸ªæœ¨æ¡¶ï¼Œæ¡¶çš„å®¹é‡æ˜¯å›ºå®šçš„ã€‚å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶å…ˆæ”¾åˆ°æœ¨æ¡¶ä¸­ï¼Œå¤„ç†è¯·æ±‚çš„workerä»¥å›ºå®šçš„é€Ÿåº¦ä»æœ¨æ¡¶ä¸­å–å‡ºè¯·æ±‚è¿›è¡Œç›¸åº”ã€‚å¦‚æœæœ¨æ¡¶å·²ç»æ»¡äº†ï¼Œç›´æ¥è¿”å›è¯·æ±‚é¢‘ç‡è¶…é™çš„é”™è¯¯ç æˆ–è€…é¡µé¢ã€‚   </p><p>æ¼æ¡¶ç®—æ³•æ˜¯æµé‡æœ€å‡åŒ€çš„é™æµå®ç°æ–¹å¼ï¼Œä¸€èˆ¬ç”¨äºæµé‡â€œæ•´å½¢â€ã€‚ä¾‹å¦‚ä¿æŠ¤æ•°æ®åº“çš„é™æµï¼Œå…ˆæŠŠå¯¹æ•°æ®åº“çš„è®¿é—®åŠ å…¥åˆ°æœ¨æ¡¶ä¸­ï¼Œworkerå†ä»¥dbèƒ½å¤Ÿæ‰¿å—çš„qpsä»æœ¨æ¡¶ä¸­å–å‡ºè¯·æ±‚ï¼Œå»è®¿é—®æ•°æ®åº“ã€‚<br><img src="/img/Golang%E9%99%90%E6%B5%81/4.png">    </p><h3 id="3-2-ç¼ºç‚¹"><a href="#3-2-ç¼ºç‚¹" class="headerlink" title="3.2 ç¼ºç‚¹"></a>3.2 ç¼ºç‚¹</h3><p>æœ¨æ¡¶æµå…¥è¯·æ±‚çš„é€Ÿç‡æ˜¯ä¸å›ºå®šçš„ï¼Œä½†æ˜¯æµå‡ºçš„é€Ÿç‡æ˜¯æ’å®šçš„ã€‚è¿™æ ·çš„è¯èƒ½ä¿æŠ¤ç³»ç»Ÿèµ„æºä¸è¢«æ‰“æ»¡ï¼Œä½†æ˜¯é¢å¯¹çªå‘æµé‡æ—¶ä¼šæœ‰å¤§é‡è¯·æ±‚å¤±è´¥ï¼Œä¸é€‚åˆç”µå•†æŠ¢è´­å’Œå¾®åšå‡ºç°çƒ­ç‚¹äº‹ä»¶ç­‰åœºæ™¯çš„é™æµã€‚  </p><h2 id="4-ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#4-ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="4. ä»¤ç‰Œæ¡¶ç®—æ³•"></a>4. ä»¤ç‰Œæ¡¶ç®—æ³•</h2><h3 id="4-1-åŸç†"><a href="#4-1-åŸç†" class="headerlink" title="4.1 åŸç†"></a>4.1 åŸç†</h3><p>ä»¤ç‰Œæ¡¶æ˜¯åå‘çš„â€æ¼æ¡¶â€ï¼Œå®ƒæ˜¯ä»¥æ’å®šçš„é€Ÿåº¦å¾€æœ¨æ¡¶é‡ŒåŠ å…¥ä»¤ç‰Œï¼Œæœ¨æ¡¶æ»¡äº†åˆ™ä¸å†åŠ å…¥ä»¤ç‰Œã€‚æœåŠ¡æ”¶åˆ°è¯·æ±‚æ—¶å°è¯•ä»æœ¨æ¡¶ä¸­å–å‡ºä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœèƒ½å¤Ÿå¾—åˆ°ä»¤ç‰Œåˆ™ç»§ç»­æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœæ²¡æœ‰å¾—åˆ°ä»¤ç‰Œï¼Œç›´æ¥è¿”å›è®¿é—®é¢‘ç‡è¶…é™çš„é”™è¯¯ç æˆ–é¡µé¢ç­‰ï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>ç‰¹ç‚¹ï¼šç”±äºæœ¨æ¡¶å†…åªè¦æœ‰ä»¤ç‰Œï¼Œè¯·æ±‚å°±å¯ä»¥è¢«å¤„ç†ï¼Œæ‰€ä»¥ä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥æ”¯æŒçªå‘æµé‡<br><img src="/img/Golang%E9%99%90%E6%B5%81/0.png">      </p><p>åŒæ—¶ç”±äºå¾€æœ¨æ¡¶æ·»åŠ ä»¤ç‰Œçš„é€Ÿåº¦æ˜¯æ’å®šçš„ï¼Œä¸”æœ¨æ¡¶çš„å®¹é‡æœ‰ä¸Šé™ï¼Œæ‰€ä»¥å•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚ä¹¦ä¹Ÿèƒ½å¤Ÿå¾—åˆ°æ§åˆ¶ï¼Œèµ·åˆ°é™æµçš„ç›®çš„ã€‚å‡è®¾åŠ å…¥ä»¤ç‰Œçš„é€Ÿåº¦ä¸º 1 token&#x2F;10msï¼Œæ¡¶çš„å®¹é‡ä¸º500ï¼Œåœ¨è¯·æ±‚æ¯”è¾ƒçš„å°‘çš„æ—¶å€™ï¼ˆå°äºæ¯10æ¯«ç§’1ä¸ªè¯·æ±‚ï¼‰æ—¶ï¼Œæœ¨æ¡¶å¯ä»¥å…ˆâ€æ”’â€ä¸€äº›ä»¤ç‰Œï¼ˆæœ€å¤š500ä¸ªï¼‰ã€‚å½“æœ‰çªå‘æµé‡æ—¶ï¼Œä¸€ä¸‹æŠŠæœ¨æ¡¶å†…çš„ä»¤ç‰Œå–ç©ºï¼Œä¹Ÿå°±æ˜¯æœ‰500ä¸ªåœ¨å¹¶å‘æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹‹åè¦ç­‰æ¯10msè¡¥å……ä¸€ä¸ªæ–°çš„ä»¤ç‰Œæ‰èƒ½æ¥æ”¶ä¸€ä¸ªæ–°çš„è¯·æ±‚ã€‚</p><h3 id="4-2-é€‚ç”¨åœºæ™¯"><a href="#4-2-é€‚ç”¨åœºæ™¯" class="headerlink" title="4.2 é€‚ç”¨åœºæ™¯"></a>4.2 é€‚ç”¨åœºæ™¯</h3><p>é€‚åˆç”µå•†æŠ¢è´­æˆ–è€…å¾®åšå‡ºç°çƒ­ç‚¹äº‹ä»¶è¿™ç§åœºæ™¯ï¼Œå› ä¸ºåœ¨é™æµçš„åŒæ—¶å¯ä»¥åº”å¯¹ä¸€å®šçš„çªå‘æµé‡ã€‚å¦‚æœé‡‡ç”¨æ¼æ¡¶é‚£æ ·çš„å‡åŒ€é€Ÿåº¦å¤„ç†è¯·æ±‚çš„ç®—æ³•ï¼Œåœ¨å‘ç”Ÿçƒ­ç‚¹æ—¶é—´çš„æ—¶å€™ï¼Œä¼šé€ æˆå¤§é‡çš„ç”¨æˆ·æ— æ³•è®¿é—®ï¼Œå¯¹ç”¨æˆ·ä½“éªŒçš„æŸå®³æ¯”è¾ƒå¤§ã€‚ </p><h3 id="4-3-å®ç°"><a href="#4-3-å®ç°" class="headerlink" title="4.3 å®ç°"></a>4.3 å®ç°</h3><p>golangå®˜æ–¹å®ç°äº†ä»¤ç‰Œæ¡¶é™æµæ–¹æ³•<code>Limiter</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Limiter <span class="hljs-keyword">struct</span> &#123;<br>mu     sync.Mutex<br>limit  Limit<br>burst  <span class="hljs-type">int</span> <span class="hljs-comment">// ä»¤ç‰Œæ¡¶çš„å¤§å°</span><br>tokens <span class="hljs-type">float64</span><br>last time.Time <span class="hljs-comment">// ä¸Šæ¬¡æ›´æ–°tokensçš„æ—¶é—´</span><br>lastEvent time.Time <span class="hljs-comment">// ä¸Šæ¬¡å‘ç”Ÿé™é€Ÿå™¨äº‹ä»¶çš„æ—¶é—´ï¼ˆé€šè¿‡æˆ–è€…é™åˆ¶éƒ½æ˜¯é™é€Ÿå™¨äº‹ä»¶ï¼‰</span><br>&#125; <br></code></pre></td></tr></table></figure><p>å…¶ä¸»è¦å­—æ®µçš„ä½œç”¨æ˜¯ï¼š  </p><ul><li>limitï¼šlimitå­—æ®µè¡¨ç¤ºå¾€æ¡¶é‡Œæ”¾Tokençš„é€Ÿç‡ï¼Œå®ƒçš„ç±»å‹æ˜¯Limitï¼Œæ˜¯int64çš„ç±»å‹åˆ«åã€‚è®¾ç½®limitæ—¶æ—¢å¯ä»¥ç”¨æ•°å­—æŒ‡å®šæ¯ç§’å‘æ¡¶ä¸­æ”¾å¤šå°‘ä¸ªTokenï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå‘æ¡¶ä¸­æ”¾Tokençš„æ—¶é—´é—´éš”ï¼Œå…¶å®æŒ‡å®šäº†æ¯ç§’æ”¾Tokençš„ä¸ªæ•°åå°±èƒ½è®¡ç®—å‡ºæ”¾æ¯ä¸ªTokençš„æ—¶é—´é—´éš”äº†ã€‚</li><li>burst: ä»¤ç‰Œæ¡¶çš„å¤§å°ã€‚</li><li>tokens: æ¡¶ä¸­çš„ä»¤ç‰Œã€‚</li><li>last: ä¸Šæ¬¡å¾€æ¡¶ä¸­æ”¾ Token çš„æ—¶é—´ã€‚</li><li>lastEventï¼šä¸Šæ¬¡å‘ç”Ÿé™é€Ÿå™¨äº‹ä»¶çš„æ—¶é—´ï¼ˆé€šè¿‡æˆ–è€…é™åˆ¶éƒ½æ˜¯é™é€Ÿå™¨äº‹ä»¶ï¼‰</li></ul><h4 id="4-3-1-æ„é€ é™æµå™¨"><a href="#4-3-1-æ„é€ é™æµå™¨" class="headerlink" title="4.3.1 æ„é€ é™æµå™¨"></a>4.3.1 æ„é€ é™æµå™¨</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">limiter := rate.NewLimiter(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ r Limitï¼Œè®¾ç½®çš„æ˜¯é™æµå™¨Limiterçš„limitå­—æ®µï¼Œä»£è¡¨æ¯ç§’å¯ä»¥å‘ Token æ¡¶ä¸­äº§ç”Ÿå¤šå°‘ tokenã€‚Limit å®é™…ä¸Šæ˜¯ float64 çš„åˆ«åã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ b intï¼Œb ä»£è¡¨ Token æ¡¶çš„å®¹é‡å¤§å°ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®çš„é™æµå™¨ Limiter çš„burstå­—æ®µã€‚</li></ul><p>é‚£ä¹ˆï¼Œå¯¹äºä»¥ä¸Šä¾‹å­æ¥è¯´ï¼Œå…¶æ„é€ å‡ºçš„é™æµå™¨çš„ä»¤ç‰Œæ¡¶å¤§å°ä¸º 100, ä»¥æ¯ç§’ 10 ä¸ª Token çš„é€Ÿç‡å‘æ¡¶ä¸­æ”¾ç½® Tokenã€‚</p><h4 id="4-3-2-ä½¿ç”¨é™æµå™¨"><a href="#4-3-2-ä½¿ç”¨é™æµå™¨" class="headerlink" title="4.3.2 ä½¿ç”¨é™æµå™¨"></a>4.3.2 ä½¿ç”¨é™æµå™¨</h4><p>Limiter æä¾›äº†ä¸‰ç±»æ–¹æ³•ä¾›ç¨‹åºæ¶ˆè´¹ Tokenï¼Œå¯ä»¥æ¯æ¬¡æ¶ˆè´¹ä¸€ä¸ª Tokenï¼Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§æ¶ˆè´¹å¤šä¸ª Tokenã€‚ æ¯ç§æ–¹æ³•ä»£è¡¨äº†å½“ Token ä¸è¶³æ—¶ï¼Œå„è‡ªä¸åŒçš„å¯¹åº”æ‰‹æ®µï¼Œå¯ä»¥é˜»å¡ç­‰å¾…æ¡¶ä¸­Tokenè¡¥å……ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿”å›å–Tokenå¤±è´¥ã€‚   </p><p>å…¶ä¸­æ¯”è¾ƒå¸¸è§çš„æ˜¯Wait&#x2F;WaitNæ–¹æ³• </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span></span> Wait(ctx context.Context) (err <span class="hljs-type">error</span>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(lim *Limiter)</span></span> WaitN(ctx context.Context, n <span class="hljs-type">int</span>) (err <span class="hljs-type">error</span>)<br></code></pre></td></tr></table></figure><p>Wait å®é™…ä¸Šå°±æ˜¯ WaitN(ctx,1)ã€‚   </p><p>å½“ä½¿ç”¨ Wait æ–¹æ³•æ¶ˆè´¹ Token æ—¶ï¼Œå¦‚æœæ­¤æ—¶æ¡¶å†… Token æ•°ç»„ä¸è¶³ (å°äº N)ï¼Œé‚£ä¹ˆ Wait æ–¹æ³•å°†ä¼šé˜»å¡ä¸€æ®µæ—¶é—´ï¼Œç›´è‡³ Token æ»¡è¶³æ¡ä»¶ã€‚å¦‚æœå……è¶³åˆ™ç›´æ¥è¿”å›ã€‚  </p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼ŒWait æ–¹æ³•æœ‰ä¸€ä¸ª context å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥è®¾ç½® context çš„ Deadline æˆ–è€… Timeoutï¼Œæ¥å†³å®šæ­¤æ¬¡ Wait çš„æœ€é•¿æ—¶é—´ã€‚     </p><p>å…¶ä»–è¿˜æœ‰ä¸¤ç§ç”¨æ³•åˆ†åˆ«å¦‚ä¸‹ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¯æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ä¿¡æ¯</p><ul><li>Allow&#x2F;AllowN </li><li>Reserve&#x2F;ReserverN</li></ul>]]></content>
    
    
    <categories>
      
      <category>Golang</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Golang</tag>
      
      <tag>é™æµå™¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redisåˆ†å¸ƒå¼é”</title>
    <link href="/2023/12/23/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <url>/2023/12/23/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    
    <content type="html"><![CDATA[<p>åˆ†å¸ƒå¼é”ï¼Œå°±æ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†æŸä¸ªä¸´ç•Œèµ„æºï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°ï¼Œä»¥ä¿è¯ä¸€è‡´æ€§ã€‚ </p><span id="more"></span>   <h2 id="Redisåˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼"><a href="#Redisåˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼" class="headerlink" title="Redisåˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼"></a>Redisåˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼</h2><blockquote><p>åœ¨çº¿redisç¯å¢ƒï¼š<a href="https://try.redis.io/">https://try.redis.io/</a>   </p></blockquote><h3 id="1-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”"><a href="#1-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”" class="headerlink" title="1. ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”"></a>1. ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”å°±æ˜¯ï¼Œæ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚å¦‚æœä¸åŒçš„ç³»ç»Ÿæˆ–åŒä¸€ä¸ªç³»ç»Ÿçš„ä¸åŒä¸»æœºä¹‹é—´å…±äº«äº†æŸä¸ªä¸´ç•Œèµ„æºï¼Œå¾€å¾€éœ€è¦äº’æ–¥æ¥é˜²æ­¢å½¼æ­¤å¹²æ‰°ï¼Œä»¥ä¿è¯ä¸€è‡´æ€§ã€‚<br>åˆ†å¸ƒå¼é”ä¸€èˆ¬å…·æœ‰ä»¥ä¸‹ç‰¹å¾:  </p><ul><li>äº’æ–¥æ€§ï¼šä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯æŒæœ‰</li><li>è¶…æ—¶é‡Šæ”¾ï¼šæŒæœ‰é”è¶…æ—¶å¯ä»¥åŠæ—¶é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”å’Œä¸å¿…è¦çš„èµ„æºæµªè´¹  </li><li>å¯é‡å…¥æ€§ï¼šä¸€ä¸ªçº¿ç¨‹è·å–é”ä¹‹åï¼Œè¿˜å¯ä»¥å†æ¬¡å¯¹å…¶è¯·æ±‚åŠ é”</li><li>é«˜æ€§èƒ½é«˜å¯ç”¨ï¼šåŠ é”å’Œè§£é”éœ€è¦å¼€é”€å°½é‡ä½ï¼ŒåŒæ—¶ä¹Ÿè¦ä¿è¯é«˜å¯ç”¨ </li><li>å®‰å…¨æ€§ï¼šé”åªèƒ½è¢«æŒæœ‰çš„å®¢æˆ·ç«¯åˆ é™¤ï¼Œä¸èƒ½è¢«å…¶ä»–å®¢æˆ·ç«¯åˆ é™¤</li></ul><!--  --><p><img src="/img/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/1.png"></p><h3 id="2-SETNX"><a href="#2-SETNX" class="headerlink" title="2. SETNX"></a>2. SETNX</h3><p>ä¸€æåˆ°ä½¿ç”¨Redisä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œå¤§å®¶è€³ç†Ÿèƒ½è¯¦çš„å°±ä¼šæƒ³åˆ°<code>SETNX + EXPIRE</code>ã€‚å³å…ˆç”¨<code>setnx</code>æ¥æŠ¢é”ï¼Œç„¶åå†ç”¨<code>expire</code>è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚</p><blockquote><p>SETNXæ˜¯ SET IF NOT EXISTSçš„ç®€ç§°ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸å­˜åœ¨å°±è®¾ç½®<br>å‘½ä»¤ä½¿ç”¨ï¼šSETNX key value<br>å¦‚æœkeyä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸè¿”å›1ï¼Œå¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œè®¾ç½®å¤±è´¥è¿”å›0</p></blockquote><p>ä½†æ˜¯ç›´æ¥ä½¿ç”¨SETNX + EXPIRE æŒ‡ä»¤ï¼Œä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p><ul><li>åŸå­æ€§ï¼šsetnx å’Œ exipreæ˜¯ä¸¤ä¸ªå‘½ä»¤ï¼Œå¦‚æœè®¾ç½®è¿‡æœŸæ—¶é—´å‡ºé”™ï¼Œå°±ä¼šå¯¼è‡´é•¿æ—¶é—´æŒæœ‰é”å¾—ä¸åˆ°é‡Šæ”¾ã€‚</li><li>è¯¯åˆ é™¤é—®é¢˜ï¼šå‡è®¾çº¿ç¨‹aæ‰§è¡Œå®Œåï¼Œä¸»åŠ¨å»é‡Šæ”¾é”ã€‚ä½†å®ƒä¸çŸ¥é“å½“å‰çš„é”å¯èƒ½æ˜¯çº¿ç¨‹bæŒæœ‰çš„ï¼ˆçº¿ç¨‹aå»é‡Šæ”¾é”æ—¶ï¼Œæœ‰å¯èƒ½è¿‡æœŸæ—¶é—´å·²ç»åˆ°äº†ï¼Œæ­¤æ—¶çº¿ç¨‹bè¿›æ¥å æœ‰äº†é”ï¼‰ã€‚é‚£çº¿ç¨‹aå°±æŠŠçº¿ç¨‹bçš„é”é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯çº¿ç¨‹bä¸´ç•ŒåŒºä¸šåŠ¡ä»£ç å¯èƒ½éƒ½è¿˜æ²¡æ‰§è¡Œå®Œæˆã€‚</li></ul><h4 id="2-1-åŸå­æ€§"><a href="#2-1-åŸå­æ€§" class="headerlink" title="2.1 åŸå­æ€§"></a>2.1 åŸå­æ€§</h4><p>ä¸ºè§£å†³åŸå­æ€§é—®é¢˜ï¼Œå¸¸è§çš„æœ‰ä¸¤ç§æ–¹å¼:  </p><h5 id="2-1-1-ä½¿ç”¨Luaè„šæœ¬"><a href="#2-1-1-ä½¿ç”¨Luaè„šæœ¬" class="headerlink" title="2.1.1 ä½¿ç”¨Luaè„šæœ¬"></a>2.1.1 ä½¿ç”¨Luaè„šæœ¬</h5><p>luaè„šæœ¬åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ˜¯å¯ä»¥ä¿è¯åŸå­å¤„ç†çš„ï¼Œå¯ä»¥å°†setnxå’Œexpireä¸¤ä¸ªå‘½ä»¤éƒ½æ”¾åˆ°luaè„šæœ¬ä¸­è¿›è¡Œæ“ä½œã€‚  </p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">&#x27;setnx&#x27;</span>,KEYS[<span class="hljs-number">1</span>],ARGV[<span class="hljs-number">1</span>]) == <span class="hljs-number">1</span> <span class="hljs-keyword">then</span><br>   redis.call(<span class="hljs-string">&#x27;expire&#x27;</span>,KEYS[<span class="hljs-number">1</span>],ARGV[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">else</span><br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><span class="hljs-keyword">end</span>;<br></code></pre></td></tr></table></figure><h5 id="2-1-2-ä½¿ç”¨SETçš„æ‰©å±•å‘½ä»¤"><a href="#2-1-2-ä½¿ç”¨SETçš„æ‰©å±•å‘½ä»¤" class="headerlink" title="2.1.2 ä½¿ç”¨SETçš„æ‰©å±•å‘½ä»¤"></a>2.1.2 ä½¿ç”¨SETçš„æ‰©å±•å‘½ä»¤</h5><p>è™½ç„¶<code>SETNX</code>å’Œ<code>EXPIRE</code>ä¸¤ä¸ªæŒ‡ä»¤æ˜¯ç‹¬ç«‹çš„ï¼Œä½†æ˜¯å•ç‹¬çš„ä¸€ä¸ªSETå‘½ä»¤æ˜¯å´æ˜¯åŸå­çš„ï¼Œå¯ä»¥ä½¿ç”¨SETçš„å‚æ•°æ‰©å±•åŠŸèƒ½å®ç°NXå’ŒEXPIREçš„èƒ½åŠ›<br><code>SET key value [EX seconds] [PX millseconds] NX</code>  </p><blockquote><p>SET key value [EX seconds] [PX milliseconds] NX<br>NX :è¡¨ç¤ºkeyä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰èƒ½setæˆåŠŸï¼Œä¹Ÿå³ä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ‰èƒ½è·å¾—é”ï¼Œè€Œå…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚åªèƒ½ç­‰å…¶é‡Šæ”¾é”ï¼Œæ‰èƒ½è·å–ã€‚<br>EX seconds :è®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´å•ä½æ˜¯ç§’ã€‚<br>PX milliseconds: è®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’  </p></blockquote><p>åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œä¸ä¼šç›´æ¥æ‰§è¡Œredisçš„cmdå‘½ä»¤ã€‚å¯ä»¥åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„sdkæ—¶ï¼ŒæŸ¥çœ‹sdkæ˜¯å¦å·²ç»æä¾›äº†ä¸€äº›åŸå­çš„æ“ä½œï¼Œé¿å…è‡ªå·±å†™åŸç”Ÿluaè„šæœ¬æˆ–è€…å‘½ä»¤ã€‚æ¯”å¦‚go-redisä¸­ï¼ŒSETNX + EXPIREå·²ç»å¯ä»¥åœ¨ä¸€ä¸ªå®¢æˆ·ç«¯æ“ä½œä¸­å®Œæˆï¼š  </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Lock ä½¿ç”¨ SETNXå®ç°åŠ é”</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span></span> Lock(key, value <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>ret := c.client.SetNX(key, value, time.Minute)<br><span class="hljs-keyword">if</span> ret.Val() &#123;<br>fmt.Println(<span class="hljs-string">&quot;åŠ é”æˆåŠŸ&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;åŠ é”å¤±è´¥&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// Redis `SET key value [expiration] NX` command.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Zero expiration means the key has no expiration time.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *cmdable)</span></span> SetNX(key <span class="hljs-type">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;, expiration time.Duration) *BoolCmd &#123;&#125;<br><br></code></pre></td></tr></table></figure><h4 id="2-2-è¯¯åˆ é™¤"><a href="#2-2-è¯¯åˆ é™¤" class="headerlink" title="2.2 è¯¯åˆ é™¤"></a>2.2 è¯¯åˆ é™¤</h4><p>æ—¢ç„¶é”å¯èƒ½ä¼šè¢«åˆ«çš„çº¿ç¨‹åˆ é™¤ï¼Œé‚£ç»™é”çš„valueå€¼è®¾ç½®ä¸€ä¸ªæ ‡è®°å½“å‰çš„çº¿ç¨‹å”¯ä¸€å€¼å³å¯ã€‚åœ¨åˆ é™¤çš„æ—¶å€™é¦–å…ˆæ ¡éªŒå€¼æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰ç›¸ç­‰çš„æƒ…å†µä¸‹æ‰å¯ä»¥åˆ é™¤é”ã€‚<br>åŒæ ·çš„ï¼Œä¸ºä¿è¯ä¸€è‡´æ€§ï¼Œå€¼çš„æ¯”è¾ƒå’Œåˆ é™¤æ“ä½œéœ€è¦ä¿è¯åŸå­æ€§ã€‚ </p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">&#x27;get&#x27;</span>,KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span> <br>   <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">&#x27;del&#x27;</span>,KEYS[<span class="hljs-number">1</span>]) <br><span class="hljs-keyword">else</span><br>   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br><span class="hljs-keyword">end</span>;<br></code></pre></td></tr></table></figure><h3 id="3-Redisson"><a href="#3-Redisson" class="headerlink" title="3. Redisson"></a>3. Redisson</h3><p>å‚è€ƒæ–‡ç« ï¼š  </p><ul><li><a href="https://blog.csdn.net/qq_34826261/article/details/126177704">https://blog.csdn.net/qq_34826261&#x2F;article&#x2F;details&#x2F;126177704</a>  </li><li><a href="https://zhuanlan.zhihu.com/p/135864820">https://zhuanlan.zhihu.com/p/135864820</a>  </li><li><a href="https://juejin.cn/post/7168802584684134413">https://juejin.cn/post/7168802584684134413</a></li></ul><p>ä¸Šé¢ä»‹ç»çš„<code>SETNX + Exipred + åŸå­æ“ä½œ + å”¯ä¸€å€¼æ ¡éªŒåˆ é™¤</code>çš„æ–¹æ¡ˆåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå·²ç»èƒ½å¤Ÿæ»¡è¶³ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªå¯èƒ½å­˜åœ¨çš„æƒ…å†µæ²¡æœ‰è§£å†³ï¼š </p><ul><li>é”è¿‡æœŸé‡Šæ”¾ï¼Œä½†ä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œæˆï¼šå‡è®¾çº¿ç¨‹aè·å–é”æˆåŠŸï¼Œä¸€ç›´åœ¨æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚100sè¿‡å»åï¼Œå®ƒè¿˜æ²¡æ‰§è¡Œå®Œã€‚ä½†è¿™æ—¶å€™é”å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹båˆè¯·æ±‚è¿‡æ¥ã€‚æ˜¾ç„¶çº¿ç¨‹bå°±å¯ä»¥è·å¾—é”æˆåŠŸï¼Œä¹Ÿå¼€å§‹æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸´ç•ŒåŒºçš„ä¸šåŠ¡ä»£ç éƒ½ä¸æ˜¯ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œã€‚</li></ul><p>é’ˆå¯¹è¿™ç§é—®é¢˜ï¼ŒRedissonæ¡†æ¶åšäº†ä¸€äº›é¢å¤–çš„ä¼˜åŒ–ï¼Œåœ¨åŠ é”çš„åŒæ—¶å¼€å¯ä¸€ä¸ªå®šæ—¶å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é”æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¯¹é”çš„è¿‡æœŸæ—¶é—´å»¶é•¿ï¼Œé˜²æ­¢é”è¿‡æœŸæå‰é‡Šæ”¾ã€‚  </p><p>Redissonä¸»è¦åŸç†åŠç»“æ„å¦‚ä¸‹ï¼š  </p><ul><li>åŸºäºRediså‘½ä»¤çš„å®ç°ï¼š Redissonåˆ©ç”¨äº†Redisçš„å•çº¿ç¨‹ç‰¹æ€§å’ŒåŸå­æ“ä½œçš„ç‰¹ç‚¹ã€‚å®ƒé€šè¿‡è°ƒç”¨Redisçš„SETNXå‘½ä»¤æ¥å°è¯•è·å–é”ï¼Œå½“é”ä¸å­˜åœ¨æ—¶ï¼Œæ‰èƒ½è·å–åˆ°é”ã€‚</li><li>å¿ƒè·³ç»­çº¦(çœ‹é—¨ç‹—)æœºåˆ¶ï¼š ä¸ºé˜²æ­¢ä¸šåŠ¡é€»è¾‘è¿˜æ²¡æ‰§è¡Œå®Œé”å°±åˆ°æœŸçš„é—®é¢˜ï¼ŒRedissonåœ¨è·å–é”ä¹‹åä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥å‘¨æœŸæ€§åœ°ç»­çº¦é”çš„æœ‰æ•ˆæ—¶é—´ã€‚</li><li>å®ç°å¯é‡å…¥é”ï¼š Redissonæ”¯æŒå¯é‡å…¥é”ï¼Œä¿è¯åŒä¸€çº¿ç¨‹åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹èƒ½å¤Ÿå¤šæ¬¡è·å–é”ï¼Œè€Œä¸ä¼šå› ä¸ºè‡ªå·±å·²ç»æŒæœ‰é”è€Œè¢«é˜»å¡ã€‚  </li><li>åˆ†å¸ƒå¼é”é‡Šæ”¾çš„å®‰å…¨æ€§ä¿è¯ï¼š Redissoné€šè¿‡Luaè„šæœ¬æ¥é‡Šæ”¾é”ï¼Œä¿è¯äº†é‡Šæ”¾é”çš„åŸå­æ€§ã€‚ä½¿ç”¨Luaè„šæœ¬å¯ä»¥ä¿è¯é‡Šæ”¾é”çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œé¿å…äº†åœ¨æ‰§è¡Œé‡Šæ”¾é”é€»è¾‘æ—¶å‡ºç°çš„å¹¶å‘é—®é¢˜ã€‚</li></ul><p><img src="/img/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/redisson.png">   </p><blockquote><p>éƒ¨åˆ†æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š </p><ul><li>åŠ é” <ul><li>æ¯æ¬¡åŠ é”éƒ½æœ‰ä¸€ä¸ªåŠ é”ç­‰å¾…æ—¶é—´ </li><li>å¦‚æœåŠ é”æˆåŠŸï¼Œç›´æ¥è¿”å›true</li><li>å¦‚æœåŠ é”å¤±è´¥ï¼Œåˆ™è®¢é˜…é”é‡Šæ”¾æ¶ˆæ¯ï¼Œåœ¨åŠ é”ç­‰å¾…æ—¶é—´å†…ç›‘å¬é”é‡Šæ”¾æ¶ˆæ¯ï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰ç›‘å¬åˆ°ï¼Œåˆ™å–æ¶ˆè®¢é˜…å¹¶è¿”å›false </li><li>å¦‚æœåœ¨ç­‰å¾…æ—¶é—´å†…ç›‘å¬åˆ°é”é‡Šæ”¾æ¶ˆæ¯ï¼Œåˆ™è¿›å…¥ä¸€ä¸ªä¸æ–­é‡è¯•è·å–é”çš„å¾ªç¯</li></ul></li><li>ç»­æœŸæœºåˆ¶  <ul><li>åªæœ‰åœ¨åŠ é”æ—¶æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´æ—¶æ‰ä¼šå¯ç”¨Watch Dogæœºåˆ¶  </li><li>Watch Dogå¯åŠ¨å®ˆæŠ¤çº¿ç¨‹ï¼Œå®ˆæŠ¤çº¿ç¨‹è½®è¯¢å‘¨æœŸä¸ºï¼šinternalLockLeaseTime&#x2F;3ã€‚internalLockLeaseTimeçš„é»˜è®¤å€¼ç”±lockWatchdogTimeoutæ¥é…ç½®ã€‚é»˜è®¤å€¼ä¸º30ç§’ã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ˆæŠ¤çº¿ç¨‹æ¯10ç§’æ£€æŸ¥ç»­æœŸ</li></ul></li></ul></blockquote><h3 id="4-RedLock"><a href="#4-RedLock" class="headerlink" title="4. RedLock"></a>4. RedLock</h3><p>Redissonè§£å†³äº†é”è¶…æ—¶ç»­æœŸè‡ªåŠ¨é‡Šæ”¾çš„é—®é¢˜ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç§æç«¯çš„æƒ…å†µæ²¡æœ‰è§£å†³ï¼š  </p><ul><li>å®¢æˆ·ç«¯Aå°è¯•åœ¨Redis MasterèŠ‚ç‚¹ä¸Šé”ï¼Œå®¢æˆ·ç«¯AæˆåŠŸè·å¾—é”çš„ç¬é—´ï¼Œé”æ•°æ®è¿˜æ²¡æœ‰åŒæ­¥è‡³SlaveèŠ‚ç‚¹ã€‚è¿™æ—¶MasteræŒ‚äº†ï¼Œäºæ˜¯å‘ç”Ÿä¸»ä»åˆ‡æ¢ï¼Œå…¶å®ƒå®¢æˆ·ç«¯è¿æ¥åˆ°SlaveèŠ‚ç‚¹å°è¯•æŠ¢å é”ï¼Œç”±äºSlaveæ²¡æœ‰å®¢æˆ·ç«¯Açš„ä¸Šé”ä¿¡æ¯ã€‚è‡ªç„¶åˆä¼šæœ‰ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯BæŠ¢åˆ°é”ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‹¥æœ‰åˆ†å¸ƒå¼é”çš„å¥‡è‘©ç°åƒã€‚</li></ul><p>é‰´äºæ­¤ï¼ŒRedisä½œè€…æå‡ºä¸€ç§æ›´é«˜çº§çš„RedLockç®—æ³•ï¼Œå®ƒéœ€è¦éƒ¨ç½² N ï¼ˆN &gt;&#x3D; 2n+1ï¼‰ä¸ªç‹¬ç«‹çš„ Redis masterå®ä¾‹ï¼Œä¸”å®ä¾‹ä¹‹é—´æ²¡æœ‰ä»»ä½•çš„è”ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€åŠä»¥ä¸Šçš„ Redis å®ä¾‹åŠ é”æˆåŠŸï¼Œé‚£ä¹ˆ Redlock ä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œã€‚  </p><p><img src="/img/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/redlock.png">  </p><p>å‡è®¾æˆ‘ä»¬æœ‰ 5 ä¸ª Redis å®ä¾‹ï¼Œå½“æˆ‘ä»¬å¯¹ order1 è¿™ä¸ªè®¢å•åŠ é”æ—¶ï¼Œå…ˆè®°å½•å½“å‰æ—¶é—´ç”¨äºç»Ÿè®¡åŠ é”è¿‡ç¨‹èŠ±è´¹çš„æ—¶é—´ï¼Œç„¶åä¾æ¬¡è®© 5 ä¸ª Redis å®ä¾‹æ‰§è¡Œ SET order1 token NX EX 60 å‘½ä»¤ï¼Œæœ€åç»Ÿè®¡<strong>åŠ é”æˆåŠŸçš„å®ä¾‹æ•°é‡ä»¥åŠåŠ é”è¿‡ç¨‹è€—è´¹çš„æ—¶é—´</strong>  </p><ul><li>ç»Ÿè®¡ä¸ªæ•°: å½“è¶…è¿‡ä¸€åŠçš„åŠ é”æˆåŠŸï¼Œè®¤ä¸ºæ˜¯æˆåŠŸ   </li><li>ç»Ÿè®¡æ—¶é—´: é¿å…æ•´ä½“çš„åŠ é”æ—¶é•¿å·²ç»è¶…è¿‡é”æœ¬èº«çš„æœ‰æ•ˆæ—¶é—´ï¼Œæ¯”å¦‚é”çš„è¿‡æœŸæ—¶é—´æ˜¯3sï¼Œä½†æ˜¯åŠ é”è¿‡ç¨‹è€—è´¹äº†4sï¼Œè‚¯å®šæ˜¯è®¤ä¸ºåŠ é”å¤±è´¥çš„ã€‚</li></ul><p>è§£é”è¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦5ä¸ªå®ä¾‹ä¾æ¬¡åˆ é™¤redis keyå³å¯ã€‚   </p><p>Redlockåœ¨Redissonä¸­ä¹Ÿæœ‰å¯¹åº”çš„å®ç°ï¼Œä¸è¿‡åœ¨æœ€æ–°ç‰ˆçš„Redissonä¸­ï¼ŒRedlockå·²ç»ä¸å†å»ºè®®ä½¿ç”¨.å› ä¸ºç°åœ¨åŠ é”æ“ä½œå®ç°ï¼Œå¯ä»¥ç­‰æ‰€æœ‰ä»èŠ‚ç‚¹æ•°æ®åŒæ­¥äº†æ‰ç®—åŠ é”æˆåŠŸã€‚è¿™æ ·çš„è¯å°±å¯ä»¥ä¿è¯ä¸»ä»åˆ‡æ¢é”ä¸ä¼šä¸¢å¤±äº†ã€‚  </p><pre><code class="hljs">8.4. RedLockThis object is deprecated. Use RLock or RFencedLock instead.</code></pre><p>å¯ä»¥é€šè¿‡Redisçš„Waitå‘½ä»¤å®ç°ä¸»ä»åŒæ­¥  </p><blockquote><p>Redis WAIT å‘½ä»¤ç”¨æ¥é˜»å¡å½“å‰å®¢æˆ·ç«¯ï¼Œç›´åˆ°æ‰€æœ‰å…ˆå‰çš„å†™å…¥å‘½ä»¤æˆåŠŸä¼ è¾“å¹¶ä¸”è‡³å°‘ç”±æŒ‡å®šæ•°é‡çš„ä»èŠ‚ç‚¹å¤åˆ¶å®Œæˆã€‚å¦‚æœæ‰§è¡Œè¶…è¿‡è¶…æ—¶æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ï¼Œåˆ™å³ä½¿å°šæœªå®ŒæˆæŒ‡å®šæ•°é‡çš„ä»ç»“ç‚¹å¤åˆ¶ï¼Œè¯¥å‘½ä»¤ä¹Ÿä¼šè¿”å›ã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Redis</tag>
      
      <tag>åˆ†å¸ƒå¼é”</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
